<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.1 Metadata Attribution | DEQ Water Quality Automated Assessment User Guide</title>
  <meta name="description" content="A companion document describing the WQA automated assessment methodology." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="3.1 Metadata Attribution | DEQ Water Quality Automated Assessment User Guide" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A companion document describing the WQA automated assessment methodology." />
  <meta name="github-repo" content="openscapes/series" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.1 Metadata Attribution | DEQ Water Quality Automated Assessment User Guide" />
  
  <meta name="twitter:description" content="A companion document describing the WQA automated assessment methodology." />
  

<meta name="author" content="DEQ Automated Assessment Team" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="automated-assessment-methods.html"/>
<link rel="next" href="organize-metadata.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.13/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<script src="assets/book.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="lib/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="lib/css/style.css" type="text/css" />
<link rel="stylesheet" href="lib/css/lesson.css" type="text/css" />
<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">DEQ Water Quality Automated Assessment User Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="HowToUseDocument.html"><a href="HowToUseDocument.html"><i class="fa fa-check"></i><b>1.1</b> How to Use Document</a></li>
<li class="chapter" data-level="1.2" data-path="ProjectHistory.html"><a href="ProjectHistory.html"><i class="fa fa-check"></i><b>1.2</b> Project History</a></li>
<li class="chapter" data-level="1.3" data-path="Acknowledgements.html"><a href="Acknowledgements.html"><i class="fa fa-check"></i><b>1.3</b> Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-organization.html"><a href="data-organization.html"><i class="fa fa-check"></i><b>2</b> Data Organization</a>
<ul>
<li class="chapter" data-level="2.0.1" data-path="data-organization.html"><a href="data-organization.html#data-location"><i class="fa fa-check"></i><b>2.0.1</b> Data Location</a></li>
<li class="chapter" data-level="2.0.2" data-path="data-organization.html"><a href="data-organization.html#data-availablility"><i class="fa fa-check"></i><b>2.0.2</b> Data Availablility</a></li>
<li class="chapter" data-level="2.1" data-path="conventionals-data.html"><a href="conventionals-data.html"><i class="fa fa-check"></i><b>2.1</b> Conventionals Data</a></li>
<li class="chapter" data-level="2.2" data-path="water-column-metals.html"><a href="water-column-metals.html"><i class="fa fa-check"></i><b>2.2</b> Water Column Metals</a></li>
<li class="chapter" data-level="2.3" data-path="sediment-metals.html"><a href="sediment-metals.html"><i class="fa fa-check"></i><b>2.3</b> Sediment Metals</a></li>
<li class="chapter" data-level="2.4" data-path="fish-tissue-data.html"><a href="fish-tissue-data.html"><i class="fa fa-check"></i><b>2.4</b> Fish Tissue Data</a></li>
<li class="chapter" data-level="2.5" data-path="pcb-data.html"><a href="pcb-data.html"><i class="fa fa-check"></i><b>2.5</b> PCB Data</a></li>
<li class="chapter" data-level="2.6" data-path="vdh-data.html"><a href="vdh-data.html"><i class="fa fa-check"></i><b>2.6</b> VDH Data</a></li>
<li class="chapter" data-level="2.7" data-path="citizen-monitoring-data.html"><a href="citizen-monitoring-data.html"><i class="fa fa-check"></i><b>2.7</b> Citizen Monitoring Data</a></li>
<li class="chapter" data-level="2.8" data-path="station-metadata.html"><a href="station-metadata.html"><i class="fa fa-check"></i><b>2.8</b> Station Metadata</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="automated-assessment-methods.html"><a href="automated-assessment-methods.html"><i class="fa fa-check"></i><b>3</b> Automated Assessment Methods</a>
<ul>
<li class="chapter" data-level="3.1" data-path="metadata-attribution.html"><a href="metadata-attribution.html"><i class="fa fa-check"></i><b>3.1</b> Metadata Attribution</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="metadata-attribution.html"><a href="metadata-attribution.html#distinct-sites"><i class="fa fa-check"></i><b>3.1.1</b> Distinct Sites</a></li>
<li class="chapter" data-level="3.1.2" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-assessment-region-and-subbasin-information"><i class="fa fa-check"></i><b>3.1.2</b> Join Assessment Region and Subbasin Information</a></li>
<li class="chapter" data-level="3.1.3" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-stations-to-wqs"><i class="fa fa-check"></i><b>3.1.3</b> Join Stations to WQS</a></li>
<li class="chapter" data-level="3.1.4" data-path="metadata-attribution.html"><a href="metadata-attribution.html#spatially-join-polygons"><i class="fa fa-check"></i><b>3.1.4</b> Spatially Join Polygons</a></li>
<li class="chapter" data-level="3.1.5" data-path="metadata-attribution.html"><a href="metadata-attribution.html#spatially-join-wqs-lines"><i class="fa fa-check"></i><b>3.1.5</b> Spatially Join WQS Lines</a></li>
<li class="chapter" data-level="3.1.6" data-path="metadata-attribution.html"><a href="metadata-attribution.html#assign-something-to-wqs_id-so-sites-will-not-fall-through-the-cracks-when-application-filtering-occurs"><i class="fa fa-check"></i><b>3.1.6</b> Assign something to WQS_ID so sites will not fall through the cracks when application filtering occurs</a></li>
<li class="chapter" data-level="3.1.7" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-stations-to-aus"><i class="fa fa-check"></i><b>3.1.7</b> Join Stations to AUs</a></li>
<li class="chapter" data-level="3.1.8" data-path="metadata-attribution.html"><a href="metadata-attribution.html#where-does-this-information-go"><i class="fa fa-check"></i><b>3.1.8</b> Where does this information go?</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="organize-metadata.html"><a href="organize-metadata.html"><i class="fa fa-check"></i><b>3.2</b> Organize Metadata</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="organize-metadata.html"><a href="organize-metadata.html#section"><i class="fa fa-check"></i><b>3.2.1</b> </a></li>
<li class="chapter" data-level="3.2.2" data-path="organize-metadata.html"><a href="organize-metadata.html#organizing-all-new-wqsau-metadata-from-the-r-server"><i class="fa fa-check"></i><b>3.2.2</b> Organizing all new WQS/AU metadata from the R server</a></li>
<li class="chapter" data-level="3.2.3" data-path="organize-metadata.html"><a href="organize-metadata.html#reorganizing-the-conventionals-dataset-to-match-schema-for-automated-assessment-script"><i class="fa fa-check"></i><b>3.2.3</b> Reorganizing the conventionals dataset to match schema for automated assessment script</a></li>
<li class="chapter" data-level="3.2.4" data-path="organize-metadata.html"><a href="organize-metadata.html#adding-secchi-depth-to-conventionals-dataset"><i class="fa fa-check"></i><b>3.2.4</b> Adding Secchi Depth to conventionals dataset</a></li>
<li class="chapter" data-level="3.2.5" data-path="organize-metadata.html"><a href="organize-metadata.html#clean-up-pcb-dataset"><i class="fa fa-check"></i><b>3.2.5</b> Clean up PCB dataset</a></li>
<li class="chapter" data-level="3.2.6" data-path="organize-metadata.html"><a href="organize-metadata.html#clean-up-fish-tissue-dataset"><i class="fa fa-check"></i><b>3.2.6</b> Clean up Fish Tissue dataset</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html"><i class="fa fa-check"></i><b>3.3</b> Individual Parameter Analyses</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#temperature"><i class="fa fa-check"></i><b>3.3.1</b> Temperature</a></li>
<li class="chapter" data-level="3.3.2" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#dissolved-oxygen"><i class="fa fa-check"></i><b>3.3.2</b> Dissolved Oxygen</a></li>
<li class="chapter" data-level="3.3.3" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#ph"><i class="fa fa-check"></i><b>3.3.3</b> pH</a></li>
<li class="chapter" data-level="3.3.4" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#bacteria"><i class="fa fa-check"></i><b>3.3.4</b> Bacteria</a></li>
<li class="chapter" data-level="3.3.5" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#nutrients"><i class="fa fa-check"></i><b>3.3.5</b> Nutrients</a></li>
<li class="chapter" data-level="3.3.6" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#ammonia"><i class="fa fa-check"></i><b>3.3.6</b> Ammonia</a></li>
<li class="chapter" data-level="3.3.7" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#pcb"><i class="fa fa-check"></i><b>3.3.7</b> PCB</a></li>
<li class="chapter" data-level="3.3.8" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#metals"><i class="fa fa-check"></i><b>3.3.8</b> Metals</a></li>
<li class="chapter" data-level="3.3.9" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#fish-tissue"><i class="fa fa-check"></i><b>3.3.9</b> Fish Tissue</a></li>
<li class="chapter" data-level="3.3.10" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#benthics"><i class="fa fa-check"></i><b>3.3.10</b> Benthics</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="automated-output.html"><a href="automated-output.html"><i class="fa fa-check"></i><b>3.4</b> Automated Output</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regional-metadata-validation-tool-how-to.html"><a href="regional-metadata-validation-tool-how-to.html"><i class="fa fa-check"></i><b>4</b> Regional Metadata Validation Tool How To</a>
<ul>
<li class="chapter" data-level="4.1" data-path="application-orientation.html"><a href="application-orientation.html"><i class="fa fa-check"></i><b>4.1</b> Application Orientation</a></li>
<li class="chapter" data-level="4.2" data-path="application-use-water-quality-standards-qa-watershed-selection-tab.html"><a href="application-use-water-quality-standards-qa-watershed-selection-tab.html"><i class="fa fa-check"></i><b>4.2</b> Application Use: Water Quality Standards QA- Watershed Selection Tab</a></li>
<li class="chapter" data-level="4.3" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html"><i class="fa fa-check"></i><b>4.3</b> Application Use: Water Quality Standards QA- Manual Review Tab</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#map-orientation"><i class="fa fa-check"></i><b>4.3.1</b> Map Orientation</a></li>
<li class="chapter" data-level="4.3.2" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#what-do-the-buttons-do"><i class="fa fa-check"></i><b>4.3.2</b> What do the buttons do?</a></li>
<li class="chapter" data-level="4.3.3" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation"><i class="fa fa-check"></i><b>4.3.3</b> Application Operation</a></li>
<li class="chapter" data-level="4.3.4" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-1-wqs-segment"><i class="fa fa-check"></i><b>4.3.4</b> Application Operation: Station that Snapped to 1 WQS Segment</a></li>
<li class="chapter" data-level="4.3.5" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-1-wqs-segment-1"><i class="fa fa-check"></i><b>4.3.5</b> Application Operation: Station that Snapped to &gt;1 WQS Segment</a></li>
<li class="chapter" data-level="4.3.6" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-0-wqs-segments"><i class="fa fa-check"></i><b>4.3.6</b> Application Operation: Station that Snapped to 0 WQS Segments</a></li>
<li class="chapter" data-level="4.3.7" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-there-are-no-more-stations-to-attribute"><i class="fa fa-check"></i><b>4.3.7</b> Application Operation: There are no more stations to attribute</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="having-problems.html"><a href="having-problems.html"><i class="fa fa-check"></i><b>4.4</b> Having problems?</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="riverine-application-how-to.html"><a href="riverine-application-how-to.html"><i class="fa fa-check"></i><b>5</b> Riverine Application How To</a></li>
<li class="chapter" data-level="6" data-path="lacustrine-application-how-to.html"><a href="lacustrine-application-how-to.html"><i class="fa fa-check"></i><b>6</b> Lacustrine Application How To</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">DEQ Water Quality Automated Assessment User Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="metadata-attribution" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Metadata Attribution</h2>
<p>The automated assessment process hinges on each station having the appropriate metadata to analyze all raw data. The required metadata for each station include what Water Quality Standards apply to the station and which Assessment Unit(s) describe the station. One or more station can be included in an Assessment Units. It is ultimately the Assessment Units that are used to determine whether or not designated uses are met, which is where the automation stops and the human analysis component is required.</p>
<p>In practice, metadata are spatially joined to stations by a rigorous data organization, spatial joining, and QA process that is detailed below. This automated process runs on the Assessment Data Analyst’s computer and results are provided to regional assessment staff for individual review. This application is known as the <a href="https://rconnect.deq.virginia.gov/RegionalAssessmentMetadataValidation/">Regional Metadata Validation Tool</a> and is hosted on the R server. It is up to each regional assessor to manually review each suggested metadata link prior to the assessment start date. After stations have completed the manual review process, they can be analyzed using the automated assessment scripts. Detailed intructions on how to use the <a href="https://rconnect.deq.virginia.gov/RegionalAssessmentMetadataValidation/">Regional Metadata Validation Tool</a> is available in the <a href="regional-metadata-validation-tool-how-to.html#regional-metadata-validation-tool-how-to">Regional Metadata Validation Tool How To</a> section.</p>
<div id="distinct-sites" class="section level3" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> Distinct Sites</h3>
<p>Before station metadata can be linked to stations, a list of unique stations that were sampled in a given assessment window is required. Because multiple data sources are combined for an assessment, each unique station from each data source with data in the given IR window are included in this list.</p>
<p>For the purposes of the Automated Assessment User Guide, we will overview the process with a snippet of conventionals and citizen monitoring data types. Please see the <a href="https://github.com/EmmaVJones/IR2024/blob/main/1.preprocessData/HowToPreprocessData.Rmd">official script</a> for more information.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="metadata-attribution.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb3-2"><a href="metadata-attribution.html#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<pre><code>## Linking to GEOS 3.6.1, GDAL 2.2.3, PROJ 4.9.3</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="metadata-attribution.html#cb5-1" aria-hidden="true" tabindex="-1"></a>conventionals <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;exampleData/conventionals.RDS&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="metadata-attribution.html#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(FDT_STA_ID, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="metadata-attribution.html#cb5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, Latitude, Longitude) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="metadata-attribution.html#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Data_Source =</span> <span class="st">&#39;DEQ&#39;</span>)</span>
<span id="cb5-5"><a href="metadata-attribution.html#cb5-5" aria-hidden="true" tabindex="-1"></a>conventionals[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,] <span class="sc">%&gt;%</span> <span class="co"># preview first 50 rows</span></span>
<span id="cb5-6"><a href="metadata-attribution.html#cb5-6" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">rownames =</span> F, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">dom =</span> <span class="st">&#39;lftip&#39;</span>, <span class="at">pageLength =</span> <span class="dv">5</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<div id="htmlwidget-abf656b6fae7996e4659" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-abf656b6fae7996e4659">{"x":{"filter":"none","data":[["2-BKW000.40","2-BKW004.87","2-BKW005.95","2-BSB000.20","2-BUF002.10","2-BUN000.04","2-BUN001.64","2-CRG001.20","2-CRG016.90","2-CRG074.47","2-CVC000.88","2-CWP002.58","2-DCK003.94","2-DNP001.98","2-DVD000.23","2-HAM000.37","2-HUO005.87","2-IVA000.05","2-IVA005.75","2-IVA012.13","2-JKS000.38","2-JKS006.67","2-JKS013.29","2-JKS015.60","2-JKS018.68","2-JKS021.09","2-JKS022.15","2-JKS022.78","2-JKS023.61","2-JKS026.01","2-JKS028.69","2-JKS030.65","2-JKS044.60","2-JKS046.40","2-JKS048.90","2-JKS053.48","2-JMS258.54","2-JMS270.84","2-JMS279.41","2-JMS298.70","2-JMS309.13","2-JMS313.85","2-JMS342.43","2-JMS345.73","2-JTH001.52","2-JTH006.53","2-LIP001.00","2-LMC000.40","2-MFL001.65","2-MIV000.39"],[37.419444444,37.4175,37.411666666,37.833333334,37.609861111,37.385277778,37.369166666,37.649101,37.646609,37.334402778,37.489497,37.792627,37.463344445,37.803104,37.549444445,37.4128,37.5392,37.418055555,37.416666667,37.390277778,37.788613,37.810555556,37.780555555,37.771666667,37.756802,37.761111111,37.767372,37.778333334,37.788611111,37.811111111,37.822691667,37.841944445,37.947311,37.953825,37.977911,38.015102,37.410277778,37.503055556,37.555325,37.580653,37.53,37.548041,37.750444,37.775555556,37.468333334,37.46836,37.633055555,37.515992,37.493363889,37.687777778],[-79.146111111,-79.184444444,-79.187777778,-79.666666666,-78.922638889,-79.211111111,-79.200555556,-79.830992,-79.94895,-80.331186111,-79.2989,-79.759498,-80.348272222,-80.021356,-78.820833334,-80.021,-79.448211111,-79.186111111,-79.225833333,-79.2825,-79.781133,-79.854166667,-79.927777778,-79.966388889,-79.986644,-80.000833333,-79.988733,-79.991111111,-80.000833333,-79.988888889,-79.989366667,-79.989166667,-79.963655,-79.979393,-79.966996,-79.916573,-79.134166667,-79.262222222,-79.367255556,-79.606508,-79.677777778,-79.742523,-79.815703,-79.780833333,-79.21,-79.262711,-79.856388889,-79.7095,-79.62835,-79.806388889],["DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>FDT_STA_ID<\/th>\n      <th>Latitude<\/th>\n      <th>Longitude<\/th>\n      <th>Data_Source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"lftip","pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="metadata-attribution.html#cb6-1" aria-hidden="true" tabindex="-1"></a>citmon <span class="ot">&lt;-</span>  <span class="fu">readRDS</span>(<span class="st">&#39;exampleData/citmon.RDS&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="metadata-attribution.html#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(FDT_STA_ID, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="metadata-attribution.html#cb6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, Latitude, Longitude, Data_Source)</span>
<span id="cb6-4"><a href="metadata-attribution.html#cb6-4" aria-hidden="true" tabindex="-1"></a>citmon[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,] <span class="sc">%&gt;%</span> <span class="co"># preview first 50 rows</span></span>
<span id="cb6-5"><a href="metadata-attribution.html#cb6-5" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">rownames =</span> F, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">dom =</span> <span class="st">&#39;lftip&#39;</span>, <span class="at">pageLength =</span> <span class="dv">5</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<div id="htmlwidget-951b93ee1669c4868827" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-951b93ee1669c4868827">{"x":{"filter":"none","data":[["2JMS-35-ALL","NULL","2-APP-ARF-ACB","1AAUS-B3-ALL","2-BRT004.01","2-CKD-CB1-ACB","2-CGB-CGB MR-SOS","2-CHK071.66","3-CAT-CP1-CBGS","3-CAT-CP2-CBGS","3-CAT-CP4-CBGS","3-CAT-CP8-CBGS","2DCHK-CR21-ACB","2-XAR-CR5-ACB","2-DRC-DC1-JRMN","7-DRN-DR3-CBGS","7-XFG-DR6-CBGS","7-DRN-DR9-CBGS","3ENG-1-ALL","3HAL-1-ALL","3MIN-17-ALL","3RPP-18-ALL","7-WIN000.88","2-HYS001.41","2-HYS007.46","2CJOP-JB1-ACB","2BJMS-JRB-JRMN","2BJMS-JRTP-JRMN","3-LIK000.15","2-MOU-MOU-01-SOS","8-PMK-PAMRIV82-ACB","3-XMR002.02","2CXXQ-PRC01-ACB","2-RDD-RC1-ACB","2-RDD-RC3-ACB","2-RDD-RC4-ACB","3-RUS007.41","8-SAR021.22","8SAR-SA2-JRMN","2-SNF000.04","2-SNF-STORUN6.2-RMN","8TLR-TAY2-ALL","3-TOT-TOT 1-ACB","3-TOT-TOT 3-ACB","3-TOT-TOT 4-ACB","2CUPM-UB1-ALL","2CUPM-UB2-ACB","2BXBH-UT1-ACB","7-WAR005.77","2BEN-SBC000.35-SUF"],[37.5246,38.464202,37.30734,38.44946,37.949092,37.51261,37.8828,37.6802779,38.08138889,38.03916667,37.98388889,37.97444444,37.419912,37.6057,37.6179,37.63527778,37.69638889,37.58555556,38.3318,38.2898,38.313611,38.321111,37.3768697,37.911234,37.93414,37.597255,37.6244,37.6652,37.9262344,37.874,37.788696,38.8045,37.59697,37.51467,37.5147872,37.50686,38.72687,37.7598,37.821667,37.6848629,37.75357,37.7645,37.9129344,37.9236345,37.8860358,37.6146,37.59832,37.51483,37.40308,36.87598],[-77.4686,-77.3873577,-78.389257,-77.38381,-79.558395,-77.48008,-79.3859,-77.4550473,-76.84611111,-76.8275,-76.80944444,-76.85388889,-76.97541,-77.5455,-77.989833,-76.69638889,-76.72722222,-76.60305556,-77.5071,-77.4816,-77.540556,-77.488889,-76.2630234,-79.40021,-79.34192,-77.473902,-77.9831,-77.886667,-76.7199799,-79.379,-77.370077,-78.1439,-77.46902,-77.47456,-77.4839271,-77.5043,-78.16991,-77.61262,-77.845278,-77.4492107,-77.48936,-77.64133,-76.6573787,-76.7206799,-76.7362806,-77.4567,-77.46803,-77.48533,-76.48952,-76.48317],["CMC - Riverine Master Naturalists","CMC - Green Aquia","CMC - Alliance for the Chesapeake Bay","CMC - Green Aquia","CMC - Rockbridge Water Monitors","CMC - Reedy Creek Coalition","CMC - Rockbridge Water Monitors","CMC - Alliance for the Chesapeake Bay","CMC - Chesapeake Bay Governor's School","CMC - Chesapeake Bay Governor's School","CMC - Chesapeake Bay Governor's School","CMC - Alliance for the Chesapeake Bay","CMC - Riverine Master Naturalists","CMC - Riverine Master Naturalists","CMC - James River Master Naturalists","CMC - Chesapeake Bay Governor's School","CMC - Chesapeake Bay Governor's School","CMC - Chesapeake Bay Governor's School","CMC - Friends of the Rappahannock","CMC - Friends of the Rappahannock","CMC - Friends of the Rappahannock","CMC - Friends of the Rappahannock","CMC - Middle Peninsula Master Naturalists","CMC - Rockbridge Water Monitors","CMC - Rockbridge Water Monitors","CMC - Riverine Master Naturalists","CMC - James River Master Naturalists","CMC - James River Master Naturalists","CMC - Alliance for the Chesapeake Bay","CMC - Rockbridge Water Monitors","CMC - Riverine Master Naturalists","CMC - Friends of the Rappahannock","CMC - Riverine Master Naturalists","CMC - Reedy Creek Coalition","CMC - Reedy Creek Coalition","CMC - Reedy Creek Coalition","CMC - Alliance for the Chesapeake Bay","CMC - Riverine Master Naturalists","CMC - James River Master Naturalists","CMC - Alliance for the Chesapeake Bay","CMC - Riverine Master Naturalists","CMC - Riverine Master Naturalists","CMC - Alliance for the Chesapeake Bay","CMC - Alliance for the Chesapeake Bay","CMC - Alliance for the Chesapeake Bay","CMC - Riverine Master Naturalists","CMC - Riverine Master Naturalists","CMC - Reedy Creek Coalition","CMC - Middle Peninsula Master Naturalists","CMC - City of Suffolk"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>FDT_STA_ID<\/th>\n      <th>Latitude<\/th>\n      <th>Longitude<\/th>\n      <th>Data_Source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"lftip","pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="metadata-attribution.html#cb7-1" aria-hidden="true" tabindex="-1"></a>distinctSites <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(conventionals, citmon)</span>
<span id="cb7-2"><a href="metadata-attribution.html#cb7-2" aria-hidden="true" tabindex="-1"></a>distinctSites[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,] <span class="sc">%&gt;%</span> <span class="co"># preview first 50 rows</span></span>
<span id="cb7-3"><a href="metadata-attribution.html#cb7-3" aria-hidden="true" tabindex="-1"></a>  DT<span class="sc">::</span><span class="fu">datatable</span>(<span class="at">rownames =</span> F, <span class="at">options =</span> <span class="fu">list</span>(<span class="at">dom =</span> <span class="st">&#39;lftip&#39;</span>, <span class="at">pageLength =</span> <span class="dv">5</span>, <span class="at">scrollX =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<div id="htmlwidget-ba60a23206cc97aa6026" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-ba60a23206cc97aa6026">{"x":{"filter":"none","data":[["2-BKW000.40","2-BKW004.87","2-BKW005.95","2-BSB000.20","2-BUF002.10","2-BUN000.04","2-BUN001.64","2-CRG001.20","2-CRG016.90","2-CRG074.47","2-CVC000.88","2-CWP002.58","2-DCK003.94","2-DNP001.98","2-DVD000.23","2-HAM000.37","2-HUO005.87","2-IVA000.05","2-IVA005.75","2-IVA012.13","2-JKS000.38","2-JKS006.67","2-JKS013.29","2-JKS015.60","2-JKS018.68","2-JKS021.09","2-JKS022.15","2-JKS022.78","2-JKS023.61","2-JKS026.01","2-JKS028.69","2-JKS030.65","2-JKS044.60","2-JKS046.40","2-JKS048.90","2-JKS053.48","2-JMS258.54","2-JMS270.84","2-JMS279.41","2-JMS298.70","2-JMS309.13","2-JMS313.85","2-JMS342.43","2-JMS345.73","2-JTH001.52","2-JTH006.53","2-LIP001.00","2-LMC000.40","2-MFL001.65","2-MIV000.39"],[37.419444444,37.4175,37.411666666,37.833333334,37.609861111,37.385277778,37.369166666,37.649101,37.646609,37.334402778,37.489497,37.792627,37.463344445,37.803104,37.549444445,37.4128,37.5392,37.418055555,37.416666667,37.390277778,37.788613,37.810555556,37.780555555,37.771666667,37.756802,37.761111111,37.767372,37.778333334,37.788611111,37.811111111,37.822691667,37.841944445,37.947311,37.953825,37.977911,38.015102,37.410277778,37.503055556,37.555325,37.580653,37.53,37.548041,37.750444,37.775555556,37.468333334,37.46836,37.633055555,37.515992,37.493363889,37.687777778],[-79.146111111,-79.184444444,-79.187777778,-79.666666666,-78.922638889,-79.211111111,-79.200555556,-79.830992,-79.94895,-80.331186111,-79.2989,-79.759498,-80.348272222,-80.021356,-78.820833334,-80.021,-79.448211111,-79.186111111,-79.225833333,-79.2825,-79.781133,-79.854166667,-79.927777778,-79.966388889,-79.986644,-80.000833333,-79.988733,-79.991111111,-80.000833333,-79.988888889,-79.989366667,-79.989166667,-79.963655,-79.979393,-79.966996,-79.916573,-79.134166667,-79.262222222,-79.367255556,-79.606508,-79.677777778,-79.742523,-79.815703,-79.780833333,-79.21,-79.262711,-79.856388889,-79.7095,-79.62835,-79.806388889],["DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ","DEQ"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>FDT_STA_ID<\/th>\n      <th>Latitude<\/th>\n      <th>Longitude<\/th>\n      <th>Data_Source<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"dom":"lftip","pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":[1,2]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
<p>This process is repeated for all datasets that have data included in the assessment window. These multiple datasets are combined into a single object named distinctSites that we will then compare to existing WQS and AU information. Where stations in our distinctSites object lack either of these pieces of metadata, we must attribute them.</p>
</div>
<div id="join-assessment-region-and-subbasin-information" class="section level3" number="3.1.2">
<h3><span class="header-section-number">3.1.2</span> Join Assessment Region and Subbasin Information</h3>
<p>For rendering purposes in the metadata review application, it is important to have each station linked to the appropriate Assessment Region and Subbasin to limit the amount of data called into the application just to essential information. This information is also important for processing each region through a loop for AU connection and WQS attachment. Subbasin information is important for WQS processing. The next chunk reads in the necessary assessment region and subbasin spatial data and spatially joins all sites to these layers. If the sites are missing from the distinctSites_sf object, that means the point plots outside either the assessment region or subbasin polygon. These missingSites are dealt with individually and forced to join to the nearest assessment region and subbasin before rejoining the distinctSites_sf object.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="metadata-attribution.html#cb8-1" aria-hidden="true" tabindex="-1"></a>assessmentLayer <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;GIS/AssessmentRegions_VA84_basins.shp&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="metadata-attribution.html#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>( <span class="fu">st_crs</span>(<span class="dv">4326</span>)) <span class="co"># transform to WQS84 for spatial intersection</span></span>
<span id="cb8-3"><a href="metadata-attribution.html#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="metadata-attribution.html#cb8-4" aria-hidden="true" tabindex="-1"></a>subbasinLayer <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;GIS/DEQ_VAHUSB_subbasins_EVJ.shp&#39;</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="metadata-attribution.html#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="st">&#39;SUBBASIN&#39;</span> <span class="ot">=</span> <span class="st">&#39;SUBBASIN_1&#39;</span>)</span>
<span id="cb8-6"><a href="metadata-attribution.html#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="metadata-attribution.html#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="metadata-attribution.html#cb8-8" aria-hidden="true" tabindex="-1"></a>distinctSites_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(distinctSites,</span>
<span id="cb8-9"><a href="metadata-attribution.html#cb8-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;Longitude&quot;</span>, <span class="st">&quot;Latitude&quot;</span>),  <span class="co"># make spatial layer using these columns</span></span>
<span id="cb8-10"><a href="metadata-attribution.html#cb8-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">remove =</span> F, <span class="co"># don&#39;t remove these lat/lon cols from df</span></span>
<span id="cb8-11"><a href="metadata-attribution.html#cb8-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="co"># add coordinate reference system, needs to be geographic for now bc entering lat/lng, </span></span>
<span id="cb8-12"><a href="metadata-attribution.html#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersection</span>(assessmentLayer ) <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="metadata-attribution.html#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(subbasinLayer, BASIN_NAME, BASIN_CODE, SUBBASIN), <span class="at">join =</span> st_intersects) </span>
<span id="cb8-14"><a href="metadata-attribution.html#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="metadata-attribution.html#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># if any joining issues occur, that means that there are stations that fall outside the joined polygon area</span></span>
<span id="cb8-16"><a href="metadata-attribution.html#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># we need to go back in and fix them manually</span></span>
<span id="cb8-17"><a href="metadata-attribution.html#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(distinctSites_sf) <span class="sc">&lt;</span> <span class="fu">nrow</span>(distinctSites)){</span>
<span id="cb8-18"><a href="metadata-attribution.html#cb8-18" aria-hidden="true" tabindex="-1"></a>  missingSites <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSites, <span class="sc">!</span> FDT_STA_ID <span class="sc">%in%</span> distinctSites_sf<span class="sc">$</span>FDT_STA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb8-19"><a href="metadata-attribution.html#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;Longitude&quot;</span>, <span class="st">&quot;Latitude&quot;</span>),  <span class="co"># make spatial layer using these columns</span></span>
<span id="cb8-20"><a href="metadata-attribution.html#cb8-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">remove =</span> F, <span class="co"># don&#39;t remove these lat/lon cols from df</span></span>
<span id="cb8-21"><a href="metadata-attribution.html#cb8-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">crs =</span> <span class="dv">4326</span>) </span>
<span id="cb8-22"><a href="metadata-attribution.html#cb8-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-23"><a href="metadata-attribution.html#cb8-23" aria-hidden="true" tabindex="-1"></a>  closest <span class="ot">&lt;-</span> <span class="fu">mutate</span>(assessmentLayer[<span class="dv">0</span>,], <span class="at">FDT_STA_ID =</span><span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-24"><a href="metadata-attribution.html#cb8-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, <span class="fu">everything</span>())</span>
<span id="cb8-25"><a href="metadata-attribution.html#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(missingSites))){</span>
<span id="cb8-26"><a href="metadata-attribution.html#cb8-26" aria-hidden="true" tabindex="-1"></a>    closest[i,] <span class="ot">&lt;-</span> assessmentLayer[<span class="fu">which.min</span>(<span class="fu">st_distance</span>(assessmentLayer, missingSites[i,])),] <span class="sc">%&gt;%</span></span>
<span id="cb8-27"><a href="metadata-attribution.html#cb8-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">FDT_STA_ID =</span> missingSites[i,]<span class="sc">$</span>FDT_STA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb8-28"><a href="metadata-attribution.html#cb8-28" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, <span class="fu">everything</span>())</span>
<span id="cb8-29"><a href="metadata-attribution.html#cb8-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-30"><a href="metadata-attribution.html#cb8-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-31"><a href="metadata-attribution.html#cb8-31" aria-hidden="true" tabindex="-1"></a>  missingSites <span class="ot">&lt;-</span> <span class="fu">left_join</span>(missingSites, closest <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>(),</span>
<span id="cb8-32"><a href="metadata-attribution.html#cb8-32" aria-hidden="true" tabindex="-1"></a>                            <span class="at">by =</span> <span class="st">&#39;FDT_STA_ID&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="metadata-attribution.html#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(subbasinLayer, BASIN_NAME, BASIN_CODE, SUBBASIN), <span class="at">join =</span> st_intersects) <span class="sc">%&gt;%</span></span>
<span id="cb8-34"><a href="metadata-attribution.html#cb8-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry), geometry) <span class="sc">%&gt;%</span></span>
<span id="cb8-35"><a href="metadata-attribution.html#cb8-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">names</span>(distinctSites_sf))</span>
<span id="cb8-36"><a href="metadata-attribution.html#cb8-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-37"><a href="metadata-attribution.html#cb8-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-38"><a href="metadata-attribution.html#cb8-38" aria-hidden="true" tabindex="-1"></a>  distinctSites_sf <span class="ot">&lt;-</span> <span class="fu">rbind</span>(distinctSites_sf, missingSites)</span>
<span id="cb8-39"><a href="metadata-attribution.html#cb8-39" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="join-stations-to-wqs" class="section level3" number="3.1.3">
<h3><span class="header-section-number">3.1.3</span> Join Stations to WQS</h3>
<p>All stations are then spatially joined to the current WQS spatial layers to link each unique StationID to a unique WQS_ID. These unique WQS_ID’s are a concatination of the waterbody type, basin code (e.g. 2A, 2B, 2C, etc.), and a number associated with each segment in the spatial layer.</p>
<p>Waterbody types include:</p>
<ul>
<li>RL = Riverine Line</li>
<li>LP = Lacustrine Polygon</li>
<li>EL = Estuarine Line</li>
<li>EP = Estuarine Polygon</li>
</ul>
<p>Since transitioning the WQS storage from local (individual assessor files) to a centralized system (on the R server for multiple program uses), the number of stations that require WQS attribution decreases significantly each IR cycle. To attribute each station to WQS information, we first need to do all spatial joins to new WQS layer to get appropriate UID information, then we can send that information to an interactive application for humans to manually verify.</p>
<p>Where WQS_ID information is already available for stations, they are first removed from the WQS snapping process as to not repeat efforts unnecessarily. WQS_ID’s are maintained across WQS layer updates, so any new WQS information will be updated when the stations are joined to the WQS metadata.</p>
<p>You can view the available WQSlookup table stored on the server by using the below script. Please see the <a href="https://rconnect.deq.virginia.gov/MethodsEncyclopedia/connectToConnectPins.html">DEQ R Methods Encyclopedia</a> for information on how to retrieve pinned data from the server.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="metadata-attribution.html#cb9-1" aria-hidden="true" tabindex="-1"></a>WQStableExisting <span class="ot">&lt;-</span> <span class="fu">pin_get</span>(<span class="st">&#39;ejones/WQSlookup&#39;</span>, <span class="at">board =</span> <span class="st">&#39;rsconnect&#39;</span>)</span>
<span id="cb9-2"><a href="metadata-attribution.html#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="metadata-attribution.html#cb9-3" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSites_sf, <span class="sc">!</span> FDT_STA_ID  <span class="sc">%in%</span> WQStableExisting<span class="sc">$</span>StationID)</span></code></pre></div>
<p>Here is the table used to store link information from stations to appropriate WQS.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="metadata-attribution.html#cb10-1" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="cn">NA</span>, <span class="at">WQS_ID =</span> <span class="cn">NA</span>)</span></code></pre></div>
</div>
<div id="spatially-join-polygons" class="section level3" number="3.1.4">
<h3><span class="header-section-number">3.1.4</span> Spatially Join Polygons</h3>
<p>Since it is much faster to look for spatial joins by polygons compared to snapping to lines, we will run spatial joins by estuarine polys and reservoir layers first.</p>
<div id="estuarine-polygons" class="section level5" number="3.1.4.0.1">
<h5><span class="header-section-number">3.1.4.0.1</span> Estuarine Polygons</h5>
<p>Here we find any sites that fall into an estuary WQS polygon. This method is only applied to subbasins that intersect estuarine areas. This process also removes any estuarine sites from the data frame of unique sites that need WQS information (distinctSitesToDoWQS).</p>
<p>We will bring in (source) a custom function that runs the analysis for us, feed it our latest WQS information, and let the function run across all input stations. You can see the latest version of the sourced script in <a href="https://github.com/EmmaVJones/IR2024/tree/main/1.preprocessData">this repository.</a></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="metadata-attribution.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;preprocessingModules/WQS_estuaryPoly.R&#39;</span>)</span>
<span id="cb11-2"><a href="metadata-attribution.html#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="metadata-attribution.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Bring in estuary layer</span></span>
<span id="cb11-4"><a href="metadata-attribution.html#cb11-4" aria-hidden="true" tabindex="-1"></a>estuarinePolys <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;../GIS/draft_WQS_shapefiles_2022/estuarinepolygons_draft2022.shp&#39;</span>, </span>
<span id="cb11-5"><a href="metadata-attribution.html#cb11-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fid_column_name =</span> <span class="st">&quot;OBJECTID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="metadata-attribution.html#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb11-7"><a href="metadata-attribution.html#cb11-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="metadata-attribution.html#cb11-8" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">estuaryPolygonJoin</span>(estuarinePolys, distinctSitesToDoWQS, WQStable)</span>
<span id="cb11-9"><a href="metadata-attribution.html#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="metadata-attribution.html#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(estuarinePolys) <span class="co"># clean up workspace</span></span></code></pre></div>
<p>Remove stations that fell inside estuarine polygons from the ‘to do’ list.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="metadata-attribution.html#cb12-1" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSitesToDoWQS, <span class="sc">!</span> FDT_STA_ID <span class="sc">%in%</span> WQStable<span class="sc">$</span>StationID)</span></code></pre></div>
</div>
<div id="lake-polygons" class="section level5" number="3.1.4.0.2">
<h5><span class="header-section-number">3.1.4.0.2</span> Lake Polygons</h5>
<p>Next find any sites that fall into a lake WQS polygon. This method is applied to all subbasins at once as it is a simple spatial join. You can see the latest version of the sourced script in <a href="https://github.com/EmmaVJones/IR2024/tree/main/1.preprocessData">this repository.</a></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="metadata-attribution.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;preprocessingModules/WQS_lakePoly.R&#39;</span>)</span>
<span id="cb13-2"><a href="metadata-attribution.html#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="metadata-attribution.html#cb13-3" aria-hidden="true" tabindex="-1"></a>lakesPoly <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;../GIS/draft_WQS_shapefiles_2022/lakes_reservoirs_draft2022.shp&#39;</span>,</span>
<span id="cb13-4"><a href="metadata-attribution.html#cb13-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">fid_column_name =</span> <span class="st">&quot;OBJECTID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="metadata-attribution.html#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb13-6"><a href="metadata-attribution.html#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="metadata-attribution.html#cb13-7" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">lakePolygonJoin</span>(lakesPoly, distinctSitesToDoWQS, WQStable)</span>
<span id="cb13-8"><a href="metadata-attribution.html#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="metadata-attribution.html#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(lakesPoly) <span class="co"># clean up workspace</span></span></code></pre></div>
<p>Remove stations that fell inside lake polygons from the ‘to do’ list.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="metadata-attribution.html#cb14-1" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSitesToDoWQS, <span class="sc">!</span> FDT_STA_ID <span class="sc">%in%</span> WQStable<span class="sc">$</span>StationID)</span></code></pre></div>
</div>
</div>
<div id="spatially-join-wqs-lines" class="section level3" number="3.1.5">
<h3><span class="header-section-number">3.1.5</span> Spatially Join WQS Lines</h3>
<p>Now on to the more computationally heavy WQS line snapping methods. First we will try to attach riverine WQS and where stations remain we will try the estuarine WQS snap.</p>
<div id="riverine-lines" class="section level5" number="3.1.5.0.1">
<h5><span class="header-section-number">3.1.5.0.1</span> Riverine Lines</h5>
<p>To do this join, we will buffer all sites that don’t fall into a polygon layer by a set sequence of distances. The output will add a field called <code>Buffer Distance</code> to the WQStable to indicate distance required for snapping. If more than one segment is found within a set buffer distance, then many rows will be attached to the WQStable with the single identifying station name. It is up to the QA tool to help the user determine which of these UID’s are correct and drop the other records.</p>
<p>We then remove any riverine sites from the data frame of unique sites that need WQS information (distinctSitesToDoWQS).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="metadata-attribution.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;snappingFunctions/snapWQS.R&#39;</span>)</span>
<span id="cb15-2"><a href="metadata-attribution.html#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="metadata-attribution.html#cb15-3" aria-hidden="true" tabindex="-1"></a>riverine <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;../GIS/draft_WQS_shapefiles_2022/riverine_draft2022.shp&#39;</span>,</span>
<span id="cb15-4"><a href="metadata-attribution.html#cb15-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fid_column_name =</span> <span class="st">&quot;OBJECTID&quot;</span>) </span>
<span id="cb15-5"><a href="metadata-attribution.html#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="metadata-attribution.html#cb15-6" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">snapAndOrganizeWQS</span>(distinctSitesToDoWQS, <span class="st">&#39;FDT_STA_ID&#39;</span>, riverine, </span>
<span id="cb15-7"><a href="metadata-attribution.html#cb15-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bufferDistances =</span> <span class="fu">seq</span>(<span class="dv">20</span>,<span class="dv">80</span>,<span class="at">by=</span><span class="dv">20</span>),  <span class="co"># buffering by 20m from 20 - 80 meters</span></span>
<span id="cb15-8"><a href="metadata-attribution.html#cb15-8" aria-hidden="true" tabindex="-1"></a>                               WQStable)</span>
<span id="cb15-9"><a href="metadata-attribution.html#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(riverine) <span class="co"># clean up workspace</span></span></code></pre></div>
<p>Remove stations that attached to riverine segments from the ‘to do’ list.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="metadata-attribution.html#cb16-1" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSitesToDoWQS, <span class="sc">!</span> FDT_STA_ID <span class="sc">%in%</span> WQStable<span class="sc">$</span>StationID)</span></code></pre></div>
<p>We can use this one last opportunity to test stations that didn’t connect to the riverine WQS against the estuarine lines WQS as a one last hope of attributing some WQS information. We will take all stations from the WQStable that didn’t snap to any WQS segments (<code>Buffer Distance</code> ==‘No connections within 80 m’) and add those back in to our distinctSitesToDoWQS list to try to snap them to the estuarine lines spatial data.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="metadata-attribution.html#cb17-1" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(WQStable, <span class="st">`</span><span class="at">Buffer Distance</span><span class="st">`</span> <span class="sc">==</span><span class="st">&#39;No connections within 80 m&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="metadata-attribution.html#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(distinctSites_sf, FDT_STA_ID, Latitude, Longitude, SUBBASIN) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="metadata-attribution.html#cb17-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">rename</span>(<span class="st">&#39;StationID&#39;</span><span class="ot">=</span> <span class="st">&#39;FDT_STA_ID&#39;</span>), <span class="at">by=</span><span class="st">&#39;StationID&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="metadata-attribution.html#cb17-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="metadata-attribution.html#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;Longitude&quot;</span>, <span class="st">&quot;Latitude&quot;</span>),  <span class="co"># make spatial layer using these columns</span></span>
<span id="cb17-6"><a href="metadata-attribution.html#cb17-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">remove =</span> T, <span class="co"># don&#39;t remove these lat/lon cols from df</span></span>
<span id="cb17-7"><a href="metadata-attribution.html#cb17-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">crs =</span> <span class="dv">4326</span>)</span></code></pre></div>
</div>
<div id="estuarine-lines" class="section level5" number="3.1.5.0.2">
<h5><span class="header-section-number">3.1.5.0.2</span> Estuarine Lines</h5>
<p>If a site doesn’t attach to a riverine segment, our last step is to try to attach estuary line segments before throwing an empty site to the users for the wild west of manual QA. Only send sites that could be in estuarine subbasin to this function to not waste time.
Removes any estuary lines sites from the data frame of unique sites that need WQS information.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="metadata-attribution.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&#39;snappingFunctions/snapWQS.R&#39;</span>)</span>
<span id="cb18-2"><a href="metadata-attribution.html#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="metadata-attribution.html#cb18-3" aria-hidden="true" tabindex="-1"></a>estuarineLines <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&#39;../GIS/draft_WQS_shapefiles_2022/estuarinelines_draft2022.shp&#39;</span> , <span class="at">fid_column_name =</span> <span class="st">&quot;OBJECTID&quot;</span>) <span class="co">#%&gt;%</span></span>
<span id="cb18-4"><a href="metadata-attribution.html#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#st_transform(102003) # forcing to albers from start bc such a huge layer</span></span>
<span id="cb18-5"><a href="metadata-attribution.html#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#st_transform(4326)</span></span>
<span id="cb18-6"><a href="metadata-attribution.html#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="metadata-attribution.html#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Only send sites to function that could be in estuarine environment</span></span>
<span id="cb18-8"><a href="metadata-attribution.html#cb18-8" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">snapAndOrganizeWQS</span>(<span class="fu">filter</span>(distinctSitesToDoWQS, SUBBASIN <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Potomac River&quot;</span>,</span>
<span id="cb18-9"><a href="metadata-attribution.html#cb18-9" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Rappahannock River&quot;</span>, </span>
<span id="cb18-10"><a href="metadata-attribution.html#cb18-10" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Atlantic Ocean Coastal&quot;</span>,</span>
<span id="cb18-11"><a href="metadata-attribution.html#cb18-11" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Chesapeake Bay Tributaries&quot;</span>,</span>
<span id="cb18-12"><a href="metadata-attribution.html#cb18-12" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Chesapeake Bay - Mainstem&quot;</span>,</span>
<span id="cb18-13"><a href="metadata-attribution.html#cb18-13" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;James River - Lower&quot;</span>,  </span>
<span id="cb18-14"><a href="metadata-attribution.html#cb18-14" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Appomattox River&quot;</span>,</span>
<span id="cb18-15"><a href="metadata-attribution.html#cb18-15" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Chowan River&quot;</span>, </span>
<span id="cb18-16"><a href="metadata-attribution.html#cb18-16" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Atlantic Ocean - South&quot;</span> ,</span>
<span id="cb18-17"><a href="metadata-attribution.html#cb18-17" aria-hidden="true" tabindex="-1"></a>                                                                            <span class="st">&quot;Dismal Swamp/Albemarle Sound&quot;</span>)),</span>
<span id="cb18-18"><a href="metadata-attribution.html#cb18-18" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;StationID&#39;</span>, estuarineLines, </span>
<span id="cb18-19"><a href="metadata-attribution.html#cb18-19" aria-hidden="true" tabindex="-1"></a>                               <span class="at">bufferDistances =</span> <span class="fu">seq</span>(<span class="dv">20</span>,<span class="dv">80</span>,<span class="at">by=</span><span class="dv">20</span>),  <span class="co"># buffering by 20m from 20 - 80 meters</span></span>
<span id="cb18-20"><a href="metadata-attribution.html#cb18-20" aria-hidden="true" tabindex="-1"></a>                               WQStable)</span>
<span id="cb18-21"><a href="metadata-attribution.html#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="metadata-attribution.html#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(estuarineLines)</span></code></pre></div>
<p>Remove stations that attached to estuarine segments from the ‘to do’ list.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="metadata-attribution.html#cb19-1" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSitesToDoWQS, <span class="sc">!</span> StationID <span class="sc">%in%</span> WQStable<span class="sc">$</span>StationID)</span></code></pre></div>
<p>Double check no stations were lost in these processes.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="metadata-attribution.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Make sure all stations from original distinct station list have some sort of record (blank or populated) int the WQStable.</span></span>
<span id="cb20-2"><a href="metadata-attribution.html#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="metadata-attribution.html#cb20-3" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS <span class="ot">&lt;-</span> <span class="fu">filter</span>(distinctSitesToDo, <span class="sc">!</span> FDT_STA_ID  <span class="sc">%in%</span> WQStableExisting<span class="sc">$</span>StationID)</span>
<span id="cb20-4"><a href="metadata-attribution.html#cb20-4" aria-hidden="true" tabindex="-1"></a>distinctSitesToDoWQS<span class="sc">$</span>FDT_STA_ID[<span class="sc">!</span>(distinctSitesToDoWQS<span class="sc">$</span>FDT_STA_ID <span class="sc">%in%</span> <span class="fu">unique</span>(WQStable<span class="sc">$</span>StationID))]</span></code></pre></div>
</div>
</div>
<div id="assign-something-to-wqs_id-so-sites-will-not-fall-through-the-cracks-when-application-filtering-occurs" class="section level3" number="3.1.6">
<h3><span class="header-section-number">3.1.6</span> Assign something to WQS_ID so sites will not fall through the cracks when application filtering occurs</h3>
<p>We don’t want to give everyone all the stations that didn’t snap to something, so we need to at least partially assign a WQS_ID so the stations get into the correct subbasin on initial filter.</p>
<p>If a station snapped to nothing, we will assigning it a RL WQS_ID and subbasin it falls into by default.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="metadata-attribution.html#cb21-1" aria-hidden="true" tabindex="-1"></a>WQStableMissing <span class="ot">&lt;-</span> <span class="fu">filter</span>(WQStable, <span class="fu">is.na</span>(WQS_ID)) <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="metadata-attribution.html#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop from list if actually fixed by snap to another segment</span></span>
<span id="cb21-3"><a href="metadata-attribution.html#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> StationID <span class="sc">%in%</span> <span class="fu">filter</span>(WQStable, <span class="fu">str_extract</span>(WQS_ID, <span class="st">&quot;^.{2}&quot;</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;EL&#39;</span>,<span class="st">&#39;LP&#39;</span>,<span class="st">&#39;EP&#39;</span>))<span class="sc">$</span>StationID) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="metadata-attribution.html#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(distinctSites_sf, FDT_STA_ID, BASIN_CODE) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="metadata-attribution.html#cb21-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">st_drop_geometry</span>(), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;StationID&#39;</span> <span class="ot">=</span> <span class="st">&#39;FDT_STA_ID&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="metadata-attribution.html#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># some fixes for missing basin codes so they will match proper naming conventions for filtering</span></span>
<span id="cb21-7"><a href="metadata-attribution.html#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BASIN_CODE1 =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(BASIN_CODE) <span class="sc">~</span> <span class="fu">str_pad</span>(</span>
<span id="cb21-8"><a href="metadata-attribution.html#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">&#39;-&#39;</span>, <span class="fu">str_extract</span>(StationID, <span class="st">&quot;^.{2}&quot;</span>)), <span class="fu">str_extract</span>(StationID, <span class="st">&quot;^.{1}&quot;</span>), <span class="fu">str_extract</span>(StationID, <span class="st">&quot;^.{2}&quot;</span>)), </span>
<span id="cb21-9"><a href="metadata-attribution.html#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="dv">2</span>, <span class="at">side =</span> <span class="st">&#39;left&#39;</span>, <span class="at">pad =</span> <span class="st">&#39;0&#39;</span>),</span>
<span id="cb21-10"><a href="metadata-attribution.html#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.character</span>(BASIN_CODE)),</span>
<span id="cb21-11"><a href="metadata-attribution.html#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">BASIN_CODE2 =</span> <span class="fu">str_pad</span>(BASIN_CODE1, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">side =</span> <span class="st">&#39;left&#39;</span>, <span class="at">pad =</span> <span class="st">&#39;0&#39;</span>),</span>
<span id="cb21-12"><a href="metadata-attribution.html#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">WQS_ID =</span> <span class="fu">paste0</span>(<span class="st">&#39;RL_&#39;</span>, BASIN_CODE2,<span class="st">&#39;_NA&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="metadata-attribution.html#cb21-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(BASIN_CODE, BASIN_CODE1, BASIN_CODE2))</span>
<span id="cb21-14"><a href="metadata-attribution.html#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="metadata-attribution.html#cb21-15" aria-hidden="true" tabindex="-1"></a>WQStable <span class="ot">&lt;-</span> <span class="fu">filter</span>(WQStable, <span class="sc">!</span><span class="fu">is.na</span>(WQS_ID)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-16"><a href="metadata-attribution.html#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span> StationID <span class="sc">%in%</span> WQStableMissing<span class="sc">$</span>StationID) <span class="sc">%&gt;%</span></span>
<span id="cb21-17"><a href="metadata-attribution.html#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(WQStableMissing)</span></code></pre></div>
</div>
<div id="join-stations-to-aus" class="section level3" number="3.1.7">
<h3><span class="header-section-number">3.1.7</span> Join Stations to AUs</h3>
</div>
<div id="where-does-this-information-go" class="section level3" number="3.1.8">
<h3><span class="header-section-number">3.1.8</span> Where does this information go?</h3>
<p>The above analyses help populate the <a href="https://rconnect.deq.virginia.gov/RegionalAssessmentMetadataValidation/">Regional Metadata Validation Tool</a>. After assessors manually review each station that requires WQS/AU information, this data is consolidated and stored on the R server as a pinned dataset (see <a href=""></a> for details on that process). That dataset feeds subsequent tools including the <a href="https://rconnect.deq.virginia.gov/IR2022riverineAssessmentApplication/">Riverine Assessment App</a>, <a href="https://rconnect.deq.virginia.gov/IR2022LakesAssessmentApp/">Lakes Assessment App</a>, and <a href="https://rconnect.deq.virginia.gov/IR2022BioassessmentDashboard/">Bioassessment Dashboard</a> in addition to querying tools including the <a href="https://rconnect.deq.virginia.gov/CEDSWQMDataQueryTool/">CEDS WQM Data Query Tool</a> and <a href="https://rconnect.deq.virginia.gov/CEDSBenthicDataQueryTool/">CEDS Benthic Data Query Tool</a>. The data is provided via the internal GIS services in the WQM Stations (All stations with full attributes) layer hosted on the <a href="https://gis.deq.virginia.gov/arcgis/rest/services/staff/DEQInternalDataViewer/MapServer/104">GIS REST service</a> and <a href="https://gis.deq.virginia.gov/GISStaffApplication/">GIS Staff Application</a>. In addition to the published tools that source this data, the dataset is included in countless data analysis projects and products. The entire dataset may be pulled from the R Connect service using the following script. Please see the <a href="https://rconnect.deq.virginia.gov/MethodsEncyclopedia/connectToConnectPins.html">DEQ R Methods Encyclopedia</a> for information on how to retrieve pinned data from the server.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="metadata-attribution.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pin_get</span>(<span class="st">&#39;ejones/WQSlookup&#39;</span>, <span class="at">board =</span> <span class="st">&#39;rsconnect&#39;</span>) <span class="co"># raw lookup table</span></span>
<span id="cb22-2"><a href="metadata-attribution.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pin_get</span>(<span class="st">&quot;ejones/WQSlookup-withStandards&quot;</span>, <span class="at">board =</span> <span class="st">&quot;rsconnect&quot;</span>) <span class="co"># lookup table with WQS information joined </span></span></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="automated-assessment-methods.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="organize-metadata.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": null
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["series.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
