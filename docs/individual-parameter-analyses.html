<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>3.5 Individual Parameter Analyses | DEQ Water Quality Automated Assessment User Guide</title>
  <meta name="description" content="A companion document describing the WQA automated assessment methodology." />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="3.5 Individual Parameter Analyses | DEQ Water Quality Automated Assessment User Guide" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A companion document describing the WQA automated assessment methodology." />
  <meta name="github-repo" content="openscapes/series" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="3.5 Individual Parameter Analyses | DEQ Water Quality Automated Assessment User Guide" />
  
  <meta name="twitter:description" content="A companion document describing the WQA automated assessment methodology." />
  

<meta name="author" content="DEQ Automated Assessment Team" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="automated-assessment-analysis.html"/>
<link rel="next" href="automated-output.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.13/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="assets/book.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="lib/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="lib/css/style.css" type="text/css" />
<link rel="stylesheet" href="lib/css/lesson.css" type="text/css" />
<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">DEQ Water Quality Automated Assessment User Manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="HowToUseDocument.html"><a href="HowToUseDocument.html"><i class="fa fa-check"></i><b>1.1</b> How to Use Document</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="HowToUseDocument.html"><a href="HowToUseDocument.html#ProgrammingExpectations"><i class="fa fa-check"></i><b>1.1.1</b> Programming Expectations</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="ProjectHistory.html"><a href="ProjectHistory.html"><i class="fa fa-check"></i><b>1.2</b> Project History</a></li>
<li class="chapter" data-level="1.3" data-path="wqa-technical-support-team.html"><a href="wqa-technical-support-team.html"><i class="fa fa-check"></i><b>1.3</b> WQA Technical Support Team</a></li>
<li class="chapter" data-level="1.4" data-path="Acknowledgements.html"><a href="Acknowledgements.html"><i class="fa fa-check"></i><b>1.4</b> Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-organization.html"><a href="data-organization.html"><i class="fa fa-check"></i><b>2</b> Data Organization</a>
<ul>
<li class="chapter" data-level="2.1" data-path="conventionals-data.html"><a href="conventionals-data.html"><i class="fa fa-check"></i><b>2.1</b> Conventionals Data</a></li>
<li class="chapter" data-level="2.2" data-path="water-column-metals.html"><a href="water-column-metals.html"><i class="fa fa-check"></i><b>2.2</b> Water Column Metals</a></li>
<li class="chapter" data-level="2.3" data-path="sediment-metals.html"><a href="sediment-metals.html"><i class="fa fa-check"></i><b>2.3</b> Sediment Metals</a></li>
<li class="chapter" data-level="2.4" data-path="fish-tissue-data.html"><a href="fish-tissue-data.html"><i class="fa fa-check"></i><b>2.4</b> Fish Tissue Data</a></li>
<li class="chapter" data-level="2.5" data-path="pcb-data.html"><a href="pcb-data.html"><i class="fa fa-check"></i><b>2.5</b> PCB Data</a></li>
<li class="chapter" data-level="2.6" data-path="vdh-data.html"><a href="vdh-data.html"><i class="fa fa-check"></i><b>2.6</b> VDH Data</a></li>
<li class="chapter" data-level="2.7" data-path="citizen-monitoring-data.html"><a href="citizen-monitoring-data.html"><i class="fa fa-check"></i><b>2.7</b> Citizen Monitoring Data</a></li>
<li class="chapter" data-level="2.8" data-path="station-metadata.html"><a href="station-metadata.html"><i class="fa fa-check"></i><b>2.8</b> Station Metadata</a></li>
<li class="chapter" data-level="2.9" data-path="low-flow-7q10-data.html"><a href="low-flow-7q10-data.html"><i class="fa fa-check"></i><b>2.9</b> Low Flow (7Q10) Data</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="low-flow-7q10-data.html"><a href="low-flow-7q10-data.html#q10-method"><i class="fa fa-check"></i><b>2.9.1</b> 7Q10 Method</a></li>
<li class="chapter" data-level="2.9.2" data-path="low-flow-7q10-data.html"><a href="low-flow-7q10-data.html#usgs-site-data-gathering"><i class="fa fa-check"></i><b>2.9.2</b> USGS Site Data Gathering</a></li>
<li class="chapter" data-level="2.9.3" data-path="low-flow-7q10-data.html"><a href="low-flow-7q10-data.html#important-7q10-calculation-notes"><i class="fa fa-check"></i><b>2.9.3</b> Important 7Q10 Calculation Notes</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="automated-assessment-methods.html"><a href="automated-assessment-methods.html"><i class="fa fa-check"></i><b>3</b> Automated Assessment Methods</a>
<ul>
<li class="chapter" data-level="3.1" data-path="metadata-attribution.html"><a href="metadata-attribution.html"><i class="fa fa-check"></i><b>3.1</b> Metadata Attribution</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="metadata-attribution.html"><a href="metadata-attribution.html#distinct-sites"><i class="fa fa-check"></i><b>3.1.1</b> Distinct Sites</a></li>
<li class="chapter" data-level="3.1.2" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-assessment-region-and-subbasin-information"><i class="fa fa-check"></i><b>3.1.2</b> Join Assessment Region and Subbasin Information</a></li>
<li class="chapter" data-level="3.1.3" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-stations-to-wqs"><i class="fa fa-check"></i><b>3.1.3</b> Join Stations to WQS</a></li>
<li class="chapter" data-level="3.1.4" data-path="metadata-attribution.html"><a href="metadata-attribution.html#join-stations-to-aus"><i class="fa fa-check"></i><b>3.1.4</b> Join Stations to AUs</a></li>
<li class="chapter" data-level="3.1.5" data-path="metadata-attribution.html"><a href="metadata-attribution.html#where-does-this-information-go"><i class="fa fa-check"></i><b>3.1.5</b> Where does this information go?</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="organize-metadata.html"><a href="organize-metadata.html"><i class="fa fa-check"></i><b>3.2</b> Organize Metadata</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="organize-metadata.html"><a href="organize-metadata.html#reorganize-conventionals-dataset"><i class="fa fa-check"></i><b>3.2.1</b> Reorganize Conventionals Dataset</a></li>
<li class="chapter" data-level="3.2.2" data-path="organize-metadata.html"><a href="organize-metadata.html#adding-secchi-depth-to-conventionals-dataset"><i class="fa fa-check"></i><b>3.2.2</b> Adding Secchi Depth to conventionals dataset</a></li>
<li class="chapter" data-level="3.2.3" data-path="organize-metadata.html"><a href="organize-metadata.html#add-citizen-monitoring-data-to-conventionals"><i class="fa fa-check"></i><b>3.2.3</b> Add Citizen Monitoring Data to conventionals</a></li>
<li class="chapter" data-level="3.2.4" data-path="organize-metadata.html"><a href="organize-metadata.html#ensure-all-stations-have-necessary-wqs-and-au-information"><i class="fa fa-check"></i><b>3.2.4</b> Ensure all stations have necessary WQS and AU information</a></li>
<li class="chapter" data-level="3.2.5" data-path="organize-metadata.html"><a href="organize-metadata.html#clean-up-pcb-dataset"><i class="fa fa-check"></i><b>3.2.5</b> Clean up PCB dataset</a></li>
<li class="chapter" data-level="3.2.6" data-path="organize-metadata.html"><a href="organize-metadata.html#clean-up-fish-tissue-dataset"><i class="fa fa-check"></i><b>3.2.6</b> Clean up Fish Tissue dataset</a></li>
<li class="chapter" data-level="3.2.7" data-path="organize-metadata.html"><a href="organize-metadata.html#pin-official-clean-ir-data-to-r-server"><i class="fa fa-check"></i><b>3.2.7</b> Pin Official Clean IR data to R server</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="automated-assessment.html"><a href="automated-assessment.html"><i class="fa fa-check"></i><b>3.3</b> Automated Assessment</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="automated-assessment.html"><a href="automated-assessment.html#bring-in-required-datasets"><i class="fa fa-check"></i><b>3.3.1</b> Bring in required datasets</a></li>
<li class="chapter" data-level="3.3.2" data-path="automated-assessment.html"><a href="automated-assessment.html#attach-wqs-information"><i class="fa fa-check"></i><b>3.3.2</b> Attach WQS information</a></li>
<li class="chapter" data-level="3.3.3" data-path="automated-assessment.html"><a href="automated-assessment.html#identify-station-type"><i class="fa fa-check"></i><b>3.3.3</b> Identify Station Type</a></li>
<li class="chapter" data-level="3.3.4" data-path="automated-assessment.html"><a href="automated-assessment.html#bring-in-low-flow-information"><i class="fa fa-check"></i><b>3.3.4</b> Bring in Low Flow Information</a></li>
<li class="chapter" data-level="3.3.5" data-path="automated-assessment.html"><a href="automated-assessment.html#metals-reoganization"><i class="fa fa-check"></i><b>3.3.5</b> Metals Reoganization</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="automated-assessment-analysis.html"><a href="automated-assessment-analysis.html"><i class="fa fa-check"></i><b>3.4</b> Automated Assessment Analysis</a></li>
<li class="chapter" data-level="3.5" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html"><i class="fa fa-check"></i><b>3.5</b> Individual Parameter Analyses</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#how-to-test-individual-parameter-functions"><i class="fa fa-check"></i><b>3.5.1</b> How to Test Individual Parameter Functions</a></li>
<li class="chapter" data-level="3.5.2" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#temperature"><i class="fa fa-check"></i><b>3.5.2</b> Temperature</a></li>
<li class="chapter" data-level="3.5.3" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#dissolved-oxygen"><i class="fa fa-check"></i><b>3.5.3</b> Dissolved Oxygen</a></li>
<li class="chapter" data-level="3.5.4" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#ph"><i class="fa fa-check"></i><b>3.5.4</b> pH</a></li>
<li class="chapter" data-level="3.5.5" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#bacteria"><i class="fa fa-check"></i><b>3.5.5</b> Bacteria</a></li>
<li class="chapter" data-level="3.5.6" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#nutrients"><i class="fa fa-check"></i><b>3.5.6</b> Nutrients</a></li>
<li class="chapter" data-level="3.5.7" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#ammonia"><i class="fa fa-check"></i><b>3.5.7</b> Ammonia</a></li>
<li class="chapter" data-level="3.5.8" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#water-column-toxics"><i class="fa fa-check"></i><b>3.5.8</b> Water Column Toxics</a></li>
<li class="chapter" data-level="3.5.9" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#public-water-supply-criteria"><i class="fa fa-check"></i><b>3.5.9</b> Public Water Supply Criteria</a></li>
<li class="chapter" data-level="3.5.10" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#freshwater-chloride"><i class="fa fa-check"></i><b>3.5.10</b> Freshwater Chloride</a></li>
<li class="chapter" data-level="3.5.11" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#pcb"><i class="fa fa-check"></i><b>3.5.11</b> PCB</a></li>
<li class="chapter" data-level="3.5.12" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#water-column-metals-1"><i class="fa fa-check"></i><b>3.5.12</b> Water Column Metals</a></li>
<li class="chapter" data-level="3.5.13" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#fish-tissue"><i class="fa fa-check"></i><b>3.5.13</b> Fish Tissue</a></li>
<li class="chapter" data-level="3.5.14" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#benthics"><i class="fa fa-check"></i><b>3.5.14</b> Benthics</a></li>
<li class="chapter" data-level="3.5.15" data-path="individual-parameter-analyses.html"><a href="individual-parameter-analyses.html#additional-functions"><i class="fa fa-check"></i><b>3.5.15</b> Additional Functions</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="automated-output.html"><a href="automated-output.html"><i class="fa fa-check"></i><b>3.6</b> Automated Output</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="regional-metadata-validation-tool-how-to.html"><a href="regional-metadata-validation-tool-how-to.html"><i class="fa fa-check"></i><b>4</b> Regional Metadata Validation <br>Tool How To</a>
<ul>
<li class="chapter" data-level="4.1" data-path="application-orientation.html"><a href="application-orientation.html"><i class="fa fa-check"></i><b>4.1</b> Application Orientation</a></li>
<li class="chapter" data-level="4.2" data-path="application-use-water-quality-standards-qa-watershed-selection-tab.html"><a href="application-use-water-quality-standards-qa-watershed-selection-tab.html"><i class="fa fa-check"></i><b>4.2</b> Application Use: <br>Water Quality Standards QA- <br>Watershed Selection Tab</a></li>
<li class="chapter" data-level="4.3" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html"><i class="fa fa-check"></i><b>4.3</b> Application Use: <br>Water Quality Standards QA- <br>Manual Review Tab</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#map-orientation"><i class="fa fa-check"></i><b>4.3.1</b> Map Orientation</a></li>
<li class="chapter" data-level="4.3.2" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#what-do-the-buttons-do"><i class="fa fa-check"></i><b>4.3.2</b> What do the buttons do?</a></li>
<li class="chapter" data-level="4.3.3" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation"><i class="fa fa-check"></i><b>4.3.3</b> Application Operation</a></li>
<li class="chapter" data-level="4.3.4" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-1-wqs-segment"><i class="fa fa-check"></i><b>4.3.4</b> Application Operation: <br>Station that Snapped to 1 WQS Segment</a></li>
<li class="chapter" data-level="4.3.5" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-1-wqs-segment-1"><i class="fa fa-check"></i><b>4.3.5</b> Application Operation: <br>Station that Snapped to &gt;1 WQS Segment</a></li>
<li class="chapter" data-level="4.3.6" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-station-that-snapped-to-0-wqs-segments"><i class="fa fa-check"></i><b>4.3.6</b> Application Operation: <br>Station that Snapped to 0 WQS Segments</a></li>
<li class="chapter" data-level="4.3.7" data-path="application-use-water-quality-standards-qa-manual-review-tab.html"><a href="application-use-water-quality-standards-qa-manual-review-tab.html#application-operation-there-are-no-more-stations-to-attribute"><i class="fa fa-check"></i><b>4.3.7</b> Application Operation: <br>There are no more stations to attribute</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="having-problems.html"><a href="having-problems.html"><i class="fa fa-check"></i><b>4.4</b> Having problems?</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="riverine-application-how-to.html"><a href="riverine-application-how-to.html"><i class="fa fa-check"></i><b>5</b> Riverine Application How To</a></li>
<li class="chapter" data-level="6" data-path="lacustrine-application-how-to.html"><a href="lacustrine-application-how-to.html"><i class="fa fa-check"></i><b>6</b> Lacustrine Application How To</a></li>
<li class="chapter" data-level="7" data-path="bioassessment-applications-how-to.html"><a href="bioassessment-applications-how-to.html"><i class="fa fa-check"></i><b>7</b> Bioassessment Applications How To</a>
<ul>
<li class="chapter" data-level="7.1" data-path="general-bioassessment-workflow.html"><a href="general-bioassessment-workflow.html"><i class="fa fa-check"></i><b>7.1</b> General Bioassessment Workflow</a></li>
<li class="chapter" data-level="7.2" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html"><i class="fa fa-check"></i><b>7.2</b> Application Use: Bioassessment Dashboard</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html#map-tab"><i class="fa fa-check"></i><b>7.2.1</b> Map Tab</a></li>
<li class="chapter" data-level="7.2.2" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html#sci-scores-tab"><i class="fa fa-check"></i><b>7.2.2</b> SCI Scores Tab</a></li>
<li class="chapter" data-level="7.2.3" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html#habitat-scores-tab"><i class="fa fa-check"></i><b>7.2.3</b> Habitat Scores Tab</a></li>
<li class="chapter" data-level="7.2.4" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html#station-summary-tab"><i class="fa fa-check"></i><b>7.2.4</b> Station Summary Tab</a></li>
<li class="chapter" data-level="7.2.5" data-path="application-use-bioassessment-dashboard.html"><a href="application-use-bioassessment-dashboard.html#assessment-decision-tab"><i class="fa fa-check"></i><b>7.2.5</b> Assessment Decision Tab</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="application-use-benthic-assessment-fact-sheet-tool.html"><a href="application-use-benthic-assessment-fact-sheet-tool.html"><i class="fa fa-check"></i><b>7.3</b> Application Use: Benthic Assessment Fact Sheet Tool</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="application-use-benthic-assessment-fact-sheet-tool.html"><a href="application-use-benthic-assessment-fact-sheet-tool.html#assessment-fact-sheet-tab"><i class="fa fa-check"></i><b>7.3.1</b> Assessment Fact Sheet Tab</a></li>
<li class="chapter" data-level="7.3.2" data-path="application-use-benthic-assessment-fact-sheet-tool.html"><a href="application-use-benthic-assessment-fact-sheet-tool.html#general-purpose-biological-fact-sheet-tab"><i class="fa fa-check"></i><b>7.3.2</b> General Purpose Biological Fact Sheet Tab</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">DEQ Water Quality Automated Assessment User Guide</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="individual-parameter-analyses" class="section level2" number="3.5">
<h2><span class="header-section-number">3.5</span> Individual Parameter Analyses</h2>
<p>The functions detailed in this section are called in either the <a href="https://github.com/EmmaVJones/IR2024/blob/main/3.automatedAssessment/HowToRunAutomatedAssessmentIR2024.Rmd" target="_blank">automated assessment workflow report</a> or by waterbody-specific shiny applications that unpack the output of the <a href="https://github.com/EmmaVJones/IR2024/blob/main/3.automatedAssessment/HowToRunAutomatedAssessmentIR2024.Rmd" target="_blank">automated assessment workflow report</a>. All of the automated assessment functions are stored in a single .R file that is shared among the waterbody-specific shiny assessment applications and Rmarkdown report to minimize the labor involved in maintaining these critical functions. One day, these functions will be published as an R package, but until then, you can access the latest version of this script <a href="https://github.com/EmmaVJones/IR2024/blob/main/3.automatedAssessment/automatedAssessmentFunctions.R" target="_blank">here</a>.</p>
<div id="how-to-test-individual-parameter-functions" class="section level3" number="3.5.1">
<h3><span class="header-section-number">3.5.1</span> How to Test Individual Parameter Functions</h3>
<p>The following code snippet will allow you to generate the appropriate <code>stationData</code> required for most function arguments. The below snippet will only run if you have run all the required data gathering and manipulation steps identified in the <a href="automated-assessment-analysis.html#automated-assessment-analysis">Automated Assessment Analysis</a> section. The chunk below is set up such that you can easily change test stations by updating your <code>station</code> object.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="individual-parameter-analyses.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># any station included in the stationTable object can be specified here, whether or not there is data for the station</span></span>
<span id="cb79-2"><a href="individual-parameter-analyses.html#cb79-2" aria-hidden="true" tabindex="-1"></a>station <span class="ot">&lt;-</span> <span class="st">&#39;1AACO014.57&#39;</span> <span class="co"># other potential examples: &#39;2-JKS023.61&#39;, &#39;1ABAR037.84&#39;</span></span>
<span id="cb79-3"><a href="individual-parameter-analyses.html#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="individual-parameter-analyses.html#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set up stationData object to run through individual parameter functions</span></span>
<span id="cb79-5"><a href="individual-parameter-analyses.html#cb79-5" aria-hidden="true" tabindex="-1"></a>stationData <span class="ot">&lt;-</span> <span class="fu">filter</span>(conventionals, FDT_STA_ID <span class="sc">%in%</span> station)<span class="sc">%&gt;%</span></span>
<span id="cb79-6"><a href="individual-parameter-analyses.html#cb79-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(stationTable, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span> <span class="ot">=</span> <span class="st">&#39;STATION_ID&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb79-7"><a href="individual-parameter-analyses.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Special Standards Correction step. This is done on the actual data bc some special standards have temporal components</span></span>
<span id="cb79-8"><a href="individual-parameter-analyses.html#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pHSpecialStandardsCorrection</span>() <span class="sc">%&gt;%</span> <span class="co"># correct pH to special standards where necessary</span></span>
<span id="cb79-9"><a href="individual-parameter-analyses.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">temperatureSpecialStandardsCorrection</span>() <span class="sc">%&gt;%</span> <span class="co"># correct temperature special standards where necessary</span></span>
<span id="cb79-10"><a href="individual-parameter-analyses.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># special lake steps</span></span>
<span id="cb79-11"><a href="individual-parameter-analyses.html#cb79-11" aria-hidden="true" tabindex="-1"></a>  {<span class="cf">if</span>(station <span class="sc">%in%</span> lakeStations<span class="sc">$</span>STATION_ID)</span>
<span id="cb79-12"><a href="individual-parameter-analyses.html#cb79-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">suppressWarnings</span>(<span class="fu">suppressMessages</span>(</span>
<span id="cb79-13"><a href="individual-parameter-analyses.html#cb79-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(., <span class="at">lakeStation =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb79-14"><a href="individual-parameter-analyses.html#cb79-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">thermoclineDepth</span>())) <span class="co"># adds thermocline information and SampleDate</span></span>
<span id="cb79-15"><a href="individual-parameter-analyses.html#cb79-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="fu">mutate</span>(., <span class="at">lakeStation =</span> <span class="cn">FALSE</span>) }</span></code></pre></div>
<div id="why-would-you-want-to-test-individual-functions" class="section level4" number="3.5.1.1">
<h4><span class="header-section-number">3.5.1.1</span> Why would you want to test individual functions?</h4>
<p>New for the IR2024 cycle, all data, methods, and results are available for regional assessment staff (or any DEQ staff) to interrogate, for riverine and lacustrine waterbody types and some estuarine methods (stay tuned on improvements on this waterbody type). The agency has been working through technology hurdles to achieve full transparency for assessment processes for a number of years, and while we arenâ€™t fully there yet, we are getting closer. This bookdown is written as an accompanying handbook to all automated assessment processes to decipher the process for beginner R users.</p>
<p>One of the goals of the WQA program is that anyone with access to the assessment data and analytical scripts can run the automated assessment processes and come to the same results. By consistently applying the same rules and logic to assessment data, we can ensure the assessment decisions are universally applied across the state.</p>
<p>Lastly, while we hope the next section containing plain English, narrative descriptions of the automated assessment functions provide sufficient explanation as to what and why analytical steps were taken, should you run into a question, the chunk above and the functions below will allow any user to dig into any function to fully understand each process. We encourage you to investigate these functions in a stepwise manner. Should you run into problems, please reach out to the <a href="#wqa-techical-support-team">WQA Technical Support Team</a>.</p>
</div>
</div>
<div id="temperature" class="section level3" number="3.5.2">
<h3><span class="header-section-number">3.5.2</span> Temperature</h3>
<p>A maximum temperature criteria applies to stations depending on their <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/" target="_blank">associated WQS</a>. The <code>tempExceedances()</code> function identifies any temperature exceedances of the <code>Max Temperature (C)</code> field for each sample provided. The function removes all Level I and Level II data and missing data before rounding measure to even and comparing against the provided criteria. An internal <code>7Q10 Flag</code> is passed through this function for use in the <code>quickStats()</code> function should a user adjust the default <code>drop7Q10</code> argument. Read more about the <code>quickStats()</code> helper function in the <a href="individual-parameter-analyses.html#quickstats" target="_blank">Additional Functions section.</a></p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="individual-parameter-analyses.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Max Temperature Exceedance Function</span></span>
<span id="cb80-2"><a href="individual-parameter-analyses.html#cb80-2" aria-hidden="true" tabindex="-1"></a>tempExceedances <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb80-3"><a href="individual-parameter-analyses.html#cb80-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_DATE_TIME, FDT_DEPTH, tidyselect<span class="sc">::</span><span class="fu">contains</span>(<span class="st">&#39;TEMP_CELCIUS&#39;</span>), <span class="st">`</span><span class="at">Max Temperature (C)</span><span class="st">`</span>, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="sc">%&gt;%</span> <span class="co"># Just get relevant columns </span></span>
<span id="cb80-4"><a href="individual-parameter-analyses.html#cb80-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> (LEVEL_FDT_TEMP_CELCIUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb80-5"><a href="individual-parameter-analyses.html#cb80-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">is.na</span>(FDT_TEMP_CELCIUS)) <span class="sc">%&gt;%</span> <span class="co"># get rid of NA&#39;s</span></span>
<span id="cb80-6"><a href="individual-parameter-analyses.html#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns to make exceedance analyses easier to apply</span></span>
<span id="cb80-7"><a href="individual-parameter-analyses.html#cb80-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">parameter =</span> <span class="sc">!!</span> <span class="fu">names</span>(.[<span class="dv">3</span>]),</span>
<span id="cb80-8"><a href="individual-parameter-analyses.html#cb80-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">limit =</span> <span class="sc">!!</span> <span class="fu">names</span>(.[<span class="dv">6</span>])) <span class="sc">%&gt;%</span> </span>
<span id="cb80-9"><a href="individual-parameter-analyses.html#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply Round to Even Rule before testing for exceedances</span></span>
<span id="cb80-10"><a href="individual-parameter-analyses.html#cb80-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(parameter, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/</span></span>
<span id="cb80-11"><a href="individual-parameter-analyses.html#cb80-11" aria-hidden="true" tabindex="-1"></a>                  <span class="at">exceeds =</span> <span class="fu">case_when</span>(parameterRound <span class="sc">&gt;</span> limit <span class="sc">~</span> <span class="cn">TRUE</span>, <span class="co"># Identify where above max Temperature, </span></span>
<span id="cb80-12"><a href="individual-parameter-analyses.html#cb80-12" aria-hidden="true" tabindex="-1"></a>                                      parameterRound <span class="sc">&lt;=</span> limit <span class="sc">~</span> <span class="cn">FALSE</span>, <span class="co"># no exceedance</span></span>
<span id="cb80-13"><a href="individual-parameter-analyses.html#cb80-13" aria-hidden="true" tabindex="-1"></a>                                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>))</span>
<span id="cb80-14"><a href="individual-parameter-analyses.html#cb80-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-15"><a href="individual-parameter-analyses.html#cb80-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-16"><a href="individual-parameter-analyses.html#cb80-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb80-17"><a href="individual-parameter-analyses.html#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb80-18"><a href="individual-parameter-analyses.html#cb80-18" aria-hidden="true" tabindex="-1"></a><span class="co"># tempExceedances(stationData) </span></span>
<span id="cb80-19"><a href="individual-parameter-analyses.html#cb80-19" aria-hidden="true" tabindex="-1"></a><span class="co"># tempExceedances(stationData) %&gt;%</span></span>
<span id="cb80-20"><a href="individual-parameter-analyses.html#cb80-20" aria-hidden="true" tabindex="-1"></a><span class="co">#  quickStats(&#39;TEMP&#39;) # pass results to quickStats() to consolidate results</span></span></code></pre></div>
</div>
<div id="dissolved-oxygen" class="section level3" number="3.5.3">
<h3><span class="header-section-number">3.5.3</span> Dissolved Oxygen</h3>
<p>There are two general dissolved oxygen (DO) criteria that may apply to stations, depending on their <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/" target="_blank">associated WQS</a>. The minimum DO criteria are evaluated against the provided <code>Dissolved Oxygen Min (mg/L)</code> using the <code>DOExceedances_Min()</code> function. This function handles lake stations differently than other waterbody types. If a station is in a <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section187/" target="_blank">Section 187 lake</a>, then only the epilimnion and unstratified samples are evaluated. Thermocline information is evaluated using the <a href="individual-parameter-analyses.html#thermoclinedepth" target="_blank"><code>thermoclineDepth()</code> function</a> in a previous step.</p>
<p>Regardless of the waterbody type, all Level I and Level II data and missing data are removed before measures are rounded to even and compared against the provided criteria. An internal <code>7Q10 Flag</code> is passed through this function for use in the <code>quickStats()</code> function should a user adjust the default <code>drop7Q10</code> argument. Read more about the <code>quickStats()</code> helper function in the <a href="individual-parameter-analyses.html#quickstats" target="_blank">Additional Functions section.</a></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="individual-parameter-analyses.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum DO Exceedance function</span></span>
<span id="cb81-2"><a href="individual-parameter-analyses.html#cb81-2" aria-hidden="true" tabindex="-1"></a>DOExceedances_Min <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb81-3"><a href="individual-parameter-analyses.html#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># special step for lake stations, remove samples based on lake assessment guidance </span></span>
<span id="cb81-4"><a href="individual-parameter-analyses.html#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb81-5"><a href="individual-parameter-analyses.html#cb81-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B)) <span class="sc">&amp;</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B) <span class="sc">==</span> <span class="st">&#39;y&#39;</span>){</span>
<span id="cb81-6"><a href="individual-parameter-analyses.html#cb81-6" aria-hidden="true" tabindex="-1"></a>      DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(stationData, LakeStratification <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Epilimnion&quot;</span>, <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># only use epilimnion or unstratified samples for analysis</span></span>
<span id="cb81-7"><a href="individual-parameter-analyses.html#cb81-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO, </span>
<span id="cb81-8"><a href="individual-parameter-analyses.html#cb81-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">Dissolved Oxygen Min (mg/L)</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="co"># Just get relevant columns,</span></span>
<span id="cb81-9"><a href="individual-parameter-analyses.html#cb81-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb81-10"><a href="individual-parameter-analyses.html#cb81-10" aria-hidden="true" tabindex="-1"></a>      DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO,</span>
<span id="cb81-11"><a href="individual-parameter-analyses.html#cb81-11" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">Dissolved Oxygen Min (mg/L)</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) }<span class="co"># Just get relevant columns,</span></span>
<span id="cb81-12"><a href="individual-parameter-analyses.html#cb81-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb81-13"><a href="individual-parameter-analyses.html#cb81-13" aria-hidden="true" tabindex="-1"></a>    DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO, </span>
<span id="cb81-14"><a href="individual-parameter-analyses.html#cb81-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Dissolved Oxygen Min (mg/L)</span><span class="st">`</span>, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="co"># Just get relevant columns, </span></span>
<span id="cb81-15"><a href="individual-parameter-analyses.html#cb81-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb81-16"><a href="individual-parameter-analyses.html#cb81-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb81-17"><a href="individual-parameter-analyses.html#cb81-17" aria-hidden="true" tabindex="-1"></a>  DOdata <span class="sc">%&gt;%</span></span>
<span id="cb81-18"><a href="individual-parameter-analyses.html#cb81-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(LEVEL_DO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb81-19"><a href="individual-parameter-analyses.html#cb81-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(DO_mg_L)) <span class="sc">%&gt;%</span> </span>
<span id="cb81-20"><a href="individual-parameter-analyses.html#cb81-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">parameter =</span> <span class="sc">!!</span><span class="fu">names</span>(.[<span class="dv">4</span>]), <span class="at">limit =</span> <span class="sc">!!</span><span class="fu">names</span>(.[<span class="dv">7</span>])) <span class="sc">%&gt;%</span> <span class="co"># rename columns to make functions easier to apply</span></span>
<span id="cb81-21"><a href="individual-parameter-analyses.html#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Round to Even Rule</span></span>
<span id="cb81-22"><a href="individual-parameter-analyses.html#cb81-22" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(parameter, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on  https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/</span></span>
<span id="cb81-23"><a href="individual-parameter-analyses.html#cb81-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">exceeds =</span> <span class="fu">case_when</span>(parameterRound <span class="sc">&lt;</span> limit <span class="sc">~</span> <span class="cn">TRUE</span>, <span class="co"># Identify where below min DO </span></span>
<span id="cb81-24"><a href="individual-parameter-analyses.html#cb81-24" aria-hidden="true" tabindex="-1"></a>                                      parameterRound <span class="sc">&gt;=</span> limit <span class="sc">~</span> <span class="cn">FALSE</span>, <span class="co"># no exceedance</span></span>
<span id="cb81-25"><a href="individual-parameter-analyses.html#cb81-25" aria-hidden="true" tabindex="-1"></a>                                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>))</span>
<span id="cb81-26"><a href="individual-parameter-analyses.html#cb81-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb81-27"><a href="individual-parameter-analyses.html#cb81-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-28"><a href="individual-parameter-analyses.html#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb81-29"><a href="individual-parameter-analyses.html#cb81-29" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb81-30"><a href="individual-parameter-analyses.html#cb81-30" aria-hidden="true" tabindex="-1"></a><span class="co"># DOExceedances_Min(stationData) </span></span>
<span id="cb81-31"><a href="individual-parameter-analyses.html#cb81-31" aria-hidden="true" tabindex="-1"></a><span class="co"># DOExceedances_Min(stationData) %&gt;% </span></span>
<span id="cb81-32"><a href="individual-parameter-analyses.html#cb81-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;DO&#39;) # pass results to quickStats() to consolidate results</span></span></code></pre></div>
<p>A separate function called <code>DO_Assessment_DailyAvg()</code> evaluates whether or not a station exceeds the DO daily average criteria, provided in the <code>Dissolved Oxygen Daily Avg (mg/L)</code> field. This analysis is only run if the number of samples for a station in a given date are greater than one. This function handles lake stations differently than other waterbody types. If a station is in a <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section187/" target="_blank">Section 187 lake</a>, then only the epilimnion and unstratified samples are evaluated. Thermocline information is evaluated using the <a href="individual-parameter-analyses.html#thermoclinedepth" target="_blank"><code>thermoclineDepth()</code> function</a> in a previous step.</p>
<p>Regardless of the waterbody type, all Level I and Level II data and missing data are removed before measures are rounded to even and compared against the provided criteria. An internal <code>7Q10 Flag</code> is passed through this function for use in the <code>quickStats()</code> function should a user adjust the default <code>drop7Q10</code> argument. Read more about the <code>quickStats()</code> helper function in the <a href="individual-parameter-analyses.html#quickstats" target="_blank">Additional Functions section.</a></p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="individual-parameter-analyses.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily Average exceedance function</span></span>
<span id="cb82-2"><a href="individual-parameter-analyses.html#cb82-2" aria-hidden="true" tabindex="-1"></a>DO_Assessment_DailyAvg <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){ </span>
<span id="cb82-3"><a href="individual-parameter-analyses.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># special step for lake stations, remove samples based on lake assessment guidance </span></span>
<span id="cb82-4"><a href="individual-parameter-analyses.html#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb82-5"><a href="individual-parameter-analyses.html#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B)) <span class="sc">&amp;</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B) <span class="sc">==</span> <span class="st">&#39;y&#39;</span>){</span>
<span id="cb82-6"><a href="individual-parameter-analyses.html#cb82-6" aria-hidden="true" tabindex="-1"></a>      DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(stationData, LakeStratification <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Epilimnion&quot;</span>, <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># only use epilimnion or unstratified samples for analysis</span></span>
<span id="cb82-7"><a href="individual-parameter-analyses.html#cb82-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO, </span>
<span id="cb82-8"><a href="individual-parameter-analyses.html#cb82-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">Dissolved Oxygen Daily Avg (mg/L)</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="co"># Just get relevant columns,</span></span>
<span id="cb82-9"><a href="individual-parameter-analyses.html#cb82-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb82-10"><a href="individual-parameter-analyses.html#cb82-10" aria-hidden="true" tabindex="-1"></a>      DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO,</span>
<span id="cb82-11"><a href="individual-parameter-analyses.html#cb82-11" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">Dissolved Oxygen Daily Avg (mg/L)</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) }<span class="co"># Just get relevant columns,</span></span>
<span id="cb82-12"><a href="individual-parameter-analyses.html#cb82-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb82-13"><a href="individual-parameter-analyses.html#cb82-13" aria-hidden="true" tabindex="-1"></a>    DOdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, DO_mg_L, RMK_DO, LEVEL_DO, </span>
<span id="cb82-14"><a href="individual-parameter-analyses.html#cb82-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">Dissolved Oxygen Daily Avg (mg/L)</span><span class="st">`</span>, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="co"># Just get relevant columns, </span></span>
<span id="cb82-15"><a href="individual-parameter-analyses.html#cb82-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb82-16"><a href="individual-parameter-analyses.html#cb82-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-17"><a href="individual-parameter-analyses.html#cb82-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb82-18"><a href="individual-parameter-analyses.html#cb82-18" aria-hidden="true" tabindex="-1"></a>  DOdata <span class="sc">%&gt;%</span> </span>
<span id="cb82-19"><a href="individual-parameter-analyses.html#cb82-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(LEVEL_DO <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb82-20"><a href="individual-parameter-analyses.html#cb82-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(DO_mg_L)) <span class="sc">%&gt;%</span> <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb82-21"><a href="individual-parameter-analyses.html#cb82-21" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(FDT_DATE_TIME, <span class="at">format=</span><span class="st">&quot;%m/%d/%Y&quot;</span>), </span>
<span id="cb82-22"><a href="individual-parameter-analyses.html#cb82-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limit =</span> <span class="st">`</span><span class="at">Dissolved Oxygen Daily Avg (mg/L)</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-23"><a href="individual-parameter-analyses.html#cb82-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb82-24"><a href="individual-parameter-analyses.html#cb82-24" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">n_Samples_Daily =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="co"># how many samples per day?</span></span>
<span id="cb82-25"><a href="individual-parameter-analyses.html#cb82-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(n_Samples_Daily <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-26"><a href="individual-parameter-analyses.html#cb82-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Daily average with average rounded to even</span></span>
<span id="cb82-27"><a href="individual-parameter-analyses.html#cb82-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">DO_DailyAverage =</span> <span class="fu">signif</span>(<span class="fu">mean</span>(DO_mg_L), <span class="at">digits =</span> <span class="dv">2</span>),  <span class="co"># two significant figures based on  https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/</span></span>
<span id="cb82-28"><a href="individual-parameter-analyses.html#cb82-28" aria-hidden="true" tabindex="-1"></a>                  <span class="at">exceeds =</span>  <span class="fu">case_when</span>(DO_DailyAverage <span class="sc">&lt;</span> limit <span class="sc">&amp;</span> <span class="fu">is.na</span>(<span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="sc">~</span> <span class="cn">TRUE</span>, <span class="co"># exceedance if above limit and no 7Q10 Flag</span></span>
<span id="cb82-29"><a href="individual-parameter-analyses.html#cb82-29" aria-hidden="true" tabindex="-1"></a>                                       DO_DailyAverage <span class="sc">&lt;</span> limit <span class="sc">&amp;</span> <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&quot;7Q10 Flag&quot;</span> <span class="sc">~</span> <span class="cn">FALSE</span>,  <span class="co"># exceedance if above limit and 7Q10 Flag</span></span>
<span id="cb82-30"><a href="individual-parameter-analyses.html#cb82-30" aria-hidden="true" tabindex="-1"></a>                                       DO_DailyAverage <span class="sc">&gt;=</span> limit <span class="sc">~</span> <span class="cn">FALSE</span>, <span class="co"># no exceedance</span></span>
<span id="cb82-31"><a href="individual-parameter-analyses.html#cb82-31" aria-hidden="true" tabindex="-1"></a>                                       <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb82-32"><a href="individual-parameter-analyses.html#cb82-32" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#ifelse(DO_DailyAverage &lt; `Dissolved Oxygen Daily Avg (mg/L)`,T,F)) %&gt;% </span></span>
<span id="cb82-33"><a href="individual-parameter-analyses.html#cb82-33" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb82-34"><a href="individual-parameter-analyses.html#cb82-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(date, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb82-35"><a href="individual-parameter-analyses.html#cb82-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(FDT_DATE_TIME)) </span>
<span id="cb82-36"><a href="individual-parameter-analyses.html#cb82-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-37"><a href="individual-parameter-analyses.html#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="individual-parameter-analyses.html#cb82-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb82-39"><a href="individual-parameter-analyses.html#cb82-39" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb82-40"><a href="individual-parameter-analyses.html#cb82-40" aria-hidden="true" tabindex="-1"></a><span class="co"># DO_Assessment_DailyAvg(stationData)</span></span>
<span id="cb82-41"><a href="individual-parameter-analyses.html#cb82-41" aria-hidden="true" tabindex="-1"></a><span class="co"># DO_Assessment_DailyAvg(stationData) %&gt;% </span></span>
<span id="cb82-42"><a href="individual-parameter-analyses.html#cb82-42" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;DO_Daily_Avg&#39;)  # pass results to quickStats() to consolidate results</span></span></code></pre></div>
</div>
<div id="ph" class="section level3" number="3.5.4">
<h3><span class="header-section-number">3.5.4</span> pH</h3>
<p>A pH range criteria applies to stations depending on their <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/" target="_blank">associated WQS</a>. The <code>pHExceedances()</code> function identifies any pH values outside of the range specified in the associated <code>pH Min</code> and <code>pH Max</code> fields. This function handles lake stations differently than other waterbody types. If a station is in a <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section187/" target="_blank">Section 187 lake</a>, then only the epilimnion and unstratified samples are evaluated. Regardless of the waterbody type, the function removes all Level I and Level II data and missing data before rounding measures to even and comparing against the provided criteria. An internal <code>7Q10 Flag</code> is passed through this function for use in the <code>quickStats()</code> function should a user adjust the default <code>drop7Q10</code> argument. Read more about the <code>quickStats()</code> helper function in the <a href="individual-parameter-analyses.html#quickstats" target="_blank">Additional Functions section.</a></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="individual-parameter-analyses.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pH range Exceedance Function</span></span>
<span id="cb83-2"><a href="individual-parameter-analyses.html#cb83-2" aria-hidden="true" tabindex="-1"></a>pHExceedances <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb83-3"><a href="individual-parameter-analyses.html#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># special step for lake stations, remove samples based on lake assessment guidance </span></span>
<span id="cb83-4"><a href="individual-parameter-analyses.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb83-5"><a href="individual-parameter-analyses.html#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B)) <span class="sc">&amp;</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B) <span class="sc">==</span> <span class="st">&#39;y&#39;</span>){</span>
<span id="cb83-6"><a href="individual-parameter-analyses.html#cb83-6" aria-hidden="true" tabindex="-1"></a>      pHdata <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, LakeStratification <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Epilimnion&quot;</span>, <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> <span class="co"># only use epilimnion or unstratified samples for analysis</span></span>
<span id="cb83-7"><a href="individual-parameter-analyses.html#cb83-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, FDT_FIELD_PH, RMK_FDT_FIELD_PH, LEVEL_FDT_FIELD_PH, </span>
<span id="cb83-8"><a href="individual-parameter-analyses.html#cb83-8" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>, <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) <span class="co"># Just get relevant columns,</span></span>
<span id="cb83-9"><a href="individual-parameter-analyses.html#cb83-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb83-10"><a href="individual-parameter-analyses.html#cb83-10" aria-hidden="true" tabindex="-1"></a>      pHdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, FDT_FIELD_PH, RMK_FDT_FIELD_PH, LEVEL_FDT_FIELD_PH,</span>
<span id="cb83-11"><a href="individual-parameter-analyses.html#cb83-11" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>, <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>, LakeStratification, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) }<span class="co"># Just get relevant columns,</span></span>
<span id="cb83-12"><a href="individual-parameter-analyses.html#cb83-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb83-13"><a href="individual-parameter-analyses.html#cb83-13" aria-hidden="true" tabindex="-1"></a>    pHdata <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, FDT_FIELD_PH, RMK_FDT_FIELD_PH, LEVEL_FDT_FIELD_PH, </span>
<span id="cb83-14"><a href="individual-parameter-analyses.html#cb83-14" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>, <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>) }<span class="co"># Just get relevant columns, </span></span>
<span id="cb83-15"><a href="individual-parameter-analyses.html#cb83-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-16"><a href="individual-parameter-analyses.html#cb83-16" aria-hidden="true" tabindex="-1"></a>  pHdata <span class="ot">&lt;-</span> <span class="fu">filter</span>(pHdata, <span class="sc">!</span>(LEVEL_FDT_FIELD_PH <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb83-17"><a href="individual-parameter-analyses.html#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(FDT_FIELD_PH)) <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb83-18"><a href="individual-parameter-analyses.html#cb83-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-19"><a href="individual-parameter-analyses.html#cb83-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># only run analysis if WQS exist for station</span></span>
<span id="cb83-20"><a href="individual-parameter-analyses.html#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(pHdata<span class="sc">$</span><span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>)) <span class="sc">|</span> <span class="fu">any</span>(<span class="fu">is.na</span>(pHdata<span class="sc">$</span><span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>))){</span>
<span id="cb83-21"><a href="individual-parameter-analyses.html#cb83-21" aria-hidden="true" tabindex="-1"></a>      pH <span class="ot">&lt;-</span> <span class="fu">mutate</span>(pHdata, <span class="at">interval =</span> <span class="dv">1</span>, <span class="at">exceeds =</span> <span class="cn">FALSE</span>, <span class="at">limit =</span> <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>) <span class="co"># placeholder to run quickStats() without any WQS</span></span>
<span id="cb83-22"><a href="individual-parameter-analyses.html#cb83-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb83-23"><a href="individual-parameter-analyses.html#cb83-23" aria-hidden="true" tabindex="-1"></a>        pH <span class="ot">&lt;-</span> pHdata <span class="sc">%&gt;%</span></span>
<span id="cb83-24"><a href="individual-parameter-analyses.html#cb83-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb83-25"><a href="individual-parameter-analyses.html#cb83-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Round to Even Rule</span></span>
<span id="cb83-26"><a href="individual-parameter-analyses.html#cb83-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(FDT_FIELD_PH, <span class="at">digits =</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span> <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/</span></span>
<span id="cb83-27"><a href="individual-parameter-analyses.html#cb83-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">interval=</span><span class="fu">findInterval</span>(parameterRound,<span class="fu">c</span>(<span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>,<span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>), <span class="at">left.open=</span><span class="cn">TRUE</span>, <span class="at">rightmost.closed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> <span class="co"># Identify where pH outside of assessment range with round to even</span></span>
<span id="cb83-28"><a href="individual-parameter-analyses.html#cb83-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()<span class="sc">%&gt;%</span></span>
<span id="cb83-29"><a href="individual-parameter-analyses.html#cb83-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">exceeds =</span> <span class="fu">case_when</span>(interval <span class="sc">!=</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">TRUE</span>, <span class="co">#  Highlight where pH doesn&#39;t fall into criteria range</span></span>
<span id="cb83-30"><a href="individual-parameter-analyses.html#cb83-30" aria-hidden="true" tabindex="-1"></a>                                   interval <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">FALSE</span>,  <span class="co"># no exceedance if inside limit</span></span>
<span id="cb83-31"><a href="individual-parameter-analyses.html#cb83-31" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>),</span>
<span id="cb83-32"><a href="individual-parameter-analyses.html#cb83-32" aria-hidden="true" tabindex="-1"></a>               <span class="at">limit =</span> <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>)</span>
<span id="cb83-33"><a href="individual-parameter-analyses.html#cb83-33" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb83-34"><a href="individual-parameter-analyses.html#cb83-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pH)</span>
<span id="cb83-35"><a href="individual-parameter-analyses.html#cb83-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-36"><a href="individual-parameter-analyses.html#cb83-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-37"><a href="individual-parameter-analyses.html#cb83-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb83-38"><a href="individual-parameter-analyses.html#cb83-38" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb83-39"><a href="individual-parameter-analyses.html#cb83-39" aria-hidden="true" tabindex="-1"></a><span class="co"># pHExceedances(stationData) </span></span>
<span id="cb83-40"><a href="individual-parameter-analyses.html#cb83-40" aria-hidden="true" tabindex="-1"></a><span class="co"># pHExceedances(stationData) %&gt;% </span></span>
<span id="cb83-41"><a href="individual-parameter-analyses.html#cb83-41" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;PH&#39;)  # pass results to quickStats() to consolidate results</span></span></code></pre></div>
</div>
<div id="bacteria" class="section level3" number="3.5.5">
<h3><span class="header-section-number">3.5.5</span> Bacteria</h3>
<p><a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section170/" target="_blank">Recreational bacteria</a> is a more complicated standard to apply to monitoring data due to the unique rolling windows. To standardize the logic across <em>E.coli</em> and enterococci data, the nested function architecture that evaluates the bacteria data is programmed to handle either <em>E.coli</em> or enterococci data. The three functions required to calculate the bacteria criteria are detailed below.</p>
<div class="figure">
<img src="images/Bacteria_Fig.png" alt="" />
<p class="caption">bacteriaLogic</p>
</div>
<div id="bacteriaexceedances_new" class="section level4" number="3.5.5.1">
<h4><span class="header-section-number">3.5.5.1</span> bacteriaExceedances_NEW</h4>
<p>The <code>bacteriaExceedances_NEW()</code> function is the innermost function in the nested bacteria function logic. This is the analytical function that applies the bacteria criteria logic. This function takes in all station data, the designated <code>bacteriaField</code> and <code>bacteriaRemark</code> field arguments to tell the function which type of bacteria to assess (<em>E.coli</em> or enterococci), a <code>sampleRequirement</code> argument (minimum n samples in 90 day window needed to apply geomean), a <code>STV</code> argument (threshold for <em>E.coli</em> or enterococci), and a <code>geomeanCriteria</code> argument (threshold for <em>E.coli</em> or enterococci). The function is applied inside the <code>bacteriaAssessmentDecision()</code> function to calculate unique 90 day data windows, apply STV and geomean criteria where appropriate, and report out the results of this analysis for summarization and language standardization by <code>bacteriaAssessmentDecision()</code>. To ease later data visualization steps, a listcolumn named <code>associatedData</code> is included in the function output that contains the raw data that falls within each 90 day window the user can unpack to see all data associated with each 90 day window.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="individual-parameter-analyses.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to assess on 90 day windows across input dataset</span></span>
<span id="cb84-2"><a href="individual-parameter-analyses.html#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># really just a building block, one probably wouldn&#39;t run this function independently</span></span>
<span id="cb84-3"><a href="individual-parameter-analyses.html#cb84-3" aria-hidden="true" tabindex="-1"></a>bacteriaExceedances_NEW <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, <span class="co"># input dataframe with bacteria data</span></span>
<span id="cb84-4"><a href="individual-parameter-analyses.html#cb84-4" aria-hidden="true" tabindex="-1"></a>                                    bacteriaField, <span class="co"># name of bacteria field data</span></span>
<span id="cb84-5"><a href="individual-parameter-analyses.html#cb84-5" aria-hidden="true" tabindex="-1"></a>                                    bacteriaRemark, <span class="co"># name of bacteria comment field</span></span>
<span id="cb84-6"><a href="individual-parameter-analyses.html#cb84-6" aria-hidden="true" tabindex="-1"></a>                                    sampleRequirement, <span class="co"># minimum n samples in 90 day window needed to apply geomean</span></span>
<span id="cb84-7"><a href="individual-parameter-analyses.html#cb84-7" aria-hidden="true" tabindex="-1"></a>                                    STV, <span class="co"># unique for ecoli/enter</span></span>
<span id="cb84-8"><a href="individual-parameter-analyses.html#cb84-8" aria-hidden="true" tabindex="-1"></a>                                    geomeanCriteria <span class="co"># unique for ecoli/enter</span></span>
<span id="cb84-9"><a href="individual-parameter-analyses.html#cb84-9" aria-hidden="true" tabindex="-1"></a>                                    ){</span>
<span id="cb84-10"><a href="individual-parameter-analyses.html#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Output tibble to organize results, need list object to save associate data</span></span>
<span id="cb84-11"><a href="individual-parameter-analyses.html#cb84-11" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">StationID</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb84-12"><a href="individual-parameter-analyses.html#cb84-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Date Window Starts</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-13"><a href="individual-parameter-analyses.html#cb84-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Date Window Ends</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-14"><a href="individual-parameter-analyses.html#cb84-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Last Sample Date in Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-15"><a href="individual-parameter-analyses.html#cb84-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Samples in 90 Day Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-16"><a href="individual-parameter-analyses.html#cb84-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-17"><a href="individual-parameter-analyses.html#cb84-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">STV Exceedance Rate</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-18"><a href="individual-parameter-analyses.html#cb84-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb84-19"><a href="individual-parameter-analyses.html#cb84-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb84-20"><a href="individual-parameter-analyses.html#cb84-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb84-21"><a href="individual-parameter-analyses.html#cb84-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">associatedData =</span> <span class="fu">list</span>())</span>
<span id="cb84-22"><a href="individual-parameter-analyses.html#cb84-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-23"><a href="individual-parameter-analyses.html#cb84-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data reorg to enable both types of bacteria assessment from a single function</span></span>
<span id="cb84-24"><a href="individual-parameter-analyses.html#cb84-24" aria-hidden="true" tabindex="-1"></a>  stationData2 <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, FDT_DATE_TIME, <span class="sc">!!</span> bacteriaField, <span class="sc">!!</span> bacteriaRemark) <span class="sc">%&gt;%</span></span>
<span id="cb84-25"><a href="individual-parameter-analyses.html#cb84-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Value =</span> bacteriaField, <span class="at">LEVEL_Value =</span> bacteriaRemark) <span class="sc">%&gt;%</span></span>
<span id="cb84-26"><a href="individual-parameter-analyses.html#cb84-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span> LEVEL_Value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>)) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb84-27"><a href="individual-parameter-analyses.html#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Value))</span>
<span id="cb84-28"><a href="individual-parameter-analyses.html#cb84-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-29"><a href="individual-parameter-analyses.html#cb84-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationData2) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb84-30"><a href="individual-parameter-analyses.html#cb84-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each row of input df to test 90 day windows against assessment criteria</span></span>
<span id="cb84-31"><a href="individual-parameter-analyses.html#cb84-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>( i <span class="cf">in</span> <span class="dv">1</span> <span class="sc">:</span> <span class="fu">nrow</span>(stationData2)){</span>
<span id="cb84-32"><a href="individual-parameter-analyses.html#cb84-32" aria-hidden="true" tabindex="-1"></a>      time1 <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(stationData2<span class="sc">$</span>FDT_DATE_TIME[i])</span>
<span id="cb84-33"><a href="individual-parameter-analyses.html#cb84-33" aria-hidden="true" tabindex="-1"></a>      timePlus89 <span class="ot">&lt;-</span> time1 <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">89</span>) </span>
<span id="cb84-34"><a href="individual-parameter-analyses.html#cb84-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-35"><a href="individual-parameter-analyses.html#cb84-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Organize prerequisites to decision process</span></span>
<span id="cb84-36"><a href="individual-parameter-analyses.html#cb84-36" aria-hidden="true" tabindex="-1"></a>      windowData <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData2, <span class="fu">as.Date</span>(FDT_DATE_TIME) <span class="sc">&gt;=</span> time1 <span class="sc">&amp;</span> <span class="fu">as.Date</span>(FDT_DATE_TIME) <span class="sc">&lt;=</span> timePlus89) <span class="sc">%&gt;%</span> </span>
<span id="cb84-37"><a href="individual-parameter-analyses.html#cb84-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">nSamples =</span> <span class="fu">n</span>(), <span class="co"># count number of samples in 90 day window</span></span>
<span id="cb84-38"><a href="individual-parameter-analyses.html#cb84-38" aria-hidden="true" tabindex="-1"></a>               <span class="at">STVhit =</span> <span class="fu">ifelse</span>(Value <span class="sc">&gt;</span> STV, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>), <span class="co"># test values in window against STV</span></span>
<span id="cb84-39"><a href="individual-parameter-analyses.html#cb84-39" aria-hidden="true" tabindex="-1"></a>               <span class="at">geomean =</span> <span class="fu">ifelse</span>(nSamples <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="co"># calculate geomean of samples if nSamples&gt;1</span></span>
<span id="cb84-40"><a href="individual-parameter-analyses.html#cb84-40" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">as.numeric</span>(round<span class="sc">::</span><span class="fu">roundAll</span>(EnvStats<span class="sc">::</span><span class="fu">geoMean</span>(Value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">digits=</span><span class="dv">0</span>, <span class="st">&quot;r0.C&quot;</span>)), <span class="co"># round to nearest whole number per Memo to Standardize Rounding for Assessment Guidance</span></span>
<span id="cb84-41"><a href="individual-parameter-analyses.html#cb84-41" aria-hidden="true" tabindex="-1"></a>                                <span class="cn">NA</span>), </span>
<span id="cb84-42"><a href="individual-parameter-analyses.html#cb84-42" aria-hidden="true" tabindex="-1"></a>               <span class="at">geomeanCriteriaHit =</span> <span class="fu">ifelse</span>(geomean <span class="sc">&gt;</span> geomeanCriteria, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>)) <span class="co"># test round to even geomean against geomean Criteria</span></span>
<span id="cb84-43"><a href="individual-parameter-analyses.html#cb84-43" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-44"><a href="individual-parameter-analyses.html#cb84-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First level of testing: any STV hits in dataset? Want this information for all scenarios</span></span>
<span id="cb84-45"><a href="individual-parameter-analyses.html#cb84-45" aria-hidden="true" tabindex="-1"></a>      nSTVhitsInWindow <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(windowData, STVhit <span class="sc">==</span> <span class="cn">TRUE</span>))</span>
<span id="cb84-46"><a href="individual-parameter-analyses.html#cb84-46" aria-hidden="true" tabindex="-1"></a>      <span class="co"># STV exceedance rate calculation with round to even math</span></span>
<span id="cb84-47"><a href="individual-parameter-analyses.html#cb84-47" aria-hidden="true" tabindex="-1"></a>      STVexceedanceRate <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>nSamples) <span class="sc">&gt;=</span> <span class="dv">10</span>, </span>
<span id="cb84-48"><a href="individual-parameter-analyses.html#cb84-48" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">as.numeric</span>(round<span class="sc">::</span><span class="fu">roundAll</span>((nSTVhitsInWindow <span class="sc">/</span> <span class="fu">unique</span>(windowData<span class="sc">$</span>nSamples)) <span class="sc">*</span> <span class="dv">100</span>,<span class="at">digits=</span><span class="dv">0</span>, <span class="st">&quot;r0.C&quot;</span>)), <span class="co"># round to nearest whole number per Memo to Standardize Rounding for Assessment Guidance</span></span>
<span id="cb84-49"><a href="individual-parameter-analyses.html#cb84-49" aria-hidden="true" tabindex="-1"></a>                                  <span class="cn">NA</span>) <span class="co"># no STV exceedance rate if &lt; 10 samples</span></span>
<span id="cb84-50"><a href="individual-parameter-analyses.html#cb84-50" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nSTVhitsInWindow <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb84-51"><a href="individual-parameter-analyses.html#cb84-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="st">&#39;No STV violations within 90 day window&#39;</span> } </span>
<span id="cb84-52"><a href="individual-parameter-analyses.html#cb84-52" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nSTVhitsInWindow <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb84-53"><a href="individual-parameter-analyses.html#cb84-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">paste</span>(nSTVhitsInWindow, <span class="st">&#39; STV violation(s) with &#39;</span>, <span class="fu">format</span>(STVexceedanceRate, <span class="at">digits =</span> <span class="dv">3</span>), </span>
<span id="cb84-54"><a href="individual-parameter-analyses.html#cb84-54" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;% exceedance rate in 90 day window | Insufficient Information (Prioritize for follow up monitoring)&#39;</span>,<span class="at">sep=</span><span class="st">&#39;&#39;</span>)}</span>
<span id="cb84-55"><a href="individual-parameter-analyses.html#cb84-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(nSTVhitsInWindow <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb84-56"><a href="individual-parameter-analyses.html#cb84-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">paste</span>(nSTVhitsInWindow, <span class="st">&#39; STV violation(s) with &#39;</span>, <span class="fu">format</span>(STVexceedanceRate, <span class="at">digits =</span> <span class="dv">3</span>), </span>
<span id="cb84-57"><a href="individual-parameter-analyses.html#cb84-57" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">&#39;% exceedance rate in 90 day window | Impaired: &#39;</span>, nSTVhitsInWindow,<span class="st">&#39; hits in the same 90-day period&#39;</span>,<span class="at">sep=</span><span class="st">&#39;&#39;</span>) }</span>
<span id="cb84-58"><a href="individual-parameter-analyses.html#cb84-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-59"><a href="individual-parameter-analyses.html#cb84-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-60"><a href="individual-parameter-analyses.html#cb84-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Second level of testing: only if minimum geomean sampling requirements met in 90 day period</span></span>
<span id="cb84-61"><a href="individual-parameter-analyses.html#cb84-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>nSamples) <span class="sc">&gt;=</span> sampleRequirement){</span>
<span id="cb84-62"><a href="individual-parameter-analyses.html#cb84-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Geomean Hit</span></span>
<span id="cb84-63"><a href="individual-parameter-analyses.html#cb84-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>geomeanCriteriaHit) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb84-64"><a href="individual-parameter-analyses.html#cb84-64" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&#39;Geomean: &#39;</span>, <span class="fu">format</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>geomean), <span class="at">digits =</span> <span class="dv">3</span>), </span>
<span id="cb84-65"><a href="individual-parameter-analyses.html#cb84-65" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">&#39; | Impaired: geomean exceeds criteria in the 90-day period&#39;</span>, <span class="at">sep=</span><span class="st">&#39;&#39;</span>)  </span>
<span id="cb84-66"><a href="individual-parameter-analyses.html#cb84-66" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span>{</span>
<span id="cb84-67"><a href="individual-parameter-analyses.html#cb84-67" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span>  <span class="fu">paste</span>(<span class="st">&#39;Geomean: &#39;</span>, <span class="fu">format</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>geomean), <span class="at">digits =</span> <span class="dv">3</span>), </span>
<span id="cb84-68"><a href="individual-parameter-analyses.html#cb84-68" aria-hidden="true" tabindex="-1"></a>                                         <span class="st">&#39; | Geomean criteria met, hold assessment decision for further testing&#39;</span>, <span class="at">sep=</span> <span class="st">&#39;&#39;</span>)} </span>
<span id="cb84-69"><a href="individual-parameter-analyses.html#cb84-69" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> { <span class="co"># minimum geomean sampling requirements NOT met in 90 day period</span></span>
<span id="cb84-70"><a href="individual-parameter-analyses.html#cb84-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="st">&#39;Insufficient Information: geomean sampling criteria not met&#39;</span>  }</span>
<span id="cb84-71"><a href="individual-parameter-analyses.html#cb84-71" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb84-72"><a href="individual-parameter-analyses.html#cb84-72" aria-hidden="true" tabindex="-1"></a>      out[i,] <span class="ot">&lt;-</span>  <span class="fu">tibble</span>(<span class="st">`</span><span class="at">StationID</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(stationData2<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb84-73"><a href="individual-parameter-analyses.html#cb84-73" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Date Window Starts</span><span class="st">`</span> <span class="ot">=</span> time1, </span>
<span id="cb84-74"><a href="individual-parameter-analyses.html#cb84-74" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Date Window Ends</span><span class="st">`</span> <span class="ot">=</span> timePlus89, </span>
<span id="cb84-75"><a href="individual-parameter-analyses.html#cb84-75" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Last Sample Date in Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">max</span>(windowData<span class="sc">$</span>FDT_DATE_TIME),</span>
<span id="cb84-76"><a href="individual-parameter-analyses.html#cb84-76" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Samples in 90 Day Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(windowData<span class="sc">$</span>nSamples), </span>
<span id="cb84-77"><a href="individual-parameter-analyses.html#cb84-77" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="ot">=</span> nSTVhitsInWindow, </span>
<span id="cb84-78"><a href="individual-parameter-analyses.html#cb84-78" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">STV Exceedance Rate</span><span class="st">`</span> <span class="ot">=</span> STVexceedanceRate,</span>
<span id="cb84-79"><a href="individual-parameter-analyses.html#cb84-79" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span>,</span>
<span id="cb84-80"><a href="individual-parameter-analyses.html#cb84-80" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">unique</span>(windowData<span class="sc">$</span>nSamples) <span class="sc">&gt;=</span> sampleRequirement, <span class="fu">unique</span>(windowData<span class="sc">$</span>geomean), <span class="cn">NA</span>), <span class="co"># avoid excitement, only give geomean result if 10+ samples</span></span>
<span id="cb84-81"><a href="individual-parameter-analyses.html#cb84-81" aria-hidden="true" tabindex="-1"></a>                         <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span>,</span>
<span id="cb84-82"><a href="individual-parameter-analyses.html#cb84-82" aria-hidden="true" tabindex="-1"></a>                         <span class="at">associatedData =</span> <span class="fu">list</span>(windowData)) </span>
<span id="cb84-83"><a href="individual-parameter-analyses.html#cb84-83" aria-hidden="true" tabindex="-1"></a>    } <span class="co">#end for loop</span></span>
<span id="cb84-84"><a href="individual-parameter-analyses.html#cb84-84" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb84-85"><a href="individual-parameter-analyses.html#cb84-85" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">StationID</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb84-86"><a href="individual-parameter-analyses.html#cb84-86" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Date Window Starts</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-87"><a href="individual-parameter-analyses.html#cb84-87" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Date Window Ends</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-88"><a href="individual-parameter-analyses.html#cb84-88" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Last Sample Date in Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.Date</span>(<span class="cn">NA</span>), </span>
<span id="cb84-89"><a href="individual-parameter-analyses.html#cb84-89" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Samples in 90 Day Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-90"><a href="individual-parameter-analyses.html#cb84-90" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-91"><a href="individual-parameter-analyses.html#cb84-91" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">STV Exceedance Rate</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb84-92"><a href="individual-parameter-analyses.html#cb84-92" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">STV Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb84-93"><a href="individual-parameter-analyses.html#cb84-93" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb84-94"><a href="individual-parameter-analyses.html#cb84-94" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">Geomean Assessment</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb84-95"><a href="individual-parameter-analyses.html#cb84-95" aria-hidden="true" tabindex="-1"></a>                  <span class="at">associatedData =</span> <span class="fu">list</span>(<span class="cn">NA</span>))</span>
<span id="cb84-96"><a href="individual-parameter-analyses.html#cb84-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb84-97"><a href="individual-parameter-analyses.html#cb84-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-98"><a href="individual-parameter-analyses.html#cb84-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For IR2024, we only want to make assessment decisions on data windows with unique datasets. Running distinct() on `Last Sample Date in Window`</span></span>
<span id="cb84-99"><a href="individual-parameter-analyses.html#cb84-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># will keep only the rows with the first occurrence of any given sample date, allowing us to remove rolled windows that contain duplicated </span></span>
<span id="cb84-100"><a href="individual-parameter-analyses.html#cb84-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># datasets. Joining this result back to the out dataset allows us to flag `Valid Assessment Window` appropriately. Since this function</span></span>
<span id="cb84-101"><a href="individual-parameter-analyses.html#cb84-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># feeds the app, we want to keep all records and only at later functions that make assessment decisions do we want to filter out </span></span>
<span id="cb84-102"><a href="individual-parameter-analyses.html#cb84-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># non-unique windows.</span></span>
<span id="cb84-103"><a href="individual-parameter-analyses.html#cb84-103" aria-hidden="true" tabindex="-1"></a>  distinctWindows <span class="ot">&lt;-</span> <span class="fu">distinct</span>(out, <span class="st">`</span><span class="at">Last Sample Date in Window</span><span class="st">`</span>, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb84-104"><a href="individual-parameter-analyses.html#cb84-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Valid Assessment Window</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span>
<span id="cb84-105"><a href="individual-parameter-analyses.html#cb84-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-106"><a href="individual-parameter-analyses.html#cb84-106" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">left_join</span>(out, distinctWindows,</span>
<span id="cb84-107"><a href="individual-parameter-analyses.html#cb84-107" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;StationID&quot;</span>, <span class="st">&quot;Date Window Starts&quot;</span>, <span class="st">&quot;Date Window Ends&quot;</span>, <span class="st">&quot;Last Sample Date in Window&quot;</span>, </span>
<span id="cb84-108"><a href="individual-parameter-analyses.html#cb84-108" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;Samples in 90 Day Window&quot;</span>, <span class="st">&quot;STV Exceedances In Window&quot;</span>, <span class="st">&quot;STV Exceedance Rate&quot;</span>, </span>
<span id="cb84-109"><a href="individual-parameter-analyses.html#cb84-109" aria-hidden="true" tabindex="-1"></a>                           <span class="st">&quot;STV Assessment&quot;</span>, <span class="st">&quot;Geomean In Window&quot;</span>, <span class="st">&quot;Geomean Assessment&quot;</span>, <span class="st">&quot;associatedData&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co"># join by everything to be safe</span></span>
<span id="cb84-110"><a href="individual-parameter-analyses.html#cb84-110" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(StationID<span class="sc">:</span><span class="st">`</span><span class="at">Last Sample Date in Window</span><span class="st">`</span>, <span class="st">`</span><span class="at">Valid Assessment Window</span><span class="st">`</span>, <span class="fu">everything</span>())</span>
<span id="cb84-111"><a href="individual-parameter-analyses.html#cb84-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb84-112"><a href="individual-parameter-analyses.html#cb84-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out) </span>
<span id="cb84-113"><a href="individual-parameter-analyses.html#cb84-113" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-114"><a href="individual-parameter-analyses.html#cb84-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-115"><a href="individual-parameter-analyses.html#cb84-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb84-116"><a href="individual-parameter-analyses.html#cb84-116" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb84-117"><a href="individual-parameter-analyses.html#cb84-117" aria-hidden="true" tabindex="-1"></a><span class="co">#bacteriaExceedances_NEW(stationData, &#39;ECOLI&#39;, &#39;LEVEL_ECOLI&#39;, 10, 410, 126)</span></span>
<span id="cb84-118"><a href="individual-parameter-analyses.html#cb84-118" aria-hidden="true" tabindex="-1"></a><span class="co">#bacteriaExceedances_NEW(stationData, &#39;ENTEROCOCCI&#39;, &#39;LEVEL_ENTEROCOCCI&#39;, 10, 130, 35) </span></span>
<span id="cb84-119"><a href="individual-parameter-analyses.html#cb84-119" aria-hidden="true" tabindex="-1"></a><span class="co"># How to unpack raw data from inside each unqiue 90 day window</span></span>
<span id="cb84-120"><a href="individual-parameter-analyses.html#cb84-120" aria-hidden="true" tabindex="-1"></a><span class="co"># y &lt;- bacteriaExceedances_NEW(stationData, &#39;ECOLI&#39;, &#39;LEVEL_ECOLI&#39;, 10, 410, 126)</span></span>
<span id="cb84-121"><a href="individual-parameter-analyses.html#cb84-121" aria-hidden="true" tabindex="-1"></a><span class="co"># View(y) # look at this data structure</span></span>
<span id="cb84-122"><a href="individual-parameter-analyses.html#cb84-122" aria-hidden="true" tabindex="-1"></a><span class="co"># y$associatedData[1] # look at first 90 day window associated data</span></span></code></pre></div>
</div>
<div id="bacteriaassessmentdecision" class="section level4" number="3.5.5.2">
<h4><span class="header-section-number">3.5.5.2</span> bacteriaAssessmentDecision</h4>
<p>The <code>bacteriaAssessmentDecision()</code> function is the workhorse of the bacteria assessment logic, summarizing bacteria assessment results into decisions. This function passes through the provided arguments to the <code>bacteriaExceedances_NEW()</code> function to perform the bacteria criteria analysis. The function is applied inside the <code>bacteriaAssessmentDecisionClass()</code> function to summarize and report out the results of the <code>bacteriaExceedances_NEW()</code> analysis. To ease later data visualization steps, a listcolumn named <code>associatedDecisionData</code> is included in the function output that the user can unpack to see all data associated with each 90 day window.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="individual-parameter-analyses.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to summarize bacteria assessment results into decisions</span></span>
<span id="cb85-2"><a href="individual-parameter-analyses.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This function returns all potential issues with priory on geomean results IF there</span></span>
<span id="cb85-3"><a href="individual-parameter-analyses.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="co"># are enough samples to run geomean</span></span>
<span id="cb85-4"><a href="individual-parameter-analyses.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Round to even rules are applied</span></span>
<span id="cb85-5"><a href="individual-parameter-analyses.html#cb85-5" aria-hidden="true" tabindex="-1"></a>bacteriaAssessmentDecision <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, <span class="co"># input dataframe with bacteria data</span></span>
<span id="cb85-6"><a href="individual-parameter-analyses.html#cb85-6" aria-hidden="true" tabindex="-1"></a>                                       bacteriaField, <span class="co"># name of bacteria field data</span></span>
<span id="cb85-7"><a href="individual-parameter-analyses.html#cb85-7" aria-hidden="true" tabindex="-1"></a>                                       bacteriaRemark, <span class="co"># name of bacteria comment field</span></span>
<span id="cb85-8"><a href="individual-parameter-analyses.html#cb85-8" aria-hidden="true" tabindex="-1"></a>                                       sampleRequirement, <span class="co"># minimum n samples in 90 day window needed to apply geomean</span></span>
<span id="cb85-9"><a href="individual-parameter-analyses.html#cb85-9" aria-hidden="true" tabindex="-1"></a>                                       STV, <span class="co"># unique for ecoli/enter</span></span>
<span id="cb85-10"><a href="individual-parameter-analyses.html#cb85-10" aria-hidden="true" tabindex="-1"></a>                                       geomeanCriteria <span class="co"># unique for ecoli/enter</span></span>
<span id="cb85-11"><a href="individual-parameter-analyses.html#cb85-11" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb85-12"><a href="individual-parameter-analyses.html#cb85-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename output columns based on station table template</span></span>
<span id="cb85-13"><a href="individual-parameter-analyses.html#cb85-13" aria-hidden="true" tabindex="-1"></a>    stationTableName <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(bacteriaField <span class="sc">==</span> <span class="st">&#39;ECOLI&#39;</span>, <span class="st">&quot;ECOLI&quot;</span>, <span class="st">&quot;ENTER&quot;</span>)</span>
<span id="cb85-14"><a href="individual-parameter-analyses.html#cb85-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-15"><a href="individual-parameter-analyses.html#cb85-15" aria-hidden="true" tabindex="-1"></a>    nSamples <span class="ot">&lt;-</span> <span class="fu">select</span>(stationData,  <span class="at">Value =</span> {{ bacteriaField }} ) <span class="sc">%&gt;%</span> </span>
<span id="cb85-16"><a href="individual-parameter-analyses.html#cb85-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Value)) <span class="co"># total n samples taken in assessment window</span></span>
<span id="cb85-17"><a href="individual-parameter-analyses.html#cb85-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-18"><a href="individual-parameter-analyses.html#cb85-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-19"><a href="individual-parameter-analyses.html#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(nSamples) <span class="sc">&gt;</span> <span class="dv">0</span>){ <span class="co"># only proceed through decisions if there is data to be analyzed</span></span>
<span id="cb85-20"><a href="individual-parameter-analyses.html#cb85-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-21"><a href="individual-parameter-analyses.html#cb85-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run assessment function</span></span>
<span id="cb85-22"><a href="individual-parameter-analyses.html#cb85-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make two objects here because we want to base all decisions only on valid data, but we also want to output all associated data from </span></span>
<span id="cb85-23"><a href="individual-parameter-analyses.html#cb85-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># this function, so we create a rawAnalysisForOutput to be saved in a list column for unpacking later</span></span>
<span id="cb85-24"><a href="individual-parameter-analyses.html#cb85-24" aria-hidden="true" tabindex="-1"></a>    rawAnalysisForOutput <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">bacteriaExceedances_NEW</span>(stationData, bacteriaField, bacteriaRemark, sampleRequirement, STV, geomeanCriteria)   )</span>
<span id="cb85-25"><a href="individual-parameter-analyses.html#cb85-25" aria-hidden="true" tabindex="-1"></a>    validForAssessment <span class="ot">&lt;-</span> rawAnalysisForOutput <span class="sc">%&gt;%</span> </span>
<span id="cb85-26"><a href="individual-parameter-analyses.html#cb85-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="st">`</span><span class="at">Valid Assessment Window</span><span class="st">`</span> <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-27"><a href="individual-parameter-analyses.html#cb85-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-28"><a href="individual-parameter-analyses.html#cb85-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bail out if no data to analyze bc all Level II or Level I, OR (new for IR2024) no valid windows for assessment</span></span>
<span id="cb85-29"><a href="individual-parameter-analyses.html#cb85-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Date Window Starts</span><span class="st">`</span>))) <span class="sc">==</span> <span class="dv">0</span> ){</span>
<span id="cb85-30"><a href="individual-parameter-analyses.html#cb85-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb85-31"><a href="individual-parameter-analyses.html#cb85-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-32"><a href="individual-parameter-analyses.html#cb85-32" aria-hidden="true" tabindex="-1"></a>                    <span class="co">#`_IMPAIREDWINDOWS` = NA,</span></span>
<span id="cb85-33"><a href="individual-parameter-analyses.html#cb85-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, </span>
<span id="cb85-34"><a href="individual-parameter-analyses.html#cb85-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-35"><a href="individual-parameter-analyses.html#cb85-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-36"><a href="individual-parameter-analyses.html#cb85-36" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="co"># is this the right code???</span></span>
<span id="cb85-37"><a href="individual-parameter-analyses.html#cb85-37" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, </span>
<span id="cb85-38"><a href="individual-parameter-analyses.html#cb85-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-39"><a href="individual-parameter-analyses.html#cb85-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-40"><a href="individual-parameter-analyses.html#cb85-40" aria-hidden="true" tabindex="-1"></a>                    <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(<span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-41"><a href="individual-parameter-analyses.html#cb85-41" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-42"><a href="individual-parameter-analyses.html#cb85-42" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-43"><a href="individual-parameter-analyses.html#cb85-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-44"><a href="individual-parameter-analyses.html#cb85-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-45"><a href="individual-parameter-analyses.html#cb85-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># number of STV exceedances, reported in bacteria_EXC field in stations table and useful for logic testing</span></span>
<span id="cb85-46"><a href="individual-parameter-analyses.html#cb85-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># don&#39;t want to do this analysis on validForAssessment bc sum(validForAssessment$`STV Exceedances In Window`) will overshoot real n</span></span>
<span id="cb85-47"><a href="individual-parameter-analyses.html#cb85-47" aria-hidden="true" tabindex="-1"></a>    exceedSTVn <span class="ot">&lt;-</span> <span class="fu">select</span>(stationData,  <span class="at">Value =</span> {{ bacteriaField }} ) <span class="sc">%&gt;%</span></span>
<span id="cb85-48"><a href="individual-parameter-analyses.html#cb85-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Value <span class="sc">&gt;</span> STV) <span class="co"># total STV exceedances in dataset</span></span>
<span id="cb85-49"><a href="individual-parameter-analyses.html#cb85-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows with &gt; 10% STV rate, these can only be calculated on windows with 10 or more samples</span></span>
<span id="cb85-50"><a href="individual-parameter-analyses.html#cb85-50" aria-hidden="true" tabindex="-1"></a>    exceedSTVrate <span class="ot">&lt;-</span> <span class="fu">filter</span>(validForAssessment, <span class="st">`</span><span class="at">STV Exceedance Rate</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">10</span>)</span>
<span id="cb85-51"><a href="individual-parameter-analyses.html#cb85-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># windows with geomean exceedances, these can only be calculated on windows with 10 or more samples</span></span>
<span id="cb85-52"><a href="individual-parameter-analyses.html#cb85-52" aria-hidden="true" tabindex="-1"></a>    exceedGeomean <span class="ot">&lt;-</span> <span class="fu">filter</span>(validForAssessment, <span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span> <span class="sc">&gt;</span> geomeanCriteria)</span>
<span id="cb85-53"><a href="individual-parameter-analyses.html#cb85-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-54"><a href="individual-parameter-analyses.html#cb85-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decision logic time, work through geomean first and if there is no appropriate geomean data (no windows with 10+ samples)</span></span>
<span id="cb85-55"><a href="individual-parameter-analyses.html#cb85-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   then go to STV assessment</span></span>
<span id="cb85-56"><a href="individual-parameter-analyses.html#cb85-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-57"><a href="individual-parameter-analyses.html#cb85-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Were at least 10 samples taken within any 90-day period of the assessment window?</span></span>
<span id="cb85-58"><a href="individual-parameter-analyses.html#cb85-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>( <span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(validForAssessment<span class="sc">$</span><span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>)) ){ <span class="co"># Were at least 10 samples taken within any 90-day period of the assessment window? - Yes</span></span>
<span id="cb85-59"><a href="individual-parameter-analyses.html#cb85-59" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Do the geometric means calculated for the 90-day periods represented by 10+ samples meet the GM criterion?</span></span>
<span id="cb85-60"><a href="individual-parameter-analyses.html#cb85-60" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>( <span class="fu">nrow</span>(exceedGeomean) <span class="sc">==</span> <span class="dv">0</span>){ <span class="co"># Do the geometric means calculated for the 90-day periods represented by 10+ samples meet the GM criterion? - Yes</span></span>
<span id="cb85-61"><a href="individual-parameter-analyses.html#cb85-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Do any of the 90-day periods of the assessment window represented in the dataset exceed the 10% STV Exceedance Rate?</span></span>
<span id="cb85-62"><a href="individual-parameter-analyses.html#cb85-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>( <span class="fu">nrow</span>(exceedSTVn) <span class="sc">&gt;</span> <span class="dv">0</span>){ <span class="co"># Do any of the 90-day periods of the assessment window represented in the dataset exceed the 10% STV Exceedance Rate? - Yes</span></span>
<span id="cb85-63"><a href="individual-parameter-analyses.html#cb85-63" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb85-64"><a href="individual-parameter-analyses.html#cb85-64" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Yes, in a 90-day period represented by 10+ samples</span></span>
<span id="cb85-65"><a href="individual-parameter-analyses.html#cb85-65" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">filter</span>(exceedSTVrate, <span class="st">`</span><span class="at">Samples in 90 Day Window</span><span class="st">`</span> <span class="sc">&gt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">STV Exceedance Rate</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">10</span>)) <span class="sc">&gt;</span> <span class="dv">0</span>){ <span class="co"># STV exceedances in a 90-day period represented by &gt;= 10 samples</span></span>
<span id="cb85-66"><a href="individual-parameter-analyses.html#cb85-66" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-67"><a href="individual-parameter-analyses.html#cb85-67" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-68"><a href="individual-parameter-analyses.html#cb85-68" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-69"><a href="individual-parameter-analyses.html#cb85-69" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-70"><a href="individual-parameter-analyses.html#cb85-70" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-71"><a href="individual-parameter-analyses.html#cb85-71" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IM&quot;</span>,</span>
<span id="cb85-72"><a href="individual-parameter-analyses.html#cb85-72" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Impaired - 2 or more STV exceedances in the same 90-day period represented by 10+ samples, no geomean exceedances.&quot;</span>,<span class="co">#STV exceedances in a 90-day period represented by &gt;= 10 samples after verifying geomean passes where applicable.&quot;,</span></span>
<span id="cb85-73"><a href="individual-parameter-analyses.html#cb85-73" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-74"><a href="individual-parameter-analyses.html#cb85-74" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-75"><a href="individual-parameter-analyses.html#cb85-75" aria-hidden="true" tabindex="-1"></a>                          <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-76"><a href="individual-parameter-analyses.html#cb85-76" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-77"><a href="individual-parameter-analyses.html#cb85-77" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-78"><a href="individual-parameter-analyses.html#cb85-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb85-79"><a href="individual-parameter-analyses.html#cb85-79" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {  <span class="co"># STV exceedances in a 90-day period represented by &lt; 10 samples</span></span>
<span id="cb85-80"><a href="individual-parameter-analyses.html#cb85-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb85-81"><a href="individual-parameter-analyses.html#cb85-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2 or more hits in the same 90-day period?</span></span>
<span id="cb85-82"><a href="individual-parameter-analyses.html#cb85-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(<span class="fu">any</span>(validForAssessment<span class="sc">$</span><span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="sc">&gt;=</span> <span class="dv">2</span>) ){</span>
<span id="cb85-83"><a href="individual-parameter-analyses.html#cb85-83" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-84"><a href="individual-parameter-analyses.html#cb85-84" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-85"><a href="individual-parameter-analyses.html#cb85-85" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-86"><a href="individual-parameter-analyses.html#cb85-86" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-87"><a href="individual-parameter-analyses.html#cb85-87" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-88"><a href="individual-parameter-analyses.html#cb85-88" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IM&quot;</span>,</span>
<span id="cb85-89"><a href="individual-parameter-analyses.html#cb85-89" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Impaired- 2 or more STV exceedances in the same 90-day period with &lt; 10 samples, no geomean exceedances.&quot;</span>, <span class="co">#2 or more STV hits in the same 90-day period with &lt; 10 samples after verifying geomean passes where applicable.&quot;,</span></span>
<span id="cb85-90"><a href="individual-parameter-analyses.html#cb85-90" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-91"><a href="individual-parameter-analyses.html#cb85-91" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-92"><a href="individual-parameter-analyses.html#cb85-92" aria-hidden="true" tabindex="-1"></a>                            <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-93"><a href="individual-parameter-analyses.html#cb85-93" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-94"><a href="individual-parameter-analyses.html#cb85-94" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-95"><a href="individual-parameter-analyses.html#cb85-95" aria-hidden="true" tabindex="-1"></a>              } <span class="cf">else</span> { </span>
<span id="cb85-96"><a href="individual-parameter-analyses.html#cb85-96" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb85-97"><a href="individual-parameter-analyses.html#cb85-97" aria-hidden="true" tabindex="-1"></a>                <span class="co"># did the STV exceedance(s) occur in windows with 10+ samples?</span></span>
<span id="cb85-98"><a href="individual-parameter-analyses.html#cb85-98" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">filter</span>(validForAssessment, <span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">$</span><span class="st">`</span><span class="at">Samples in 90 Day Window</span><span class="st">`</span> <span class="sc">&gt;=</span> <span class="dv">10</span>)){</span>
<span id="cb85-99"><a href="individual-parameter-analyses.html#cb85-99" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-100"><a href="individual-parameter-analyses.html#cb85-100" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-101"><a href="individual-parameter-analyses.html#cb85-101" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-102"><a href="individual-parameter-analyses.html#cb85-102" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-103"><a href="individual-parameter-analyses.html#cb85-103" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-104"><a href="individual-parameter-analyses.html#cb85-104" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;S&quot;</span>,</span>
<span id="cb85-105"><a href="individual-parameter-analyses.html#cb85-105" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Fully Supporting - No STV exceedance rates &gt;10% or geomean exceedances in any 90-day period represented by 10+ samples.&quot;</span>,<span class="co"># No geomean exceedances and STV exceedance(s) in one or multiple 90-day periods represented by 10+ samples.&quot;, # previous language: 1 STV hit in one or multiple 90-day periods with &lt; 10 samples after verifying geomean passes where applicable.&quot;,</span></span>
<span id="cb85-106"><a href="individual-parameter-analyses.html#cb85-106" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-107"><a href="individual-parameter-analyses.html#cb85-107" aria-hidden="true" tabindex="-1"></a>                                <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-108"><a href="individual-parameter-analyses.html#cb85-108" aria-hidden="true" tabindex="-1"></a>                                <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-109"><a href="individual-parameter-analyses.html#cb85-109" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-110"><a href="individual-parameter-analyses.html#cb85-110" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-111"><a href="individual-parameter-analyses.html#cb85-111" aria-hidden="true" tabindex="-1"></a>                  </span>
<span id="cb85-112"><a href="individual-parameter-analyses.html#cb85-112" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">else</span> {<span class="co"># STV exceedance(s) occured in windows with &lt; 10 samples</span></span>
<span id="cb85-113"><a href="individual-parameter-analyses.html#cb85-113" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb85-114"><a href="individual-parameter-analyses.html#cb85-114" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 1 hit in one or multiple 90-day periods after verifying geomean passes where applicable</span></span>
<span id="cb85-115"><a href="individual-parameter-analyses.html#cb85-115" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-116"><a href="individual-parameter-analyses.html#cb85-116" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-117"><a href="individual-parameter-analyses.html#cb85-117" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-118"><a href="individual-parameter-analyses.html#cb85-118" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-119"><a href="individual-parameter-analyses.html#cb85-119" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-120"><a href="individual-parameter-analyses.html#cb85-120" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;O&quot;</span>,</span>
<span id="cb85-121"><a href="individual-parameter-analyses.html#cb85-121" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Fully Supporting - No geomean exceedances and only 1 STV exceedance in one or multiple 90-day periods represented by &lt; 10 samples.&quot;</span>, <span class="co"># previous language: 1 STV hit in one or multiple 90-day periods with &lt; 10 samples after verifying geomean passes where applicable.&quot;,</span></span>
<span id="cb85-122"><a href="individual-parameter-analyses.html#cb85-122" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-123"><a href="individual-parameter-analyses.html#cb85-123" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-124"><a href="individual-parameter-analyses.html#cb85-124" aria-hidden="true" tabindex="-1"></a>                              <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-125"><a href="individual-parameter-analyses.html#cb85-125" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-126"><a href="individual-parameter-analyses.html#cb85-126" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-127"><a href="individual-parameter-analyses.html#cb85-127" aria-hidden="true" tabindex="-1"></a>                } </span>
<span id="cb85-128"><a href="individual-parameter-analyses.html#cb85-128" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb85-129"><a href="individual-parameter-analyses.html#cb85-129" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb85-130"><a href="individual-parameter-analyses.html#cb85-130" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb85-131"><a href="individual-parameter-analyses.html#cb85-131" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {  <span class="co"># Do any of the 90-day periods of the assessment window represented in the dataset exceed the 10% STV Exceedance Rate? - No</span></span>
<span id="cb85-132"><a href="individual-parameter-analyses.html#cb85-132" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-133"><a href="individual-parameter-analyses.html#cb85-133" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-134"><a href="individual-parameter-analyses.html#cb85-134" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-135"><a href="individual-parameter-analyses.html#cb85-135" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-136"><a href="individual-parameter-analyses.html#cb85-136" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-137"><a href="individual-parameter-analyses.html#cb85-137" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;S&quot;</span>,</span>
<span id="cb85-138"><a href="individual-parameter-analyses.html#cb85-138" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Fully Supporting - No STV exceedance rates &gt;10% or geomean exceedances in any 90-day period represented by 10+ samples.&quot;</span>, <span class="co">#No STV exceedances or geomean exceedances in any 90-day period.&quot;,</span></span>
<span id="cb85-139"><a href="individual-parameter-analyses.html#cb85-139" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-140"><a href="individual-parameter-analyses.html#cb85-140" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-141"><a href="individual-parameter-analyses.html#cb85-141" aria-hidden="true" tabindex="-1"></a>                        <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-142"><a href="individual-parameter-analyses.html#cb85-142" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-143"><a href="individual-parameter-analyses.html#cb85-143" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-144"><a href="individual-parameter-analyses.html#cb85-144" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb85-145"><a href="individual-parameter-analyses.html#cb85-145" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-146"><a href="individual-parameter-analyses.html#cb85-146" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> { <span class="co"># Do the geometric means calculated for the 90-day periods represented by 10+ samples meet the GM criterion? - No</span></span>
<span id="cb85-147"><a href="individual-parameter-analyses.html#cb85-147" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-148"><a href="individual-parameter-analyses.html#cb85-148" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-149"><a href="individual-parameter-analyses.html#cb85-149" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-150"><a href="individual-parameter-analyses.html#cb85-150" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedGeomean),</span>
<span id="cb85-151"><a href="individual-parameter-analyses.html#cb85-151" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(validForAssessment, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">Geomean In Window</span><span class="st">`</span>))),</span>
<span id="cb85-152"><a href="individual-parameter-analyses.html#cb85-152" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IM&quot;</span>,</span>
<span id="cb85-153"><a href="individual-parameter-analyses.html#cb85-153" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Impaired- geomean exceedance in any 90-day period.&quot;</span>, <span class="co">#geomean exceedance(s) in any 90-day period with &gt;= 10 samples.&quot;,</span></span>
<span id="cb85-154"><a href="individual-parameter-analyses.html#cb85-154" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-155"><a href="individual-parameter-analyses.html#cb85-155" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-156"><a href="individual-parameter-analyses.html#cb85-156" aria-hidden="true" tabindex="-1"></a>                      <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-157"><a href="individual-parameter-analyses.html#cb85-157" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-158"><a href="individual-parameter-analyses.html#cb85-158" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-159"><a href="individual-parameter-analyses.html#cb85-159" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb85-160"><a href="individual-parameter-analyses.html#cb85-160" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb85-161"><a href="individual-parameter-analyses.html#cb85-161" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># Were at least 10 samples taken within any 90-day period of the assessment window? - No</span></span>
<span id="cb85-162"><a href="individual-parameter-analyses.html#cb85-162" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Were there any hits of the STV during the dataset?</span></span>
<span id="cb85-163"><a href="individual-parameter-analyses.html#cb85-163" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>( <span class="fu">nrow</span>(exceedSTVn) <span class="sc">==</span> <span class="dv">0</span>){ <span class="co"># Were there any hits of the STV during the dataset? - No</span></span>
<span id="cb85-164"><a href="individual-parameter-analyses.html#cb85-164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-165"><a href="individual-parameter-analyses.html#cb85-165" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-166"><a href="individual-parameter-analyses.html#cb85-166" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-167"><a href="individual-parameter-analyses.html#cb85-167" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(exceedGeomean), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-168"><a href="individual-parameter-analyses.html#cb85-168" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(filter(validForAssessment, !is.na(`Geomean In Window`))), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-169"><a href="individual-parameter-analyses.html#cb85-169" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IN&quot;</span>, </span>
<span id="cb85-170"><a href="individual-parameter-analyses.html#cb85-170" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Insufficient Information (Prioritize for follow up monitoring)- No STV exceedances but insufficient data to analyze geomean.&quot;</span>, <span class="co">#0 STV hits but insufficient data to analyze geomean.&quot;,</span></span>
<span id="cb85-171"><a href="individual-parameter-analyses.html#cb85-171" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-172"><a href="individual-parameter-analyses.html#cb85-172" aria-hidden="true" tabindex="-1"></a>                      <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-173"><a href="individual-parameter-analyses.html#cb85-173" aria-hidden="true" tabindex="-1"></a>                      <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-174"><a href="individual-parameter-analyses.html#cb85-174" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>))<span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-175"><a href="individual-parameter-analyses.html#cb85-175" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-176"><a href="individual-parameter-analyses.html#cb85-176" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> { <span class="co"># Were there any hits of the STV during the dataset? - Yes</span></span>
<span id="cb85-177"><a href="individual-parameter-analyses.html#cb85-177" aria-hidden="true" tabindex="-1"></a>          <span class="co"># 2 or more hits in the same 90-day period</span></span>
<span id="cb85-178"><a href="individual-parameter-analyses.html#cb85-178" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">any</span>(validForAssessment<span class="sc">$</span><span class="st">`</span><span class="at">STV Exceedances In Window</span><span class="st">`</span> <span class="sc">&gt;=</span> <span class="dv">2</span>) ){</span>
<span id="cb85-179"><a href="individual-parameter-analyses.html#cb85-179" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-180"><a href="individual-parameter-analyses.html#cb85-180" aria-hidden="true" tabindex="-1"></a>                          <span class="co"># not quite right yet</span></span>
<span id="cb85-181"><a href="individual-parameter-analyses.html#cb85-181" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the number of STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-182"><a href="individual-parameter-analyses.html#cb85-182" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-183"><a href="individual-parameter-analyses.html#cb85-183" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(exceedGeomean), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-184"><a href="individual-parameter-analyses.html#cb85-184" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(filter(validForAssessment, !is.na(`Geomean In Window`))), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-185"><a href="individual-parameter-analyses.html#cb85-185" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IM&quot;</span>, </span>
<span id="cb85-186"><a href="individual-parameter-analyses.html#cb85-186" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Impaired - 2 or more STV hits in the same 90-day period with &lt; 10 samples.&quot;</span>,</span>
<span id="cb85-187"><a href="individual-parameter-analyses.html#cb85-187" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-188"><a href="individual-parameter-analyses.html#cb85-188" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-189"><a href="individual-parameter-analyses.html#cb85-189" aria-hidden="true" tabindex="-1"></a>                          <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-190"><a href="individual-parameter-analyses.html#cb85-190" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>))<span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-191"><a href="individual-parameter-analyses.html#cb85-191" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-192"><a href="individual-parameter-analyses.html#cb85-192" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> { </span>
<span id="cb85-193"><a href="individual-parameter-analyses.html#cb85-193" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 1 hit in one or multiple 90-day periods</span></span>
<span id="cb85-194"><a href="individual-parameter-analyses.html#cb85-194" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(validForAssessment<span class="sc">$</span>StationID),</span>
<span id="cb85-195"><a href="individual-parameter-analyses.html#cb85-195" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(exceedSTVn), <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-196"><a href="individual-parameter-analyses.html#cb85-196" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">nrow</span>(nSamples), </span>
<span id="cb85-197"><a href="individual-parameter-analyses.html#cb85-197" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(exceedGeomean), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-198"><a href="individual-parameter-analyses.html#cb85-198" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="co">#nrow(filter(validForAssessment, !is.na(`Geomean In Window`))), # Data Entry manual updated to require NA instead of 0 if &lt; 10 samples per 90 day window</span></span>
<span id="cb85-199"><a href="individual-parameter-analyses.html#cb85-199" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;IN&quot;</span>,</span>
<span id="cb85-200"><a href="individual-parameter-analyses.html#cb85-200" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Insufficient Information (Prioritize for follow up monitoring)- One STV exceedance in one or multiple 90-day periods but insufficient data to analyze geomean.&quot;</span>,<span class="co">#1 STV hit in one or multiple 90-day periods but insufficient data to analyze geomean.&quot;,</span></span>
<span id="cb85-201"><a href="individual-parameter-analyses.html#cb85-201" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: &quot;</span>,<span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span>),</span>
<span id="cb85-202"><a href="individual-parameter-analyses.html#cb85-202" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste0</span>(stationTableName, <span class="st">&quot;: Number of 90 day windows with &gt; 10% STV exceedance rate: &quot;</span>, <span class="fu">nrow</span>(exceedSTVrate)),</span>
<span id="cb85-203"><a href="individual-parameter-analyses.html#cb85-203" aria-hidden="true" tabindex="-1"></a>                          <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(rawAnalysisForOutput) ) <span class="sc">%&gt;%</span></span>
<span id="cb85-204"><a href="individual-parameter-analyses.html#cb85-204" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-205"><a href="individual-parameter-analyses.html#cb85-205" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-206"><a href="individual-parameter-analyses.html#cb85-206" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb85-207"><a href="individual-parameter-analyses.html#cb85-207" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb85-208"><a href="individual-parameter-analyses.html#cb85-208" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb85-209"><a href="individual-parameter-analyses.html#cb85-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># No bacteria data to analyze</span></span>
<span id="cb85-210"><a href="individual-parameter-analyses.html#cb85-210" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb85-211"><a href="individual-parameter-analyses.html#cb85-211" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">StationID =</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb85-212"><a href="individual-parameter-analyses.html#cb85-212" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="co"># right now this is set to # total STV exceedances, not the # STV exceedances in a 90-day period with 10+ samples</span></span>
<span id="cb85-213"><a href="individual-parameter-analyses.html#cb85-213" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, </span>
<span id="cb85-214"><a href="individual-parameter-analyses.html#cb85-214" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_GM.EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-215"><a href="individual-parameter-analyses.html#cb85-215" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_GM.SAMP</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-216"><a href="individual-parameter-analyses.html#cb85-216" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="co"># is this the right code???</span></span>
<span id="cb85-217"><a href="individual-parameter-analyses.html#cb85-217" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">_STAT_VERBOSE</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>, </span>
<span id="cb85-218"><a href="individual-parameter-analyses.html#cb85-218" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">BACTERIADECISION</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-219"><a href="individual-parameter-analyses.html#cb85-219" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">BACTERIASTATS</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb85-220"><a href="individual-parameter-analyses.html#cb85-220" aria-hidden="true" tabindex="-1"></a>                    <span class="at">associatedDecisionData =</span> <span class="fu">list</span>(<span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-221"><a href="individual-parameter-analyses.html#cb85-221" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;_&quot;</span>, <span class="fu">paste0</span>(stationTableName,<span class="st">&quot;_&quot;</span>), .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span>  <span class="co"># fix names to match station table format</span></span>
<span id="cb85-222"><a href="individual-parameter-analyses.html#cb85-222" aria-hidden="true" tabindex="-1"></a>               <span class="fu">rename_with</span>( <span class="sc">~</span> <span class="fu">gsub</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_&quot;</span>, .x, <span class="at">fixed =</span> <span class="cn">TRUE</span>)) ) <span class="co"># special step to get around accidentally replacing _GM with station table name</span></span>
<span id="cb85-223"><a href="individual-parameter-analyses.html#cb85-223" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb85-224"><a href="individual-parameter-analyses.html#cb85-224" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb85-225"><a href="individual-parameter-analyses.html#cb85-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-226"><a href="individual-parameter-analyses.html#cb85-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb85-227"><a href="individual-parameter-analyses.html#cb85-227" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData object is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb85-228"><a href="individual-parameter-analyses.html#cb85-228" aria-hidden="true" tabindex="-1"></a><span class="co"># bacteriaAssessmentDecision(stationData, &#39;ECOLI&#39;, &#39;LEVEL_ECOLI&#39;, 10, 410, 126)</span></span>
<span id="cb85-229"><a href="individual-parameter-analyses.html#cb85-229" aria-hidden="true" tabindex="-1"></a><span class="co"># bacteriaAssessmentDecision(stationData, &#39;ENTEROCOCCI&#39;, &#39;LEVEL_ENTEROCOCCI&#39;, 10, 130, 35)</span></span>
<span id="cb85-230"><a href="individual-parameter-analyses.html#cb85-230" aria-hidden="true" tabindex="-1"></a><span class="co"># To get just info for station table  </span></span>
<span id="cb85-231"><a href="individual-parameter-analyses.html#cb85-231" aria-hidden="true" tabindex="-1"></a><span class="co">#bacteriaAssessmentDecision(stationData, &#39;ECOLI&#39;, &#39;LEVEL_ECOLI&#39;, 10, 410, 126) %&gt;%</span></span>
<span id="cb85-232"><a href="individual-parameter-analyses.html#cb85-232" aria-hidden="true" tabindex="-1"></a><span class="co">#  dplyr::select(StationID:ECOLI_STAT)</span></span>
<span id="cb85-233"><a href="individual-parameter-analyses.html#cb85-233" aria-hidden="true" tabindex="-1"></a><span class="co">#bacteriaAssessmentDecision(stationData, &#39;ENTEROCOCCI&#39;, &#39;LEVEL_ENTEROCOCCI&#39;, 10, 130, 35) %&gt;%</span></span>
<span id="cb85-234"><a href="individual-parameter-analyses.html#cb85-234" aria-hidden="true" tabindex="-1"></a><span class="co">#  dplyr::select(StationID:ENTER_STAT)</span></span>
<span id="cb85-235"><a href="individual-parameter-analyses.html#cb85-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-236"><a href="individual-parameter-analyses.html#cb85-236" aria-hidden="true" tabindex="-1"></a><span class="co"># How to unpack analyzed data from a single site</span></span>
<span id="cb85-237"><a href="individual-parameter-analyses.html#cb85-237" aria-hidden="true" tabindex="-1"></a><span class="co"># x &lt;- bacteriaAssessmentDecision(stationData, &#39;ENTEROCOCCI&#39;, &#39;LEVEL_ENTEROCOCCI&#39;, 10, 130, 35)</span></span>
<span id="cb85-238"><a href="individual-parameter-analyses.html#cb85-238" aria-hidden="true" tabindex="-1"></a><span class="co"># View(x) # look at this data structure</span></span>
<span id="cb85-239"><a href="individual-parameter-analyses.html#cb85-239" aria-hidden="true" tabindex="-1"></a><span class="co"># x$associatedDecisionData[1] # look at each 90 day window used to make the assessment decision</span></span></code></pre></div>
</div>
<div id="bacteriaassessmentdecisionclass" class="section level4" number="3.5.5.3">
<h4><span class="header-section-number">3.5.5.3</span> bacteriaAssessmentDecisionClass</h4>
<p>The <code>bacteriaAssessmentDecisionClass()</code> is the outermost function to assess bacteria data. The function takes in all data for a single station as well as a StationID (to provide adequate output information in case no bacteria data exist for said station). Based on the WQS class, <em>E.coli</em> is analyzed if the site is freshwater or <em>E.coli</em> and Enterococci are analyzed if the site is saltwater or transitional. It is up to the regional assessor to determine which bacteria analysis best represents these transitional sites. Regardless of the waterbody type, all Level I and Level II data and missing data are removed before measures are rounded to even and compared against the provided criteria. The output of this function includes all the bacteria columns required in the Station Table for CEDS bulk data upload as well as a verbose comment that is provided to the assessor for standardized inclusion in CEDS WQA.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="individual-parameter-analyses.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="do">## outermost function to decide which bacteria should be assessed based on WQS Class</span></span>
<span id="cb86-2"><a href="individual-parameter-analyses.html#cb86-2" aria-hidden="true" tabindex="-1"></a>bacteriaAssessmentDecisionClass <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, <span class="co"># input dataframe with bacteria data</span></span>
<span id="cb86-3"><a href="individual-parameter-analyses.html#cb86-3" aria-hidden="true" tabindex="-1"></a>                                            uniqueStationName <span class="co"># stationID for output in case no data come into function</span></span>
<span id="cb86-4"><a href="individual-parameter-analyses.html#cb86-4" aria-hidden="true" tabindex="-1"></a>                                            ){</span>
<span id="cb86-5"><a href="individual-parameter-analyses.html#cb86-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-6"><a href="individual-parameter-analyses.html#cb86-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-7"><a href="individual-parameter-analyses.html#cb86-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stop everything if no data to analyze in stationData</span></span>
<span id="cb86-8"><a href="individual-parameter-analyses.html#cb86-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationData) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb86-9"><a href="individual-parameter-analyses.html#cb86-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb86-10"><a href="individual-parameter-analyses.html#cb86-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">StationID =</span> uniqueStationName, <span class="at">ECOLI_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_GM_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_GM_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb86-11"><a href="individual-parameter-analyses.html#cb86-11" aria-hidden="true" tabindex="-1"></a>             <span class="at">ECOLI_STAT =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ECOLI_STATECOLI_VERBOSE =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb86-12"><a href="individual-parameter-analyses.html#cb86-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">ENTER_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb86-13"><a href="individual-parameter-analyses.html#cb86-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">ENTER_STAT =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ENTER_STATENTER_VERBOSE =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)) )}</span>
<span id="cb86-14"><a href="individual-parameter-analyses.html#cb86-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-15"><a href="individual-parameter-analyses.html#cb86-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># lake stations should only be surface sample</span></span>
<span id="cb86-16"><a href="individual-parameter-analyses.html#cb86-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb86-17"><a href="individual-parameter-analyses.html#cb86-17" aria-hidden="true" tabindex="-1"></a>    stationData <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, FDT_DEPTH <span class="sc">&lt;=</span> <span class="fl">0.3</span>) }</span>
<span id="cb86-18"><a href="individual-parameter-analyses.html#cb86-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb86-19"><a href="individual-parameter-analyses.html#cb86-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationData) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb86-20"><a href="individual-parameter-analyses.html#cb86-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>CLASS) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;I&#39;</span>, <span class="st">&#39;II&#39;</span>)){</span>
<span id="cb86-21"><a href="individual-parameter-analyses.html#cb86-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># previously this was programmed to only output enterococci results for these classes, but assessors requested both outputs to be conservative</span></span>
<span id="cb86-22"><a href="individual-parameter-analyses.html#cb86-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(</span>
<span id="cb86-23"><a href="individual-parameter-analyses.html#cb86-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(<span class="fu">bacteriaAssessmentDecision</span>(stationData, <span class="st">&#39;ECOLI&#39;</span>, <span class="st">&#39;LEVEL_ECOLI&#39;</span>, <span class="dv">10</span>, <span class="dv">410</span>, <span class="dv">126</span>),</span>
<span id="cb86-24"><a href="individual-parameter-analyses.html#cb86-24" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">bacteriaAssessmentDecision</span>(stationData, <span class="st">&#39;ENTEROCOCCI&#39;</span>, <span class="st">&#39;LEVEL_ENTEROCOCCI&#39;</span>, <span class="dv">10</span>, <span class="dv">130</span>, <span class="dv">35</span>),</span>
<span id="cb86-25"><a href="individual-parameter-analyses.html#cb86-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">&#39;StationID&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-26"><a href="individual-parameter-analyses.html#cb86-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">BACTERIADECISION =</span> <span class="fu">paste0</span>(BACTERIADECISION.x, <span class="st">&#39; | &#39;</span>, BACTERIADECISION.y),</span>
<span id="cb86-27"><a href="individual-parameter-analyses.html#cb86-27" aria-hidden="true" tabindex="-1"></a>                 <span class="at">BACTERIASTATS =</span> <span class="fu">paste0</span>(BACTERIASTATS.x, <span class="st">&#39; | &#39;</span>, BACTERIASTATS.y)) <span class="sc">%&gt;%</span> </span>
<span id="cb86-28"><a href="individual-parameter-analyses.html#cb86-28" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(BACTERIADECISION.x, BACTERIADECISION.y, BACTERIASTATS.x, BACTERIASTATS.y,</span>
<span id="cb86-29"><a href="individual-parameter-analyses.html#cb86-29" aria-hidden="true" tabindex="-1"></a>                           associatedDecisionData.x, associatedDecisionData.y)) )</span>
<span id="cb86-30"><a href="individual-parameter-analyses.html#cb86-30" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb86-31"><a href="individual-parameter-analyses.html#cb86-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(</span>
<span id="cb86-32"><a href="individual-parameter-analyses.html#cb86-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bacteriaAssessmentDecision</span>(stationData, <span class="st">&#39;ECOLI&#39;</span>, <span class="st">&#39;LEVEL_ECOLI&#39;</span>, <span class="dv">10</span>, <span class="dv">410</span>, <span class="dv">126</span>) <span class="sc">%&gt;%</span></span>
<span id="cb86-33"><a href="individual-parameter-analyses.html#cb86-33" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(StationID<span class="sc">:</span>BACTERIASTATS) <span class="sc">%&gt;%</span> <span class="co">#ECOLI_STATECOLI_VERBOSE) %&gt;%</span></span>
<span id="cb86-34"><a href="individual-parameter-analyses.html#cb86-34" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ENTER_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb86-35"><a href="individual-parameter-analyses.html#cb86-35" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ENTER_STAT =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ENTER_STATENTER_VERBOSE =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)) ) }</span>
<span id="cb86-36"><a href="individual-parameter-analyses.html#cb86-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb86-37"><a href="individual-parameter-analyses.html#cb86-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb86-38"><a href="individual-parameter-analyses.html#cb86-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">StationID =</span> uniqueStationName, <span class="at">ECOLI_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_GM_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ECOLI_GM_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb86-39"><a href="individual-parameter-analyses.html#cb86-39" aria-hidden="true" tabindex="-1"></a>             <span class="at">ECOLI_STAT =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ECOLI_STATECOLI_VERBOSE =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb86-40"><a href="individual-parameter-analyses.html#cb86-40" aria-hidden="true" tabindex="-1"></a>             <span class="at">ENTER_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_EXC =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ENTER_GM_SAMP =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb86-41"><a href="individual-parameter-analyses.html#cb86-41" aria-hidden="true" tabindex="-1"></a>             <span class="at">ENTER_STAT =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ENTER_STATENTER_VERBOSE =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)) )}</span>
<span id="cb86-42"><a href="individual-parameter-analyses.html#cb86-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-43"><a href="individual-parameter-analyses.html#cb86-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-44"><a href="individual-parameter-analyses.html#cb86-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb86-45"><a href="individual-parameter-analyses.html#cb86-45" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData object is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb86-46"><a href="individual-parameter-analyses.html#cb86-46" aria-hidden="true" tabindex="-1"></a><span class="co"># bacteriaAssessmentDecisionClass(stationData)</span></span></code></pre></div>
</div>
</div>
<div id="nutrients" class="section level3" number="3.5.6">
<h3><span class="header-section-number">3.5.6</span> Nutrients</h3>
<p>Nutrients are assessed based on waterbody type. Lake stations have a rigorous protocol detailed below, but <a href="individual-parameter-analyses.html#nutrients-in-other-waterbodies">automated assessment methods for non-lake stations</a> simply sum samples. An example workflow below describes how using the <code>lakeStation</code> field created during prior <code>stationData</code> <a href="individual-parameter-analyses.html#how-to-test-individual-parameter-functions">organization steps</a> can appropriately assess nutrients for different station types. See below for more information on lake vs <a href="individual-parameter-analyses.html#nutrients-in-other-waterbodies">other waterbody individual nutrient analyses</a>.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="individual-parameter-analyses.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage for the Station Table output:</span></span>
<span id="cb87-2"><a href="individual-parameter-analyses.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData object is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb87-3"><a href="individual-parameter-analyses.html#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="individual-parameter-analyses.html#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Nutrients: TP </span></span>
<span id="cb87-5"><a href="individual-parameter-analyses.html#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb87-6"><a href="individual-parameter-analyses.html#cb87-6" aria-hidden="true" tabindex="-1"></a>    TP <span class="ot">&lt;-</span> <span class="fu">TP_Assessment</span>(stationData) </span>
<span id="cb87-7"><a href="individual-parameter-analyses.html#cb87-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb87-8"><a href="individual-parameter-analyses.html#cb87-8" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">countNutrients</span>(stationData, PHOSPHORUS_mg_L, LEVEL_PHOSPHORUS, <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">quickStats</span>(<span class="st">&#39;NUT_TP&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb87-9"><a href="individual-parameter-analyses.html#cb87-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">NUT_TP_STAT =</span> <span class="fu">ifelse</span>(NUT_TP_STAT <span class="sc">!=</span> <span class="st">&quot;S&quot;</span>, <span class="st">&quot;Review&quot;</span>, <span class="cn">NA</span>)) } <span class="co"># if status isn&#39;t S, flag for follow up review</span></span>
<span id="cb87-10"><a href="individual-parameter-analyses.html#cb87-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-11"><a href="individual-parameter-analyses.html#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Nutrients: Chl a </span></span>
<span id="cb87-12"><a href="individual-parameter-analyses.html#cb87-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb87-13"><a href="individual-parameter-analyses.html#cb87-13" aria-hidden="true" tabindex="-1"></a>  chla <span class="ot">&lt;-</span> <span class="fu">chlA_Assessment</span>(stationData)</span>
<span id="cb87-14"><a href="individual-parameter-analyses.html#cb87-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb87-15"><a href="individual-parameter-analyses.html#cb87-15" aria-hidden="true" tabindex="-1"></a>    chla <span class="ot">&lt;-</span> <span class="fu">countNutrients</span>(stationData, CHLOROPHYLL_A_ug_L, LEVEL_CHLOROPHYLL_A, <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">quickStats</span>(<span class="st">&#39;NUT_CHLA&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb87-16"><a href="individual-parameter-analyses.html#cb87-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">NUT_CHLA_STAT =</span> <span class="cn">NA</span>) } <span class="co"># don&#39;t show a real assessment decision </span></span></code></pre></div>
<div id="nutrients-in-lakes" class="section level4" number="3.5.6.1">
<h4><span class="header-section-number">3.5.6.1</span> Nutrients in Lakes</h4>
<p>Nutrients are assessed in Virginia lakes and reservoirs based on lake-specific criteria <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section187/" target="_blank">Section 187</a>. Chlorophyll a and Total Phosphorus (TP) data collected in the top meter are assessed for Aquatic Life Use, with TP criteria only applying to stations designated in a lakeâ€™s lacustrine zone in lakes where algaecides are applied any time during the monitoring period. The lacustrine zone designation is communicated to the automated assessment process in the Station Table LACUSTRINE field.</p>
<p>Assessment guidance states:
â€œThe 90th percentile of chlorophyll data collected at one meter or less within the lacustrine portion of the man-made lake or reservoir between April 1 and October 31 (considered a lake monitoring year) shall not exceed the chlorophyll a criterion for that waterbody in each of the two most recent monitoring years within the assessment window. For a waterbody that received algaecide treatment, the median of the total phosphorus data collected at one meter or less within the lacustrine portion of the man-made lake or reservoir between April 1 and October 31 shall not exceed the total phosphorus criterion in each of the two most recent years that total phosphorus data are available. The aquatic life (fishery) use of any lake assessment unit is considered impaired for nutrients if the criterion for either chlorophyll a or total phosphorus is exceeded at a station or pooled stations in that unit in each of the two most recent monitoring years within the assessment window.â€</p>
<p>The TP and Chlorophyll a functions are designed to operate on individual station data and data from multiple stations (e.g.Â stations in the same AU).</p>
<div id="total-phosphorus-lakes" class="section level5" number="3.5.6.1.1">
<h5><span class="header-section-number">3.5.6.1.1</span> Total Phosphorus: Lakes</h5>
<p>Total Phosphorus (TP) is assessed using two functions, the <code>TP_analysis()</code> and <code>TP_Assessment()</code> functions. The <code>TP_analysis()</code> function calculates and compares annual median TP values to the lake-specific criteria, providing an output for the <code>TP_Assessment()</code> function to apply three year exceedance rules.</p>
<p>The <code>TP_analysis()</code> first verifies the station is a lacustrine station in a Section 187 lake. Next, all Level I and Level II data, missing data, data outside the sample season, and data greater than 1 meter depth are removed from further analyses steps. The median TP of each sample month is calculated before taking the median of each sample year, rounding the value to even, and comparing the results to the lake-specific TP criteria. The number of valid samples are totaled and returned with the annual median results and station lacustrine status.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="individual-parameter-analyses.html#cb88-1" aria-hidden="true" tabindex="-1"></a>TP_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb88-2"><a href="individual-parameter-analyses.html#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B))){</span>
<span id="cb88-3"><a href="individual-parameter-analyses.html#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B) <span class="sc">==</span> <span class="st">&#39;y&#39;</span>){</span>
<span id="cb88-4"><a href="individual-parameter-analyses.html#cb88-4" aria-hidden="true" tabindex="-1"></a>      stationData <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, LACUSTRINE <span class="sc">==</span> <span class="st">&#39;Y&#39;</span>)  }</span>
<span id="cb88-5"><a href="individual-parameter-analyses.html#cb88-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-6"><a href="individual-parameter-analyses.html#cb88-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-7"><a href="individual-parameter-analyses.html#cb88-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb88-8"><a href="individual-parameter-analyses.html#cb88-8" aria-hidden="true" tabindex="-1"></a>  TP <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, <span class="sc">!</span><span class="fu">is.na</span>(PHOSPHORUS_mg_L)) <span class="sc">%&gt;%</span></span>
<span id="cb88-9"><a href="individual-parameter-analyses.html#cb88-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(FDT_DEPTH <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Guidance calls for top meter only</span></span>
<span id="cb88-10"><a href="individual-parameter-analyses.html#cb88-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>( LEVEL_PHOSPHORUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb88-11"><a href="individual-parameter-analyses.html#cb88-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DEPTH, FDT_DATE_TIME, SampleDate, PHOSPHORUS_mg_L, <span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>, LACUSTRINE)<span class="sc">%&gt;%</span></span>
<span id="cb88-12"><a href="individual-parameter-analyses.html#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Year=</span> <span class="fu">year</span>(FDT_DATE_TIME), <span class="at">Month=</span><span class="fu">month</span>(FDT_DATE_TIME)) <span class="sc">%&gt;%</span></span>
<span id="cb88-13"><a href="individual-parameter-analyses.html#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)) <span class="co"># make sure only assess valid sample months</span></span>
<span id="cb88-14"><a href="individual-parameter-analyses.html#cb88-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(TP<span class="sc">$</span>FDT_STA_ID)) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb88-15"><a href="individual-parameter-analyses.html#cb88-15" aria-hidden="true" tabindex="-1"></a>    TPResults <span class="ot">&lt;-</span> TP <span class="sc">%&gt;%</span></span>
<span id="cb88-16"><a href="individual-parameter-analyses.html#cb88-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Month, Year) <span class="sc">%&gt;%</span></span>
<span id="cb88-17"><a href="individual-parameter-analyses.html#cb88-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">samplesPerMonth =</span> <span class="fu">n</span>(),</span>
<span id="cb88-18"><a href="individual-parameter-analyses.html#cb88-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">medianPHOSPHORUS_mg_L =</span> <span class="fu">median</span>(PHOSPHORUS_mg_L, <span class="at">na.rm =</span> T),</span>
<span id="cb88-19"><a href="individual-parameter-analyses.html#cb88-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb88-20"><a href="individual-parameter-analyses.html#cb88-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb88-21"><a href="individual-parameter-analyses.html#cb88-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb88-22"><a href="individual-parameter-analyses.html#cb88-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">samplesPerYear =</span> <span class="fu">n</span>(),</span>
<span id="cb88-23"><a href="individual-parameter-analyses.html#cb88-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">median</span>(medianPHOSPHORUS_mg_L, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb88-24"><a href="individual-parameter-analyses.html#cb88-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb88-25"><a href="individual-parameter-analyses.html#cb88-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">1</span>),  <span class="co"># one significant figures based on WQS https://lis.virginia.gov/cgi-bin/legp604.exe?000+reg+9VAC25-260-187&amp;000+reg+9VAC25-260-187</span></span>
<span id="cb88-26"><a href="individual-parameter-analyses.html#cb88-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">TP_Exceedance =</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>, T, F),</span>
<span id="cb88-27"><a href="individual-parameter-analyses.html#cb88-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">ID305B =</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>ID305B_1))  <span class="sc">%&gt;%</span></span>
<span id="cb88-28"><a href="individual-parameter-analyses.html#cb88-28" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID305B, Year, samplesPerYear, <span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span>, <span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span>, <span class="fu">everything</span>())</span>
<span id="cb88-29"><a href="individual-parameter-analyses.html#cb88-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb88-30"><a href="individual-parameter-analyses.html#cb88-30" aria-hidden="true" tabindex="-1"></a>    TPResults <span class="ot">&lt;-</span> TP <span class="sc">%&gt;%</span></span>
<span id="cb88-31"><a href="individual-parameter-analyses.html#cb88-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb88-32"><a href="individual-parameter-analyses.html#cb88-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">samplesPerYear =</span> <span class="fu">n</span>(),</span>
<span id="cb88-33"><a href="individual-parameter-analyses.html#cb88-33" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">median</span>(PHOSPHORUS_mg_L, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb88-34"><a href="individual-parameter-analyses.html#cb88-34" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">1</span>),  <span class="co"># one significant figures based on WQS https://lis.virginia.gov/cgi-bin/legp604.exe?000+reg+9VAC25-260-187&amp;000+reg+9VAC25-260-187</span></span>
<span id="cb88-35"><a href="individual-parameter-analyses.html#cb88-35" aria-hidden="true" tabindex="-1"></a>             <span class="at">TP_Exceedance =</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>, T, F)) <span class="sc">%&gt;%</span></span>
<span id="cb88-36"><a href="individual-parameter-analyses.html#cb88-36" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, Year, samplesPerYear, <span class="st">`</span><span class="at">Annual Median TP</span><span class="st">`</span>, <span class="st">`</span><span class="at">Annual Median TP Rounded to WQS Format</span><span class="st">`</span>,<span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>, TP_Exceedance, LACUSTRINE) <span class="sc">%&gt;%</span></span>
<span id="cb88-37"><a href="individual-parameter-analyses.html#cb88-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(Year, <span class="at">.keep_all=</span>T)</span>
<span id="cb88-38"><a href="individual-parameter-analyses.html#cb88-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb88-39"><a href="individual-parameter-analyses.html#cb88-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(TPResults)</span>
<span id="cb88-40"><a href="individual-parameter-analyses.html#cb88-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-41"><a href="individual-parameter-analyses.html#cb88-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-42"><a href="individual-parameter-analyses.html#cb88-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb88-43"><a href="individual-parameter-analyses.html#cb88-43" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb88-44"><a href="individual-parameter-analyses.html#cb88-44" aria-hidden="true" tabindex="-1"></a><span class="co">#TP_analysis(stationData)</span></span>
<span id="cb88-45"><a href="individual-parameter-analyses.html#cb88-45" aria-hidden="true" tabindex="-1"></a><span class="co">#TP_analysis(AUdata) # where AUdata is the stationData from all stations in the same AU</span></span></code></pre></div>
<p>The <code>TP_Assessment()</code> function analyzes and transforms annual TP results into the Station Table output format. The function first uses the <code>TP_analysis()</code> function to establish annual TP exceedance results. Annual TP results are only analyzed in years with six or greater samples. With nested if/else logic, the function identifies if/when any exceedances exist. If no exceedances occurred in the most recent two years, â€œSâ€ is returned in the status field. If both of the most recent two years exceeded median TP criteria, â€œIMâ€ is returned in the status field. If one of two years had a median TP exceedance, the third most recent year is brought in as a tiebreak. If two of the most recent three years have a median TP exceedance, â€œIMâ€ is returned in the status field, but if one in the most recent three years have a median TP exceedance then â€œReviewâ€ is returned in the status field. The sample count returned is the number of years analyzed in the analysis and the exceedance field reports the number of years where the median TP exceeds criteria in the most recent two or three years.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="individual-parameter-analyses.html#cb89-1" aria-hidden="true" tabindex="-1"></a>TP_Assessment <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb89-2"><a href="individual-parameter-analyses.html#cb89-2" aria-hidden="true" tabindex="-1"></a>  TP_Results <span class="ot">&lt;-</span> <span class="fu">TP_analysis</span>(stationData) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb89-3"><a href="individual-parameter-analyses.html#cb89-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-4"><a href="individual-parameter-analyses.html#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(TP_Results) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb89-5"><a href="individual-parameter-analyses.html#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">unique</span>(TP_Results<span class="sc">$</span><span class="st">`</span><span class="at">Total Phosphorus (mg/L)</span><span class="st">`</span>))){ <span class="co"># bail out if nutrient standards didn&#39;t join properly</span></span>
<span id="cb89-6"><a href="individual-parameter-analyses.html#cb89-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_TP_SAMP =</span> <span class="cn">NA</span>,   <span class="at">NUT_TP_STAT =</span> <span class="cn">NA</span>))}</span>
<span id="cb89-7"><a href="individual-parameter-analyses.html#cb89-7" aria-hidden="true" tabindex="-1"></a>    validYears <span class="ot">&lt;-</span> <span class="fu">filter</span>(TP_Results, samplesPerYear <span class="sc">&gt;=</span> <span class="dv">6</span>) <span class="co"># need at least 6 samples per year</span></span>
<span id="cb89-8"><a href="individual-parameter-analyses.html#cb89-8" aria-hidden="true" tabindex="-1"></a>    mostRecent2years <span class="ot">&lt;-</span> <span class="fu">slice_max</span>(validYears, Year, <span class="at">n =</span> <span class="dv">2</span>) <span class="co"># get most recent two years of results</span></span>
<span id="cb89-9"><a href="individual-parameter-analyses.html#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(mostRecent2years) <span class="sc">==</span> <span class="dv">2</span>){ </span>
<span id="cb89-10"><a href="individual-parameter-analyses.html#cb89-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">unique</span>(mostRecent2years<span class="sc">$</span>TP_Exceedance) <span class="sc">==</span> <span class="cn">FALSE</span>)){ <span class="co"># no exceedances in last two years</span></span>
<span id="cb89-11"><a href="individual-parameter-analyses.html#cb89-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="dv">0</span>, <span class="at">NUT_TP_SAMP =</span> <span class="fu">nrow</span>(mostRecent2years),  <span class="at">NUT_TP_STAT =</span> <span class="st">&#39;S&#39;</span>) )</span>
<span id="cb89-12"><a href="individual-parameter-analyses.html#cb89-12" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> { <span class="co"># at least one TP_Exceedance exists</span></span>
<span id="cb89-13"><a href="individual-parameter-analyses.html#cb89-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">unique</span>(mostRecent2years<span class="sc">$</span>TP_Exceedance) <span class="sc">==</span> <span class="cn">TRUE</span>)){ <span class="co"># both years exceed</span></span>
<span id="cb89-14"><a href="individual-parameter-analyses.html#cb89-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="fu">nrow</span>(mostRecent2years), <span class="at">NUT_TP_SAMP =</span> <span class="fu">nrow</span>(mostRecent2years),   <span class="at">NUT_TP_STAT =</span> <span class="st">&#39;IM&#39;</span>))</span>
<span id="cb89-15"><a href="individual-parameter-analyses.html#cb89-15" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> { <span class="co"># run a tiebreak with third most recent year</span></span>
<span id="cb89-16"><a href="individual-parameter-analyses.html#cb89-16" aria-hidden="true" tabindex="-1"></a>          mostRecent3years <span class="ot">&lt;-</span> <span class="fu">slice_max</span>(validYears, Year, <span class="at">n =</span> <span class="dv">3</span>)  <span class="co"># get most recent three years of results</span></span>
<span id="cb89-17"><a href="individual-parameter-analyses.html#cb89-17" aria-hidden="true" tabindex="-1"></a>          mostRecent3yearsExceed <span class="ot">&lt;-</span> <span class="fu">filter</span>(mostRecent3years, TP_Exceedance <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-18"><a href="individual-parameter-analyses.html#cb89-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">nrow</span>(mostRecent3yearsExceed) <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb89-19"><a href="individual-parameter-analyses.html#cb89-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="fu">nrow</span>(mostRecent3yearsExceed), <span class="at">NUT_TP_SAMP =</span> <span class="fu">nrow</span>(mostRecent3years),   <span class="at">NUT_TP_STAT =</span> <span class="st">&#39;IM&#39;</span>))</span>
<span id="cb89-20"><a href="individual-parameter-analyses.html#cb89-20" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb89-21"><a href="individual-parameter-analyses.html#cb89-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="fu">nrow</span>(mostRecent3yearsExceed), <span class="at">NUT_TP_SAMP =</span> <span class="fu">nrow</span>(mostRecent3years),   <span class="at">NUT_TP_STAT =</span> <span class="st">&#39;Review&#39;</span>)) }</span>
<span id="cb89-22"><a href="individual-parameter-analyses.html#cb89-22" aria-hidden="true" tabindex="-1"></a>        }}} <span class="cf">else</span> {<span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_TP_SAMP =</span> <span class="fu">nrow</span>(validYears), <span class="at">NUT_TP_STAT =</span> <span class="st">&#39;IN&#39;</span>) ) }</span>
<span id="cb89-23"><a href="individual-parameter-analyses.html#cb89-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {    <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_TP_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_TP_SAMP =</span> <span class="cn">NA</span>,   <span class="at">NUT_TP_STAT =</span> <span class="cn">NA</span>) )  }</span>
<span id="cb89-24"><a href="individual-parameter-analyses.html#cb89-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-25"><a href="individual-parameter-analyses.html#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="individual-parameter-analyses.html#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb89-27"><a href="individual-parameter-analyses.html#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb89-28"><a href="individual-parameter-analyses.html#cb89-28" aria-hidden="true" tabindex="-1"></a><span class="co">#TP_Assessment(stationData)</span></span>
<span id="cb89-29"><a href="individual-parameter-analyses.html#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="co">#TP_Assessment(AUdata) # where AUdata is the stationData from all stations in the same AU</span></span></code></pre></div>
</div>
<div id="chlorophyll-a-lakes" class="section level5" number="3.5.6.1.2">
<h5><span class="header-section-number">3.5.6.1.2</span> Chlorophyll a: Lakes</h5>
<p>Chlorophyll a is assessed using two functions, the <code>chlA_analysis()</code> and <code>chlA_Assessment()</code> functions. The <code>chlA_analysis()</code> function calculates and compares the annual 90th percentile of chlorophyll a values to the lake-specific criteria, providing an output for the <code>chlA_Assessment()</code> function to apply three year exceedance rules.</p>
<p>The <code>chlA_analysis()</code> first verifies the station is a lacustrine station in a Section 187 lake. Next, all Level I and Level II data, missing data, data outside the sample season, and data greater than 1 meter depth are removed from further analyses steps. The median chlorophyll a of each sample month is calculated before taking the 90th percentile of chlorophyll a values from each sample year, rounding the value to even, and comparing the results to the lake-specific chlorophyll a criteria. The number of valid samples are totaled and returned with the annual 90th percentile results and station lacustrine status.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="individual-parameter-analyses.html#cb90-1" aria-hidden="true" tabindex="-1"></a>chlA_analysis <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb90-2"><a href="individual-parameter-analyses.html#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B))){</span>
<span id="cb90-3"><a href="individual-parameter-analyses.html#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B) <span class="sc">==</span> <span class="st">&#39;y&#39;</span>){</span>
<span id="cb90-4"><a href="individual-parameter-analyses.html#cb90-4" aria-hidden="true" tabindex="-1"></a>      stationData <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, LACUSTRINE <span class="sc">==</span> <span class="st">&#39;Y&#39;</span>)  } }</span>
<span id="cb90-5"><a href="individual-parameter-analyses.html#cb90-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-6"><a href="individual-parameter-analyses.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  chla <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, <span class="sc">!</span><span class="fu">is.na</span>(CHLOROPHYLL_A_ug_L)) <span class="sc">%&gt;%</span></span>
<span id="cb90-7"><a href="individual-parameter-analyses.html#cb90-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(FDT_DEPTH <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Guidance calls for top meter only</span></span>
<span id="cb90-8"><a href="individual-parameter-analyses.html#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>( LEVEL_CHLOROPHYLL_A <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb90-9"><a href="individual-parameter-analyses.html#cb90-9" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DEPTH, FDT_DATE_TIME, SampleDate, CHLOROPHYLL_A_ug_L, <span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>, LACUSTRINE)<span class="sc">%&gt;%</span></span>
<span id="cb90-10"><a href="individual-parameter-analyses.html#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Year=</span> <span class="fu">year</span>(FDT_DATE_TIME), <span class="at">Month=</span><span class="fu">month</span>(FDT_DATE_TIME)) <span class="sc">%&gt;%</span></span>
<span id="cb90-11"><a href="individual-parameter-analyses.html#cb90-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Month <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>)) <span class="co"># make sure only assess valid sample months</span></span>
<span id="cb90-12"><a href="individual-parameter-analyses.html#cb90-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(chla<span class="sc">$</span>FDT_STA_ID)) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb90-13"><a href="individual-parameter-analyses.html#cb90-13" aria-hidden="true" tabindex="-1"></a>    chlaResults <span class="ot">&lt;-</span> chla <span class="sc">%&gt;%</span></span>
<span id="cb90-14"><a href="individual-parameter-analyses.html#cb90-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Month, Year) <span class="sc">%&gt;%</span></span>
<span id="cb90-15"><a href="individual-parameter-analyses.html#cb90-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">samplesPerMonth =</span> <span class="fu">n</span>(),</span>
<span id="cb90-16"><a href="individual-parameter-analyses.html#cb90-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">medianCHLOROPHYLL_A_ug_L =</span> <span class="fu">median</span>(CHLOROPHYLL_A_ug_L, <span class="at">na.rm =</span> T),</span>
<span id="cb90-17"><a href="individual-parameter-analyses.html#cb90-17" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb90-18"><a href="individual-parameter-analyses.html#cb90-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-19"><a href="individual-parameter-analyses.html#cb90-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb90-20"><a href="individual-parameter-analyses.html#cb90-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">samplesPerYear =</span> <span class="fu">n</span>(),</span>
<span id="cb90-21"><a href="individual-parameter-analyses.html#cb90-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">pct90 =</span> <span class="fu">quantile</span>(medianCHLOROPHYLL_A_ug_L, <span class="fl">0.9</span>),</span>
<span id="cb90-22"><a href="individual-parameter-analyses.html#cb90-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb90-23"><a href="individual-parameter-analyses.html#cb90-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(pct90, <span class="at">digits =</span> <span class="dv">2</span>),  <span class="co"># two significant figures based on WQS https://lis.virginia.gov/cgi-bin/legp604.exe?000+reg+9VAC25-260-187&amp;000+reg+9VAC25-260-187</span></span>
<span id="cb90-24"><a href="individual-parameter-analyses.html#cb90-24" aria-hidden="true" tabindex="-1"></a>             <span class="at">chlA_Exceedance =</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>, T, F),</span>
<span id="cb90-25"><a href="individual-parameter-analyses.html#cb90-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">ID305B =</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>ID305B_1))  <span class="sc">%&gt;%</span></span>
<span id="cb90-26"><a href="individual-parameter-analyses.html#cb90-26" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID305B, Year, samplesPerYear, pct90, <span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span>, <span class="fu">everything</span>())</span>
<span id="cb90-27"><a href="individual-parameter-analyses.html#cb90-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb90-28"><a href="individual-parameter-analyses.html#cb90-28" aria-hidden="true" tabindex="-1"></a>    chlaResults <span class="ot">&lt;-</span> chla <span class="sc">%&gt;%</span></span>
<span id="cb90-29"><a href="individual-parameter-analyses.html#cb90-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb90-30"><a href="individual-parameter-analyses.html#cb90-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">samplesPerYear =</span> <span class="fu">n</span>(),</span>
<span id="cb90-31"><a href="individual-parameter-analyses.html#cb90-31" aria-hidden="true" tabindex="-1"></a>             <span class="at">pct90 =</span> <span class="fu">quantile</span>(CHLOROPHYLL_A_ug_L, <span class="fl">0.9</span>),</span>
<span id="cb90-32"><a href="individual-parameter-analyses.html#cb90-32" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(pct90, <span class="at">digits =</span> <span class="dv">2</span>),  <span class="co"># two significant figures based on WQS https://lis.virginia.gov/cgi-bin/legp604.exe?000+reg+9VAC25-260-187&amp;000+reg+9VAC25-260-187</span></span>
<span id="cb90-33"><a href="individual-parameter-analyses.html#cb90-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">chlA_Exceedance =</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>, T, F)) <span class="sc">%&gt;%</span></span>
<span id="cb90-34"><a href="individual-parameter-analyses.html#cb90-34" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, Year, samplesPerYear, pct90, <span class="st">`</span><span class="at">90th Percentile Rounded to WQS Format</span><span class="st">`</span>,<span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>, chlA_Exceedance, LACUSTRINE) <span class="sc">%&gt;%</span></span>
<span id="cb90-35"><a href="individual-parameter-analyses.html#cb90-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(Year, <span class="at">.keep_all=</span>T)</span>
<span id="cb90-36"><a href="individual-parameter-analyses.html#cb90-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-37"><a href="individual-parameter-analyses.html#cb90-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(chlaResults)</span>
<span id="cb90-38"><a href="individual-parameter-analyses.html#cb90-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-39"><a href="individual-parameter-analyses.html#cb90-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb90-40"><a href="individual-parameter-analyses.html#cb90-40" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb90-41"><a href="individual-parameter-analyses.html#cb90-41" aria-hidden="true" tabindex="-1"></a><span class="co">#chlA_analysis(stationData)</span></span>
<span id="cb90-42"><a href="individual-parameter-analyses.html#cb90-42" aria-hidden="true" tabindex="-1"></a><span class="co">#chlA_analysis(AUdata) # where AUdata is the stationData from all stations in the same AU</span></span></code></pre></div>
<p>The <code>chlA_Assessment()</code> function analyzes and transforms annual chlorophyll a results into the Station Table output format. The function first uses the <code>chlA_analysis()</code> function to establish annual chlorophyll a exceedance results. Annual chlorophyll a results are only analyzed in years with six or greater samples. With nested if/else logic, the function identifies if/when any exceedances exist. If no exceedances occurred in the most recent two years, â€œSâ€ is returned in the status field. If both of the most recent two years exceeded the chlorophyll a criteria, â€œIMâ€ is returned in the status field. If one of two years had a chlorophyll a exceedance, the third most recent year is brought in as a tiebreak. If two of the most recent three years have a chlorophyll a exceedance, â€œIMâ€ is returned in the status field, but if one in the most recent three years have a chlorophyll a exceedance then â€œReviewâ€ is returned in the status field. The sample count returned is the number of years analyzed in the analysis and the exceedance field reports the number of years where the chlorophyll a exceeds criteria in the most recent two or three years.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="individual-parameter-analyses.html#cb91-1" aria-hidden="true" tabindex="-1"></a>chlA_Assessment <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb91-2"><a href="individual-parameter-analyses.html#cb91-2" aria-hidden="true" tabindex="-1"></a>  chlA_Results <span class="ot">&lt;-</span> <span class="fu">chlA_analysis</span>(stationData) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb91-3"><a href="individual-parameter-analyses.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-4"><a href="individual-parameter-analyses.html#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(chlA_Results) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb91-5"><a href="individual-parameter-analyses.html#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">unique</span>(chlA_Results<span class="sc">$</span><span class="st">`</span><span class="at">Chlorophyll a (ug/L)</span><span class="st">`</span>))){ <span class="co"># bail out if nutrient standards didn&#39;t join properly</span></span>
<span id="cb91-6"><a href="individual-parameter-analyses.html#cb91-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_CHLA_SAMP =</span> <span class="cn">NA</span>,   <span class="at">NUT_CHLA_STAT =</span> <span class="cn">NA</span>))}</span>
<span id="cb91-7"><a href="individual-parameter-analyses.html#cb91-7" aria-hidden="true" tabindex="-1"></a>    validYears <span class="ot">&lt;-</span> <span class="fu">filter</span>(chlA_Results, samplesPerYear <span class="sc">&gt;=</span> <span class="dv">6</span>) <span class="co"># need at least 6 samples per year</span></span>
<span id="cb91-8"><a href="individual-parameter-analyses.html#cb91-8" aria-hidden="true" tabindex="-1"></a>    mostRecent2years <span class="ot">&lt;-</span> <span class="fu">slice_max</span>(validYears, Year, <span class="at">n =</span> <span class="dv">2</span>) <span class="co"># get most recent two years of results</span></span>
<span id="cb91-9"><a href="individual-parameter-analyses.html#cb91-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(mostRecent2years) <span class="sc">==</span> <span class="dv">2</span>){ </span>
<span id="cb91-10"><a href="individual-parameter-analyses.html#cb91-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">unique</span>(mostRecent2years<span class="sc">$</span>chlA_Exceedance) <span class="sc">==</span> <span class="cn">FALSE</span>)){ <span class="co"># no exceedances in last two years</span></span>
<span id="cb91-11"><a href="individual-parameter-analyses.html#cb91-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="dv">0</span>, <span class="at">NUT_CHLA_SAMP =</span> <span class="fu">nrow</span>(mostRecent2years),  <span class="at">NUT_CHLA_STAT =</span> <span class="st">&#39;S&#39;</span>) )</span>
<span id="cb91-12"><a href="individual-parameter-analyses.html#cb91-12" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> { <span class="co"># at least one chlA_Exceedance exists</span></span>
<span id="cb91-13"><a href="individual-parameter-analyses.html#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">all</span>(<span class="fu">unique</span>(mostRecent2years<span class="sc">$</span>chlA_Exceedance)) <span class="sc">==</span> <span class="cn">TRUE</span>){ <span class="co"># both years exceed</span></span>
<span id="cb91-14"><a href="individual-parameter-analyses.html#cb91-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="fu">nrow</span>(mostRecent2years), <span class="at">NUT_CHLA_SAMP =</span> <span class="fu">nrow</span>(mostRecent2years),   <span class="at">NUT_CHLA_STAT =</span> <span class="st">&#39;IM&#39;</span>))</span>
<span id="cb91-15"><a href="individual-parameter-analyses.html#cb91-15" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> { <span class="co"># run a tiebreak with third most recent year</span></span>
<span id="cb91-16"><a href="individual-parameter-analyses.html#cb91-16" aria-hidden="true" tabindex="-1"></a>          mostRecent3years <span class="ot">&lt;-</span> <span class="fu">slice_max</span>(validYears, Year, <span class="at">n =</span> <span class="dv">3</span>) <span class="co"># get most recent three years of results</span></span>
<span id="cb91-17"><a href="individual-parameter-analyses.html#cb91-17" aria-hidden="true" tabindex="-1"></a>          mostRecent3yearsExceed <span class="ot">&lt;-</span> <span class="fu">filter</span>(mostRecent3years, chlA_Exceedance <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-18"><a href="individual-parameter-analyses.html#cb91-18" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">nrow</span>(mostRecent3yearsExceed) <span class="sc">&gt;=</span> <span class="dv">2</span>){</span>
<span id="cb91-19"><a href="individual-parameter-analyses.html#cb91-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="fu">nrow</span>(mostRecent3yearsExceed), <span class="at">NUT_CHLA_SAMP =</span> <span class="fu">nrow</span>(mostRecent3years),   <span class="at">NUT_CHLA_STAT =</span> <span class="st">&#39;IM&#39;</span>))</span>
<span id="cb91-20"><a href="individual-parameter-analyses.html#cb91-20" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb91-21"><a href="individual-parameter-analyses.html#cb91-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="fu">nrow</span>(mostRecent3yearsExceed), <span class="at">NUT_CHLA_SAMP =</span> <span class="fu">nrow</span>(mostRecent3years),   <span class="at">NUT_CHLA_STAT =</span> <span class="st">&#39;Review&#39;</span>)) }</span>
<span id="cb91-22"><a href="individual-parameter-analyses.html#cb91-22" aria-hidden="true" tabindex="-1"></a>        }}} <span class="cf">else</span> {<span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_CHLA_SAMP =</span> <span class="fu">nrow</span>(validYears), <span class="at">NUT_CHLA_STAT =</span> <span class="st">&#39;IN&#39;</span>) ) }</span>
<span id="cb91-23"><a href="individual-parameter-analyses.html#cb91-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {    <span class="fu">return</span>(<span class="fu">tibble</span>(<span class="at">NUT_CHLA_EXC=</span> <span class="cn">NA</span>, <span class="at">NUT_CHLA_SAMP =</span> <span class="cn">NA</span>, <span class="at">NUT_CHLA_STAT =</span> <span class="cn">NA</span>) )  }</span>
<span id="cb91-24"><a href="individual-parameter-analyses.html#cb91-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-25"><a href="individual-parameter-analyses.html#cb91-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-26"><a href="individual-parameter-analyses.html#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb91-27"><a href="individual-parameter-analyses.html#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb91-28"><a href="individual-parameter-analyses.html#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="co">#chlA_Assessment(stationData)</span></span>
<span id="cb91-29"><a href="individual-parameter-analyses.html#cb91-29" aria-hidden="true" tabindex="-1"></a><span class="co">#chlA_analysis(AUdata) # where AUdata is the stationData from all stations in the same AU</span></span></code></pre></div>
</div>
</div>
<div id="nutrients-in-other-waterbodies" class="section level4" number="3.5.6.2">
<h4><span class="header-section-number">3.5.6.2</span> Nutrients in Other Waterbodies</h4>
<p>Non-lake station use the <code>countNutrients()</code> function to sum nutrient samples for the Station Table. Using non-standard evaluation techniques in the function arguments allows users to specify which parameter to evaluate and the associated criteria. Criteria or thresholds may be established in the <code>nutrientLimit</code> function arguments for analytical purposes, but NA is used for the Station Table output. All Level I and Level II data and missing data are removed for the selected parameter before the samples compared against the value in the <code>nutrientLimit</code> argument. The <code>quickStats()</code> function can then use that output to efficiently tabulate the number of samples and exceedances.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="individual-parameter-analyses.html#cb92-1" aria-hidden="true" tabindex="-1"></a>countNutrients <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, fieldName, commentName, nutrientLimit){</span>
<span id="cb92-2"><a href="individual-parameter-analyses.html#cb92-2" aria-hidden="true" tabindex="-1"></a>  fieldName_ <span class="ot">&lt;-</span> <span class="fu">enquo</span>(fieldName)</span>
<span id="cb92-3"><a href="individual-parameter-analyses.html#cb92-3" aria-hidden="true" tabindex="-1"></a>  commentName_ <span class="ot">&lt;-</span> <span class="fu">enquo</span>(commentName)</span>
<span id="cb92-4"><a href="individual-parameter-analyses.html#cb92-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-5"><a href="individual-parameter-analyses.html#cb92-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(stationData,FDT_STA_ID,FDT_DATE_TIME, <span class="sc">!!</span> fieldName_, <span class="sc">!!</span> commentName_)<span class="sc">%&gt;%</span> <span class="co"># Just get relevant columns</span></span>
<span id="cb92-6"><a href="individual-parameter-analyses.html#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>( <span class="sc">!!</span> commentName_ <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb92-7"><a href="individual-parameter-analyses.html#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span>fieldName_ )) <span class="sc">%&gt;%</span> <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb92-8"><a href="individual-parameter-analyses.html#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">parameter =</span> <span class="sc">!!</span><span class="fu">names</span>(.[<span class="dv">3</span>])) <span class="sc">%&gt;%</span> <span class="co"># rename columns to make functions easier to apply</span></span>
<span id="cb92-9"><a href="individual-parameter-analyses.html#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">limit =</span> nutrientLimit, </span>
<span id="cb92-10"><a href="individual-parameter-analyses.html#cb92-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">exceeds =</span> <span class="fu">ifelse</span>(parameter <span class="sc">&gt;</span> limit, T, F)) <span class="co"># Identify where above WQS limit</span></span>
<span id="cb92-11"><a href="individual-parameter-analyses.html#cb92-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb92-12"><a href="individual-parameter-analyses.html#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="individual-parameter-analyses.html#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb92-14"><a href="individual-parameter-analyses.html#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData object is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb92-15"><a href="individual-parameter-analyses.html#cb92-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-16"><a href="individual-parameter-analyses.html#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="co"># countNutrients(stationData, PHOSPHORUS_mg_L, LEVEL_PHOSPHORUS, 0.2) %&gt;%</span></span>
<span id="cb92-17"><a href="individual-parameter-analyses.html#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;NUT_TP&#39;)</span></span>
<span id="cb92-18"><a href="individual-parameter-analyses.html#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="co"># countNutrients(stationData, CHLOROPHYLL_A_ug_L, LEVEL_CHLOROPHYLL_A, NA)  %&gt;%</span></span>
<span id="cb92-19"><a href="individual-parameter-analyses.html#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;NUT_CHLA&#39;)</span></span></code></pre></div>
</div>
<div id="trophic-state-index-tsi-lakes" class="section level4" number="3.5.6.3">
<h4><span class="header-section-number">3.5.6.3</span> Trophic State Index (TSI): Lakes</h4>
<p>TSI is calculated for lakes not defined in <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section187/" target="_blank">Section 187</a> of the Virginia Water Quality Standards (e.g.Â lakes without nutrient criteria). The <a href="Carlson,%20R.E.%201977.%20A%20trophic%20state%20index%20for%20lakes.%20Limnology%20and%20Oceanography.%2022:361-369.">Carlson</a> TSI equations use secchi depth (SD), surface chlorophyll a (CA), and surface total phosphorus (TP) to estimate algal biomass to determine if DO problems in lakes and reservoirs are natural. These calculations are applied to stratified lakes using aggregated station data from mid-June through mid-September. The TSI index is calculated with equations for secchi depth, chlorophyll a, and TP, each resulting in a continuous variable from 0-100. If any of the parameters results in index values of 60 or greater, nutrient enrichment could be adversely affecting the waterbodyâ€™s designated uses.</p>
<p>The <code>TSIcalculation()</code> function calculates all three TSI equations for individual stations not designated as Section 187 lakes (in the linked WQS metadata). Depth and temporal filters established by the WQA Guidance are applied to the station dataset and sample secchi depth measures are carried across all relevant measures (because secchi depth measures are only stored at the 0.3 meter depth record for all samples). All Level I and Level II data and missing data are removed from each parameter before measures are run through the appropriate TSI equation. The mean of each parameter TSI index results is calculated and reported back with a listcolumn of associated data.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="individual-parameter-analyses.html#cb93-1" aria-hidden="true" tabindex="-1"></a>TSIcalculation <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb93-2"><a href="individual-parameter-analyses.html#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>lakeStation) <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb93-3"><a href="individual-parameter-analyses.html#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>Lakes_187B))){</span>
<span id="cb93-4"><a href="individual-parameter-analyses.html#cb93-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># first fill down secchi depth in case it isn&#39;t stored exactly at 0.3 meter</span></span>
<span id="cb93-5"><a href="individual-parameter-analyses.html#cb93-5" aria-hidden="true" tabindex="-1"></a>      secchiFix <span class="ot">&lt;-</span> stationData <span class="sc">%&gt;%</span></span>
<span id="cb93-6"><a href="individual-parameter-analyses.html#cb93-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(FDT_STA_ID, FDT_DATE_TIME) <span class="sc">%&gt;%</span> </span>
<span id="cb93-7"><a href="individual-parameter-analyses.html#cb93-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">fill</span>(SECCHI_DEPTH_M, <span class="at">.direction =</span> <span class="st">&quot;downup&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb93-8"><a href="individual-parameter-analyses.html#cb93-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(FDT_DEPTH <span class="sc">&lt;=</span> <span class="fl">0.3</span>) <span class="sc">%&gt;%</span></span>
<span id="cb93-9"><a href="individual-parameter-analyses.html#cb93-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># remove all data except those from mid June through mid September (going with June 15 and Sept 15 since guidance does not specify)</span></span>
<span id="cb93-10"><a href="individual-parameter-analyses.html#cb93-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">monthday =</span> <span class="fu">as.numeric</span>(<span class="fu">paste0</span>(<span class="fu">month</span>(FDT_DATE_TIME), <span class="fu">day</span>(FDT_DATE_TIME)))) <span class="sc">%&gt;%</span></span>
<span id="cb93-11"><a href="individual-parameter-analyses.html#cb93-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="fu">between</span>(monthday, <span class="dv">615</span>, <span class="dv">915</span> )) <span class="sc">%&gt;%</span></span>
<span id="cb93-12"><a href="individual-parameter-analyses.html#cb93-12" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>monthday)</span>
<span id="cb93-13"><a href="individual-parameter-analyses.html#cb93-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-14"><a href="individual-parameter-analyses.html#cb93-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate Secchi depth TSI</span></span>
<span id="cb93-15"><a href="individual-parameter-analyses.html#cb93-15" aria-hidden="true" tabindex="-1"></a>      SDdata <span class="ot">&lt;-</span> <span class="fu">filter</span>(secchiFix, <span class="sc">!</span><span class="fu">is.na</span>(SECCHI_DEPTH_M) ) <span class="sc">%&gt;%</span></span>
<span id="cb93-16"><a href="individual-parameter-analyses.html#cb93-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span>( LEVEL_SECCHI_DEPTH <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb93-17"><a href="individual-parameter-analyses.html#cb93-17" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH,SECCHI_DEPTH_M) <span class="sc">%&gt;%</span></span>
<span id="cb93-18"><a href="individual-parameter-analyses.html#cb93-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">TSI_SD =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fu">log</span>(SECCHI_DEPTH_M) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>))) )</span>
<span id="cb93-19"><a href="individual-parameter-analyses.html#cb93-19" aria-hidden="true" tabindex="-1"></a>      SD <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">suppressMessages</span>(</span>
<span id="cb93-20"><a href="individual-parameter-analyses.html#cb93-20" aria-hidden="true" tabindex="-1"></a>        SDdata <span class="sc">%&gt;%</span></span>
<span id="cb93-21"><a href="individual-parameter-analyses.html#cb93-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(FDT_STA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb93-22"><a href="individual-parameter-analyses.html#cb93-22" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">meanSD =</span> <span class="fu">mean</span>(SECCHI_DEPTH_M, <span class="at">na.rm =</span> T), <span class="co"># take average of all secchi depths first</span></span>
<span id="cb93-23"><a href="individual-parameter-analyses.html#cb93-23" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TSI_SD =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fu">log</span>(meanSD) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>))) ) ))<span class="co"># log() is natural log in R</span></span>
<span id="cb93-24"><a href="individual-parameter-analyses.html#cb93-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-25"><a href="individual-parameter-analyses.html#cb93-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate Chlorophyll a TSI</span></span>
<span id="cb93-26"><a href="individual-parameter-analyses.html#cb93-26" aria-hidden="true" tabindex="-1"></a>      chlaData <span class="ot">&lt;-</span> <span class="fu">filter</span>(secchiFix, <span class="sc">!</span><span class="fu">is.na</span>(CHLOROPHYLL_A_ug_L) ) <span class="sc">%&gt;%</span></span>
<span id="cb93-27"><a href="individual-parameter-analyses.html#cb93-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span>( LEVEL_CHLOROPHYLL_A <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb93-28"><a href="individual-parameter-analyses.html#cb93-28" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, CHLOROPHYLL_A_ug_L) <span class="sc">%&gt;%</span></span>
<span id="cb93-29"><a href="individual-parameter-analyses.html#cb93-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">TSI_chla =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fl">2.04</span> <span class="sc">-</span> <span class="fl">0.68</span> <span class="sc">*</span> (<span class="fu">log</span>( CHLOROPHYLL_A_ug_L))) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>))) </span>
<span id="cb93-30"><a href="individual-parameter-analyses.html#cb93-30" aria-hidden="true" tabindex="-1"></a>      chla <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">suppressMessages</span>(</span>
<span id="cb93-31"><a href="individual-parameter-analyses.html#cb93-31" aria-hidden="true" tabindex="-1"></a>        chlaData <span class="sc">%&gt;%</span> </span>
<span id="cb93-32"><a href="individual-parameter-analyses.html#cb93-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(FDT_STA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb93-33"><a href="individual-parameter-analyses.html#cb93-33" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">meanchla =</span> <span class="fu">mean</span>(CHLOROPHYLL_A_ug_L, <span class="at">na.rm =</span> T), <span class="co"># take average of all chl a first</span></span>
<span id="cb93-34"><a href="individual-parameter-analyses.html#cb93-34" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TSI_chla =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fl">2.04</span> <span class="sc">-</span> <span class="fl">0.68</span> <span class="sc">*</span> (<span class="fu">log</span>(meanchla))) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>)))  ))<span class="co"># log() is natural log in R</span></span>
<span id="cb93-35"><a href="individual-parameter-analyses.html#cb93-35" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-36"><a href="individual-parameter-analyses.html#cb93-36" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate Total Phosphorus TSI</span></span>
<span id="cb93-37"><a href="individual-parameter-analyses.html#cb93-37" aria-hidden="true" tabindex="-1"></a>      TPdata <span class="ot">&lt;-</span> <span class="fu">filter</span>(secchiFix, <span class="sc">!</span><span class="fu">is.na</span>(PHOSPHORUS_mg_L) ) <span class="sc">%&gt;%</span></span>
<span id="cb93-38"><a href="individual-parameter-analyses.html#cb93-38" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span>( LEVEL_PHOSPHORUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb93-39"><a href="individual-parameter-analyses.html#cb93-39" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, PHOSPHORUS_mg_L) <span class="sc">%&gt;%</span></span>
<span id="cb93-40"><a href="individual-parameter-analyses.html#cb93-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">PHOSPHORUS_ug_L =</span> PHOSPHORUS_mg_L <span class="sc">*</span> <span class="dv">1000</span>,<span class="co"># first convert mg/L to ug/L</span></span>
<span id="cb93-41"><a href="individual-parameter-analyses.html#cb93-41" aria-hidden="true" tabindex="-1"></a>                 <span class="at">TSI_TP =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fu">log</span>( (<span class="dv">48</span> <span class="sc">/</span> PHOSPHORUS_ug_L )) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>))) )   </span>
<span id="cb93-42"><a href="individual-parameter-analyses.html#cb93-42" aria-hidden="true" tabindex="-1"></a>      TP <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">suppressMessages</span>(</span>
<span id="cb93-43"><a href="individual-parameter-analyses.html#cb93-43" aria-hidden="true" tabindex="-1"></a>        TPdata <span class="sc">%&gt;%</span></span>
<span id="cb93-44"><a href="individual-parameter-analyses.html#cb93-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(FDT_STA_ID) <span class="sc">%&gt;%</span></span>
<span id="cb93-45"><a href="individual-parameter-analyses.html#cb93-45" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">meanTP =</span> <span class="fu">mean</span>(PHOSPHORUS_ug_L, <span class="at">na.rm =</span> T), <span class="co"># take average of all TP first</span></span>
<span id="cb93-46"><a href="individual-parameter-analyses.html#cb93-46" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TSI_TP =</span> <span class="dv">10</span><span class="sc">*</span>(<span class="dv">6</span> <span class="sc">-</span> (<span class="fu">log</span>( (<span class="dv">48</span> <span class="sc">/</span> meanTP)) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">2</span>))) ) ))<span class="co"># log() is natural log in R</span></span>
<span id="cb93-47"><a href="individual-parameter-analyses.html#cb93-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-48"><a href="individual-parameter-analyses.html#cb93-48" aria-hidden="true" tabindex="-1"></a>      TSI <span class="ot">&lt;-</span> <span class="fu">full_join</span>(SD, chla, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-49"><a href="individual-parameter-analyses.html#cb93-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">full_join</span>(TP, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-50"><a href="individual-parameter-analyses.html#cb93-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(<span class="fu">full_join</span>(SDdata, chlaData, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;FDT_DATE_TIME&#39;</span>, <span class="st">&#39;FDT_DEPTH&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-51"><a href="individual-parameter-analyses.html#cb93-51" aria-hidden="true" tabindex="-1"></a>                                                 <span class="fu">full_join</span>(TPdata, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;FDT_DATE_TIME&#39;</span>, <span class="st">&#39;FDT_DEPTH&#39;</span>))) ))</span>
<span id="cb93-52"><a href="individual-parameter-analyses.html#cb93-52" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-53"><a href="individual-parameter-analyses.html#cb93-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(TSI)</span>
<span id="cb93-54"><a href="individual-parameter-analyses.html#cb93-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb93-55"><a href="individual-parameter-analyses.html#cb93-55" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb93-56"><a href="individual-parameter-analyses.html#cb93-56" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {<span class="fu">return</span>(<span class="cn">NULL</span>)} </span>
<span id="cb93-57"><a href="individual-parameter-analyses.html#cb93-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-58"><a href="individual-parameter-analyses.html#cb93-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-59"><a href="individual-parameter-analyses.html#cb93-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-60"><a href="individual-parameter-analyses.html#cb93-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb93-61"><a href="individual-parameter-analyses.html#cb93-61" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb93-62"><a href="individual-parameter-analyses.html#cb93-62" aria-hidden="true" tabindex="-1"></a><span class="co"># TSIcalculation(stationData)</span></span></code></pre></div>
</div>
</div>
<div id="ammonia" class="section level3" number="3.5.7">
<h3><span class="header-section-number">3.5.7</span> Ammonia</h3>
<p><a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/" target="_blank">Ammonia</a> is evaluated using acute, chronic, and four-day criteria across rolling three year windows that may not exceed more than once every three years on the average in free flowing streams. The presence or absence of trout, freshwater mussel species, and early life stages of fish during most times of the year each affect the calculation of ammonia criteria for a given waterbody. The WQS state that <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/" target="&quot;_blank">â€œthe Department of Environmental Quality, after consultation with the Virginia Department of Wildlife Resources and the U.S. Fish and Wildlife Service, has determined that the majority of Virginia freshwaters are likely to contain, or have contained in the past, freshwater mussel species in the family Unionidae and contain early life stages of fish during most times of the year. Therefore, the ammonia criteria presented in subsections B and C of this section are designed to provide protection to these species and life stages.â€</a> In practice, this means, unless demonstrated otherwise, mussels and fish early life stages are assumed present for criteria method calculations. Once the method for criteria calculation has been established for a waterbody, individual temperature and pH measurements are required to calculate individual criteria, and averages of these parameters are required when more than one measure is present within a given criteria window (for chronic, 30 day, and four day criteria).</p>
<p>Ammonia is a complicated criteria to program and understand. The automated assessment scripts have organized ammonia criteria calculation into nested functions such that individual components of the analysis can be extracted when needed (e.g.Â during interactive application data visualization). To expedite application rendering time, calculated ammonia results are stored in a R dataset (.RDS) and provided to the application instead of recalculating the criteria on the fly in the application. As such, the WQS (including trout present/absent) attributed to a station in the metadata attribution process as well as mussels and early life fish stages present values are the default values when exploring ammonia criteria analyses in the interactive waterbody-specific shiny assessment applications. Should sufficient justification exist to depart from these default values for individual stations, please contact the <a href="wqa-technical-support-team.html#wqa-technical-support-team">WQA Technical Support Team</a>.</p>
<div id="freshwaternh3limit" class="section level4" number="3.5.7.1">
<h4><span class="header-section-number">3.5.7.1</span> freshwaterNH3limit</h4>
<p>The calculation and application of ammonia criteria is performed by the <code>freshwaterNH3limit()</code> function. This function takes in data from one station (<code>stationData</code> argument) as well as three additional boolean (TRUE/FALSE) arguments: <code>trout</code> (trout present/absent), <code>mussels</code> (mussels present/absent), and <code>earlyLife</code> (early life stages of fish present/absent). The <code>trout</code> argument determined by the associated WQS Class where Class V and VI waters indicate trout are present and any other class indicates trout are absent. As stated above, the <code>mussels</code> and <code>earlyLife</code> arguments are default set to TRUE to be most protective, but should justification exist, these options may be toggled to FALSE and result in different criteria methods applied to the data.</p>
<p>This function is complicated and will be explained using the order of operations presented internally. Running through each scenario individually could assist understanding of the logic. First, since this is a computationally-intensive function, if no data are available to be analyzed, the function returns NULL. If data are present, the function removes all Level I and Level II data, missing data, and data greater than 1 meter depth before rechecking whether data are there for analysis and returning NULL if not.</p>
<p>The function then creates storage objects for acute, chronic, and four day average results and loops through each row of data to correctly calculate acute criteria and find any chronic scenarios (and then run a 4 day analysis if data exist). Each new sample event prompts the creation of acute, chronic, and four day data windows. If sufficient data exist in any of these windows, the window temperature and pH averages are used to calculate ammonia criteria based on the scenario arguments established above for comparison to the window ammonia average, rounded to even. Chronic and four day windows are only calculated if more than one result exists in those data windows. The data analyzed within each window is saved as a listcolumn called <code>associatedData</code> that may be extracted for investigation later. The output of the function is a long dataset where each unique sample event could have a row summarizing the acute, chronic, and four day calculated criteria, sample count in the given window, exceedance result, and associated data (<code>associatedData</code> listcolumn).</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="individual-parameter-analyses.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate limits and return dataframe with original data and limits 9VAC25-260-155 https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/</span></span>
<span id="cb94-2"><a href="individual-parameter-analyses.html#cb94-2" aria-hidden="true" tabindex="-1"></a>freshwaterNH3limit <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, <span class="co"># dataframe with station data</span></span>
<span id="cb94-3"><a href="individual-parameter-analyses.html#cb94-3" aria-hidden="true" tabindex="-1"></a>                               trout, <span class="co"># T/F condition</span></span>
<span id="cb94-4"><a href="individual-parameter-analyses.html#cb94-4" aria-hidden="true" tabindex="-1"></a>                               mussels,<span class="co"># T/F condition</span></span>
<span id="cb94-5"><a href="individual-parameter-analyses.html#cb94-5" aria-hidden="true" tabindex="-1"></a>                               earlyLife<span class="co"># T/F condition</span></span>
<span id="cb94-6"><a href="individual-parameter-analyses.html#cb94-6" aria-hidden="true" tabindex="-1"></a>){</span>
<span id="cb94-7"><a href="individual-parameter-analyses.html#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no data, return nothing</span></span>
<span id="cb94-8"><a href="individual-parameter-analyses.html#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationData)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb94-9"><a href="individual-parameter-analyses.html#cb94-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-10"><a href="individual-parameter-analyses.html#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any data that shouldn&#39;t be considered</span></span>
<span id="cb94-11"><a href="individual-parameter-analyses.html#cb94-11" aria-hidden="true" tabindex="-1"></a>  stationDataAmmonia <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, <span class="sc">!</span>(LEVEL_FDT_TEMP_CELCIUS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>)) <span class="sc">|</span></span>
<span id="cb94-12"><a href="individual-parameter-analyses.html#cb94-12" aria-hidden="true" tabindex="-1"></a>                                 <span class="sc">!</span>(LEVEL_FDT_FIELD_PH <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb94-13"><a href="individual-parameter-analyses.html#cb94-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # lake stations should only be surface sample</span></span>
<span id="cb94-14"><a href="individual-parameter-analyses.html#cb94-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># {if(unique(stationData$lakeStation) == TRUE)</span></span>
<span id="cb94-15"><a href="individual-parameter-analyses.html#cb94-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(., FDT_DEPTH <span class="sc">&lt;=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span>  <span class="co"># all samples should be &lt; 1m (this allows for 0.3m surface samples and 0m integrated samples)</span></span>
<span id="cb94-16"><a href="individual-parameter-analyses.html#cb94-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># else . } %&gt;%</span></span>
<span id="cb94-17"><a href="individual-parameter-analyses.html#cb94-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(AMMONIA_mg_L)) <span class="sc">%&gt;%</span> <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb94-18"><a href="individual-parameter-analyses.html#cb94-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, FDT_TEMP_CELCIUS, FDT_FIELD_PH, AMMONIA_mg_L) <span class="sc">%&gt;%</span> </span>
<span id="cb94-19"><a href="individual-parameter-analyses.html#cb94-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># can only run analysis if all above variable are populated for a given date/time</span></span>
<span id="cb94-20"><a href="individual-parameter-analyses.html#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(FDT_TEMP_CELCIUS) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(FDT_FIELD_PH))</span>
<span id="cb94-21"><a href="individual-parameter-analyses.html#cb94-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no data, return nothing</span></span>
<span id="cb94-22"><a href="individual-parameter-analyses.html#cb94-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationDataAmmonia)<span class="sc">==</span><span class="dv">0</span>){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb94-23"><a href="individual-parameter-analyses.html#cb94-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-24"><a href="individual-parameter-analyses.html#cb94-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-25"><a href="individual-parameter-analyses.html#cb94-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a place to store analysis results</span></span>
<span id="cb94-26"><a href="individual-parameter-analyses.html#cb94-26" aria-hidden="true" tabindex="-1"></a>  acuteCriteriaResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">WindowDateTimeStart =</span> <span class="fu">as.POSIXct</span>(<span class="cn">NA</span>), </span>
<span id="cb94-27"><a href="individual-parameter-analyses.html#cb94-27" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">FDT_DEPTH =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),<span class="co"># character so we can concatenate multiple depth values if needed</span></span>
<span id="cb94-28"><a href="individual-parameter-analyses.html#cb94-28" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">Value =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ValueType =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), </span>
<span id="cb94-29"><a href="individual-parameter-analyses.html#cb94-29" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb94-30"><a href="individual-parameter-analyses.html#cb94-30" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb94-31"><a href="individual-parameter-analyses.html#cb94-31" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">parameterRound =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">Exceedance =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb94-32"><a href="individual-parameter-analyses.html#cb94-32" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">associatedData =</span> <span class="fu">list</span>())</span>
<span id="cb94-33"><a href="individual-parameter-analyses.html#cb94-33" aria-hidden="true" tabindex="-1"></a>  chronicCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults</span>
<span id="cb94-34"><a href="individual-parameter-analyses.html#cb94-34" aria-hidden="true" tabindex="-1"></a>  fourDayCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults</span>
<span id="cb94-35"><a href="individual-parameter-analyses.html#cb94-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-36"><a href="individual-parameter-analyses.html#cb94-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through each row of data to correctly calculate acute criteria and find any chronic scenarios (and then </span></span>
<span id="cb94-37"><a href="individual-parameter-analyses.html#cb94-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   run a 4 day analysis if data exist)</span></span>
<span id="cb94-38"><a href="individual-parameter-analyses.html#cb94-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> stationDataAmmonia<span class="sc">$</span>FDT_DATE_TIME){  <span class="co">#k = stationDataAmmonia$FDT_DATE_TIME[2]</span></span>
<span id="cb94-39"><a href="individual-parameter-analyses.html#cb94-39" aria-hidden="true" tabindex="-1"></a>    acuteDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationDataAmmonia,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>)))</span>
<span id="cb94-40"><a href="individual-parameter-analyses.html#cb94-40" aria-hidden="true" tabindex="-1"></a>    chronicDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationDataAmmonia,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">30</span>)))</span>
<span id="cb94-41"><a href="individual-parameter-analyses.html#cb94-41" aria-hidden="true" tabindex="-1"></a>    fourDayDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationDataAmmonia,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">4</span>)))</span>
<span id="cb94-42"><a href="individual-parameter-analyses.html#cb94-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-43"><a href="individual-parameter-analyses.html#cb94-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-44"><a href="individual-parameter-analyses.html#cb94-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run acute analysis if data exists</span></span>
<span id="cb94-45"><a href="individual-parameter-analyses.html#cb94-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Acute is calculated on 1 hour windows, so we need to average temperature and pH within each 1 hour window before we can calculate an</span></span>
<span id="cb94-46"><a href="individual-parameter-analyses.html#cb94-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  acute criteria. There are no rules on how many samples need to occur in a 1 hour window for the window to be valid, but chronic and</span></span>
<span id="cb94-47"><a href="individual-parameter-analyses.html#cb94-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  4 day criteria require &gt; 1 sample to be analyzed.</span></span>
<span id="cb94-48"><a href="individual-parameter-analyses.html#cb94-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-49"><a href="individual-parameter-analyses.html#cb94-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Acute criteria can combine multiple depths in calculation of criteria, &lt;1m difference (which is taken care of above)</span></span>
<span id="cb94-50"><a href="individual-parameter-analyses.html#cb94-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-51"><a href="individual-parameter-analyses.html#cb94-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(acuteDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb94-52"><a href="individual-parameter-analyses.html#cb94-52" aria-hidden="true" tabindex="-1"></a>      acuteDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>( </span>
<span id="cb94-53"><a href="individual-parameter-analyses.html#cb94-53" aria-hidden="true" tabindex="-1"></a>        acuteDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb94-54"><a href="individual-parameter-analyses.html#cb94-54" aria-hidden="true" tabindex="-1"></a>          <span class="co">#  group_by(FDT_STA_ID) %&gt;% # for some reason if multiple depths but 1 stationID get 2 rows when group_by(FDT_STA_ID)</span></span>
<span id="cb94-55"><a href="individual-parameter-analyses.html#cb94-55" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">paste0</span>(<span class="fu">unique</span>(FDT_STA_ID), <span class="at">collapse =</span> <span class="st">&#39; &#39;</span>), <span class="do">### this is the ugly fix to problem identified above</span></span>
<span id="cb94-56"><a href="individual-parameter-analyses.html#cb94-56" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FDT_DEPTH =</span> <span class="fu">paste0</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(FDT_DEPTH)), <span class="at">collapse =</span> <span class="st">&#39; | &#39;</span>),</span>
<span id="cb94-57"><a href="individual-parameter-analyses.html#cb94-57" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TempValue =</span> <span class="fu">mean</span>(FDT_TEMP_CELCIUS, <span class="at">na.rm=</span>T),  <span class="co"># get hourly average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-58"><a href="individual-parameter-analyses.html#cb94-58" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pHValue =</span> <span class="fu">mean</span>(FDT_FIELD_PH, <span class="at">na.rm=</span>T),  <span class="co"># get hourly average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-59"><a href="individual-parameter-analyses.html#cb94-59" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Value =</span> <span class="fu">mean</span>(AMMONIA_mg_L, <span class="at">na.rm=</span>T),  <span class="co"># get hourly average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-60"><a href="individual-parameter-analyses.html#cb94-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">length</span>(AMMONIA_mg_L)) <span class="sc">%&gt;%</span>  <span class="co">#count sample that made up average</span></span>
<span id="cb94-61"><a href="individual-parameter-analyses.html#cb94-61" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Hourly Average&#39;</span>,</span>
<span id="cb94-62"><a href="individual-parameter-analyses.html#cb94-62" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ID =</span> <span class="fu">paste</span>( FDT_STA_ID, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>), <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb94-63"><a href="individual-parameter-analyses.html#cb94-63" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Acute&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb94-64"><a href="individual-parameter-analyses.html#cb94-64" aria-hidden="true" tabindex="-1"></a>          {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span>)  <span class="co"># Trout &amp; mussels present scenario</span></span>
<span id="cb94-65"><a href="individual-parameter-analyses.html#cb94-65" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-66"><a href="individual-parameter-analyses.html#cb94-66" aria-hidden="true" tabindex="-1"></a>              <span class="fu">min</span>(((<span class="fl">0.275</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">39.0</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))),</span>
<span id="cb94-67"><a href="individual-parameter-analyses.html#cb94-67" aria-hidden="true" tabindex="-1"></a>                  (<span class="fl">0.7249</span> <span class="sc">*</span> ( (<span class="fl">0.0114</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.6181</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))) <span class="sc">*</span> (<span class="fl">23.12</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.036</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue))) )), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-68"><a href="individual-parameter-analyses.html#cb94-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> . } <span class="sc">%&gt;%</span></span>
<span id="cb94-69"><a href="individual-parameter-analyses.html#cb94-69" aria-hidden="true" tabindex="-1"></a>          {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span>) <span class="co"># Trout present &amp; mussels absent scenario</span></span>
<span id="cb94-70"><a href="individual-parameter-analyses.html#cb94-70" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-71"><a href="individual-parameter-analyses.html#cb94-71" aria-hidden="true" tabindex="-1"></a>              <span class="fu">min</span>(((<span class="fl">0.275</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">39.0</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))),</span>
<span id="cb94-72"><a href="individual-parameter-analyses.html#cb94-72" aria-hidden="true" tabindex="-1"></a>                  (<span class="fl">0.7249</span> <span class="sc">*</span> ( (<span class="fl">0.0114</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.6181</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))) <span class="sc">*</span> (<span class="fl">62.15</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.036</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue))) )), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-73"><a href="individual-parameter-analyses.html#cb94-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> . } <span class="sc">%&gt;%</span></span>
<span id="cb94-74"><a href="individual-parameter-analyses.html#cb94-74" aria-hidden="true" tabindex="-1"></a>          {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span>) <span class="co"># Trout absent &amp; mussels present scenario</span></span>
<span id="cb94-75"><a href="individual-parameter-analyses.html#cb94-75" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-76"><a href="individual-parameter-analyses.html#cb94-76" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.7249</span> <span class="sc">*</span> ((<span class="fl">0.0114</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.6181</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))) <span class="sc">*</span> <span class="fu">min</span>(<span class="fl">51.93</span>, (<span class="fl">23.12</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.036</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-77"><a href="individual-parameter-analyses.html#cb94-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> .} <span class="sc">%&gt;%</span> </span>
<span id="cb94-78"><a href="individual-parameter-analyses.html#cb94-78" aria-hidden="true" tabindex="-1"></a>          {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span>) <span class="co"># Trout &amp; mussels absent scenario</span></span>
<span id="cb94-79"><a href="individual-parameter-analyses.html#cb94-79" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-80"><a href="individual-parameter-analyses.html#cb94-80" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.7249</span> <span class="sc">*</span> ((<span class="fl">0.0114</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.204</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.6181</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.204</span>)))) <span class="sc">*</span> <span class="fu">min</span>(<span class="fl">51.93</span>, (<span class="fl">62.15</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.036</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-81"><a href="individual-parameter-analyses.html#cb94-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> .} <span class="sc">%&gt;%</span> </span>
<span id="cb94-82"><a href="individual-parameter-analyses.html#cb94-82" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on 9VAC25-260-155 https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/</span></span>
<span id="cb94-83"><a href="individual-parameter-analyses.html#cb94-83" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb94-84"><a href="individual-parameter-analyses.html#cb94-84" aria-hidden="true" tabindex="-1"></a>                 <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(acuteDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-85"><a href="individual-parameter-analyses.html#cb94-85" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID) ) </span>
<span id="cb94-86"><a href="individual-parameter-analyses.html#cb94-86" aria-hidden="true" tabindex="-1"></a>      <span class="co"># now save data for later, in a format that matches with desired output</span></span>
<span id="cb94-87"><a href="individual-parameter-analyses.html#cb94-87" aria-hidden="true" tabindex="-1"></a>      acuteDataCriteriaAnalysis <span class="ot">&lt;-</span> acuteDataCriteriaAnalysis <span class="sc">%&gt;%</span> </span>
<span id="cb94-88"><a href="individual-parameter-analyses.html#cb94-88" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TempValue, pHValue)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-89"><a href="individual-parameter-analyses.html#cb94-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(<span class="fu">left_join</span>(acuteDataWindow,</span>
<span id="cb94-90"><a href="individual-parameter-analyses.html#cb94-90" aria-hidden="true" tabindex="-1"></a>                                                         dplyr<span class="sc">::</span><span class="fu">select</span>(acuteDataCriteriaAnalysis, FDT_STA_ID,  WindowDateTimeStart, TempValue, pHValue, Value),</span>
<span id="cb94-91"><a href="individual-parameter-analyses.html#cb94-91" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;FDT_DATE_TIME&#39;</span> <span class="ot">=</span> <span class="st">&#39;WindowDateTimeStart&#39;</span>)))) )</span>
<span id="cb94-92"><a href="individual-parameter-analyses.html#cb94-92" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-93"><a href="individual-parameter-analyses.html#cb94-93" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb94-94"><a href="individual-parameter-analyses.html#cb94-94" aria-hidden="true" tabindex="-1"></a>      acuteCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(acuteCriteriaResults, acuteDataCriteriaAnalysis) </span>
<span id="cb94-95"><a href="individual-parameter-analyses.html#cb94-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-96"><a href="individual-parameter-analyses.html#cb94-96" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {acuteCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults }</span>
<span id="cb94-97"><a href="individual-parameter-analyses.html#cb94-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-98"><a href="individual-parameter-analyses.html#cb94-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-99"><a href="individual-parameter-analyses.html#cb94-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run chronic analysis if enough data exists, must have &gt; 1 sample in chronic window to run analysis</span></span>
<span id="cb94-100"><a href="individual-parameter-analyses.html#cb94-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chronic is calculated on 30 day windows, so we need to average temperature and pH within each 30 day window before we can calculate a</span></span>
<span id="cb94-101"><a href="individual-parameter-analyses.html#cb94-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  chronic criteria. The chronic criteria will be associated with each sample date that starts a 30 day period, but it applies to all</span></span>
<span id="cb94-102"><a href="individual-parameter-analyses.html#cb94-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  samples within the 30 day window. All raw data associated with each window is saved as a listcolumn for later review.</span></span>
<span id="cb94-103"><a href="individual-parameter-analyses.html#cb94-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-104"><a href="individual-parameter-analyses.html#cb94-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Chronic criteria can combine multiple depths in calculation of criteria, &lt;1m difference (which is taken care of above)</span></span>
<span id="cb94-105"><a href="individual-parameter-analyses.html#cb94-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-106"><a href="individual-parameter-analyses.html#cb94-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(chronicDataWindow) <span class="sc">&gt;</span> <span class="dv">1</span>){ <span class="co"># need 2 or more data points to run a chronic</span></span>
<span id="cb94-107"><a href="individual-parameter-analyses.html#cb94-107" aria-hidden="true" tabindex="-1"></a>      chronicDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(</span>
<span id="cb94-108"><a href="individual-parameter-analyses.html#cb94-108" aria-hidden="true" tabindex="-1"></a>        chronicDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb94-109"><a href="individual-parameter-analyses.html#cb94-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">#  group_by(FDT_STA_ID) %&gt;% # for some reason if multiple depths but 1 stationID get 2 rows when group_by(FDT_STA_ID)</span></span>
<span id="cb94-110"><a href="individual-parameter-analyses.html#cb94-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">paste0</span>(<span class="fu">unique</span>(FDT_STA_ID), <span class="at">collapse =</span> <span class="st">&#39; &#39;</span>), <span class="do">### this is the ugly fix to problem identified above</span></span>
<span id="cb94-111"><a href="individual-parameter-analyses.html#cb94-111" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FDT_DEPTH =</span> <span class="fu">paste0</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(FDT_DEPTH)), <span class="at">collapse =</span> <span class="st">&#39; | &#39;</span>),</span>
<span id="cb94-112"><a href="individual-parameter-analyses.html#cb94-112" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TempValue =</span> <span class="fu">mean</span>(FDT_TEMP_CELCIUS, <span class="at">na.rm =</span> T), <span class="co"># get 30 day average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-113"><a href="individual-parameter-analyses.html#cb94-113" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pHValue =</span> <span class="fu">mean</span>(FDT_FIELD_PH, <span class="at">na.rm =</span> T), <span class="co"># get 30 day average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-114"><a href="individual-parameter-analyses.html#cb94-114" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Value =</span> <span class="fu">mean</span>(AMMONIA_mg_L, <span class="at">na.rm =</span> T), <span class="co"># get 30 day average; don&#39;t round to even bc more calculations to follow with data</span></span>
<span id="cb94-115"><a href="individual-parameter-analyses.html#cb94-115" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">length</span>(AMMONIA_mg_L)) <span class="sc">%&gt;%</span>  <span class="co">#count sample that made up average</span></span>
<span id="cb94-116"><a href="individual-parameter-analyses.html#cb94-116" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;30 Day Average&#39;</span>,</span>
<span id="cb94-117"><a href="individual-parameter-analyses.html#cb94-117" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ID =</span> <span class="fu">paste</span>( FDT_STA_ID, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>), <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb94-118"><a href="individual-parameter-analyses.html#cb94-118" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Chronic&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb94-119"><a href="individual-parameter-analyses.html#cb94-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trout &amp; mussels present scenario</span></span>
<span id="cb94-120"><a href="individual-parameter-analyses.html#cb94-120" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">TRUE</span>)  <span class="co"># Trout &amp; mussels present scenario &amp; earlyLife == TRUE</span></span>
<span id="cb94-121"><a href="individual-parameter-analyses.html#cb94-121" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-122"><a href="individual-parameter-analyses.html#cb94-122" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.8876</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> (<span class="fl">2.126</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> <span class="fu">max</span>(<span class="dv">7</span>, TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-123"><a href="individual-parameter-analyses.html#cb94-123" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-124"><a href="individual-parameter-analyses.html#cb94-124" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">FALSE</span>)  <span class="co"># Trout &amp; mussels present scenario &amp; earlyLife == FALSE</span></span>
<span id="cb94-125"><a href="individual-parameter-analyses.html#cb94-125" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>))</span>
<span id="cb94-126"><a href="individual-parameter-analyses.html#cb94-126" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-127"><a href="individual-parameter-analyses.html#cb94-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-128"><a href="individual-parameter-analyses.html#cb94-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trout present &amp; mussels absent scenario</span></span>
<span id="cb94-129"><a href="individual-parameter-analyses.html#cb94-129" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">TRUE</span>)  <span class="co"># Trout present &amp; mussels absent scenario &amp; earlyLife == TRUE</span></span>
<span id="cb94-130"><a href="individual-parameter-analyses.html#cb94-130" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-131"><a href="individual-parameter-analyses.html#cb94-131" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9405</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> <span class="fu">min</span>(<span class="fl">6.92</span>, (<span class="fl">7.547</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-132"><a href="individual-parameter-analyses.html#cb94-132" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-133"><a href="individual-parameter-analyses.html#cb94-133" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">FALSE</span>)  <span class="co"># Trout present &amp; mussels absent scenario &amp; earlyLife == FALSE</span></span>
<span id="cb94-134"><a href="individual-parameter-analyses.html#cb94-134" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-135"><a href="individual-parameter-analyses.html#cb94-135" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9405</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> (<span class="fl">7.547</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> <span class="fu">max</span>(TempValue, <span class="dv">7</span>)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-136"><a href="individual-parameter-analyses.html#cb94-136" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-137"><a href="individual-parameter-analyses.html#cb94-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-138"><a href="individual-parameter-analyses.html#cb94-138" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Trout absent &amp; mussels present scenario</span></span>
<span id="cb94-139"><a href="individual-parameter-analyses.html#cb94-139" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">TRUE</span>)  <span class="co"># Trout absent &amp; mussels present scenario &amp; earlyLife == TRUE</span></span>
<span id="cb94-140"><a href="individual-parameter-analyses.html#cb94-140" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-141"><a href="individual-parameter-analyses.html#cb94-141" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.8876</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> (<span class="fl">2.126</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> <span class="fu">max</span>(<span class="dv">7</span>, TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-142"><a href="individual-parameter-analyses.html#cb94-142" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-143"><a href="individual-parameter-analyses.html#cb94-143" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">FALSE</span>)  <span class="co"># Trout absent &amp; mussels present scenario &amp; earlyLife == FALSE</span></span>
<span id="cb94-144"><a href="individual-parameter-analyses.html#cb94-144" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>))</span>
<span id="cb94-145"><a href="individual-parameter-analyses.html#cb94-145" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-146"><a href="individual-parameter-analyses.html#cb94-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-147"><a href="individual-parameter-analyses.html#cb94-147" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Trout &amp; mussels absent scenario</span></span>
<span id="cb94-148"><a href="individual-parameter-analyses.html#cb94-148" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">TRUE</span>)  <span class="co"># Trout &amp; mussels absent scenario &amp; earlyLife == TRUE</span></span>
<span id="cb94-149"><a href="individual-parameter-analyses.html#cb94-149" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-150"><a href="individual-parameter-analyses.html#cb94-150" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9405</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> <span class="fu">min</span>(<span class="fl">6.92</span>, (<span class="fl">7.547</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> TempValue)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-151"><a href="individual-parameter-analyses.html#cb94-151" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-152"><a href="individual-parameter-analyses.html#cb94-152" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(trout <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> mussels <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> earlyLife <span class="sc">==</span> <span class="cn">FALSE</span>)  <span class="co"># Trout &amp; mussels absent scenario &amp; earlyLife == FALSE</span></span>
<span id="cb94-153"><a href="individual-parameter-analyses.html#cb94-153" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(., <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(</span>
<span id="cb94-154"><a href="individual-parameter-analyses.html#cb94-154" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.9405</span> <span class="sc">*</span> ((<span class="fl">0.0278</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">7.688</span> <span class="sc">-</span> pHValue))) <span class="sc">+</span> (<span class="fl">1.1994</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">^</span>(pHValue <span class="sc">-</span> <span class="fl">7.688</span>)))) <span class="sc">*</span> (<span class="fl">7.547</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^</span>(<span class="fl">0.028</span> <span class="sc">*</span> (<span class="dv">20</span> <span class="sc">-</span> <span class="fu">max</span>(TempValue, <span class="dv">7</span>)))), <span class="at">digits =</span> <span class="dv">2</span>)))</span>
<span id="cb94-155"><a href="individual-parameter-analyses.html#cb94-155" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .} <span class="sc">%&gt;%</span></span>
<span id="cb94-156"><a href="individual-parameter-analyses.html#cb94-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-157"><a href="individual-parameter-analyses.html#cb94-157" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on 9VAC25-260-155 https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/</span></span>
<span id="cb94-158"><a href="individual-parameter-analyses.html#cb94-158" aria-hidden="true" tabindex="-1"></a>               <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb94-159"><a href="individual-parameter-analyses.html#cb94-159" aria-hidden="true" tabindex="-1"></a>               <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(acuteDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span></span>
<span id="cb94-160"><a href="individual-parameter-analyses.html#cb94-160" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID) ) </span>
<span id="cb94-161"><a href="individual-parameter-analyses.html#cb94-161" aria-hidden="true" tabindex="-1"></a>      <span class="co"># now save data for later, in a format that matches with desired output</span></span>
<span id="cb94-162"><a href="individual-parameter-analyses.html#cb94-162" aria-hidden="true" tabindex="-1"></a>      chronicDataCriteriaAnalysis <span class="ot">&lt;-</span> chronicDataCriteriaAnalysis <span class="sc">%&gt;%</span> </span>
<span id="cb94-163"><a href="individual-parameter-analyses.html#cb94-163" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TempValue, pHValue)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-164"><a href="individual-parameter-analyses.html#cb94-164" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(<span class="fu">left_join</span>(chronicDataWindow,</span>
<span id="cb94-165"><a href="individual-parameter-analyses.html#cb94-165" aria-hidden="true" tabindex="-1"></a>                                                         dplyr<span class="sc">::</span><span class="fu">select</span>(chronicDataCriteriaAnalysis, FDT_STA_ID,  WindowDateTimeStart, TempValue, pHValue, Value),</span>
<span id="cb94-166"><a href="individual-parameter-analyses.html#cb94-166" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;FDT_DATE_TIME&#39;</span> <span class="ot">=</span> <span class="st">&#39;WindowDateTimeStart&#39;</span>)))) )</span>
<span id="cb94-167"><a href="individual-parameter-analyses.html#cb94-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-168"><a href="individual-parameter-analyses.html#cb94-168" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb94-169"><a href="individual-parameter-analyses.html#cb94-169" aria-hidden="true" tabindex="-1"></a>      chronicCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(chronicCriteriaResults, chronicDataCriteriaAnalysis)</span>
<span id="cb94-170"><a href="individual-parameter-analyses.html#cb94-170" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {chronicCriteriaResults <span class="ot">&lt;-</span> chronicCriteriaResults }</span>
<span id="cb94-171"><a href="individual-parameter-analyses.html#cb94-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-172"><a href="individual-parameter-analyses.html#cb94-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-173"><a href="individual-parameter-analyses.html#cb94-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run 4 day analysis if data exists</span></span>
<span id="cb94-174"><a href="individual-parameter-analyses.html#cb94-174" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4 day analysis is run on 4 day windows, so we need to average temperature and pH within each 4 day window before we can compare to a 2.5x </span></span>
<span id="cb94-175"><a href="individual-parameter-analyses.html#cb94-175" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  chronic criteria. The chronic criteria associated with each sample date that starts a 4 day period is used for the 4 day analysis. </span></span>
<span id="cb94-176"><a href="individual-parameter-analyses.html#cb94-176" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  All raw data associated with each window is saved as a listcolumn for later review.</span></span>
<span id="cb94-177"><a href="individual-parameter-analyses.html#cb94-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-178"><a href="individual-parameter-analyses.html#cb94-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4day criteria can combine multiple depths in calculation of criteria, &lt;1m difference (which is taken care of above)</span></span>
<span id="cb94-179"><a href="individual-parameter-analyses.html#cb94-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-180"><a href="individual-parameter-analyses.html#cb94-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(fourDayDataWindow) <span class="sc">&gt;</span> <span class="dv">1</span>){</span>
<span id="cb94-181"><a href="individual-parameter-analyses.html#cb94-181" aria-hidden="true" tabindex="-1"></a>      fourDayDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>( </span>
<span id="cb94-182"><a href="individual-parameter-analyses.html#cb94-182" aria-hidden="true" tabindex="-1"></a>        fourDayDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb94-183"><a href="individual-parameter-analyses.html#cb94-183" aria-hidden="true" tabindex="-1"></a>          <span class="co">#  group_by(FDT_STA_ID) %&gt;% # for some reason if multiple depths but 1 stationID get 2 rows when group_by(FDT_STA_ID)</span></span>
<span id="cb94-184"><a href="individual-parameter-analyses.html#cb94-184" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">paste0</span>(<span class="fu">unique</span>(FDT_STA_ID), <span class="at">collapse =</span> <span class="st">&#39; &#39;</span>), <span class="do">### this is the ugly fix to problem identified above</span></span>
<span id="cb94-185"><a href="individual-parameter-analyses.html#cb94-185" aria-hidden="true" tabindex="-1"></a>                    <span class="at">FDT_DEPTH =</span> <span class="fu">paste0</span>(<span class="fu">sort</span>(<span class="fu">unique</span>(FDT_DEPTH)), <span class="at">collapse =</span> <span class="st">&#39; | &#39;</span>),</span>
<span id="cb94-186"><a href="individual-parameter-analyses.html#cb94-186" aria-hidden="true" tabindex="-1"></a>                    <span class="at">TempValue =</span> <span class="fu">mean</span>(FDT_TEMP_CELCIUS, <span class="at">na.rm=</span>T),  <span class="co"># get 4day average; doesn&#39;t do anything bc this doesn&#39;t go into criteria calculation but needed to match other data format</span></span>
<span id="cb94-187"><a href="individual-parameter-analyses.html#cb94-187" aria-hidden="true" tabindex="-1"></a>                    <span class="at">pHValue =</span> <span class="fu">mean</span>(FDT_FIELD_PH, <span class="at">na.rm=</span>T),  <span class="co"># get 4day average; doesn&#39;t do anything bc this doesn&#39;t go into criteria calculation but needed to match other data format</span></span>
<span id="cb94-188"><a href="individual-parameter-analyses.html#cb94-188" aria-hidden="true" tabindex="-1"></a>                    <span class="at">Value =</span> <span class="fu">mean</span>(AMMONIA_mg_L, <span class="at">na.rm=</span>T),  <span class="co"># get 4day average; don&#39;t round to even bc want to see raw and parameterRound columns in output</span></span>
<span id="cb94-189"><a href="individual-parameter-analyses.html#cb94-189" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">length</span>(AMMONIA_mg_L)) <span class="sc">%&gt;%</span>  <span class="co">#count sample that made up average</span></span>
<span id="cb94-190"><a href="individual-parameter-analyses.html#cb94-190" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Four Day Average&#39;</span>,</span>
<span id="cb94-191"><a href="individual-parameter-analyses.html#cb94-191" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ID =</span> <span class="fu">paste</span>( FDT_STA_ID, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>), <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb94-192"><a href="individual-parameter-analyses.html#cb94-192" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Four Day&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb94-193"><a href="individual-parameter-analyses.html#cb94-193" aria-hidden="true" tabindex="-1"></a>          <span class="fu">left_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(chronicDataCriteriaAnalysis, FDT_STA_ID, <span class="st">`</span><span class="at">Chronic CriteriaValue</span><span class="st">`</span> <span class="ot">=</span> CriteriaValue),</span>
<span id="cb94-194"><a href="individual-parameter-analyses.html#cb94-194" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-195"><a href="individual-parameter-analyses.html#cb94-195" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="fu">signif</span>(<span class="st">`</span><span class="at">Chronic CriteriaValue</span><span class="st">`</span> <span class="sc">*</span> <span class="fl">2.5</span>, <span class="at">digits =</span> <span class="dv">2</span>)), <span class="co"># 4 day criteria = 2.5x chronic criteria</span></span>
<span id="cb94-196"><a href="individual-parameter-analyses.html#cb94-196" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on 9VAC25-260-155 https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/</span></span>
<span id="cb94-197"><a href="individual-parameter-analyses.html#cb94-197" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb94-198"><a href="individual-parameter-analyses.html#cb94-198" aria-hidden="true" tabindex="-1"></a>                 <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(fourDayDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-199"><a href="individual-parameter-analyses.html#cb94-199" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span><span class="fu">c</span>(ID, <span class="st">`</span><span class="at">Chronic CriteriaValue</span><span class="st">`</span> ) ) )</span>
<span id="cb94-200"><a href="individual-parameter-analyses.html#cb94-200" aria-hidden="true" tabindex="-1"></a>      <span class="co"># now save data for later, in a format that matches with desired output</span></span>
<span id="cb94-201"><a href="individual-parameter-analyses.html#cb94-201" aria-hidden="true" tabindex="-1"></a>      fourDayDataCriteriaAnalysis <span class="ot">&lt;-</span> fourDayDataCriteriaAnalysis <span class="sc">%&gt;%</span> </span>
<span id="cb94-202"><a href="individual-parameter-analyses.html#cb94-202" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TempValue, pHValue)) <span class="sc">%&gt;%</span> </span>
<span id="cb94-203"><a href="individual-parameter-analyses.html#cb94-203" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(<span class="fu">left_join</span>(fourDayDataWindow,</span>
<span id="cb94-204"><a href="individual-parameter-analyses.html#cb94-204" aria-hidden="true" tabindex="-1"></a>                                                         dplyr<span class="sc">::</span><span class="fu">select</span>(fourDayDataCriteriaAnalysis, FDT_STA_ID,  WindowDateTimeStart, TempValue, pHValue, Value),</span>
<span id="cb94-205"><a href="individual-parameter-analyses.html#cb94-205" aria-hidden="true" tabindex="-1"></a>                                                         <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;FDT_DATE_TIME&#39;</span> <span class="ot">=</span> <span class="st">&#39;WindowDateTimeStart&#39;</span>)))) )</span>
<span id="cb94-206"><a href="individual-parameter-analyses.html#cb94-206" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-207"><a href="individual-parameter-analyses.html#cb94-207" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb94-208"><a href="individual-parameter-analyses.html#cb94-208" aria-hidden="true" tabindex="-1"></a>      fourDayCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(fourDayCriteriaResults, fourDayDataCriteriaAnalysis) </span>
<span id="cb94-209"><a href="individual-parameter-analyses.html#cb94-209" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-210"><a href="individual-parameter-analyses.html#cb94-210" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {fourDayCriteriaResults <span class="ot">&lt;-</span> fourDayCriteriaResults }</span>
<span id="cb94-211"><a href="individual-parameter-analyses.html#cb94-211" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-212"><a href="individual-parameter-analyses.html#cb94-212" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb94-213"><a href="individual-parameter-analyses.html#cb94-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-214"><a href="individual-parameter-analyses.html#cb94-214" aria-hidden="true" tabindex="-1"></a>    combinedResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(acuteCriteriaResults, chronicCriteriaResults) <span class="sc">%&gt;%</span></span>
<span id="cb94-215"><a href="individual-parameter-analyses.html#cb94-215" aria-hidden="true" tabindex="-1"></a>      {<span class="cf">if</span>(<span class="fu">nrow</span>(fourDayCriteriaResults) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb94-216"><a href="individual-parameter-analyses.html#cb94-216" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bind_rows</span>(., fourDayCriteriaResults)</span>
<span id="cb94-217"><a href="individual-parameter-analyses.html#cb94-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> .} <span class="sc">%&gt;%</span> </span>
<span id="cb94-218"><a href="individual-parameter-analyses.html#cb94-218" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(WindowDateTimeStart, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>)</span>
<span id="cb94-219"><a href="individual-parameter-analyses.html#cb94-219" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-220"><a href="individual-parameter-analyses.html#cb94-220" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-221"><a href="individual-parameter-analyses.html#cb94-221" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-222"><a href="individual-parameter-analyses.html#cb94-222" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb94-223"><a href="individual-parameter-analyses.html#cb94-223" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>( combinedResults)<span class="co">#bind_rows(acuteDataCriteriaAnalysis, chronicDataCriteriaAnalysis))</span></span>
<span id="cb94-224"><a href="individual-parameter-analyses.html#cb94-224" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-225"><a href="individual-parameter-analyses.html#cb94-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-226"><a href="individual-parameter-analyses.html#cb94-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb94-227"><a href="individual-parameter-analyses.html#cb94-227" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb94-228"><a href="individual-parameter-analyses.html#cb94-228" aria-hidden="true" tabindex="-1"></a><span class="co"># ammoniaAnalysisStation &lt;- freshwaterNH3limit(stationData, </span></span>
<span id="cb94-229"><a href="individual-parameter-analyses.html#cb94-229" aria-hidden="true" tabindex="-1"></a><span class="co">#                                              trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb94-230"><a href="individual-parameter-analyses.html#cb94-230" aria-hidden="true" tabindex="-1"></a><span class="co">#                                              mussels = TRUE, </span></span>
<span id="cb94-231"><a href="individual-parameter-analyses.html#cb94-231" aria-hidden="true" tabindex="-1"></a><span class="co">#                                              earlyLife = TRUE) </span></span>
<span id="cb94-232"><a href="individual-parameter-analyses.html#cb94-232" aria-hidden="true" tabindex="-1"></a><span class="co"># https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section155/ states the assumption is that</span></span>
<span id="cb94-233"><a href="individual-parameter-analyses.html#cb94-233" aria-hidden="true" tabindex="-1"></a><span class="co"># waters are to be assessed with the assumption that mussels and early life stages of fish should be present</span></span>
<span id="cb94-234"><a href="individual-parameter-analyses.html#cb94-234" aria-hidden="true" tabindex="-1"></a><span class="co"># trout presence is determined by WQS class, this can be changed in the app but is forced to be what the station</span></span>
<span id="cb94-235"><a href="individual-parameter-analyses.html#cb94-235" aria-hidden="true" tabindex="-1"></a><span class="co"># is attributed to in the automated assessment scripts</span></span></code></pre></div>
</div>
<div id="annualrollingexceedanceanalysis" class="section level4" number="3.5.7.2">
<h4><span class="header-section-number">3.5.7.2</span> annualRollingExceedanceAnalysis</h4>
<p>Calculating the appropriate ammonia criteria is just the first part of assessing ammonia. To assess ammonia in free-flowing and tidal waters for Wildlife and Aquatic Life Uses, acute, chronic and four day criteria must not exceed respective criteria more than once every three years on the average. Helper functions have been established to assist with the automation of these decisions. The <code>annualRollingExceedanceAnalysis()</code> helper function takes in the output of the <code>freshwaterNH3limit()</code> function and an additional argument (<code>yearsToRoll</code>) that established the number of years to roll analyses over, for our use case we will use three years. The argument <code>aquaticLifeUse</code> allows this function to be used across multiple data input types. The default allows for the logic from the ammonia <code>freshwaterNH3limit()</code> function to be used to flag whether or not a window is valid for later assessment steps. An example of when one would change the default argument for <code>aquaticLifeUse</code> from FALSE to TRUE is if they were assessing freshwater chloride for the Aquatic Life Designated Use. When <code>aquaticLifeUse</code> is set to TRUE, the function uses the Aquatic Life Use definition of valid windows to flag windows for later assessment steps. The Assessment Guidance states:
â€œFor toxic pollutant assessment of Aquatic Life Designated Use in free-flowing streams, both chronic and acute criteria can be assessed whenever sufficient data are available as applicable. Chronic criteria are to be assessed when multiple grab samples are collected within two separate four-day periods within a three-year period, or when there are two or more separate 30-day SPMD deployments within a three-year period. Two samples (either grab or SPMD) taken within three consecutive years are sufficient to assess acute criteria.â€</p>
<p>The function extracts the year from each data window analyzed and drops any criteria that do not meet sample count rules (e.g.Â chronic or four day window results that were calculated on 1 or fewer samples). Based on the unique years of the input data windows and the <code>yearsToRoll</code> argument (3 in our case), the function loops over data within each <code>yearsToRoll</code> window range to calculate the number of exceedances in the rolled window (and whether or not the window is valid) by criteria type (e.g.Â acute, chronic, or four day) and appends all data used for the summary in a listcolumn called <code>associatedData</code> to simplify data review. Unique window ranges are not repeated thanks to the logic outlined in the <code>windowRange</code> range established for the for loop.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="individual-parameter-analyses.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># New rolling window analysis function. This calculates the number of exceedances in a X year window (not repeating windows)</span></span>
<span id="cb95-2"><a href="individual-parameter-analyses.html#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#  and determines if the number of windows exceeding criteria are greater than the number of windows not exceeding criteria</span></span>
<span id="cb95-3"><a href="individual-parameter-analyses.html#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  using subsequent annualRollingExceedanceSummary()</span></span>
<span id="cb95-4"><a href="individual-parameter-analyses.html#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co"># analyze results by 3 year windows, not a strict rolling window, roll by year</span></span>
<span id="cb95-5"><a href="individual-parameter-analyses.html#cb95-5" aria-hidden="true" tabindex="-1"></a>annualRollingExceedanceAnalysis <span class="ot">&lt;-</span> <span class="cf">function</span>(dataToAnalyze,</span>
<span id="cb95-6"><a href="individual-parameter-analyses.html#cb95-6" aria-hidden="true" tabindex="-1"></a>                                            yearsToRoll, <span class="co"># number of years to roll analysis over</span></span>
<span id="cb95-7"><a href="individual-parameter-analyses.html#cb95-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">aquaticLifeUse =</span> <span class="cn">FALSE</span> <span class="co"># whether or not this function is being used for Aquatic Life Use criteria</span></span>
<span id="cb95-8"><a href="individual-parameter-analyses.html#cb95-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="co"># default = FALSE, which uses the Ammonia definition for window validity for chronic and four day sampling criteria</span></span>
<span id="cb95-9"><a href="individual-parameter-analyses.html#cb95-9" aria-hidden="true" tabindex="-1"></a>                                            <span class="co"># if TRUE, two samples across the rolled window length ensures a valid window</span></span>
<span id="cb95-10"><a href="individual-parameter-analyses.html#cb95-10" aria-hidden="true" tabindex="-1"></a>                                            ){</span>
<span id="cb95-11"><a href="individual-parameter-analyses.html#cb95-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-12"><a href="individual-parameter-analyses.html#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(dataToAnalyze)){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb95-13"><a href="individual-parameter-analyses.html#cb95-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-14"><a href="individual-parameter-analyses.html#cb95-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># place to store results</span></span>
<span id="cb95-15"><a href="individual-parameter-analyses.html#cb95-15" aria-hidden="true" tabindex="-1"></a>  dataWindowResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="st">`</span><span class="at">Window Begin</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb95-16"><a href="individual-parameter-analyses.html#cb95-16" aria-hidden="true" tabindex="-1"></a>                              <span class="at">FDT_DEPTH =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),<span class="co"># character so we can concatenate multiple depth values if needed</span></span>
<span id="cb95-17"><a href="individual-parameter-analyses.html#cb95-17" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#FDT_DEPTH = as.numeric(NA), </span></span>
<span id="cb95-18"><a href="individual-parameter-analyses.html#cb95-18" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb95-19"><a href="individual-parameter-analyses.html#cb95-19" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">Years Analysis Rolled Over</span><span class="st">`</span><span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb95-20"><a href="individual-parameter-analyses.html#cb95-20" aria-hidden="true" tabindex="-1"></a>                              <span class="st">`</span><span class="at">Exceedances in Rolled Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb95-21"><a href="individual-parameter-analyses.html#cb95-21" aria-hidden="true" tabindex="-1"></a>                              <span class="co">#`Valid Chronic Window` = NA, </span></span>
<span id="cb95-22"><a href="individual-parameter-analyses.html#cb95-22" aria-hidden="true" tabindex="-1"></a>                              <span class="at">associatedData =</span> <span class="fu">list</span>())</span>
<span id="cb95-23"><a href="individual-parameter-analyses.html#cb95-23" aria-hidden="true" tabindex="-1"></a>  dataToAnalyze <span class="ot">&lt;-</span> dataToAnalyze <span class="sc">%&gt;%</span> </span>
<span id="cb95-24"><a href="individual-parameter-analyses.html#cb95-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">year</span>(WindowDateTimeStart),</span>
<span id="cb95-25"><a href="individual-parameter-analyses.html#cb95-25" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Acute&quot;</span>) <span class="sc">~</span> <span class="cn">TRUE</span>, <span class="co"># just to make people feel good later on</span></span>
<span id="cb95-26"><a href="individual-parameter-analyses.html#cb95-26" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Chronic&quot;</span>, <span class="st">&quot;Four Day&quot;</span>)  <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb95-27"><a href="individual-parameter-analyses.html#cb95-27" aria-hidden="true" tabindex="-1"></a>                                      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA</span>))</span>
<span id="cb95-28"><a href="individual-parameter-analyses.html#cb95-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-29"><a href="individual-parameter-analyses.html#cb95-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First, identify all window start options</span></span>
<span id="cb95-30"><a href="individual-parameter-analyses.html#cb95-30" aria-hidden="true" tabindex="-1"></a>  windowOptions <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">year</span>(dataToAnalyze<span class="sc">$</span>WindowDateTimeStart))</span>
<span id="cb95-31"><a href="individual-parameter-analyses.html#cb95-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now, stop loop from repeating windows by capping the top end by yearsToRoll-1 (so don&#39;t have 3 yr windows exceeding assessment period)</span></span>
<span id="cb95-32"><a href="individual-parameter-analyses.html#cb95-32" aria-hidden="true" tabindex="-1"></a>  windowRange <span class="ot">&lt;-</span> (<span class="fu">min</span>(windowOptions)<span class="sc">:</span>(<span class="fu">max</span>(windowOptions)<span class="sc">-</span> (yearsToRoll<span class="sc">-</span> <span class="dv">1</span>)))</span>
<span id="cb95-33"><a href="individual-parameter-analyses.html#cb95-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb95-34"><a href="individual-parameter-analyses.html#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="individual-parameter-analyses.html#cb95-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> windowRange){ <span class="co">#i = min(min(windowRange):(max(windowRange)- (yearsToRoll- 1))[1])</span></span>
<span id="cb95-36"><a href="individual-parameter-analyses.html#cb95-36" aria-hidden="true" tabindex="-1"></a>    dataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(dataToAnalyze, Year <span class="sc">%in%</span> i<span class="sc">:</span>(i <span class="sc">+</span> yearsToRoll<span class="sc">-</span> <span class="dv">1</span>) ) <span class="co"># minus 1 year for math to work</span></span>
<span id="cb95-37"><a href="individual-parameter-analyses.html#cb95-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-38"><a href="individual-parameter-analyses.html#cb95-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-39"><a href="individual-parameter-analyses.html#cb95-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="fu">unique</span>(dataWindow<span class="sc">$</span><span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>)){ <span class="co"># this logic will skip years with no data</span></span>
<span id="cb95-40"><a href="individual-parameter-analyses.html#cb95-40" aria-hidden="true" tabindex="-1"></a>      dataWindowCriteria <span class="ot">&lt;-</span> <span class="fu">filter</span>(dataWindow, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">%in%</span> k)</span>
<span id="cb95-41"><a href="individual-parameter-analyses.html#cb95-41" aria-hidden="true" tabindex="-1"></a>      dataWindowAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>( dataWindowCriteria <span class="sc">%&gt;%</span> </span>
<span id="cb95-42"><a href="individual-parameter-analyses.html#cb95-42" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">group_by</span>(FDT_STA_ID, <span class="co">#FDT_DEPTH, </span></span>
<span id="cb95-43"><a href="individual-parameter-analyses.html#cb95-43" aria-hidden="true" tabindex="-1"></a>                                                         <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-44"><a href="individual-parameter-analyses.html#cb95-44" aria-hidden="true" tabindex="-1"></a>                                                {<span class="cf">if</span>(aquaticLifeUse <span class="sc">==</span> <span class="cn">FALSE</span>)</span>
<span id="cb95-45"><a href="individual-parameter-analyses.html#cb95-45" aria-hidden="true" tabindex="-1"></a>                                                  <span class="fu">summarise</span>(., <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>),</span>
<span id="cb95-46"><a href="individual-parameter-analyses.html#cb95-46" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">`</span><span class="at">Window Begin</span><span class="st">`</span> <span class="ot">=</span> i , <span class="co">#year(min(WindowDateTimeStart)),</span></span>
<span id="cb95-47"><a href="individual-parameter-analyses.html#cb95-47" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">`</span><span class="at">Years Analysis Rolled Over</span><span class="st">`</span> <span class="ot">=</span> yearsToRoll, </span>
<span id="cb95-48"><a href="individual-parameter-analyses.html#cb95-48" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">`</span><span class="at">Exceedances in Rolled Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Exceedance),</span>
<span id="cb95-49"><a href="individual-parameter-analyses.html#cb95-49" aria-hidden="true" tabindex="-1"></a>                                                            <span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">all</span>(<span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="sc">==</span> T))</span>
<span id="cb95-50"><a href="individual-parameter-analyses.html#cb95-50" aria-hidden="true" tabindex="-1"></a>                                                  <span class="cf">else</span> <span class="fu">summarise</span>(., <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">unique</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>),</span>
<span id="cb95-51"><a href="individual-parameter-analyses.html#cb95-51" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="st">`</span><span class="at">Window Begin</span><span class="st">`</span> <span class="ot">=</span> i, <span class="co">#year(min(WindowDateTimeStart)),</span></span>
<span id="cb95-52"><a href="individual-parameter-analyses.html#cb95-52" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="st">`</span><span class="at">Years Analysis Rolled Over</span><span class="st">`</span> <span class="ot">=</span> yearsToRoll, </span>
<span id="cb95-53"><a href="individual-parameter-analyses.html#cb95-53" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="st">`</span><span class="at">Exceedances in Rolled Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Exceedance),</span>
<span id="cb95-54"><a href="individual-parameter-analyses.html#cb95-54" aria-hidden="true" tabindex="-1"></a>                                                                 <span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="fu">nrow</span>(dataWindowCriteria) <span class="sc">&gt;=</span> <span class="dv">2</span>, <span class="cn">TRUE</span>, <span class="cn">NA</span>))</span>
<span id="cb95-55"><a href="individual-parameter-analyses.html#cb95-55" aria-hidden="true" tabindex="-1"></a>                                                  }   <span class="sc">%&gt;%</span> </span>
<span id="cb95-56"><a href="individual-parameter-analyses.html#cb95-56" aria-hidden="true" tabindex="-1"></a>                                                <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(dataWindowCriteria))) )</span>
<span id="cb95-57"><a href="individual-parameter-analyses.html#cb95-57" aria-hidden="true" tabindex="-1"></a>      dataWindowResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dataWindowResults, dataWindowAnalysis) </span>
<span id="cb95-58"><a href="individual-parameter-analyses.html#cb95-58" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb95-59"><a href="individual-parameter-analyses.html#cb95-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-60"><a href="individual-parameter-analyses.html#cb95-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(dataWindowResults)</span>
<span id="cb95-61"><a href="individual-parameter-analyses.html#cb95-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-62"><a href="individual-parameter-analyses.html#cb95-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-63"><a href="individual-parameter-analyses.html#cb95-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-64"><a href="individual-parameter-analyses.html#cb95-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-65"><a href="individual-parameter-analyses.html#cb95-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage: (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb95-66"><a href="individual-parameter-analyses.html#cb95-66" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb95-67"><a href="individual-parameter-analyses.html#cb95-67" aria-hidden="true" tabindex="-1"></a><span class="co"># annualRollingExceedanceAnalysis(</span></span>
<span id="cb95-68"><a href="individual-parameter-analyses.html#cb95-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   freshwaterNH3limit(stationData,</span></span>
<span id="cb95-69"><a href="individual-parameter-analyses.html#cb95-69" aria-hidden="true" tabindex="-1"></a><span class="co">#                    trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb95-70"><a href="individual-parameter-analyses.html#cb95-70" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mussels = TRUE,</span></span>
<span id="cb95-71"><a href="individual-parameter-analyses.html#cb95-71" aria-hidden="true" tabindex="-1"></a><span class="co">#                    earlyLife = TRUE),</span></span>
<span id="cb95-72"><a href="individual-parameter-analyses.html#cb95-72" aria-hidden="true" tabindex="-1"></a><span class="co">#   yearsToRoll = 3, aquaticLifeUse = FALSE)</span></span>
<span id="cb95-73"><a href="individual-parameter-analyses.html#cb95-73" aria-hidden="true" tabindex="-1"></a><span class="co"># freshwaterNH3limit(stationData,</span></span>
<span id="cb95-74"><a href="individual-parameter-analyses.html#cb95-74" aria-hidden="true" tabindex="-1"></a><span class="co">#                    trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb95-75"><a href="individual-parameter-analyses.html#cb95-75" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mussels = TRUE,</span></span>
<span id="cb95-76"><a href="individual-parameter-analyses.html#cb95-76" aria-hidden="true" tabindex="-1"></a><span class="co">#                    earlyLife = TRUE) %&gt;% </span></span>
<span id="cb95-77"><a href="individual-parameter-analyses.html#cb95-77" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE)</span></span>
<span id="cb95-78"><a href="individual-parameter-analyses.html#cb95-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-79"><a href="individual-parameter-analyses.html#cb95-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Freshwater Chloride Example:</span></span>
<span id="cb95-80"><a href="individual-parameter-analyses.html#cb95-80" aria-hidden="true" tabindex="-1"></a><span class="co"># annualRollingExceedanceAnalysis(</span></span>
<span id="cb95-81"><a href="individual-parameter-analyses.html#cb95-81" aria-hidden="true" tabindex="-1"></a><span class="co">#   chlorideFreshwaterAnalysis(stationData),</span></span>
<span id="cb95-82"><a href="individual-parameter-analyses.html#cb95-82" aria-hidden="true" tabindex="-1"></a><span class="co">#   yearsToRoll = 3, aquaticLifeUse = TRUE) </span></span>
<span id="cb95-83"><a href="individual-parameter-analyses.html#cb95-83" aria-hidden="true" tabindex="-1"></a><span class="co"># chlorideFreshwaterAnalysis(stationData) %&gt;%</span></span>
<span id="cb95-84"><a href="individual-parameter-analyses.html#cb95-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) </span></span></code></pre></div>
</div>
<div id="annualrollingexceedancesummary" class="section level4" number="3.5.7.3">
<h4><span class="header-section-number">3.5.7.3</span> annualRollingExceedanceSummary</h4>
<p>The <code>annualRollingExceedanceSummary()</code> helper function summarizes the output of the <code>annualRollingExceedanceAnalysis()</code> function to suggest an ammonia result for Wildlife and Aquatic Life Designated uses. This function determines whether the number of exceeding windows are greater than the number of windows without exceedances and suggests a result based on that analysis. Before suggesting any results, the function ensures all data windows are valid (based upon flags chronic and four day sampling criteria analyzed in previous functions). After summarizing the window results by criteria type, the function suggests a result to the user where a â€œSupportingâ€ output is provided only if the number of windows without exceedances are greater than the number of windows with exceedances. All other summaries result in a â€œReviewâ€ flag.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="individual-parameter-analyses.html#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flag if more windows exceeding than not</span></span>
<span id="cb96-2"><a href="individual-parameter-analyses.html#cb96-2" aria-hidden="true" tabindex="-1"></a>annualRollingExceedanceSummary <span class="ot">&lt;-</span> <span class="cf">function</span>(rolledAnalysis){</span>
<span id="cb96-3"><a href="individual-parameter-analyses.html#cb96-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-4"><a href="individual-parameter-analyses.html#cb96-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(rolledAnalysis)){<span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb96-5"><a href="individual-parameter-analyses.html#cb96-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-6"><a href="individual-parameter-analyses.html#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a valid dataset for this analysis</span></span>
<span id="cb96-7"><a href="individual-parameter-analyses.html#cb96-7" aria-hidden="true" tabindex="-1"></a>  validDataForExceedanceSummary <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb96-8"><a href="individual-parameter-analyses.html#cb96-8" aria-hidden="true" tabindex="-1"></a>    rolledAnalysis <span class="sc">%&gt;%</span> </span>
<span id="cb96-9"><a href="individual-parameter-analyses.html#cb96-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&#39;Chronic&#39;</span> <span class="sc">&amp;</span> <span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="sc">==</span> <span class="cn">TRUE</span>),</span>
<span id="cb96-10"><a href="individual-parameter-analyses.html#cb96-10" aria-hidden="true" tabindex="-1"></a>    rolledAnalysis <span class="sc">%&gt;%</span> </span>
<span id="cb96-11"><a href="individual-parameter-analyses.html#cb96-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&#39;Acute&#39;</span>)  ) <span class="sc">%&gt;%</span> </span>
<span id="cb96-12"><a href="individual-parameter-analyses.html#cb96-12" aria-hidden="true" tabindex="-1"></a>    {<span class="cf">if</span>(<span class="st">&quot;Four Day&quot;</span> <span class="sc">%in%</span> <span class="fu">unique</span>(rolledAnalysis<span class="sc">$</span><span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>))</span>
<span id="cb96-13"><a href="individual-parameter-analyses.html#cb96-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(.,</span>
<span id="cb96-14"><a href="individual-parameter-analyses.html#cb96-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">filter</span>(rolledAnalysis, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&quot;Four Day&quot;</span><span class="sc">&amp;</span> <span class="st">`</span><span class="at">Valid Window</span><span class="st">`</span> <span class="sc">==</span> <span class="cn">TRUE</span>) )</span>
<span id="cb96-15"><a href="individual-parameter-analyses.html#cb96-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> . }</span>
<span id="cb96-16"><a href="individual-parameter-analyses.html#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="individual-parameter-analyses.html#cb96-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-18"><a href="individual-parameter-analyses.html#cb96-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressMessages</span>(</span>
<span id="cb96-19"><a href="individual-parameter-analyses.html#cb96-19" aria-hidden="true" tabindex="-1"></a>    validDataForExceedanceSummary <span class="sc">%&gt;%</span> </span>
<span id="cb96-20"><a href="individual-parameter-analyses.html#cb96-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(FDT_STA_ID, FDT_DEPTH, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb96-21"><a href="individual-parameter-analyses.html#cb96-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="st">`</span><span class="at">n Windows Fine</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">Exceedances in Rolled Window</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="dv">2</span>),</span>
<span id="cb96-22"><a href="individual-parameter-analyses.html#cb96-22" aria-hidden="true" tabindex="-1"></a>              <span class="st">`</span><span class="at">n Windows Exceeding</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(<span class="st">`</span><span class="at">Exceedances in Rolled Window</span><span class="st">`</span> <span class="sc">&gt;=</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb96-23"><a href="individual-parameter-analyses.html#cb96-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Suggested Result</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(<span class="st">`</span><span class="at">n Windows Fine</span><span class="st">`</span> <span class="sc">&gt;</span> <span class="st">`</span><span class="at">n Windows Exceeding</span><span class="st">`</span> <span class="sc">~</span> <span class="st">&quot;Supporting&quot;</span>,</span>
<span id="cb96-24"><a href="individual-parameter-analyses.html#cb96-24" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">`</span><span class="at">n Windows Fine</span><span class="st">`</span> <span class="sc">&lt;</span> <span class="st">`</span><span class="at">n Windows Exceeding</span><span class="st">`</span> <span class="sc">~</span> <span class="st">&quot;Review&quot;</span>,</span>
<span id="cb96-25"><a href="individual-parameter-analyses.html#cb96-25" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">`</span><span class="at">n Windows Fine</span><span class="st">`</span> <span class="sc">==</span> <span class="st">`</span><span class="at">n Windows Exceeding</span><span class="st">`</span> <span class="sc">~</span> <span class="st">&quot;Review&quot;</span>,</span>
<span id="cb96-26"><a href="individual-parameter-analyses.html#cb96-26" aria-hidden="true" tabindex="-1"></a>                                          <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.character</span>(<span class="cn">NA</span>))))</span>
<span id="cb96-27"><a href="individual-parameter-analyses.html#cb96-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-28"><a href="individual-parameter-analyses.html#cb96-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-29"><a href="individual-parameter-analyses.html#cb96-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-30"><a href="individual-parameter-analyses.html#cb96-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage: (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb96-31"><a href="individual-parameter-analyses.html#cb96-31" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb96-32"><a href="individual-parameter-analyses.html#cb96-32" aria-hidden="true" tabindex="-1"></a><span class="co"># annualRollingExceedanceSummary(</span></span>
<span id="cb96-33"><a href="individual-parameter-analyses.html#cb96-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(</span></span>
<span id="cb96-34"><a href="individual-parameter-analyses.html#cb96-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   freshwaterNH3limit(stationData,</span></span>
<span id="cb96-35"><a href="individual-parameter-analyses.html#cb96-35" aria-hidden="true" tabindex="-1"></a><span class="co">#                    trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb96-36"><a href="individual-parameter-analyses.html#cb96-36" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mussels = TRUE,</span></span>
<span id="cb96-37"><a href="individual-parameter-analyses.html#cb96-37" aria-hidden="true" tabindex="-1"></a><span class="co">#                    earlyLife = TRUE),</span></span>
<span id="cb96-38"><a href="individual-parameter-analyses.html#cb96-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   yearsToRoll = 3, aquaticLifeUse = FALSE)</span></span>
<span id="cb96-39"><a href="individual-parameter-analyses.html#cb96-39" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb96-40"><a href="individual-parameter-analyses.html#cb96-40" aria-hidden="true" tabindex="-1"></a><span class="co"># freshwaterNH3limit(stationData,</span></span>
<span id="cb96-41"><a href="individual-parameter-analyses.html#cb96-41" aria-hidden="true" tabindex="-1"></a><span class="co">#                    trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb96-42"><a href="individual-parameter-analyses.html#cb96-42" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mussels = TRUE,</span></span>
<span id="cb96-43"><a href="individual-parameter-analyses.html#cb96-43" aria-hidden="true" tabindex="-1"></a><span class="co">#                    earlyLife = TRUE) %&gt;%</span></span>
<span id="cb96-44"><a href="individual-parameter-analyses.html#cb96-44" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) %&gt;% </span></span>
<span id="cb96-45"><a href="individual-parameter-analyses.html#cb96-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary()</span></span>
<span id="cb96-46"><a href="individual-parameter-analyses.html#cb96-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-47"><a href="individual-parameter-analyses.html#cb96-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Freshwater Chloride Example:</span></span>
<span id="cb96-48"><a href="individual-parameter-analyses.html#cb96-48" aria-hidden="true" tabindex="-1"></a><span class="co"># annualRollingExceedanceSummary(</span></span>
<span id="cb96-49"><a href="individual-parameter-analyses.html#cb96-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(</span></span>
<span id="cb96-50"><a href="individual-parameter-analyses.html#cb96-50" aria-hidden="true" tabindex="-1"></a><span class="co">#     chlorideFreshwaterAnalysis(stationData),</span></span>
<span id="cb96-51"><a href="individual-parameter-analyses.html#cb96-51" aria-hidden="true" tabindex="-1"></a><span class="co">#     yearsToRoll = 3, aquaticLifeUse = TRUE) )</span></span>
<span id="cb96-52"><a href="individual-parameter-analyses.html#cb96-52" aria-hidden="true" tabindex="-1"></a><span class="co"># chlorideFreshwaterAnalysis(stationData) %&gt;%</span></span>
<span id="cb96-53"><a href="individual-parameter-analyses.html#cb96-53" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) %&gt;%</span></span>
<span id="cb96-54"><a href="individual-parameter-analyses.html#cb96-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary()</span></span></code></pre></div>
</div>
<div id="rollingwindowsummary" class="section level4" number="3.5.7.4">
<h4><span class="header-section-number">3.5.7.4</span> rollingWindowSummary</h4>
<p>The <code>rollingWindowSummary()</code> helper function summarizes the output of the <code>annualRollingExceedanceSummary()</code> function for a simplified output for the Station Table. The nested series of functions that analyzed the ammonia data are summarized in an output of two columns, detailing the number of exceedances and the suggested parameter status. As of the writing of this document, the value desired in the number of exceedances column has not been determined (potentially the number of windows with exceedances or the number of exceedances across all windows), so to be conservative, this is left as NA right now and requires input by assessment staff before upload into CEDS. However, the parameter status is summarized as such. Should a â€œReviewâ€ result be contained in any of the acute, chronic, or four day results, then the parameter status will be set to â€œReviewâ€ to signify to the assessor that further review is needed for the decision. If all criteria assessed contain â€œSupportingâ€ results, then the parameter status will suggest the parameter status is supporting (â€œSâ€). The <code>parameterAbbreviation</code> argument passes a character string of the chosen parameter name to the Station Table output column headers.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="individual-parameter-analyses.html#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling summary for stations table</span></span>
<span id="cb97-2"><a href="individual-parameter-analyses.html#cb97-2" aria-hidden="true" tabindex="-1"></a>rollingWindowSummary <span class="ot">&lt;-</span> <span class="cf">function</span>(annualRollingExceedanceSummaryOutput, parameterAbbreviation){</span>
<span id="cb97-3"><a href="individual-parameter-analyses.html#cb97-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-4"><a href="individual-parameter-analyses.html#cb97-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">&quot;Review&quot;</span> <span class="sc">%in%</span> <span class="fu">unique</span>(annualRollingExceedanceSummaryOutput<span class="sc">$</span><span class="st">`</span><span class="at">Suggested Result</span><span class="st">`</span>)){</span>
<span id="cb97-5"><a href="individual-parameter-analyses.html#cb97-5" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Review&#39;</span>)</span>
<span id="cb97-6"><a href="individual-parameter-analyses.html#cb97-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb97-7"><a href="individual-parameter-analyses.html#cb97-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># first kick out NULL entries (no data to analyze)</span></span>
<span id="cb97-8"><a href="individual-parameter-analyses.html#cb97-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.null</span>(annualRollingExceedanceSummaryOutput)){</span>
<span id="cb97-9"><a href="individual-parameter-analyses.html#cb97-9" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>))</span>
<span id="cb97-10"><a href="individual-parameter-analyses.html#cb97-10" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {  z <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">`</span><span class="at">_EXC</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="st">`</span><span class="at">_STAT</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;S&quot;</span>)} }</span>
<span id="cb97-11"><a href="individual-parameter-analyses.html#cb97-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(z) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(parameterAbbreviation, <span class="fu">names</span>(z))</span>
<span id="cb97-12"><a href="individual-parameter-analyses.html#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(z)</span>
<span id="cb97-13"><a href="individual-parameter-analyses.html#cb97-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-14"><a href="individual-parameter-analyses.html#cb97-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-15"><a href="individual-parameter-analyses.html#cb97-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage: (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb97-16"><a href="individual-parameter-analyses.html#cb97-16" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb97-17"><a href="individual-parameter-analyses.html#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="co"># rollingWindowSummary(</span></span>
<span id="cb97-18"><a href="individual-parameter-analyses.html#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary(</span></span>
<span id="cb97-19"><a href="individual-parameter-analyses.html#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     annualRollingExceedanceAnalysis(</span></span>
<span id="cb97-20"><a href="individual-parameter-analyses.html#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="co">#       freshwaterNH3limit(stationData,</span></span>
<span id="cb97-21"><a href="individual-parameter-analyses.html#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="co">#                          trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb97-22"><a href="individual-parameter-analyses.html#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">#                          mussels = TRUE,</span></span>
<span id="cb97-23"><a href="individual-parameter-analyses.html#cb97-23" aria-hidden="true" tabindex="-1"></a><span class="co">#                          earlyLife = TRUE),</span></span>
<span id="cb97-24"><a href="individual-parameter-analyses.html#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="co">#       yearsToRoll = 3, aquaticLifeUse = FALSE)</span></span>
<span id="cb97-25"><a href="individual-parameter-analyses.html#cb97-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     ),</span></span>
<span id="cb97-26"><a href="individual-parameter-analyses.html#cb97-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   parameterAbbreviation = &quot;AMMONIA&quot;</span></span>
<span id="cb97-27"><a href="individual-parameter-analyses.html#cb97-27" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb97-28"><a href="individual-parameter-analyses.html#cb97-28" aria-hidden="true" tabindex="-1"></a><span class="co"># freshwaterNH3limit(stationData,</span></span>
<span id="cb97-29"><a href="individual-parameter-analyses.html#cb97-29" aria-hidden="true" tabindex="-1"></a><span class="co">#                    trout = ifelse(unique(stationData$CLASS) %in% c(&#39;V&#39;,&#39;VI&#39;), TRUE, FALSE),</span></span>
<span id="cb97-30"><a href="individual-parameter-analyses.html#cb97-30" aria-hidden="true" tabindex="-1"></a><span class="co">#                    mussels = TRUE,</span></span>
<span id="cb97-31"><a href="individual-parameter-analyses.html#cb97-31" aria-hidden="true" tabindex="-1"></a><span class="co">#                    earlyLife = TRUE) %&gt;%</span></span>
<span id="cb97-32"><a href="individual-parameter-analyses.html#cb97-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) %&gt;%</span></span>
<span id="cb97-33"><a href="individual-parameter-analyses.html#cb97-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary() %&gt;% </span></span>
<span id="cb97-34"><a href="individual-parameter-analyses.html#cb97-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   rollingWindowSummary(parameterAbbreviation = &quot;AMMONIA&quot;)</span></span>
<span id="cb97-35"><a href="individual-parameter-analyses.html#cb97-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-36"><a href="individual-parameter-analyses.html#cb97-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-37"><a href="individual-parameter-analyses.html#cb97-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Freshwater Chloride Example:</span></span>
<span id="cb97-38"><a href="individual-parameter-analyses.html#cb97-38" aria-hidden="true" tabindex="-1"></a><span class="co"># rollingWindowSummary(</span></span>
<span id="cb97-39"><a href="individual-parameter-analyses.html#cb97-39" aria-hidden="true" tabindex="-1"></a><span class="co">#         annualRollingExceedanceSummary(</span></span>
<span id="cb97-40"><a href="individual-parameter-analyses.html#cb97-40" aria-hidden="true" tabindex="-1"></a><span class="co">#           annualRollingExceedanceAnalysis(</span></span>
<span id="cb97-41"><a href="individual-parameter-analyses.html#cb97-41" aria-hidden="true" tabindex="-1"></a><span class="co">#             chlorideFreshwaterAnalysis(stationData),</span></span>
<span id="cb97-42"><a href="individual-parameter-analyses.html#cb97-42" aria-hidden="true" tabindex="-1"></a><span class="co">#             yearsToRoll = 3, aquaticLifeUse = TRUE) ),</span></span>
<span id="cb97-43"><a href="individual-parameter-analyses.html#cb97-43" aria-hidden="true" tabindex="-1"></a><span class="co">#         parameterAbbreviation = &quot;CHL&quot;)</span></span>
<span id="cb97-44"><a href="individual-parameter-analyses.html#cb97-44" aria-hidden="true" tabindex="-1"></a><span class="co"># chlorideFreshwaterAnalysis(stationData) %&gt;%</span></span>
<span id="cb97-45"><a href="individual-parameter-analyses.html#cb97-45" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) %&gt;%</span></span>
<span id="cb97-46"><a href="individual-parameter-analyses.html#cb97-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary() %&gt;%</span></span>
<span id="cb97-47"><a href="individual-parameter-analyses.html#cb97-47" aria-hidden="true" tabindex="-1"></a><span class="co">#   rollingWindowSummary(parameterAbbreviation = &quot;CHL&quot;)</span></span></code></pre></div>
</div>
</div>
<div id="water-column-toxics" class="section level3" number="3.5.8">
<h3><span class="header-section-number">3.5.8</span> Water Column Toxics</h3>
<p>Since there is no place in the Station Table for individual Public Water Supply, freshwater chloride, or water column PCB criteria results, the WAT_TOX fields summarize exceedances for PWS criteria, freshwater chloride aquatic life use, and water column PCB status. The code snippet below (see <a href="automated-assessment-analysis.html#automated-assessment-analysis">Automated Assessment Analysis</a>) outlines how these criteria results are combined into a single field in the Station Table. It is highly advised that assessment staff use this field as a flag when reviewing a station summary from the Station Table using the appropriate waterbody-specific shiny assessment application to fully understand which criteria may be providing the WAT_TOX flag.</p>
<p>See the <a href="individual-parameter-analyses.html#public-water-supply-criteria">Public Water Supply Criteria</a>, <a href="individual-parameter-analyses.html#freshwater-chloride">Freshwater Chloride</a>, and <a href="individual-parameter-analyses.html#pcb">PCB</a> sections below for details on individual parameter functions demonstrated in the below chunk.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="individual-parameter-analyses.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># code snippet from Automated Assessment Analysis</span></span>
<span id="cb98-2"><a href="individual-parameter-analyses.html#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb98-3"><a href="individual-parameter-analyses.html#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="individual-parameter-analyses.html#cb98-4" aria-hidden="true" tabindex="-1"></a> <span class="co"># PWS Human Health Criteria</span></span>
<span id="cb98-5"><a href="individual-parameter-analyses.html#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationData) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb98-6"><a href="individual-parameter-analyses.html#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>PWS))  ){</span>
<span id="cb98-7"><a href="individual-parameter-analyses.html#cb98-7" aria-hidden="true" tabindex="-1"></a>      PWSconcat <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">PWS=</span> <span class="cn">NA</span>)</span>
<span id="cb98-8"><a href="individual-parameter-analyses.html#cb98-8" aria-hidden="true" tabindex="-1"></a>   } <span class="cf">else</span> {</span>
<span id="cb98-9"><a href="individual-parameter-analyses.html#cb98-9" aria-hidden="true" tabindex="-1"></a>     PWSconcat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="fu">assessPWSsummary</span>(<span class="fu">assessPWS</span>(stationData, NITRATE_mg_L, LEVEL_NITRATE, <span class="dv">10</span>), <span class="st">&#39;PWS_Nitrate&#39;</span>),</span>
<span id="cb98-10"><a href="individual-parameter-analyses.html#cb98-10" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">assessPWSsummary</span>(<span class="fu">assessPWS</span>(stationData, CHLORIDE_mg_L, LEVEL_CHLORIDE, <span class="dv">250</span>), <span class="st">&#39;PWS_Chloride&#39;</span>),</span>
<span id="cb98-11"><a href="individual-parameter-analyses.html#cb98-11" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">assessPWSsummary</span>(<span class="fu">assessPWS</span>(stationData, SULFATE_TOTAL_mg_L, LEVEL_SULFATE_TOTAL, <span class="dv">250</span>), <span class="st">&#39;PWS_Total_Sulfate&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb98-12"><a href="individual-parameter-analyses.html#cb98-12" aria-hidden="true" tabindex="-1"></a>       dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">&#39;exceedanceRate&#39;</span>)) }</span>
<span id="cb98-13"><a href="individual-parameter-analyses.html#cb98-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-14"><a href="individual-parameter-analyses.html#cb98-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Freshwater Chloride Aquatic Life assessment, if data exists</span></span>
<span id="cb98-15"><a href="individual-parameter-analyses.html#cb98-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">filter</span>(stationData, <span class="sc">!</span><span class="fu">is.na</span>(CHLORIDE_mg_L))) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb98-16"><a href="individual-parameter-analyses.html#cb98-16" aria-hidden="true" tabindex="-1"></a>      chlorideFreshwater <span class="ot">&lt;-</span> <span class="fu">rollingWindowSummary</span>(</span>
<span id="cb98-17"><a href="individual-parameter-analyses.html#cb98-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">annualRollingExceedanceSummary</span>(</span>
<span id="cb98-18"><a href="individual-parameter-analyses.html#cb98-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">annualRollingExceedanceAnalysis</span>(<span class="fu">chlorideFreshwaterAnalysis</span>(stationData), <span class="at">yearsToRoll =</span> <span class="dv">3</span>, <span class="at">aquaticLifeUse =</span> <span class="cn">TRUE</span>) ), <span class="st">&quot;CHL&quot;</span>)</span>
<span id="cb98-19"><a href="individual-parameter-analyses.html#cb98-19" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {chlorideFreshwater <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">CHL_EXC =</span> <span class="cn">NA</span>, <span class="at">CHL_STAT=</span> <span class="cn">NA</span>)}</span>
<span id="cb98-20"><a href="individual-parameter-analyses.html#cb98-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-21"><a href="individual-parameter-analyses.html#cb98-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Water toxics combination with PWS, Chloride Freshwater, and water column PCB data</span></span>
<span id="cb98-22"><a href="individual-parameter-analyses.html#cb98-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(<span class="fu">bind_cols</span>(PWSconcat,</span>
<span id="cb98-23"><a href="individual-parameter-analyses.html#cb98-23" aria-hidden="true" tabindex="-1"></a>                    chlorideFreshwater,</span>
<span id="cb98-24"><a href="individual-parameter-analyses.html#cb98-24" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">PCBmetalsDataExists</span>(<span class="fu">filter</span>(markPCB, <span class="fu">str_detect</span>(SampleMedia, <span class="st">&#39;Water&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb98-25"><a href="individual-parameter-analyses.html#cb98-25" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">filter</span>(StationID <span class="sc">%in%</span> stationData<span class="sc">$</span>FDT_STA_ID), <span class="st">&#39;WAT_TOX&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb98-26"><a href="individual-parameter-analyses.html#cb98-26" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">contains</span>(<span class="fu">c</span>(<span class="st">&#39;_EXC&#39;</span>,<span class="st">&#39;_STAT&#39;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb98-27"><a href="individual-parameter-analyses.html#cb98-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="fu">across</span>( <span class="fu">everything</span>(),  as.character)) <span class="sc">%&gt;%</span></span>
<span id="cb98-28"><a href="individual-parameter-analyses.html#cb98-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="fu">c</span>(<span class="st">&#39;_EXC&#39;</span>,<span class="st">&#39;_STAT&#39;</span>)), <span class="at">names_to =</span> <span class="st">&#39;parameter&#39;</span>, <span class="at">values_to =</span> <span class="st">&#39;values&#39;</span>, <span class="at">values_drop_na =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb98-29"><a href="individual-parameter-analyses.html#cb98-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span> <span class="fu">str_detect</span>(values, <span class="st">&#39;WQS info missing from analysis&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb98-30"><a href="individual-parameter-analyses.html#cb98-30" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span> values <span class="sc">==</span> <span class="st">&quot;S&quot;</span>)) <span class="sc">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb98-31"><a href="individual-parameter-analyses.html#cb98-31" aria-hidden="true" tabindex="-1"></a>    WCtoxics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">WAT_TOX_EXC =</span> <span class="cn">NA</span>, <span class="at">WAT_TOX_STAT =</span> <span class="st">&#39;Review&#39;</span>)</span>
<span id="cb98-32"><a href="individual-parameter-analyses.html#cb98-32" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { WCtoxics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">WAT_TOX_EXC =</span> <span class="cn">NA</span>, <span class="at">WAT_TOX_STAT =</span> <span class="cn">NA</span>)} </span>
<span id="cb98-33"><a href="individual-parameter-analyses.html#cb98-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-34"><a href="individual-parameter-analyses.html#cb98-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb98-35"><a href="individual-parameter-analyses.html#cb98-35" aria-hidden="true" tabindex="-1"></a>    WCtoxics <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">WAT_TOX_EXC =</span> <span class="cn">NA</span>, <span class="at">WAT_TOX_STAT =</span> <span class="cn">NA</span>)</span>
<span id="cb98-36"><a href="individual-parameter-analyses.html#cb98-36" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
</div>
<div id="public-water-supply-criteria" class="section level3" number="3.5.9">
<h3><span class="header-section-number">3.5.9</span> Public Water Supply Criteria</h3>
<p>Public Water Supply (PWS) human health criteria are assessed using the <code>assessPWS()</code> function and summarized for the Station Table by <code>assessPWSsummary()</code> function. These functions operate across PWS parameters, using non-standard evaluation techniques to allow users to specify which parameter to evaluate and the associated criteria using function arguments. If the WQS metadata linked to the station is designated as a PWS segment, the <code>assessPWS()</code> function first removes all Level I and Level II data and missing data before the median of measures collected over a six year assessment period is calculated. The parameter six year median is rounded to even, compared against the provided criteria, and flagged if the median exceeds the provided criteria limit.</p>
<p><strong>Chloride, Sulfate, Total Dissolved Solids, Iron, and Foaming Agents are secondary criteria and are only applicable to data collected at the drinking water intake.</strong> To be most protective, the automated assessment process evaluates all PWS designated segments for each of these criteria if data exists, regardless of the proximity of the station to the drinking water supply intake. It is the responsibility of the assessment staff to remove these decisions from the Station Table when they are not applicable. <strong>The waterbody-specific shiny assessment applications flag stations within 100 meters from a drinking water intake.</strong></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="individual-parameter-analyses.html#cb99-1" aria-hidden="true" tabindex="-1"></a>assessPWS <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData, fieldName, commentName, PWSlimit){</span>
<span id="cb99-2"><a href="individual-parameter-analyses.html#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">unique</span>(stationData<span class="sc">$</span>PWS) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Yes&quot;</span>)){</span>
<span id="cb99-3"><a href="individual-parameter-analyses.html#cb99-3" aria-hidden="true" tabindex="-1"></a>    fieldName_ <span class="ot">&lt;-</span> <span class="fu">enquo</span>(fieldName)</span>
<span id="cb99-4"><a href="individual-parameter-analyses.html#cb99-4" aria-hidden="true" tabindex="-1"></a>    commentName_ <span class="ot">&lt;-</span> <span class="fu">enquo</span>(commentName)</span>
<span id="cb99-5"><a href="individual-parameter-analyses.html#cb99-5" aria-hidden="true" tabindex="-1"></a>    parameterData <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_DATE_TIME, <span class="sc">!!</span> fieldName_, <span class="sc">!!</span> commentName_) <span class="sc">%&gt;%</span></span>
<span id="cb99-6"><a href="individual-parameter-analyses.html#cb99-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span>( <span class="sc">!!</span> commentName_ <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb99-7"><a href="individual-parameter-analyses.html#cb99-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span>fieldName_ )) <span class="sc">%&gt;%</span> <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb99-8"><a href="individual-parameter-analyses.html#cb99-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Parameter Median</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">median</span>(<span class="sc">!!</span> fieldName_),</span>
<span id="cb99-9"><a href="individual-parameter-analyses.html#cb99-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">`</span><span class="at">Parameter Rounded to WQS Format</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="st">`</span><span class="at">Parameter Median</span><span class="st">`</span>, <span class="at">digits =</span> <span class="dv">2</span>),  <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb99-10"><a href="individual-parameter-analyses.html#cb99-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">limit =</span>  PWSlimit) <span class="sc">%&gt;%</span></span>
<span id="cb99-11"><a href="individual-parameter-analyses.html#cb99-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">parameter =</span> <span class="sc">!!</span><span class="fu">names</span>(.[<span class="dv">5</span>])) <span class="sc">%&gt;%</span> <span class="co"># rename columns to make functions easier to apply</span></span>
<span id="cb99-12"><a href="individual-parameter-analyses.html#cb99-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">exceeds =</span> <span class="fu">ifelse</span>(parameter <span class="sc">&gt;</span> limit, T, F)) <span class="co"># Identify where above WQS limit</span></span>
<span id="cb99-13"><a href="individual-parameter-analyses.html#cb99-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(parameterData)</span>
<span id="cb99-14"><a href="individual-parameter-analyses.html#cb99-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-15"><a href="individual-parameter-analyses.html#cb99-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb99-16"><a href="individual-parameter-analyses.html#cb99-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-17"><a href="individual-parameter-analyses.html#cb99-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-18"><a href="individual-parameter-analyses.html#cb99-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb99-19"><a href="individual-parameter-analyses.html#cb99-19" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb99-20"><a href="individual-parameter-analyses.html#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWS(stationData, NITRATE_mg_L, LEVEL_NITRATE, 10)</span></span>
<span id="cb99-21"><a href="individual-parameter-analyses.html#cb99-21" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWS(stationData, CHLORIDE_mg_L, LEVEL_CHLORIDE, 250)</span></span>
<span id="cb99-22"><a href="individual-parameter-analyses.html#cb99-22" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWS(stationData, SULFATE_TOTAL_mg_L, LEVEL_SULFATE_TOTAL, 250)</span></span></code></pre></div>
<p>The output of the <code>assessPWS()</code> function becomes the input for the <code>assessPWSsummary()</code> function when the user desires the results to be summarized for the Station Table.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="individual-parameter-analyses.html#cb100-1" aria-hidden="true" tabindex="-1"></a>assessPWSsummary <span class="ot">&lt;-</span> <span class="cf">function</span>(assessPWSresults, </span>
<span id="cb100-2"><a href="individual-parameter-analyses.html#cb100-2" aria-hidden="true" tabindex="-1"></a>                             outputName){</span>
<span id="cb100-3"><a href="individual-parameter-analyses.html#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(assessPWSresults)){</span>
<span id="cb100-4"><a href="individual-parameter-analyses.html#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">quickStats</span>(assessPWSresults, outputName))  </span>
<span id="cb100-5"><a href="individual-parameter-analyses.html#cb100-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-6"><a href="individual-parameter-analyses.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">quickStats</span>(<span class="fu">tibble</span>(<span class="at">limit =</span> <span class="cn">NA</span>), outputName))</span>
<span id="cb100-7"><a href="individual-parameter-analyses.html#cb100-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-8"><a href="individual-parameter-analyses.html#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="individual-parameter-analyses.html#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb100-10"><a href="individual-parameter-analyses.html#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb100-11"><a href="individual-parameter-analyses.html#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWSsummary(assessPWS(stationData, NITRATE_mg_L, LEVEL_NITRATE, 10), &#39;PWS_Nitrate&#39;)</span></span>
<span id="cb100-12"><a href="individual-parameter-analyses.html#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWSsummary(assessPWS(stationData, CHLORIDE_mg_L, LEVEL_CHLORIDE, 250), &#39;PWS_Chloride&#39;)</span></span>
<span id="cb100-13"><a href="individual-parameter-analyses.html#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="co">#assessPWSsummary(assessPWS(stationData, SULFATE_TOTAL_mg_L, LEVEL_SULFATE_TOTAL, 250), &#39;PWS_Total_Sulfate&#39;)</span></span></code></pre></div>
</div>
<div id="freshwater-chloride" class="section level3" number="3.5.10">
<h3><span class="header-section-number">3.5.10</span> Freshwater Chloride</h3>
<p>Chloride is assessed for Aquatic Life Uses using acute and chronic criteria only in freshwater environments. The evaluation of chloride data against acute and chronic criteria is performed by the <code>chlorideFreshwaterAnalysis()</code> function while the summarization of results to conduct an assessment decision is performed by the nested <a href="individual-parameter-analyses.html#annualrollingexceedanceanalysis"><code>annualRollingExceedanceAnalysis()</code></a>, <a href="individual-parameter-analyses.html#annualrollingexceedancesummary"><code>annualRollingExceedanceSummary()</code></a>, and <a href="individual-parameter-analyses.html#rollingwindowsummary"><code>rollingWindowSummary()</code></a> functions. These functions are detailed for ammonia, but the same logic rules apply to any parameter dataset provided to the function logic. An example of the freshwater chloride analysis and summarization for the Station Table are provided in the chunk below.</p>
<p>The <code>chlorideFreshwaterAnalysis()</code> function first ensures the station provided to the function is designated a freshwater or transitional before removing all Level I and Level II data and missing data. If data exist after those initial filters are applied, subsequent logic may be applied, if not, the function returns NULL. The function then creates storage objects for acute and chronic average results and loops through each row of data to correctly calculate acute criteria and find any chronic scenarios (if data exist). Each new sample event prompts the creation of acute and chronic data windows.</p>
<p>If sufficient data exist in any of these windows, the appropriate criteria are applied to the window chloride average, rounded to even. To be most protective, chronic windows are calculated if one or more measure exists in any data window; this information is useful for assessor visualization and understanding in the application environment, but these results based on only one measure are culled from assessment decisions in later functions. The data analyzed within each window is saved as a listcolumn called <code>associatedData</code> that may be extracted for investigation later. The output of the function is a long dataset where each unique sample event could have a row summarizing the acute and chronic criteria, sample count in the given window, exceedance result, and associated data (<code>associatedData</code> listcolumn).</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="individual-parameter-analyses.html#cb101-1" aria-hidden="true" tabindex="-1"></a>chlorideFreshwaterAnalysis <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb101-2"><a href="individual-parameter-analyses.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># doesn&#39;t apply in class II transition zone</span></span>
<span id="cb101-3"><a href="individual-parameter-analyses.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  stationDataCHL <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, CLASS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;III&#39;</span>, <span class="st">&quot;IV&quot;</span>,<span class="st">&quot;V&quot;</span>,<span class="st">&quot;VI&quot;</span>,<span class="st">&quot;VII&quot;</span>) <span class="sc">|</span></span>
<span id="cb101-4"><a href="individual-parameter-analyses.html#cb101-4" aria-hidden="true" tabindex="-1"></a>                             CLASS <span class="sc">==</span>  <span class="st">&quot;II&quot;</span> <span class="sc">&amp;</span> ZONE <span class="sc">==</span> <span class="st">&#39;Tidal Fresh&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb101-5"><a href="individual-parameter-analyses.html#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span>(LEVEL_CHLORIDE <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Level II&#39;</span>, <span class="st">&#39;Level I&#39;</span>))) <span class="sc">%&gt;%</span> <span class="co"># get lower levels out</span></span>
<span id="cb101-6"><a href="individual-parameter-analyses.html#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(CHLORIDE_mg_L)) <span class="co">#get rid of NA&#39;s</span></span>
<span id="cb101-7"><a href="individual-parameter-analyses.html#cb101-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-8"><a href="individual-parameter-analyses.html#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(stationDataCHL) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb101-9"><a href="individual-parameter-analyses.html#cb101-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-10"><a href="individual-parameter-analyses.html#cb101-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-11"><a href="individual-parameter-analyses.html#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># make a place to store analysis results</span></span>
<span id="cb101-12"><a href="individual-parameter-analyses.html#cb101-12" aria-hidden="true" tabindex="-1"></a>    acuteCriteriaResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">FDT_STA_ID =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">WindowDateTimeStart =</span> <span class="fu">as.POSIXct</span>(<span class="cn">NA</span>), <span class="at">FDT_DEPTH =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb101-13"><a href="individual-parameter-analyses.html#cb101-13" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">Value =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">ValueType =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), </span>
<span id="cb101-14"><a href="individual-parameter-analyses.html#cb101-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb101-15"><a href="individual-parameter-analyses.html#cb101-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), </span>
<span id="cb101-16"><a href="individual-parameter-analyses.html#cb101-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">parameterRound =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">Exceedance =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb101-17"><a href="individual-parameter-analyses.html#cb101-17" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">associatedData =</span> <span class="fu">list</span>())</span>
<span id="cb101-18"><a href="individual-parameter-analyses.html#cb101-18" aria-hidden="true" tabindex="-1"></a>    chronicCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults</span>
<span id="cb101-19"><a href="individual-parameter-analyses.html#cb101-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-20"><a href="individual-parameter-analyses.html#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># loop through each row of data to correctly calculate criteria and find any chronic scenarios</span></span>
<span id="cb101-21"><a href="individual-parameter-analyses.html#cb101-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> stationDataCHL<span class="sc">$</span>FDT_DATE_TIME){  <span class="co">#k = stationDataCHL$FDT_DATE_TIME[1]</span></span>
<span id="cb101-22"><a href="individual-parameter-analyses.html#cb101-22" aria-hidden="true" tabindex="-1"></a>      acuteDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationDataCHL,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>)))</span>
<span id="cb101-23"><a href="individual-parameter-analyses.html#cb101-23" aria-hidden="true" tabindex="-1"></a>      chronicDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationDataCHL,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">4</span>)))</span>
<span id="cb101-24"><a href="individual-parameter-analyses.html#cb101-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-25"><a href="individual-parameter-analyses.html#cb101-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Run acute analysis if data exists</span></span>
<span id="cb101-26"><a href="individual-parameter-analyses.html#cb101-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(acuteDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb101-27"><a href="individual-parameter-analyses.html#cb101-27" aria-hidden="true" tabindex="-1"></a>        acuteDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>( </span>
<span id="cb101-28"><a href="individual-parameter-analyses.html#cb101-28" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(acuteDataWindow, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, CHLORIDE_mg_L) <span class="sc">%&gt;%</span> </span>
<span id="cb101-29"><a href="individual-parameter-analyses.html#cb101-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(FDT_STA_ID, FDT_DEPTH) <span class="sc">%&gt;%</span> <span class="co"># can&#39;t group by datetime or summary can&#39;t happen</span></span>
<span id="cb101-30"><a href="individual-parameter-analyses.html#cb101-30" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">Value =</span> <span class="fu">mean</span>(CHLORIDE_mg_L, <span class="at">na.rm=</span>T),  <span class="co"># get hourly average</span></span>
<span id="cb101-31"><a href="individual-parameter-analyses.html#cb101-31" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">length</span>(CHLORIDE_mg_L)) <span class="sc">%&gt;%</span>  <span class="co">#count sample that made up average</span></span>
<span id="cb101-32"><a href="individual-parameter-analyses.html#cb101-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Hourly Average&#39;</span>,</span>
<span id="cb101-33"><a href="individual-parameter-analyses.html#cb101-33" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ID =</span> <span class="fu">paste</span>( FDT_STA_ID, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>), <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb101-34"><a href="individual-parameter-analyses.html#cb101-34" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Acute&#39;</span>, </span>
<span id="cb101-35"><a href="individual-parameter-analyses.html#cb101-35" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CriteriaValue =</span> <span class="dv">860</span>) <span class="sc">%&gt;%</span>  <span class="co"># 860,000ug/L criteria to mg/L</span></span>
<span id="cb101-36"><a href="individual-parameter-analyses.html#cb101-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb101-37"><a href="individual-parameter-analyses.html#cb101-37" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb101-38"><a href="individual-parameter-analyses.html#cb101-38" aria-hidden="true" tabindex="-1"></a>                 <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(acuteDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb101-39"><a href="individual-parameter-analyses.html#cb101-39" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID) ) <span class="sc">%&gt;%</span> </span>
<span id="cb101-40"><a href="individual-parameter-analyses.html#cb101-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(acuteDataWindow, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, CHLORIDE_mg_L) ) ))</span>
<span id="cb101-41"><a href="individual-parameter-analyses.html#cb101-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the results for viewing later</span></span>
<span id="cb101-42"><a href="individual-parameter-analyses.html#cb101-42" aria-hidden="true" tabindex="-1"></a>        acuteCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(acuteCriteriaResults, acuteDataCriteriaAnalysis) </span>
<span id="cb101-43"><a href="individual-parameter-analyses.html#cb101-43" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {acuteCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults }</span>
<span id="cb101-44"><a href="individual-parameter-analyses.html#cb101-44" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb101-45"><a href="individual-parameter-analyses.html#cb101-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Run chronic analysis if data exists</span></span>
<span id="cb101-46"><a href="individual-parameter-analyses.html#cb101-46" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(chronicDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb101-47"><a href="individual-parameter-analyses.html#cb101-47" aria-hidden="true" tabindex="-1"></a>        chronicDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>( </span>
<span id="cb101-48"><a href="individual-parameter-analyses.html#cb101-48" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(chronicDataWindow, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, CHLORIDE_mg_L) <span class="sc">%&gt;%</span> </span>
<span id="cb101-49"><a href="individual-parameter-analyses.html#cb101-49" aria-hidden="true" tabindex="-1"></a>          <span class="fu">group_by</span>(FDT_STA_ID, FDT_DEPTH) <span class="sc">%&gt;%</span> <span class="co"># can&#39;t group by datetime or summary can&#39;t happen</span></span>
<span id="cb101-50"><a href="individual-parameter-analyses.html#cb101-50" aria-hidden="true" tabindex="-1"></a>          <span class="fu">summarise</span>(<span class="at">Value =</span> <span class="fu">mean</span>(CHLORIDE_mg_L, <span class="at">na.rm=</span>T),  <span class="co"># get hourly average</span></span>
<span id="cb101-51"><a href="individual-parameter-analyses.html#cb101-51" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Sample Count</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">length</span>(CHLORIDE_mg_L)) <span class="sc">%&gt;%</span>  <span class="co">#count sample that made up average</span></span>
<span id="cb101-52"><a href="individual-parameter-analyses.html#cb101-52" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Four Day Average&#39;</span>,</span>
<span id="cb101-53"><a href="individual-parameter-analyses.html#cb101-53" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ID =</span> <span class="fu">paste</span>( FDT_STA_ID, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>), <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb101-54"><a href="individual-parameter-analyses.html#cb101-54" aria-hidden="true" tabindex="-1"></a>                 <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;Chronic&#39;</span>, </span>
<span id="cb101-55"><a href="individual-parameter-analyses.html#cb101-55" aria-hidden="true" tabindex="-1"></a>                 <span class="at">CriteriaValue =</span> <span class="dv">230</span>) <span class="sc">%&gt;%</span>  <span class="co"># 230,000ug/L criteria to mg/L</span></span>
<span id="cb101-56"><a href="individual-parameter-analyses.html#cb101-56" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb101-57"><a href="individual-parameter-analyses.html#cb101-57" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb101-58"><a href="individual-parameter-analyses.html#cb101-58" aria-hidden="true" tabindex="-1"></a>                 <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(chronicDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb101-59"><a href="individual-parameter-analyses.html#cb101-59" aria-hidden="true" tabindex="-1"></a>          dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID) ) <span class="sc">%&gt;%</span> </span>
<span id="cb101-60"><a href="individual-parameter-analyses.html#cb101-60" aria-hidden="true" tabindex="-1"></a>          <span class="fu">bind_cols</span>(<span class="fu">tibble</span>(<span class="at">associatedData =</span> <span class="fu">list</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(chronicDataWindow, FDT_STA_ID, FDT_DATE_TIME, FDT_DEPTH, CHLORIDE_mg_L) ) ))</span>
<span id="cb101-61"><a href="individual-parameter-analyses.html#cb101-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the results for viewing later</span></span>
<span id="cb101-62"><a href="individual-parameter-analyses.html#cb101-62" aria-hidden="true" tabindex="-1"></a>        chronicCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(chronicCriteriaResults, chronicDataCriteriaAnalysis) </span>
<span id="cb101-63"><a href="individual-parameter-analyses.html#cb101-63" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {chronicCriteriaResults <span class="ot">&lt;-</span> chronicCriteriaResults }</span>
<span id="cb101-64"><a href="individual-parameter-analyses.html#cb101-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb101-65"><a href="individual-parameter-analyses.html#cb101-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># summarize results</span></span>
<span id="cb101-66"><a href="individual-parameter-analyses.html#cb101-66" aria-hidden="true" tabindex="-1"></a>    stationCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>( acuteCriteriaResults, chronicCriteriaResults) <span class="sc">%&gt;%</span> </span>
<span id="cb101-67"><a href="individual-parameter-analyses.html#cb101-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(FDT_STA_ID)) <span class="sc">%&gt;%</span> <span class="co"># drop placeholder rows</span></span>
<span id="cb101-68"><a href="individual-parameter-analyses.html#cb101-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">distinct</span>(FDT_STA_ID, WindowDateTimeStart, FDT_DEPTH, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> <span class="co"># remove duplicates in case &gt; 1 depth per datetime</span></span>
<span id="cb101-69"><a href="individual-parameter-analyses.html#cb101-69" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(FDT_STA_ID, WindowDateTimeStart, FDT_DEPTH, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>)</span>
<span id="cb101-70"><a href="individual-parameter-analyses.html#cb101-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(stationCriteriaResults)</span>
<span id="cb101-71"><a href="individual-parameter-analyses.html#cb101-71" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="fu">return</span>(<span class="cn">NULL</span>)}</span>
<span id="cb101-72"><a href="individual-parameter-analyses.html#cb101-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-73"><a href="individual-parameter-analyses.html#cb101-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb101-74"><a href="individual-parameter-analyses.html#cb101-74" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb101-75"><a href="individual-parameter-analyses.html#cb101-75" aria-hidden="true" tabindex="-1"></a><span class="co"># chlorideFreshwaterAnalysis(stationData) </span></span>
<span id="cb101-76"><a href="individual-parameter-analyses.html#cb101-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage for Station Table (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb101-77"><a href="individual-parameter-analyses.html#cb101-77" aria-hidden="true" tabindex="-1"></a><span class="co"># rollingWindowSummary(</span></span>
<span id="cb101-78"><a href="individual-parameter-analyses.html#cb101-78" aria-hidden="true" tabindex="-1"></a><span class="co">#         annualRollingExceedanceSummary(</span></span>
<span id="cb101-79"><a href="individual-parameter-analyses.html#cb101-79" aria-hidden="true" tabindex="-1"></a><span class="co">#           annualRollingExceedanceAnalysis(</span></span>
<span id="cb101-80"><a href="individual-parameter-analyses.html#cb101-80" aria-hidden="true" tabindex="-1"></a><span class="co">#             chlorideFreshwaterAnalysis(stationData), </span></span>
<span id="cb101-81"><a href="individual-parameter-analyses.html#cb101-81" aria-hidden="true" tabindex="-1"></a><span class="co">#             yearsToRoll = 3, aquaticLifeUse = TRUE) ),  </span></span>
<span id="cb101-82"><a href="individual-parameter-analyses.html#cb101-82" aria-hidden="true" tabindex="-1"></a><span class="co">#         parameterAbbreviation = &quot;CHL&quot;)</span></span>
<span id="cb101-83"><a href="individual-parameter-analyses.html#cb101-83" aria-hidden="true" tabindex="-1"></a><span class="co"># chlorideFreshwaterAnalysis(stationData) %&gt;% </span></span>
<span id="cb101-84"><a href="individual-parameter-analyses.html#cb101-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceAnalysis(yearsToRoll = 3, aquaticLifeUse = FALSE) %&gt;% </span></span>
<span id="cb101-85"><a href="individual-parameter-analyses.html#cb101-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   annualRollingExceedanceSummary() %&gt;% </span></span>
<span id="cb101-86"><a href="individual-parameter-analyses.html#cb101-86" aria-hidden="true" tabindex="-1"></a><span class="co">#   rollingWindowSummary(parameterAbbreviation = &quot;CHL&quot;)</span></span></code></pre></div>
</div>
<div id="pcb" class="section level3" number="3.5.11">
<h3><span class="header-section-number">3.5.11</span> PCB</h3>
<p>The <code>PCBmetalsDataExists()</code> function is used primarily for flagging whether or not certain data exist when building the Station Table. Most stations evaluated during an assessment period do not have metals or toxics data, so it is important to flag when data require review. This particular function can be used to flag when data exist across water column PCB, sediment PCB, fish tissue metals, and fish tissue PCB data. When data exists for these toxics parameters, regional assessment staff may investigate them against applicable thresholds inside the waterbody-specific shiny assessment application.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="individual-parameter-analyses.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Identify if further review needs to happen for PCB or metals data </span></span>
<span id="cb102-2"><a href="individual-parameter-analyses.html#cb102-2" aria-hidden="true" tabindex="-1"></a>PCBmetalsDataExists <span class="ot">&lt;-</span> <span class="cf">function</span>(datasetType, <span class="co"># any of the preorganized PCB or fish tissue datasets</span></span>
<span id="cb102-3"><a href="individual-parameter-analyses.html#cb102-3" aria-hidden="true" tabindex="-1"></a>                                parameterType <span class="co"># field name to pass through to Station Table output</span></span>
<span id="cb102-4"><a href="individual-parameter-analyses.html#cb102-4" aria-hidden="true" tabindex="-1"></a>                                ){</span>
<span id="cb102-5"><a href="individual-parameter-analyses.html#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if any data given to function</span></span>
<span id="cb102-6"><a href="individual-parameter-analyses.html#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(datasetType) <span class="sc">&gt;</span> <span class="dv">0</span>){ </span>
<span id="cb102-7"><a href="individual-parameter-analyses.html#cb102-7" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EXC =</span> <span class="cn">NA</span>, <span class="at">STAT =</span> <span class="st">&#39;Review&#39;</span>)</span>
<span id="cb102-8"><a href="individual-parameter-analyses.html#cb102-8" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span> {</span>
<span id="cb102-9"><a href="individual-parameter-analyses.html#cb102-9" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EXC =</span> <span class="cn">NA</span>, <span class="at">STAT =</span> <span class="cn">NA</span>) }</span>
<span id="cb102-10"><a href="individual-parameter-analyses.html#cb102-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb102-11"><a href="individual-parameter-analyses.html#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(x) <span class="ot">&lt;-</span> <span class="fu">paste</span>(parameterType, <span class="fu">names</span>(x), <span class="at">sep=</span><span class="st">&#39;_&#39;</span>)</span>
<span id="cb102-12"><a href="individual-parameter-analyses.html#cb102-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(x)</span>
<span id="cb102-13"><a href="individual-parameter-analyses.html#cb102-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-14"><a href="individual-parameter-analyses.html#cb102-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-15"><a href="individual-parameter-analyses.html#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb102-16"><a href="individual-parameter-analyses.html#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="co"># where markPCB, fishMetals, fishPCB objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb102-17"><a href="individual-parameter-analyses.html#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="co"># PCBmetalsDataExists(filter(markPCB, str_detect(SampleMedia, &#39;Water&#39;)) %&gt;%</span></span>
<span id="cb102-18"><a href="individual-parameter-analyses.html#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                       filter(StationID %in% &#39;2-JKS023.61&#39;), &#39;WAT_TOX&#39;)</span></span>
<span id="cb102-19"><a href="individual-parameter-analyses.html#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="co"># PCBmetalsDataExists(filter(markPCB, str_detect(SampleMedia, &#39;Sediment&#39;)) %&gt;%</span></span>
<span id="cb102-20"><a href="individual-parameter-analyses.html#cb102-20" aria-hidden="true" tabindex="-1"></a><span class="co">#                       filter(StationID %in% &#39;2-JKS023.61&#39;), &#39;SED_TOX&#39;)</span></span>
<span id="cb102-21"><a href="individual-parameter-analyses.html#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="co"># PCBmetalsDataExists(filter(fishMetals, Station_ID %in% &#39;2-JKS023.61&#39;), &#39;FISH_MET&#39;)</span></span>
<span id="cb102-22"><a href="individual-parameter-analyses.html#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="co"># PCBmetalsDataExists(filter(fishPCB, `DEQ rivermile` %in%  &#39;2-JKS023.61&#39;), &#39;FISH_TOX&#39;)</span></span></code></pre></div>
</div>
<div id="water-column-metals-1" class="section level3" number="3.5.12">
<h3><span class="header-section-number">3.5.12</span> Water Column Metals</h3>
<p>There are three functions that support the surface water metals assessment. These functions are used to determine criteria, identify exceedances of those criteria, and report these results in the stations table format. Surface water metals criteria are dependent on the designated use (aquatic life or human health). The aquatic life use is subdivided into freshwater and saltwater, which are further subdivided into acute and chronic criteria. The human health designated use is subdivided into public water supply and all other surface waters. Some criteria are specified outright, but a subset of criteria require calculation, which can involve a combination of variables (i.e., hardness, water effect ratio, and correction factor). For more information on surface water metals criteria see <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/" target="_blank">9VAC25-260-140</a>. The functions that are used to assess surface water metals are further described below.</p>
<p><img src="images/MetalsFig.png" /></p>
<div id="metalscriteriafunction" class="section level4" number="3.5.12.1">
<h4><span class="header-section-number">3.5.12.1</span> metalsCriteriaFunction</h4>
<p>This function is used to determine the criteria for a given sample, which are then applied against the metal concentrations of that sample. The function takes inputs of ID, Hardness, and WER. The ID field is a unique identifier for a sampling event. Hardness represents the hardness of the water associated with the sampling event in question. WER is the water effects ratio, which is â€œdetermined by measuring the effect of receiving water (as it is or will be affected by any discharges) on the bioavailability or toxicity of a metal by using standard test organisms and a metal to conduct toxicity tests simultaneously in receiving water and laboratory water.â€ The WER is set to 1 unless an â€œapplicant or permittee demonstrates to the departmentâ€™s satisfaction in a permit proceeding that another value is appropriate, or unless available data allow the department to compute a WER for the receiving waters.â€ The formulae used in this function to produce the criteria were extracted from <a href="https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/">9VAC25-260-140</a>. Output criteria are set to 2 significant figures. This function is used as part of <code>metalsAnalysis()</code> , a separate function that is described below.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="individual-parameter-analyses.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Metals criteria analysis</span></span>
<span id="cb103-2"><a href="individual-parameter-analyses.html#cb103-2" aria-hidden="true" tabindex="-1"></a>metalsCriteriaFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(ID, Hardness, WER){</span>
<span id="cb103-3"><a href="individual-parameter-analyses.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remember: ln is really log() in R; exp() is natural antilog in R</span></span>
<span id="cb103-4"><a href="individual-parameter-analyses.html#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Per 9VAC25-260-140, criteria to 2 sig figs #https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb103-5"><a href="individual-parameter-analyses.html#cb103-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-6"><a href="individual-parameter-analyses.html#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no WER supplied, use 1</span></span>
<span id="cb103-7"><a href="individual-parameter-analyses.html#cb103-7" aria-hidden="true" tabindex="-1"></a>  WER <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(WER), <span class="dv">1</span>, WER)</span>
<span id="cb103-8"><a href="individual-parameter-analyses.html#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Establish Hardness Criteria</span></span>
<span id="cb103-9"><a href="individual-parameter-analyses.html#cb103-9" aria-hidden="true" tabindex="-1"></a>  criteriaHardness <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Hardness <span class="sc">&lt;</span> <span class="dv">25</span>, <span class="dv">25</span>, <span class="fu">ifelse</span>(Hardness <span class="sc">&gt;</span> <span class="dv">400</span>, <span class="dv">400</span>, Hardness))</span>
<span id="cb103-10"><a href="individual-parameter-analyses.html#cb103-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb103-11"><a href="individual-parameter-analyses.html#cb103-11" aria-hidden="true" tabindex="-1"></a>  metalsCriteria <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb103-12"><a href="individual-parameter-analyses.html#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">ID=</span> ID, <span class="st">`</span><span class="at">Antimony PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">5.6</span>, <span class="st">`</span><span class="at">Antimony All Other Surface Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">640</span>,</span>
<span id="cb103-13"><a href="individual-parameter-analyses.html#cb103-13" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Arsenic Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">340</span>, <span class="st">`</span><span class="at">Arsenic Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">150</span>, <span class="st">`</span><span class="at">Arsenic PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">10</span>,</span>
<span id="cb103-14"><a href="individual-parameter-analyses.html#cb103-14" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Arsenic Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">69</span>, <span class="st">`</span><span class="at">Arsenic Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">36</span>,</span>
<span id="cb103-15"><a href="individual-parameter-analyses.html#cb103-15" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Barium PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">2000</span>,</span>
<span id="cb103-16"><a href="individual-parameter-analyses.html#cb103-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Cadmium Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">signif</span>(WER <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.9789</span> <span class="sc">*</span> (<span class="fu">log</span>(criteriaHardness))<span class="sc">-</span><span class="fl">3.866</span>) <span class="sc">*</span> (<span class="fl">1.136672</span> <span class="sc">-</span> (<span class="fu">log</span>(criteriaHardness) <span class="sc">*</span> <span class="fl">0.041838</span>)), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-17"><a href="individual-parameter-analyses.html#cb103-17" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Cadmium Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> <span class="fu">exp</span>(<span class="fl">0.7977</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">3.909</span>) <span class="sc">*</span> (<span class="fl">1.101672</span> <span class="sc">-</span> (<span class="fu">log</span>(criteriaHardness) <span class="sc">*</span> (<span class="fl">0.041838</span>))), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-18"><a href="individual-parameter-analyses.html#cb103-18" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Cadmium Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">33</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Cadmium Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="fl">7.9</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Cadmium PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>,</span>
<span id="cb103-19"><a href="individual-parameter-analyses.html#cb103-19" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">ChromiumIII Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span>  (<span class="fu">exp</span>(<span class="fl">0.8190</span> <span class="sc">*</span> (<span class="fu">log</span>(criteriaHardness)) <span class="sc">+</span> <span class="fl">3.7256</span>)) <span class="sc">*</span> <span class="fl">0.316</span>, <span class="at">digits =</span> <span class="dv">2</span>), </span>
<span id="cb103-20"><a href="individual-parameter-analyses.html#cb103-20" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">ChromiumIII Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span>  (<span class="fu">exp</span>(<span class="fl">0.8190</span> <span class="sc">*</span> (<span class="fu">log</span>(criteriaHardness))  <span class="sc">+</span><span class="fl">0.6848</span>)) <span class="sc">*</span> <span class="fl">0.860</span>, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">ChromiumIII PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">100</span>,</span>
<span id="cb103-21"><a href="individual-parameter-analyses.html#cb103-21" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">ChromiumVI Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">16</span>, <span class="st">`</span><span class="at">ChromiumVI Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">11</span>, <span class="st">`</span><span class="at">ChromiumVI Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1100</span>, <span class="st">`</span><span class="at">ChromiumVI Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">50</span>, </span>
<span id="cb103-22"><a href="individual-parameter-analyses.html#cb103-22" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Copper Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">0.9422</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">1.700</span>)) <span class="sc">*</span> <span class="fl">0.960</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-23"><a href="individual-parameter-analyses.html#cb103-23" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Copper Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">0.8545</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">1.702</span>)) <span class="sc">*</span> <span class="fl">0.960</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-24"><a href="individual-parameter-analyses.html#cb103-24" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Copper Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">signif</span>(<span class="fl">9.3</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Copper Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span>  <span class="fu">signif</span>(<span class="fl">6.0</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Copper PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1300</span>,</span>
<span id="cb103-25"><a href="individual-parameter-analyses.html#cb103-25" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Lead Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">1.273</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">1.084</span>)) <span class="sc">*</span> (<span class="fl">1.46203</span> <span class="sc">-</span> (<span class="fu">log</span>(criteriaHardness) <span class="sc">*</span> <span class="fl">0.145712</span>)), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-26"><a href="individual-parameter-analyses.html#cb103-26" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Lead Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">1.273</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">3.259</span>)) <span class="sc">*</span> (<span class="fl">1.46203</span> <span class="sc">-</span> (<span class="fu">log</span>(criteriaHardness) <span class="sc">*</span> <span class="fl">0.145712</span>)), <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-27"><a href="individual-parameter-analyses.html#cb103-27" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Lead Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">230</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Lead Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="fl">8.8</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Lead PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">15</span>,</span>
<span id="cb103-28"><a href="individual-parameter-analyses.html#cb103-28" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Mercury Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">1.4</span>, <span class="st">`</span><span class="at">Mercury Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.77</span>, <span class="st">`</span><span class="at">Mercury Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">1.8</span>, <span class="st">`</span><span class="at">Mercury Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.94</span>,</span>
<span id="cb103-29"><a href="individual-parameter-analyses.html#cb103-29" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Nickel Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span> (<span class="fl">0.8460</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">+</span> <span class="fl">1.312</span>)) <span class="sc">*</span> <span class="fl">0.998</span>, <span class="at">digits =</span> <span class="dv">2</span>), </span>
<span id="cb103-30"><a href="individual-parameter-analyses.html#cb103-30" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Nickel Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">0.8460</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">0.8840</span>)) <span class="sc">*</span> <span class="fl">0.997</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-31"><a href="individual-parameter-analyses.html#cb103-31" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Nickel Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">74</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Nickel Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="fl">8.2</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Nickel PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">610</span>,  <span class="st">`</span><span class="at">Nickel All Other Surface Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">4600</span>,</span>
<span id="cb103-32"><a href="individual-parameter-analyses.html#cb103-32" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Uranium PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">30</span>,</span>
<span id="cb103-33"><a href="individual-parameter-analyses.html#cb103-33" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Selenium Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">20</span>, <span class="st">`</span><span class="at">Selenium Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">5.0</span>, </span>
<span id="cb103-34"><a href="individual-parameter-analyses.html#cb103-34" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Selenium Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">290</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Selenium Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">71</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-35"><a href="individual-parameter-analyses.html#cb103-35" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Selenium PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">170</span>, <span class="st">`</span><span class="at">Selenium All Other Surface Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">4200</span>,</span>
<span id="cb103-36"><a href="individual-parameter-analyses.html#cb103-36" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Silver Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">1.72</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">-</span> <span class="fl">6.52</span>)) <span class="sc">*</span> <span class="fl">0.85</span>, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Silver Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="fl">1.9</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-37"><a href="individual-parameter-analyses.html#cb103-37" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Thallium PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.24</span>, <span class="st">`</span><span class="at">Thallium All Other Surface Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.47</span>,</span>
<span id="cb103-38"><a href="individual-parameter-analyses.html#cb103-38" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Zinc Acute Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">0.8473</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">+</span> <span class="fl">0.884</span>)) <span class="sc">*</span> <span class="fl">0.978</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-39"><a href="individual-parameter-analyses.html#cb103-39" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Zinc Chronic Freshwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(WER <span class="sc">*</span> (<span class="fu">exp</span>(<span class="fl">0.8473</span> <span class="sc">*</span> <span class="fu">log</span>(criteriaHardness) <span class="sc">+</span> <span class="fl">0.884</span>)) <span class="sc">*</span> <span class="fl">0.986</span>, <span class="at">digits =</span> <span class="dv">2</span>),</span>
<span id="cb103-40"><a href="individual-parameter-analyses.html#cb103-40" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Zinc Acute Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">90</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), <span class="st">`</span><span class="at">Zinc Chronic Saltwater</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">signif</span>(<span class="dv">81</span> <span class="sc">*</span> WER, <span class="at">digits =</span> <span class="dv">2</span>), </span>
<span id="cb103-41"><a href="individual-parameter-analyses.html#cb103-41" aria-hidden="true" tabindex="-1"></a>           <span class="st">`</span><span class="at">Zinc PWS</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">7400</span>, <span class="st">`</span><span class="at">Zinc All Other Surface Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">26000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-42"><a href="individual-parameter-analyses.html#cb103-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">!</span>ID, <span class="at">names_to =</span> <span class="st">&#39;Criteria&#39;</span>, <span class="at">values_to =</span> <span class="st">&#39;CriteriaValue&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-43"><a href="individual-parameter-analyses.html#cb103-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Criteria2 =</span> Criteria) <span class="sc">%&gt;%</span>  <span class="co">#duplicate column to split</span></span>
<span id="cb103-44"><a href="individual-parameter-analyses.html#cb103-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">separate</span>(Criteria2, <span class="fu">c</span>(<span class="st">&quot;Metal&quot;</span>, <span class="st">&quot;Criteria Type&quot;</span>, <span class="st">&quot;Waterbody&quot;</span>), <span class="at">sep =</span> <span class="st">&quot; &quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb103-45"><a href="individual-parameter-analyses.html#cb103-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">ifelse</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&#39;All&#39;</span>, <span class="st">&#39;All Other Waters&#39;</span>, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>),</span>
<span id="cb103-46"><a href="individual-parameter-analyses.html#cb103-46" aria-hidden="true" tabindex="-1"></a>             <span class="at">Waterbody =</span> <span class="fu">ifelse</span>(Waterbody <span class="sc">==</span> <span class="st">&#39;Other&#39;</span>, <span class="cn">NA</span>, Waterbody)) <span class="sc">%&gt;%</span> </span>
<span id="cb103-47"><a href="individual-parameter-analyses.html#cb103-47" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(ID, Metal, Criteria, <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span>, Waterbody, CriteriaValue))</span>
<span id="cb103-48"><a href="individual-parameter-analyses.html#cb103-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(metalsCriteria)</span>
<span id="cb103-49"><a href="individual-parameter-analyses.html#cb103-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="metalsanalysis" class="section level4" number="3.5.12.2">
<h4><span class="header-section-number">3.5.12.2</span> metalsAnalysis</h4>
<p>This function identifies samples within relevant data windows, calculates averages of the data within those windows where necessary (acute and chronic criteria), determines the appropriate criteria to apply using <code>metalsCriteriaFunction()</code>, and tallies exceedances based on those criteria.</p>
<p><code>metalsAnalysis()</code> approaches metals assessment by separating the analysis into 3 bins: raw, acute, and chronic. The function loops across individual samples for the station under consideration and creates a dataframe based on the data windows for raw, acute, and chronic criteria. The raw data window simply uses the time that the current sample in the loop was collected. The acute data window will include all site-specific samples taken within an hour of the sample under consideration, whereas the chronic data window will include all samples taken within four days of the sample under consideration.</p>
<p>After these data windows are created for an individual sample, the process described below occurs in succession: first for the raw data, then for acute data, and ending with chronic data. The loop then repeats this process for the next sample at the station under consideration, starting with the creation of a new set of data windows specific to that sample. The process is as follows:</p>
<ol style="list-style-type: decimal">
<li><p>The data are reshaped to facilitate evaluation against criteria. This involves pivoting the data into long format, dropping unnecessary fields, and adding fields used for identification.</p></li>
<li><p>A mean value is calculated (only true for acute and chronic assessment).</p></li>
<li><p>The criteria are determined using <code>metalsCriteriaFunction()</code>. The ID, hardness, and WER for the sample under consideration are used as inputs to this function.</p></li>
<li><p>The sample values are rounded to 2 significant figures and compared to the criteria (also set to 2 significant figures).</p></li>
<li><p>Exceedances for specific metals are flagged with a value of 1 in the â€œExceedanceâ€ column and a 0 is returned to this column if there is no exceedance for a given metal.</p></li>
</ol>
<p>After this process is completed for all samples at a station, the results from raw, acute, and chronic metals assessment are combined into a single dataframe (<code>stationCriteriaResults</code>), which is the output of the function.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="individual-parameter-analyses.html#cb104-1" aria-hidden="true" tabindex="-1"></a>metalsAnalysis <span class="ot">&lt;-</span> <span class="cf">function</span>(stationMetalsData, stationData, WER){</span>
<span id="cb104-2"><a href="individual-parameter-analyses.html#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no WER supplied, use 1</span></span>
<span id="cb104-3"><a href="individual-parameter-analyses.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  WER <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(WER), <span class="dv">1</span>, WER)</span>
<span id="cb104-4"><a href="individual-parameter-analyses.html#cb104-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-5"><a href="individual-parameter-analyses.html#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get WQS from stationData so correct criteria can be applied</span></span>
<span id="cb104-6"><a href="individual-parameter-analyses.html#cb104-6" aria-hidden="true" tabindex="-1"></a>  stationMetalsData <span class="ot">&lt;-</span> <span class="fu">left_join</span>(stationMetalsData, </span>
<span id="cb104-7"><a href="individual-parameter-analyses.html#cb104-7" aria-hidden="true" tabindex="-1"></a>                                 dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, CLASS, PWS, ZONE) <span class="sc">%&gt;%</span> </span>
<span id="cb104-8"><a href="individual-parameter-analyses.html#cb104-8" aria-hidden="true" tabindex="-1"></a>                                   <span class="fu">distinct</span>(FDT_STA_ID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;Station_Id&#39;</span> <span class="ot">=</span> <span class="st">&#39;FDT_STA_ID&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-9"><a href="individual-parameter-analyses.html#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Assess As</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(CLASS <span class="sc">==</span> <span class="st">&quot;I&quot;</span> <span class="sc">~</span> <span class="st">&#39;Saltwater&#39;</span>,</span>
<span id="cb104-10"><a href="individual-parameter-analyses.html#cb104-10" aria-hidden="true" tabindex="-1"></a>                                   CLASS <span class="sc">==</span> <span class="st">&quot;II&quot;</span> <span class="sc">&amp;</span> ZONE <span class="sc">==</span> <span class="st">&#39;Estuarine&#39;</span> <span class="sc">~</span> <span class="st">&#39;Saltwater&#39;</span>,</span>
<span id="cb104-11"><a href="individual-parameter-analyses.html#cb104-11" aria-hidden="true" tabindex="-1"></a>                                   CLASS <span class="sc">==</span> <span class="st">&quot;II&quot;</span> <span class="sc">&amp;</span> ZONE <span class="sc">==</span> <span class="st">&#39;Transition&#39;</span> <span class="sc">~</span> <span class="st">&#39;More Stringent&#39;</span>,</span>
<span id="cb104-12"><a href="individual-parameter-analyses.html#cb104-12" aria-hidden="true" tabindex="-1"></a>                                   CLASS <span class="sc">==</span> <span class="st">&quot;II&quot;</span> <span class="sc">&amp;</span> ZONE <span class="sc">==</span> <span class="st">&#39;Tidal Fresh&#39;</span> <span class="sc">~</span> <span class="st">&#39;Freshwater&#39;</span>,</span>
<span id="cb104-13"><a href="individual-parameter-analyses.html#cb104-13" aria-hidden="true" tabindex="-1"></a>                                   CLASS <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;III&#39;</span>, <span class="st">&quot;IV&quot;</span>,<span class="st">&quot;V&quot;</span>,<span class="st">&quot;VI&quot;</span>,<span class="st">&quot;VII&quot;</span>) <span class="sc">~</span> <span class="st">&#39;Freshwater&#39;</span>,</span>
<span id="cb104-14"><a href="individual-parameter-analyses.html#cb104-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.character</span>(<span class="cn">NA</span>)),</span>
<span id="cb104-15"><a href="individual-parameter-analyses.html#cb104-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">ChromiumIII=</span> Chromium, <span class="at">RMK_ChromiumIII =</span> RMK_Chromium, </span>
<span id="cb104-16"><a href="individual-parameter-analyses.html#cb104-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">ChromiumVI=</span> Chromium, <span class="at">RMK_ChromiumVI =</span> RMK_Chromium ) <span class="sc">%&gt;%</span> <span class="co"># add individual Chromium variables to make joining to assessment criteria easier</span></span>
<span id="cb104-17"><a href="individual-parameter-analyses.html#cb104-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Roger uses ChromiumIII and VI to flag any potential chromium issues, likely further lab analyses needed if either chromium criteria blown</span></span>
<span id="cb104-18"><a href="individual-parameter-analyses.html#cb104-18" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Station_Id<span class="sc">:</span>RMK_Cadmium, ChromiumIII<span class="sc">:</span>RMK_ChromiumVI, Cadmium<span class="sc">:</span><span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>)</span>
<span id="cb104-19"><a href="individual-parameter-analyses.html#cb104-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-20"><a href="individual-parameter-analyses.html#cb104-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make a place to store raw analysis results</span></span>
<span id="cb104-21"><a href="individual-parameter-analyses.html#cb104-21" aria-hidden="true" tabindex="-1"></a>  rawCriteriaResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Station_Id =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">WindowDateTimeStart =</span> <span class="fu">as.POSIXct</span>(<span class="cn">NA</span>), <span class="at">FDT_DEPTH =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb104-22"><a href="individual-parameter-analyses.html#cb104-22" aria-hidden="true" tabindex="-1"></a>                               <span class="at">CLASS =</span> <span class="fu">as.factor</span>(<span class="cn">NA</span>), <span class="at">PWS =</span> <span class="fu">as.factor</span>(<span class="cn">NA</span>), <span class="at">ZONE =</span> <span class="fu">as.factor</span>(<span class="cn">NA</span>), <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>),</span>
<span id="cb104-23"><a href="individual-parameter-analyses.html#cb104-23" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Metal =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">ValueType =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">Value =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">Criteria =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), </span>
<span id="cb104-24"><a href="individual-parameter-analyses.html#cb104-24" aria-hidden="true" tabindex="-1"></a>                               <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">Waterbody =</span> <span class="fu">as.character</span>(<span class="cn">NA</span>), <span class="at">CriteriaValue =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>),</span>
<span id="cb104-25"><a href="individual-parameter-analyses.html#cb104-25" aria-hidden="true" tabindex="-1"></a>                               <span class="at">parameterRound =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>), <span class="at">Exceedance =</span> <span class="fu">as.numeric</span>(<span class="cn">NA</span>))</span>
<span id="cb104-26"><a href="individual-parameter-analyses.html#cb104-26" aria-hidden="true" tabindex="-1"></a>  acuteCriteriaResults <span class="ot">&lt;-</span> rawCriteriaResults </span>
<span id="cb104-27"><a href="individual-parameter-analyses.html#cb104-27" aria-hidden="true" tabindex="-1"></a>  chronicCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults </span>
<span id="cb104-28"><a href="individual-parameter-analyses.html#cb104-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb104-29"><a href="individual-parameter-analyses.html#cb104-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># loop through each row of data to correctly calculate criteria and find any chronic scenarios</span></span>
<span id="cb104-30"><a href="individual-parameter-analyses.html#cb104-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> stationMetalsData<span class="sc">$</span>FDT_DATE_TIME){</span>
<span id="cb104-31"><a href="individual-parameter-analyses.html#cb104-31" aria-hidden="true" tabindex="-1"></a>    rawDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationMetalsData, FDT_DATE_TIME <span class="sc">==</span> k)</span>
<span id="cb104-32"><a href="individual-parameter-analyses.html#cb104-32" aria-hidden="true" tabindex="-1"></a>    acuteDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationMetalsData,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">hours</span>(<span class="dv">1</span>)))</span>
<span id="cb104-33"><a href="individual-parameter-analyses.html#cb104-33" aria-hidden="true" tabindex="-1"></a>    chronicDataWindow <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationMetalsData,  <span class="fu">between</span>(FDT_DATE_TIME, k, k <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">4</span>)))</span>
<span id="cb104-34"><a href="individual-parameter-analyses.html#cb104-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run any analyses requiring raw data if data exists</span></span>
<span id="cb104-35"><a href="individual-parameter-analyses.html#cb104-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(rawDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb104-36"><a href="individual-parameter-analyses.html#cb104-36" aria-hidden="true" tabindex="-1"></a>      rawData <span class="ot">&lt;-</span> rawDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb104-37"><a href="individual-parameter-analyses.html#cb104-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(Station_Id, FDT_DATE_TIME, FDT_DEPTH, CLASS, PWS, ZONE, <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-38"><a href="individual-parameter-analyses.html#cb104-38" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">contains</span>(<span class="st">&#39;RMK_&#39;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb104-39"><a href="individual-parameter-analyses.html#cb104-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="at">cols =</span> Antimony<span class="sc">:</span>Hardness, <span class="at">names_to =</span> <span class="st">&quot;Metal&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Value&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-40"><a href="individual-parameter-analyses.html#cb104-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Raw Result&#39;</span>,</span>
<span id="cb104-41"><a href="individual-parameter-analyses.html#cb104-41" aria-hidden="true" tabindex="-1"></a>               <span class="at">ID =</span> <span class="fu">paste</span>(Station_Id, FDT_DATE_TIME, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>)) <span class="sc">%&gt;%</span> <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb104-42"><a href="individual-parameter-analyses.html#cb104-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>()</span>
<span id="cb104-43"><a href="individual-parameter-analyses.html#cb104-43" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate criteria based on raw data</span></span>
<span id="cb104-44"><a href="individual-parameter-analyses.html#cb104-44" aria-hidden="true" tabindex="-1"></a>      rawDataCriteria <span class="ot">&lt;-</span> <span class="fu">metalsCriteriaFunction</span>(<span class="fu">filter</span>(rawData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>ID, <span class="fu">filter</span>(rawData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>Value, <span class="at">WER =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-45"><a href="individual-parameter-analyses.html#cb104-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;All Other Waters&#39;</span>, <span class="st">&#39;PWS&#39;</span>)) <span class="sc">%&gt;%</span> <span class="co"># don&#39;t need other criteria for acute window</span></span>
<span id="cb104-46"><a href="individual-parameter-analyses.html#cb104-46" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(<span class="fu">is.na</span>(<span class="fu">unique</span>(rawData<span class="sc">$</span>PWS)))</span>
<span id="cb104-47"><a href="individual-parameter-analyses.html#cb104-47" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(., <span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">!=</span> <span class="st">&#39;PWS&#39;</span>)</span>
<span id="cb104-48"><a href="individual-parameter-analyses.html#cb104-48" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> .}</span>
<span id="cb104-49"><a href="individual-parameter-analyses.html#cb104-49" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Join appropriate criteria to rawData for comparison to averaged data</span></span>
<span id="cb104-50"><a href="individual-parameter-analyses.html#cb104-50" aria-hidden="true" tabindex="-1"></a>      rawDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">left_join</span>(rawData, rawDataCriteria, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;ID&#39;</span>, <span class="st">&#39;Metal&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-51"><a href="individual-parameter-analyses.html#cb104-51" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb104-52"><a href="individual-parameter-analyses.html#cb104-52" aria-hidden="true" tabindex="-1"></a>               <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ),</span>
<span id="cb104-53"><a href="individual-parameter-analyses.html#cb104-53" aria-hidden="true" tabindex="-1"></a>               <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(rawDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span>  <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb104-54"><a href="individual-parameter-analyses.html#cb104-54" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Criteria)) <span class="sc">%&gt;%</span>  <span class="co"># filter out metals that don&#39;t have chronic criteria</span></span>
<span id="cb104-55"><a href="individual-parameter-analyses.html#cb104-55" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(Station_Id, WindowDateTimeStart, <span class="fu">everything</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb104-56"><a href="individual-parameter-analyses.html#cb104-56" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(FDT_DATE_TIME, ID))</span>
<span id="cb104-57"><a href="individual-parameter-analyses.html#cb104-57" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb104-58"><a href="individual-parameter-analyses.html#cb104-58" aria-hidden="true" tabindex="-1"></a>      rawCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rawCriteriaResults, rawDataCriteriaAnalysis) </span>
<span id="cb104-59"><a href="individual-parameter-analyses.html#cb104-59" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {rawCriteriaResults <span class="ot">&lt;-</span> rawCriteriaResults }</span>
<span id="cb104-60"><a href="individual-parameter-analyses.html#cb104-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run acute analysis if data exists</span></span>
<span id="cb104-61"><a href="individual-parameter-analyses.html#cb104-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(acuteDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb104-62"><a href="individual-parameter-analyses.html#cb104-62" aria-hidden="true" tabindex="-1"></a>      acuteData <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(acuteDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb104-63"><a href="individual-parameter-analyses.html#cb104-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(Station_Id, FDT_DEPTH, CLASS, PWS, ZONE, <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>) <span class="sc">%&gt;%</span> <span class="co"># can&#39;t group by datetime or summary can&#39;t happen</span></span>
<span id="cb104-64"><a href="individual-parameter-analyses.html#cb104-64" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">contains</span>(<span class="st">&#39;RMK_&#39;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb104-65"><a href="individual-parameter-analyses.html#cb104-65" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="at">cols =</span> Antimony<span class="sc">:</span>Hardness, <span class="at">names_to =</span> <span class="st">&quot;Metal&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;CriteriaValue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-66"><a href="individual-parameter-analyses.html#cb104-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Station_Id, FDT_DEPTH, CLASS, PWS, ZONE, <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>, Metal) <span class="sc">%&gt;%</span> </span>
<span id="cb104-67"><a href="individual-parameter-analyses.html#cb104-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">Value =</span> <span class="fu">mean</span>(CriteriaValue, <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span>  <span class="co"># get hourly average</span></span>
<span id="cb104-68"><a href="individual-parameter-analyses.html#cb104-68" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Hourly Average&#39;</span>,</span>
<span id="cb104-69"><a href="individual-parameter-analyses.html#cb104-69" aria-hidden="true" tabindex="-1"></a>               <span class="at">ID =</span> <span class="fu">paste</span>(Station_Id, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>)) ) <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb104-70"><a href="individual-parameter-analyses.html#cb104-70" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate criteria based on hourly averaged data</span></span>
<span id="cb104-71"><a href="individual-parameter-analyses.html#cb104-71" aria-hidden="true" tabindex="-1"></a>      acuteDataCriteria <span class="ot">&lt;-</span> <span class="fu">metalsCriteriaFunction</span>(<span class="fu">filter</span>(acuteData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>ID, <span class="fu">filter</span>(acuteData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>Value, <span class="at">WER =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-72"><a href="individual-parameter-analyses.html#cb104-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&#39;Acute&#39;</span>) <span class="sc">%&gt;%</span> <span class="co"># don&#39;t need other criteria for acute window</span></span>
<span id="cb104-73"><a href="individual-parameter-analyses.html#cb104-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep only the criteria needed </span></span>
<span id="cb104-74"><a href="individual-parameter-analyses.html#cb104-74" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(<span class="fu">unique</span>(acuteData<span class="sc">$</span><span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Freshwater&#39;</span>, <span class="st">&#39;Saltwater&#39;</span>))</span>
<span id="cb104-75"><a href="individual-parameter-analyses.html#cb104-75" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(., Waterbody <span class="sc">%in%</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="sc">!!</span><span class="fu">unique</span>(acuteData<span class="sc">$</span><span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>)))</span>
<span id="cb104-76"><a href="individual-parameter-analyses.html#cb104-76" aria-hidden="true" tabindex="-1"></a>          <span class="co"># if in Transition Zone then use the more stringent standard</span></span>
<span id="cb104-77"><a href="individual-parameter-analyses.html#cb104-77" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="fu">group_by</span>(., Metal) <span class="sc">%&gt;%</span> </span>
<span id="cb104-78"><a href="individual-parameter-analyses.html#cb104-78" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">MoreStringent =</span> <span class="fu">min</span>(CriteriaValue)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-79"><a href="individual-parameter-analyses.html#cb104-79" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(CriteriaValue <span class="sc">==</span> MoreStringent) <span class="sc">%&gt;%</span> </span>
<span id="cb104-80"><a href="individual-parameter-analyses.html#cb104-80" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>MoreStringent)} </span>
<span id="cb104-81"><a href="individual-parameter-analyses.html#cb104-81" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Join appropriate criteria to acuteData for comparison to averaged data</span></span>
<span id="cb104-82"><a href="individual-parameter-analyses.html#cb104-82" aria-hidden="true" tabindex="-1"></a>      acuteDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">left_join</span>(acuteData, acuteDataCriteria, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;ID&#39;</span>, <span class="st">&#39;Metal&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-83"><a href="individual-parameter-analyses.html#cb104-83" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb104-84"><a href="individual-parameter-analyses.html#cb104-84" aria-hidden="true" tabindex="-1"></a>               <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb104-85"><a href="individual-parameter-analyses.html#cb104-85" aria-hidden="true" tabindex="-1"></a>               <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(acuteDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-86"><a href="individual-parameter-analyses.html#cb104-86" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Criteria)) <span class="sc">%&gt;%</span> <span class="co"># filter out metals that don&#39;t have chronic criteria</span></span>
<span id="cb104-87"><a href="individual-parameter-analyses.html#cb104-87" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(Station_Id, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID)</span>
<span id="cb104-88"><a href="individual-parameter-analyses.html#cb104-88" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb104-89"><a href="individual-parameter-analyses.html#cb104-89" aria-hidden="true" tabindex="-1"></a>      acuteCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(acuteCriteriaResults, acuteDataCriteriaAnalysis) </span>
<span id="cb104-90"><a href="individual-parameter-analyses.html#cb104-90" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {acuteCriteriaResults <span class="ot">&lt;-</span> acuteCriteriaResults }</span>
<span id="cb104-91"><a href="individual-parameter-analyses.html#cb104-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Run chronic analysis if data exists</span></span>
<span id="cb104-92"><a href="individual-parameter-analyses.html#cb104-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(chronicDataWindow) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb104-93"><a href="individual-parameter-analyses.html#cb104-93" aria-hidden="true" tabindex="-1"></a>      chronicData <span class="ot">&lt;-</span> <span class="fu">suppressMessages</span>(chronicDataWindow <span class="sc">%&gt;%</span> </span>
<span id="cb104-94"><a href="individual-parameter-analyses.html#cb104-94" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(Station_Id, FDT_DEPTH, CLASS, PWS, ZONE, <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>) <span class="sc">%&gt;%</span> <span class="co"># can&#39;t group by datetime or summary can&#39;t happen</span></span>
<span id="cb104-95"><a href="individual-parameter-analyses.html#cb104-95" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="fu">contains</span>(<span class="st">&#39;RMK_&#39;</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb104-96"><a href="individual-parameter-analyses.html#cb104-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(<span class="at">cols =</span> Antimony<span class="sc">:</span>Hardness, <span class="at">names_to =</span> <span class="st">&quot;Metal&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;CriteriaValue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-97"><a href="individual-parameter-analyses.html#cb104-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(Station_Id, FDT_DEPTH, CLASS, PWS, ZONE, <span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>, Metal) <span class="sc">%&gt;%</span> </span>
<span id="cb104-98"><a href="individual-parameter-analyses.html#cb104-98" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">Value =</span> <span class="fu">mean</span>(CriteriaValue, <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span> <span class="co"># get four day average</span></span>
<span id="cb104-99"><a href="individual-parameter-analyses.html#cb104-99" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">ValueType =</span> <span class="st">&#39;Four Day Average&#39;</span>,</span>
<span id="cb104-100"><a href="individual-parameter-analyses.html#cb104-100" aria-hidden="true" tabindex="-1"></a>               <span class="at">ID =</span> <span class="fu">paste</span>(Station_Id, FDT_DEPTH, <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>)) ) <span class="co"># make a uniqueID in case &gt;1 sample for given datetime</span></span>
<span id="cb104-101"><a href="individual-parameter-analyses.html#cb104-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Calculate criteria based on hourly averaged data</span></span>
<span id="cb104-102"><a href="individual-parameter-analyses.html#cb104-102" aria-hidden="true" tabindex="-1"></a>      chronicDataCriteria <span class="ot">&lt;-</span> <span class="fu">metalsCriteriaFunction</span>(<span class="fu">filter</span>(chronicData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>ID, <span class="fu">filter</span>(chronicData, Metal <span class="sc">==</span> <span class="st">&quot;Hardness&quot;</span>)<span class="sc">$</span>Value, <span class="at">WER =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb104-103"><a href="individual-parameter-analyses.html#cb104-103" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="st">`</span><span class="at">Criteria Type</span><span class="st">`</span> <span class="sc">==</span> <span class="st">&#39;Chronic&#39;</span>) <span class="sc">%&gt;%</span> <span class="co"># don&#39;t need other criteria for chronic window analysis</span></span>
<span id="cb104-104"><a href="individual-parameter-analyses.html#cb104-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep only the criteria needed </span></span>
<span id="cb104-105"><a href="individual-parameter-analyses.html#cb104-105" aria-hidden="true" tabindex="-1"></a>        {<span class="cf">if</span>(<span class="fu">unique</span>(chronicData<span class="sc">$</span><span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Freshwater&#39;</span>, <span class="st">&#39;Saltwater&#39;</span>))</span>
<span id="cb104-106"><a href="individual-parameter-analyses.html#cb104-106" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(., Waterbody <span class="sc">%in%</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="sc">!!</span><span class="fu">unique</span>(chronicData<span class="sc">$</span><span class="st">`</span><span class="at">Assess As</span><span class="st">`</span>)))</span>
<span id="cb104-107"><a href="individual-parameter-analyses.html#cb104-107" aria-hidden="true" tabindex="-1"></a>          <span class="co"># if in Transition Zone then use the more stringent standard</span></span>
<span id="cb104-108"><a href="individual-parameter-analyses.html#cb104-108" aria-hidden="true" tabindex="-1"></a>          <span class="cf">else</span> <span class="fu">group_by</span>(., Metal) <span class="sc">%&gt;%</span> </span>
<span id="cb104-109"><a href="individual-parameter-analyses.html#cb104-109" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">MoreStringent =</span> <span class="fu">min</span>(CriteriaValue)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-110"><a href="individual-parameter-analyses.html#cb104-110" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(CriteriaValue <span class="sc">==</span> MoreStringent) <span class="sc">%&gt;%</span> </span>
<span id="cb104-111"><a href="individual-parameter-analyses.html#cb104-111" aria-hidden="true" tabindex="-1"></a>            dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>MoreStringent)} </span>
<span id="cb104-112"><a href="individual-parameter-analyses.html#cb104-112" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Join appropriate criteria to chronicData for comparison to averaged data</span></span>
<span id="cb104-113"><a href="individual-parameter-analyses.html#cb104-113" aria-hidden="true" tabindex="-1"></a>      chronicDataCriteriaAnalysis <span class="ot">&lt;-</span> <span class="fu">left_join</span>(chronicData, chronicDataCriteria, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;ID&#39;</span>, <span class="st">&#39;Metal&#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-114"><a href="individual-parameter-analyses.html#cb104-114" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">parameterRound =</span> <span class="fu">signif</span>(Value, <span class="at">digits =</span> <span class="dv">2</span>), <span class="co"># two significant figures based on WQS https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section140/</span></span>
<span id="cb104-115"><a href="individual-parameter-analyses.html#cb104-115" aria-hidden="true" tabindex="-1"></a>               <span class="at">Exceedance =</span> <span class="fu">ifelse</span>(parameterRound <span class="sc">&gt;</span> CriteriaValue, <span class="dv">1</span>, <span class="dv">0</span> ), <span class="co"># use 1/0 to easily summarize multiple results later</span></span>
<span id="cb104-116"><a href="individual-parameter-analyses.html#cb104-116" aria-hidden="true" tabindex="-1"></a>               <span class="at">WindowDateTimeStart =</span> <span class="fu">min</span>(chronicDataWindow<span class="sc">$</span>FDT_DATE_TIME)) <span class="sc">%&gt;%</span> </span>
<span id="cb104-117"><a href="individual-parameter-analyses.html#cb104-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Criteria)) <span class="sc">%&gt;%</span> <span class="co"># filter out metals that don&#39;t have chronic criteria</span></span>
<span id="cb104-118"><a href="individual-parameter-analyses.html#cb104-118" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(Station_Id, WindowDateTimeStart, <span class="fu">everything</span>(), <span class="sc">-</span>ID)</span>
<span id="cb104-119"><a href="individual-parameter-analyses.html#cb104-119" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Save the results for viewing later</span></span>
<span id="cb104-120"><a href="individual-parameter-analyses.html#cb104-120" aria-hidden="true" tabindex="-1"></a>      chronicCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(chronicCriteriaResults, chronicDataCriteriaAnalysis) </span>
<span id="cb104-121"><a href="individual-parameter-analyses.html#cb104-121" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {chronicCriteriaResults <span class="ot">&lt;-</span> chronicCriteriaResults }</span>
<span id="cb104-122"><a href="individual-parameter-analyses.html#cb104-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-123"><a href="individual-parameter-analyses.html#cb104-123" aria-hidden="true" tabindex="-1"></a>  stationCriteriaResults <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rawCriteriaResults, acuteCriteriaResults, chronicCriteriaResults) <span class="sc">%&gt;%</span> </span>
<span id="cb104-124"><a href="individual-parameter-analyses.html#cb104-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Station_Id)) <span class="sc">%&gt;%</span> <span class="co"># drop placeholder rows</span></span>
<span id="cb104-125"><a href="individual-parameter-analyses.html#cb104-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(Station_Id, WindowDateTimeStart, FDT_DEPTH, Criteria, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> <span class="co"># remove duplicates in case &gt; 1 depth per datetime</span></span>
<span id="cb104-126"><a href="individual-parameter-analyses.html#cb104-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Station_Id, WindowDateTimeStart, FDT_DEPTH, Metal)</span>
<span id="cb104-127"><a href="individual-parameter-analyses.html#cb104-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stationCriteriaResults)</span>
<span id="cb104-128"><a href="individual-parameter-analyses.html#cb104-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-129"><a href="individual-parameter-analyses.html#cb104-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-130"><a href="individual-parameter-analyses.html#cb104-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage: (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb104-131"><a href="individual-parameter-analyses.html#cb104-131" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData and WCmetalsForAnalysis objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb104-132"><a href="individual-parameter-analyses.html#cb104-132" aria-hidden="true" tabindex="-1"></a><span class="co"># metalsAnalysis(filter(WCmetalsForAnalysis, Station_Id %in%  stationData$FDT_STA_ID), stationData, WER= 1)</span></span>
<span id="cb104-133"><a href="individual-parameter-analyses.html#cb104-133" aria-hidden="true" tabindex="-1"></a><span class="co"># filter(WCmetalsForAnalysis, Station_Id %in%  stationData$FDT_STA_ID) %&gt;%</span></span>
<span id="cb104-134"><a href="individual-parameter-analyses.html#cb104-134" aria-hidden="true" tabindex="-1"></a><span class="co">#   metalsAnalysis(stationData, WER= 1) </span></span></code></pre></div>
</div>
<div id="metalsassessmentfunction" class="section level4" number="3.5.12.3">
<h4><span class="header-section-number">3.5.12.3</span> metalsAssessmentFunction</h4>
<p>This final function takes the output of <code>metalsAnalysis()</code> and converts it into the stations table format. However, because there are multiple metals and only 2 columns in the stations table available to describe these results, the total number of exceedances across all metals for a station is reported in the WAT_MET_EXC field. The WAT_MET_STAT field returns â€œSâ€ if no exceedances exist and â€œReviewâ€ if any exceedances are found in any metal. In the WAT_MET_COMMENT field, this function returns a string that includes the criteria that were exceeded with the number of exceedances in parentheses (e.g., Cadmium Chronic Freshwater (2), Barium PWS (1), Copper Acute Freshwater (4), etc.). The WAT_MET_COMMENT is not reported directly in the Station Table but is instead combined into the overall station COMMENT field to comply with standardized assessment application features.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="individual-parameter-analyses.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Metals Assessment function that makes sense of output from metalsAnalysis()</span></span>
<span id="cb105-2"><a href="individual-parameter-analyses.html#cb105-2" aria-hidden="true" tabindex="-1"></a>metalsAssessmentFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(metalsAnalysisResults){</span>
<span id="cb105-3"><a href="individual-parameter-analyses.html#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Check to make sure that metals data exist</span></span>
<span id="cb105-4"><a href="individual-parameter-analyses.html#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(metalsAnalysisResults) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb105-5"><a href="individual-parameter-analyses.html#cb105-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-6"><a href="individual-parameter-analyses.html#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  Organize results to include Staion_Id, Criteria, and the # of Exceedances</span></span>
<span id="cb105-7"><a href="individual-parameter-analyses.html#cb105-7" aria-hidden="true" tabindex="-1"></a>    metalsExceedances <span class="ot">&lt;-</span> metalsAnalysisResults <span class="sc">%&gt;%</span></span>
<span id="cb105-8"><a href="individual-parameter-analyses.html#cb105-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(Station_Id, Criteria) <span class="sc">%&gt;%</span></span>
<span id="cb105-9"><a href="individual-parameter-analyses.html#cb105-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">Exceedances =</span> <span class="fu">sum</span>(Exceedance, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb105-10"><a href="individual-parameter-analyses.html#cb105-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(Criteria)<span class="sc">%&gt;%</span>  <span class="co"># arrange on just Criteria to make column order make more sense</span></span>
<span id="cb105-11"><a href="individual-parameter-analyses.html#cb105-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Exceedances <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb105-12"><a href="individual-parameter-analyses.html#cb105-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-13"><a href="individual-parameter-analyses.html#cb105-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If there are any exceedances, create a string that includes the metal name(s) and the number of exceedances in parentheses</span></span>
<span id="cb105-14"><a href="individual-parameter-analyses.html#cb105-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(metalsExceedances)<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb105-15"><a href="individual-parameter-analyses.html#cb105-15" aria-hidden="true" tabindex="-1"></a>      WAT_MET_STATstring<span class="ot">&lt;-</span><span class="fu">sapply</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(metalsExceedances)), <span class="cf">function</span>(i) <span class="fu">paste0</span>(metalsExceedances<span class="sc">$</span>Criteria[i],<span class="st">&quot; (&quot;</span>, metalsExceedances<span class="sc">$</span>Exceedances[i], <span class="st">&quot;)&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb105-16"><a href="individual-parameter-analyses.html#cb105-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">toString</span>()</span>
<span id="cb105-17"><a href="individual-parameter-analyses.html#cb105-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create tibble in the format of the stations table that takes the sum of all exceedances for the WAT_MET_EXC field and returns the string created above for the WAT_MET_STAT field</span></span>
<span id="cb105-18"><a href="individual-parameter-analyses.html#cb105-18" aria-hidden="true" tabindex="-1"></a>      metalsResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">&quot;WAT_MET_EXC&quot;</span> <span class="ot">=</span> <span class="fu">sum</span>(metalsExceedances<span class="sc">$</span>Exceedances), <span class="st">&quot;WAT_MET_STAT&quot;</span> <span class="ot">=</span> <span class="st">&quot;Review&quot;</span>, <span class="st">&quot;WAT_MET_COMMENT&quot;</span> <span class="ot">=</span> WAT_MET_STATstring)</span>
<span id="cb105-19"><a href="individual-parameter-analyses.html#cb105-19" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb105-20"><a href="individual-parameter-analyses.html#cb105-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If metals data do exist, but there are no exceedances, return 0 and &quot;S&quot; for supporting</span></span>
<span id="cb105-21"><a href="individual-parameter-analyses.html#cb105-21" aria-hidden="true" tabindex="-1"></a>      metalsResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">&quot;WAT_MET_EXC&quot;</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">&quot;WAT_MET_STAT&quot;</span> <span class="ot">=</span> <span class="st">&quot;S&quot;</span>, <span class="st">&quot;WAT_MET_COMMENT&quot;</span> <span class="ot">=</span> <span class="cn">NA</span>)</span>
<span id="cb105-22"><a href="individual-parameter-analyses.html#cb105-22" aria-hidden="true" tabindex="-1"></a>    }}<span class="cf">else</span>{</span>
<span id="cb105-23"><a href="individual-parameter-analyses.html#cb105-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If no metals data exist, return a tibble with NA for both fields</span></span>
<span id="cb105-24"><a href="individual-parameter-analyses.html#cb105-24" aria-hidden="true" tabindex="-1"></a>      metalsResults <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">&quot;WAT_MET_EXC&quot;</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="st">&quot;WAT_MET_STAT&quot;</span> <span class="ot">=</span> <span class="cn">NA</span>, <span class="st">&quot;WAT_MET_COMMENT&quot;</span> <span class="ot">=</span> <span class="cn">NA</span>)</span>
<span id="cb105-25"><a href="individual-parameter-analyses.html#cb105-25" aria-hidden="true" tabindex="-1"></a>    }    </span>
<span id="cb105-26"><a href="individual-parameter-analyses.html#cb105-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(metalsResults)</span>
<span id="cb105-27"><a href="individual-parameter-analyses.html#cb105-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb105-28"><a href="individual-parameter-analyses.html#cb105-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-29"><a href="individual-parameter-analyses.html#cb105-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage for Station Table (demonstrating nested function syntax and pipes, both result in the same output):</span></span>
<span id="cb105-30"><a href="individual-parameter-analyses.html#cb105-30" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData and WCmetalsForAnalysis objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb105-31"><a href="individual-parameter-analyses.html#cb105-31" aria-hidden="true" tabindex="-1"></a><span class="co"># metalsAssessmentFunction(</span></span>
<span id="cb105-32"><a href="individual-parameter-analyses.html#cb105-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   metalsAnalysis(filter(WCmetalsForAnalysis, Station_Id %in%  stationData$FDT_STA_ID),</span></span>
<span id="cb105-33"><a href="individual-parameter-analyses.html#cb105-33" aria-hidden="true" tabindex="-1"></a><span class="co">#                stationData, WER= 1))</span></span>
<span id="cb105-34"><a href="individual-parameter-analyses.html#cb105-34" aria-hidden="true" tabindex="-1"></a><span class="co"># filter(WCmetalsForAnalysis, Station_Id %in%  stationData$FDT_STA_ID) %&gt;% </span></span>
<span id="cb105-35"><a href="individual-parameter-analyses.html#cb105-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   metalsAnalysis(stationData, WER= 1) %&gt;% </span></span>
<span id="cb105-36"><a href="individual-parameter-analyses.html#cb105-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   metalsAssessmentFunction()</span></span></code></pre></div>
</div>
</div>
<div id="fish-tissue" class="section level3" number="3.5.13">
<h3><span class="header-section-number">3.5.13</span> Fish Tissue</h3>
<p>For a general flag provided to the Station Table to determine whether fish tissue data do/do not exist, please see <a href="individual-parameter-analyses.html#pcb">PCB</a> above. When data exists for these fish tissue metals or PCB data, regional assessment staff may investigate them against applicable thresholds inside the waterbody-specific shiny assessment application.</p>
</div>
<div id="benthics" class="section level3" number="3.5.14">
<h3><span class="header-section-number">3.5.14</span> Benthics</h3>
<p>The <code>benthicAssessment()</code> function is used primarily for flagging whether or benthic data exist when building the Station Table. Most stations evaluated during an assessment period do not have benthic macroinvertebrate data, so it is important to flag when data require review.</p>
<p>Benthic assessments are completed by regional biologists to ensure the appropriate SCI and professional judgment are used for assessments. The biological staff review all samples within a given assessment period using the <a href="https://rconnect.deq.virginia.gov/IR2022BioassessmentDashboard/" target="_blank">Bioassessment Dashboard</a> and complete a bioassessment for submission via the <a href="https://rconnect.deq.virginia.gov/BenthicAssessmentFactSheet/" target="_blank">Bioassessment Fact Sheet Generator</a>. This information is archived for future biological, assessment, and TMDL staff as well as provided seamlessly within the <a href="https://rconnect.deq.virginia.gov/IR2022riverineAssessmentApplication/" target="_blank">Riverine Assessment Application</a>.</p>
<p>The regional assessment staff know to look for bioassessment information based on the â€˜Reviewâ€™ flag that the <code>benthicAssessment()</code> function provides to the Station Table output.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="individual-parameter-analyses.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Benthic Data flag</span></span>
<span id="cb106-2"><a href="individual-parameter-analyses.html#cb106-2" aria-hidden="true" tabindex="-1"></a>benthicAssessment <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData,</span>
<span id="cb106-3"><a href="individual-parameter-analyses.html#cb106-3" aria-hidden="true" tabindex="-1"></a>                              VSCIresults <span class="co"># pinned dataset with all BenSamps run against just VSCI</span></span>
<span id="cb106-4"><a href="individual-parameter-analyses.html#cb106-4" aria-hidden="true" tabindex="-1"></a>                              ){</span>
<span id="cb106-5"><a href="individual-parameter-analyses.html#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this works because the all SCI options are run on all data, so if there is a VSCI result </span></span>
<span id="cb106-6"><a href="individual-parameter-analyses.html#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (even if in real life that is not the correct SCI to use), then benthic data exists for</span></span>
<span id="cb106-7"><a href="individual-parameter-analyses.html#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a given station</span></span>
<span id="cb106-8"><a href="individual-parameter-analyses.html#cb106-8" aria-hidden="true" tabindex="-1"></a>  benthicDataExist <span class="ot">&lt;-</span> <span class="fu">filter</span>(VSCIresults, StationID <span class="sc">%in%</span> <span class="fu">unique</span>(stationData<span class="sc">$</span>FDT_STA_ID))</span>
<span id="cb106-9"><a href="individual-parameter-analyses.html#cb106-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(benthicDataExist) <span class="sc">&gt;</span> <span class="dv">0</span>){<span class="fu">tibble</span>(<span class="at">BENTHIC_STAT =</span> <span class="st">&#39;Review&#39;</span>)</span>
<span id="cb106-10"><a href="individual-parameter-analyses.html#cb106-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="fu">tibble</span>(<span class="at">BENTHIC_STAT =</span> <span class="cn">NA</span>)}</span>
<span id="cb106-11"><a href="individual-parameter-analyses.html#cb106-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb106-12"><a href="individual-parameter-analyses.html#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="individual-parameter-analyses.html#cb106-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb106-14"><a href="individual-parameter-analyses.html#cb106-14" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData and VSCIresults objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb106-15"><a href="individual-parameter-analyses.html#cb106-15" aria-hidden="true" tabindex="-1"></a><span class="co"># benthicAssessment(stationData, VSCIresults)</span></span></code></pre></div>
</div>
<div id="additional-functions" class="section level3" number="3.5.15">
<h3><span class="header-section-number">3.5.15</span> Additional Functions</h3>
<p>The functions below are helper functions but do not take a starring role in the automated assessment process; however, without these functions, one could not perform an automated assessment. Each function is detailed below.</p>
<div id="assessmentperiod" class="section level4" number="3.5.15.1">
<h4><span class="header-section-number">3.5.15.1</span> assessmentPeriod</h4>
<p>The <code>assessmentPeriod</code> and <code>assessmentCycle</code> objects are not functions but incredibly useful vectors. These objects hold assessment window and cycle name information that allow for significantly easier updates from cycle to cycle. By sourcing this information throughout multiple dependent arguments and functions, one can easily make cycle changes when a new cycle is ready for assessment.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="individual-parameter-analyses.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish Assessment Period, update each cycle</span></span>
<span id="cb107-2"><a href="individual-parameter-analyses.html#cb107-2" aria-hidden="true" tabindex="-1"></a>assessmentPeriod <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>( <span class="fu">c</span>(<span class="st">&quot;2017-01-01 00:00:00 UTC&quot;</span>, <span class="st">&quot;2022-12-31 23:59:59 UTC&quot;</span>), <span class="at">tz=</span><span class="st">&#39;UTC&#39;</span>)</span>
<span id="cb107-3"><a href="individual-parameter-analyses.html#cb107-3" aria-hidden="true" tabindex="-1"></a>assessmentCycle <span class="ot">&lt;-</span> <span class="st">&#39;2024&#39;</span></span>
<span id="cb107-4"><a href="individual-parameter-analyses.html#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="individual-parameter-analyses.html#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb107-6"><a href="individual-parameter-analyses.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pin_get(&quot;ejones/VSCIresults&quot;, board = &quot;rsconnect&quot;) %&gt;%</span></span>
<span id="cb107-7"><a href="individual-parameter-analyses.html#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter( between(`Collection Date`, assessmentPeriod[1], assessmentPeriod[2]) )</span></span></code></pre></div>
</div>
<div id="wqsvalues" class="section level4" number="3.5.15.2">
<h4><span class="header-section-number">3.5.15.2</span> WQSvalues</h4>
<p>The <code>WQSvalues</code> object is a tibble that allows for easy WQS updates should these values change over time. This data is joined to individual station data by WQS Class information to easily link measured parameters to appropriate criteria. Follow up functions refine the criteria information should a stationâ€™s WQS specify any special standards.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="individual-parameter-analyses.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WQS information for functions</span></span>
<span id="cb108-2"><a href="individual-parameter-analyses.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co"># From: 9VAC25-260-50. Numerical Criteria for Dissolved Oxygen, Ph, and Maximum Temperature</span></span>
<span id="cb108-3"><a href="individual-parameter-analyses.html#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section50/</span></span>
<span id="cb108-4"><a href="individual-parameter-analyses.html#cb108-4" aria-hidden="true" tabindex="-1"></a>WQSvalues <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">CLASS_BASIN =</span> <span class="fu">c</span>(<span class="st">&#39;I&#39;</span>,<span class="st">&quot;II&quot;</span>,<span class="st">&quot;II_7&quot;</span>,<span class="st">&quot;III&quot;</span>,<span class="st">&quot;IV&quot;</span>,<span class="st">&quot;V&quot;</span>,<span class="st">&quot;VI&quot;</span>,<span class="st">&quot;VII&quot;</span>),</span>
<span id="cb108-5"><a href="individual-parameter-analyses.html#cb108-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">CLASS =</span> <span class="fu">c</span>(<span class="st">&#39;I&#39;</span>,<span class="st">&quot;II&quot;</span>,<span class="st">&quot;II&quot;</span>,<span class="st">&quot;III&quot;</span>,<span class="st">&quot;IV&quot;</span>,<span class="st">&quot;V&quot;</span>,<span class="st">&quot;VI&quot;</span>,<span class="st">&quot;VII&quot;</span>),</span>
<span id="cb108-6"><a href="individual-parameter-analyses.html#cb108-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Description Of Waters</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;Open Ocean&#39;</span>, <span class="st">&#39;Tidal Waters in the Chowan Basin and the Atlantic Ocean Basin&#39;</span>,</span>
<span id="cb108-7"><a href="individual-parameter-analyses.html#cb108-7" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&#39;Tidal Waters in the Chesapeake Bay and its tidal tributaries&#39;</span>,</span>
<span id="cb108-8"><a href="individual-parameter-analyses.html#cb108-8" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&#39;Nontidal Waters (Coastal and Piedmont Zone)&#39;</span>,<span class="st">&#39;Mountainous Zone Waters&#39;</span>,</span>
<span id="cb108-9"><a href="individual-parameter-analyses.html#cb108-9" aria-hidden="true" tabindex="-1"></a>                                                <span class="st">&#39;Stockable Trout Waters&#39;</span>,<span class="st">&#39;Natural Trout Waters&#39;</span>,<span class="st">&#39;Swamp Waters&#39;</span>),</span>
<span id="cb108-10"><a href="individual-parameter-analyses.html#cb108-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Dissolved Oxygen Min (mg/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>,<span class="cn">NA</span>,<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="cn">NA</span>),</span>
<span id="cb108-11"><a href="individual-parameter-analyses.html#cb108-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Dissolved Oxygen Daily Avg (mg/L)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>,<span class="dv">5</span>,<span class="cn">NA</span>,<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="cn">NA</span>),</span>
<span id="cb108-12"><a href="individual-parameter-analyses.html#cb108-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">6</span>,<span class="fl">6.0</span>,<span class="fl">6.0</span>,<span class="fl">6.0</span>,<span class="fl">6.0</span>,<span class="fl">6.0</span>,<span class="fl">3.7</span>),</span>
<span id="cb108-13"><a href="individual-parameter-analyses.html#cb108-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">9.0</span>,<span class="fl">8.0</span>),</span>
<span id="cb108-14"><a href="individual-parameter-analyses.html#cb108-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">`</span><span class="at">Max Temperature (C)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="dv">32</span>, <span class="dv">31</span>, <span class="dv">21</span>, <span class="dv">20</span>, <span class="cn">NA</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb108-15"><a href="individual-parameter-analyses.html#cb108-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CLASS_DESCRIPTION =</span> <span class="fu">paste0</span>(CLASS, <span class="st">&quot; | &quot;</span>, <span class="st">`</span><span class="at">Description Of Waters</span><span class="st">`</span>))</span>
<span id="cb108-16"><a href="individual-parameter-analyses.html#cb108-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-17"><a href="individual-parameter-analyses.html#cb108-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb108-18"><a href="individual-parameter-analyses.html#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationTable is already joined to citmonWQS and WQSlookup, see Automated Assessment for environment set up help</span></span>
<span id="cb108-19"><a href="individual-parameter-analyses.html#cb108-19" aria-hidden="true" tabindex="-1"></a><span class="co"># stationTable %&gt;%</span></span>
<span id="cb108-20"><a href="individual-parameter-analyses.html#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Fix for Class II Tidal Waters in Chesapeake (bc complicated DO/temp/etc standard)</span></span>
<span id="cb108-21"><a href="individual-parameter-analyses.html#cb108-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(CLASS_BASIN = paste(CLASS,substr(BASIN, 1,1), sep=&quot;_&quot;)) %&gt;% # (2)</span></span>
<span id="cb108-22"><a href="individual-parameter-analyses.html#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(CLASS_BASIN = ifelse(CLASS_BASIN == &#39;II_7&#39;, &quot;II_7&quot;, as.character(CLASS))) %&gt;% # (2)</span></span>
<span id="cb108-23"><a href="individual-parameter-analyses.html#cb108-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Join actual WQS criteria to each StationID</span></span>
<span id="cb108-24"><a href="individual-parameter-analyses.html#cb108-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(WQSvalues, by = &#39;CLASS_BASIN&#39;)</span></span></code></pre></div>
</div>
<div id="lakenamestandardization" class="section level4" number="3.5.15.3">
<h4><span class="header-section-number">3.5.15.3</span> lakeNameStandardization</h4>
<p>This helper function allows for easier lake name cleanup to allow for joins on lake name fields between disparate data types. By storing this crosswalk information in a single function, it can be easily updated if lake names change and applied to multiple scripts easily.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="individual-parameter-analyses.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lake name standardization</span></span>
<span id="cb109-2"><a href="individual-parameter-analyses.html#cb109-2" aria-hidden="true" tabindex="-1"></a>lakeNameStandardization <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb109-3"><a href="individual-parameter-analyses.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># flexibility to handle new and old naming conventions</span></span>
<span id="cb109-4"><a href="individual-parameter-analyses.html#cb109-4" aria-hidden="true" tabindex="-1"></a>  x <span class="sc">%&gt;%</span> </span>
<span id="cb109-5"><a href="individual-parameter-analyses.html#cb109-5" aria-hidden="true" tabindex="-1"></a>    {<span class="cf">if</span>(<span class="st">&quot;WaterName&quot;</span> <span class="sc">%in%</span> <span class="fu">names</span>(x))</span>
<span id="cb109-6"><a href="individual-parameter-analyses.html#cb109-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(x, <span class="at">WATER_NAME =</span> WaterName)</span>
<span id="cb109-7"><a href="individual-parameter-analyses.html#cb109-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> .} <span class="sc">%&gt;%</span> </span>
<span id="cb109-8"><a href="individual-parameter-analyses.html#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Lake_Name =</span> <span class="fu">case_when</span>(WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Abel Lake Reservoir (Long Branch)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Abel Lake&#39;</span>,</span>
<span id="cb109-9"><a href="individual-parameter-analyses.html#cb109-9" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Big Cherry Reservior&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Big Cherry Lake&#39;</span>,</span>
<span id="cb109-10"><a href="individual-parameter-analyses.html#cb109-10" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Dan River&#39;</span>,<span class="st">&#39;Buffalo Creek&#39;</span>,<span class="st">&#39;Bluestone Creek&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Kerr Reservoir&#39;</span>,</span>
<span id="cb109-11"><a href="individual-parameter-analyses.html#cb109-11" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Smith Lake (Aquia Reservoir)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Aquia Reservoir (Smith Lake)&#39;</span>,</span>
<span id="cb109-12"><a href="individual-parameter-analyses.html#cb109-12" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Claytor Lake (New River)&#39;</span>, <span class="st">&#39;Claytor Lake (Peak Creek)&#39;</span>,</span>
<span id="cb109-13"><a href="individual-parameter-analyses.html#cb109-13" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Claytor Lake Lower (New River)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Claytor Lake&#39;</span>,</span>
<span id="cb109-14"><a href="individual-parameter-analyses.html#cb109-14" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Fairystone Lake (Goblin Town Creek)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Fairystone Lake&#39;</span>, </span>
<span id="cb109-15"><a href="individual-parameter-analyses.html#cb109-15" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Harwood Mill Reservoir (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Harwood Mills Reservoir&#39;</span>,</span>
<span id="cb109-16"><a href="individual-parameter-analyses.html#cb109-16" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Goose Creek&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Goose Creek Reservoir&#39;</span>,</span>
<span id="cb109-17"><a href="individual-parameter-analyses.html#cb109-17" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Anna&#39;</span>, <span class="st">&#39;Lake Anna/Contrary Creek&#39;</span>, <span class="st">&#39;Lake Anna/Freshwater Creek&#39;</span>, </span>
<span id="cb109-18"><a href="individual-parameter-analyses.html#cb109-18" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Lake Anna/Gold Mine Creek&#39;</span>, <span class="st">&#39;Lake Anna/Pamunkey Creek&#39;</span>, </span>
<span id="cb109-19"><a href="individual-parameter-analyses.html#cb109-19" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Lake Anna/Plentiful Creek&#39;</span>, <span class="st">&#39;Terrys Run/Lake Anna&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Anna&#39;</span>,</span>
<span id="cb109-20"><a href="individual-parameter-analyses.html#cb109-20" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Cohoon (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Cohoon&#39;</span>,     </span>
<span id="cb109-21"><a href="individual-parameter-analyses.html#cb109-21" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Conner Lake&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Conner&#39;</span>,</span>
<span id="cb109-22"><a href="individual-parameter-analyses.html#cb109-22" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Kilby (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Kilby&#39;</span>,</span>
<span id="cb109-23"><a href="individual-parameter-analyses.html#cb109-23" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Meade (PWS)&#39;</span>,<span class="st">&#39;Pitch Kettle Creek - Lake (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Meade&#39;</span>,</span>
<span id="cb109-24"><a href="individual-parameter-analyses.html#cb109-24" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Moomaw (Jackson River)&#39;</span>,<span class="st">&#39;Lake Moomaw Middle (Jackson River)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Moomaw&#39;</span>,</span>
<span id="cb109-25"><a href="individual-parameter-analyses.html#cb109-25" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Prince - Reservoir (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Prince&#39;</span>,</span>
<span id="cb109-26"><a href="individual-parameter-analyses.html#cb109-26" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Shenandoah&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Shenandoah Lake&#39;</span>,</span>
<span id="cb109-27"><a href="individual-parameter-analyses.html#cb109-27" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Smith (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Smith&#39;</span>,</span>
<span id="cb109-28"><a href="individual-parameter-analyses.html#cb109-28" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lake Whitehurst (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Whitehurst&#39;</span>,</span>
<span id="cb109-29"><a href="individual-parameter-analyses.html#cb109-29" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Leesville Lake&#39;</span>, <span class="st">&#39;Leesville Lake (Pigg R.)&#39;</span>, </span>
<span id="cb109-30"><a href="individual-parameter-analyses.html#cb109-30" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Leesville Lake Middle (Roanoke R.)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Leesville Lake&#39;</span>,</span>
<span id="cb109-31"><a href="individual-parameter-analyses.html#cb109-31" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lee Hall Reservoir- Upper, Middle&#39;</span>,<span class="st">&#39;Lee Hall Reservoir-Lower&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lee Hall Reservoir&#39;</span>,</span>
<span id="cb109-32"><a href="individual-parameter-analyses.html#cb109-32" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Little Creek Reservoir - (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Little Creek Reservoir (VBC)&#39;</span>,</span>
<span id="cb109-33"><a href="individual-parameter-analyses.html#cb109-33" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Little Creek Reservoir (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Little Creek Reservoir (JCC)&#39;</span>,</span>
<span id="cb109-34"><a href="individual-parameter-analyses.html#cb109-34" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lonestar Lake F (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lone Star Lake F (Crystal Lake)&#39;</span>, </span>
<span id="cb109-35"><a href="individual-parameter-analyses.html#cb109-35" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lone Star Lake G (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lone Star Lake G (Crane Lake)&#39;</span>, </span>
<span id="cb109-36"><a href="individual-parameter-analyses.html#cb109-36" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Lone Star Lake I (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lone Star Lake I (Butler Lake)&#39;</span>, </span>
<span id="cb109-37"><a href="individual-parameter-analyses.html#cb109-37" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Martinsville (Beaver Creek) Reservoir&#39;</span>,</span>
<span id="cb109-38"><a href="individual-parameter-analyses.html#cb109-38" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Martinsville Reservoir&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Martinsville Reservoir (Beaver Creek Reservoir)&#39;</span>,</span>
<span id="cb109-39"><a href="individual-parameter-analyses.html#cb109-39" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Moormans River&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Sugar Hollow Reservoir&#39;</span>,</span>
<span id="cb109-40"><a href="individual-parameter-analyses.html#cb109-40" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;North River&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Staunton Dam Lake&#39;</span>,</span>
<span id="cb109-41"><a href="individual-parameter-analyses.html#cb109-41" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Philpott Reservoir (Goblin Town Creek)&#39;</span>, <span class="st">&#39;Philpott Reservoir Lower (Smith River)&#39;</span>,</span>
<span id="cb109-42"><a href="individual-parameter-analyses.html#cb109-42" aria-hidden="true" tabindex="-1"></a>                                                   <span class="st">&#39;Philpott Reservoir (Smith River)&#39;</span>) <span class="sc">~</span> <span class="st">&quot;Philpott Reservoir&quot;</span>,</span>
<span id="cb109-43"><a href="individual-parameter-analyses.html#cb109-43" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Roanoke River&#39;</span>,<span class="st">&#39;Lake Gaston&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Lake Gaston&#39;</span>,     </span>
<span id="cb109-44"><a href="individual-parameter-analyses.html#cb109-44" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Roaring Fork Reservoir&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Roaring Fork&#39;</span>,</span>
<span id="cb109-45"><a href="individual-parameter-analyses.html#cb109-45" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;S F Rivanna River Reservoir&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Rivanna Reservoir (South Fork Rivanna Reservoir)&#39;</span>,</span>
<span id="cb109-46"><a href="individual-parameter-analyses.html#cb109-46" aria-hidden="true" tabindex="-1"></a>                                 <span class="fu">str_detect</span>(WATER_NAME, <span class="st">&#39;Smith Mtn. Lake&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Smith Mountain Lake&#39;</span>, </span>
<span id="cb109-47"><a href="individual-parameter-analyses.html#cb109-47" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Speights Run - Lake (PWS)&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Speights Run Lake&#39;</span>,</span>
<span id="cb109-48"><a href="individual-parameter-analyses.html#cb109-48" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Troublesome Reservoir&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Troublesome Creek Reservoir&#39;</span>,</span>
<span id="cb109-49"><a href="individual-parameter-analyses.html#cb109-49" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Waller Mill Reservoir [PWS]&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Waller Mill Reservoir&#39;</span>,</span>
<span id="cb109-50"><a href="individual-parameter-analyses.html#cb109-50" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Unnamed pond near Tanyard Swamp&#39;</span>) <span class="sc">~</span> <span class="st">&#39;Tanyard Swamp&#39;</span>,</span>
<span id="cb109-51"><a href="individual-parameter-analyses.html#cb109-51" aria-hidden="true" tabindex="-1"></a>                                 WATER_NAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&#39;Unsegmented lakes in G03&#39;</span>) <span class="sc">~</span> <span class="st">&#39;West Run&#39;</span>,</span>
<span id="cb109-52"><a href="individual-parameter-analyses.html#cb109-52" aria-hidden="true" tabindex="-1"></a>                                 <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.character</span>(WATER_NAME))) </span>
<span id="cb109-53"><a href="individual-parameter-analyses.html#cb109-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb109-54"><a href="individual-parameter-analyses.html#cb109-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-55"><a href="individual-parameter-analyses.html#cb109-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb109-56"><a href="individual-parameter-analyses.html#cb109-56" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationTable is already joined to citmonWQS, WQSlookup, WQSvalues, and WQMstationFull, see Automated Assessment for environment set up help</span></span>
<span id="cb109-57"><a href="individual-parameter-analyses.html#cb109-57" aria-hidden="true" tabindex="-1"></a><span class="co"># stationTable %&gt;% </span></span>
<span id="cb109-58"><a href="individual-parameter-analyses.html#cb109-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   lakeNameStandardization()  </span></span></code></pre></div>
</div>
<div id="quickstats" class="section level4" number="3.5.15.4">
<h4><span class="header-section-number">3.5.15.4</span> quickStats</h4>
<p>This helper function is essential to the automated assessment process. The function takes in parameter data with exceedances identified and sample counts and simplifies the data into a suggested assessment decision, where appropriate. The <code>parameter</code> argument allows users to pass through a character string they want to be included in the Stations Table field naming format. The <code>drop7Q10</code> argument is default set to false for automated assessment purposes, but the shiny applications use this feature to quickly rerun the exceedance math should a user decide that the 7Q10 flag should be used to remove data for a station and parameter combination.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="individual-parameter-analyses.html#cb110-1" aria-hidden="true" tabindex="-1"></a>quickStats <span class="ot">&lt;-</span> <span class="cf">function</span>(parameterDataset, <span class="co"># dataset from one station that has been run through a parameter exceedance analysis function </span></span>
<span id="cb110-2"><a href="individual-parameter-analyses.html#cb110-2" aria-hidden="true" tabindex="-1"></a>                       <span class="co">#                  (e.g. tempExceedances(), DOExceedances_Min(), pHexceedances())</span></span>
<span id="cb110-3"><a href="individual-parameter-analyses.html#cb110-3" aria-hidden="true" tabindex="-1"></a>                       parameter, <span class="co"># the name of the parameter as you want it to appear in final stations table output</span></span>
<span id="cb110-4"><a href="individual-parameter-analyses.html#cb110-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">drop7Q10 =</span> <span class="cn">FALSE</span> <span class="co"># drop any records from this analysis with a 7Q10 flag, default is false but can be overridden in apps</span></span>
<span id="cb110-5"><a href="individual-parameter-analyses.html#cb110-5" aria-hidden="true" tabindex="-1"></a>                       ){</span>
<span id="cb110-6"><a href="individual-parameter-analyses.html#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Drop any 7Q10 flagged data from exceedance analyses for appropriate parameters</span></span>
<span id="cb110-7"><a href="individual-parameter-analyses.html#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(drop7Q10 <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">&amp;</span></span>
<span id="cb110-8"><a href="individual-parameter-analyses.html#cb110-8" aria-hidden="true" tabindex="-1"></a>     parameter <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;TEMP&quot;</span>, <span class="st">&quot;DO&quot;</span>, <span class="st">&quot;DO_Daily_Avg&quot;</span>, <span class="st">&quot;PH&quot;</span>)){</span>
<span id="cb110-9"><a href="individual-parameter-analyses.html#cb110-9" aria-hidden="true" tabindex="-1"></a>    parameterDataset <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(parameterDataset, <span class="fu">is.na</span>(<span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>)) <span class="co"># only assess on assessable dataset</span></span>
<span id="cb110-10"><a href="individual-parameter-analyses.html#cb110-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-11"><a href="individual-parameter-analyses.html#cb110-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-12"><a href="individual-parameter-analyses.html#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(parameterDataset) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(parameterDataset<span class="sc">$</span>limit))){</span>
<span id="cb110-13"><a href="individual-parameter-analyses.html#cb110-13" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EXC =</span> <span class="fu">nrow</span>(dplyr<span class="sc">::</span><span class="fu">filter</span>(parameterDataset, exceeds <span class="sc">==</span> <span class="cn">TRUE</span>)),</span>
<span id="cb110-14"><a href="individual-parameter-analyses.html#cb110-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">SAMP =</span> <span class="fu">nrow</span>(parameterDataset)) <span class="sc">%&gt;%</span></span>
<span id="cb110-15"><a href="individual-parameter-analyses.html#cb110-15" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Implement Round to Even on Exceedance Frequency</span></span>
<span id="cb110-16"><a href="individual-parameter-analyses.html#cb110-16" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">exceedanceRate =</span> <span class="fu">as.numeric</span>(round<span class="sc">::</span><span class="fu">roundAll</span>((EXC<span class="sc">/</span>SAMP)<span class="sc">*</span><span class="dv">100</span>,<span class="at">digits=</span><span class="dv">0</span>, <span class="st">&quot;r0.C&quot;</span>))) <span class="co"># round to nearest whole number per Memo to Standardize Rounding for Assessment Guidance</span></span>
<span id="cb110-17"><a href="individual-parameter-analyses.html#cb110-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-18"><a href="individual-parameter-analyses.html#cb110-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&gt;=</span> <span class="dv">1</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;Review&#39;</span>} <span class="co"># for Mary</span></span>
<span id="cb110-19"><a href="individual-parameter-analyses.html#cb110-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> results<span class="sc">$</span>exceedanceRate <span class="sc">&lt;</span> <span class="fl">10.5</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;Review&#39;</span>}</span>
<span id="cb110-20"><a href="individual-parameter-analyses.html#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>exceedanceRate <span class="sc">&gt;</span> <span class="fl">10.5</span> <span class="sc">&amp;</span> results<span class="sc">$</span>EXC <span class="sc">&gt;=</span> <span class="dv">2</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&gt;</span> <span class="dv">10</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;10.5% Exceedance&#39;</span>}</span>
<span id="cb110-21"><a href="individual-parameter-analyses.html#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span>results<span class="sc">$</span>exceedanceRate <span class="sc">&lt;</span> <span class="fl">10.5</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&gt;</span> <span class="dv">10</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;S&#39;</span>}</span>
<span id="cb110-22"><a href="individual-parameter-analyses.html#cb110-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&lt;=</span> <span class="dv">10</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;Review&#39;</span>}</span>
<span id="cb110-23"><a href="individual-parameter-analyses.html#cb110-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&lt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&gt;</span> <span class="dv">1</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;S&#39;</span>} <span class="co"># &amp; results$SAMP &gt;1 new 12/21/2020 can&#39;t say supporting on 1 sample</span></span>
<span id="cb110-24"><a href="individual-parameter-analyses.html#cb110-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(results<span class="sc">$</span>EXC <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">&lt;=</span> <span class="dv">10</span> <span class="sc">&amp;</span> results<span class="sc">$</span>SAMP <span class="sc">==</span> <span class="dv">1</span>){outcome <span class="ot">&lt;-</span> <span class="st">&#39;Review&#39;</span>} <span class="co"># &amp; results$SAMP &gt;1 new 12/21/2020 can&#39;t say supporting on 1 sample</span></span>
<span id="cb110-25"><a href="individual-parameter-analyses.html#cb110-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-26"><a href="individual-parameter-analyses.html#cb110-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-27"><a href="individual-parameter-analyses.html#cb110-27" aria-hidden="true" tabindex="-1"></a>    results <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(results, <span class="at">STAT =</span> outcome)</span>
<span id="cb110-28"><a href="individual-parameter-analyses.html#cb110-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(results) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste</span>(parameter,<span class="fu">names</span>(results)[<span class="dv">1</span>], <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>),</span>
<span id="cb110-29"><a href="individual-parameter-analyses.html#cb110-29" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste</span>(parameter,<span class="fu">names</span>(results)[<span class="dv">2</span>], <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>),</span>
<span id="cb110-30"><a href="individual-parameter-analyses.html#cb110-30" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste</span>(parameter,<span class="fu">names</span>(results)[<span class="dv">3</span>], <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>),</span>
<span id="cb110-31"><a href="individual-parameter-analyses.html#cb110-31" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">paste</span>(parameter,<span class="fu">names</span>(results)[<span class="dv">4</span>], <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>))</span>
<span id="cb110-32"><a href="individual-parameter-analyses.html#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rename based on parameter entered</span></span>
<span id="cb110-33"><a href="individual-parameter-analyses.html#cb110-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(results)</span>
<span id="cb110-34"><a href="individual-parameter-analyses.html#cb110-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb110-35"><a href="individual-parameter-analyses.html#cb110-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(parameterDataset) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb110-36"><a href="individual-parameter-analyses.html#cb110-36" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EXC =</span> <span class="cn">NA</span>, <span class="at">SAMP=</span> <span class="fu">nrow</span>(parameterDataset), <span class="at">exceedanceRate=</span> <span class="cn">NA</span>, <span class="at">STAT=</span> <span class="cn">NA</span>)</span>
<span id="cb110-37"><a href="individual-parameter-analyses.html#cb110-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(z) <span class="ot">&lt;-</span> <span class="fu">paste</span>(parameter,<span class="fu">names</span>(z), <span class="at">sep=</span><span class="st">&#39;_&#39;</span>)</span>
<span id="cb110-38"><a href="individual-parameter-analyses.html#cb110-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(z)</span>
<span id="cb110-39"><a href="individual-parameter-analyses.html#cb110-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb110-40"><a href="individual-parameter-analyses.html#cb110-40" aria-hidden="true" tabindex="-1"></a>      z <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">EXC =</span> <span class="cn">NA</span>, <span class="at">SAMP=</span> <span class="fu">nrow</span>(parameterDataset), <span class="at">exceedanceRate=</span> <span class="cn">NA</span>, <span class="at">STAT=</span> <span class="fu">paste</span>(parameter, <span class="st">&#39;WQS info missing from analysis&#39;</span>))</span>
<span id="cb110-41"><a href="individual-parameter-analyses.html#cb110-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(z) <span class="ot">&lt;-</span> <span class="fu">paste</span>(parameter,<span class="fu">names</span>(z), <span class="at">sep=</span><span class="st">&#39;_&#39;</span>)</span>
<span id="cb110-42"><a href="individual-parameter-analyses.html#cb110-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(z)</span>
<span id="cb110-43"><a href="individual-parameter-analyses.html#cb110-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb110-44"><a href="individual-parameter-analyses.html#cb110-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb110-45"><a href="individual-parameter-analyses.html#cb110-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-46"><a href="individual-parameter-analyses.html#cb110-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-47"><a href="individual-parameter-analyses.html#cb110-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-48"><a href="individual-parameter-analyses.html#cb110-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb110-49"><a href="individual-parameter-analyses.html#cb110-49" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb110-50"><a href="individual-parameter-analyses.html#cb110-50" aria-hidden="true" tabindex="-1"></a><span class="co"># tempExceedances(stationData) %&gt;% </span></span>
<span id="cb110-51"><a href="individual-parameter-analyses.html#cb110-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   quickStats(&#39;TEMP&#39;)</span></span></code></pre></div>
</div>
<div id="stationtablestartingdata" class="section level4" number="3.5.15.5">
<h4><span class="header-section-number">3.5.15.5</span> StationTableStartingData</h4>
<p>This helper function organizes existing site metadata into a format that matches the desired Station Table output format.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="individual-parameter-analyses.html#cb111-1" aria-hidden="true" tabindex="-1"></a>StationTableStartingData <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb111-2"><a href="individual-parameter-analyses.html#cb111-2" aria-hidden="true" tabindex="-1"></a>  stationData <span class="sc">%&gt;%</span></span>
<span id="cb111-3"><a href="individual-parameter-analyses.html#cb111-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(FDT_STA_ID, ID305B_1<span class="sc">:</span>VAHU6) <span class="sc">%&gt;%</span></span>
<span id="cb111-4"><a href="individual-parameter-analyses.html#cb111-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">&#39;STATION_ID&#39;</span> <span class="ot">=</span> <span class="st">&#39;FDT_STA_ID&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb111-5"><a href="individual-parameter-analyses.html#cb111-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">distinct</span>(STATION_ID, <span class="at">.keep_all =</span> T)</span>
<span id="cb111-6"><a href="individual-parameter-analyses.html#cb111-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb111-7"><a href="individual-parameter-analyses.html#cb111-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-8"><a href="individual-parameter-analyses.html#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb111-9"><a href="individual-parameter-analyses.html#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb111-10"><a href="individual-parameter-analyses.html#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="co"># StationTableStartingData(stationData)</span></span></code></pre></div>
</div>
<div id="temperaturespecialstandardscorrection" class="section level4" number="3.5.15.6">
<h4><span class="header-section-number">3.5.15.6</span> temperatureSpecialStandardsCorrection</h4>
<p>This helper function is applied after <code>WQSvalues()</code> is run on a tibble of station data. The function corrects the coarser WQS value joined by Class by identifying if any temperature special standards are attributed to a station. If so, the function then adjusts each <code>Max Temperature (C)</code> record based on temporal criteria accordingly.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="individual-parameter-analyses.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># temperature special standards adjustment function</span></span>
<span id="cb112-2"><a href="individual-parameter-analyses.html#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this is applied to the actual monitoring data because there is a temporal component to these criteria</span></span>
<span id="cb112-3"><a href="individual-parameter-analyses.html#cb112-3" aria-hidden="true" tabindex="-1"></a>temperatureSpecialStandardsCorrection <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb112-4"><a href="individual-parameter-analyses.html#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ee. Maximum temperature for these seasonally stockable trout waters is 26Â°C and applies May 1 through October 31. https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section310/</span></span>
<span id="cb112-5"><a href="individual-parameter-analyses.html#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ff. Maximum temperature for these seasonally stockable trout waters is 28Â°C and applies May 1 through October 31. https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section310/</span></span>
<span id="cb112-6"><a href="individual-parameter-analyses.html#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hh. Maximum temperature for these seasonally stockable trout waters is 31Â°C and applies May 1 through October 31. https://law.lis.virginia.gov/admincode/title9/agency25/chapter260/section310/</span></span>
<span id="cb112-7"><a href="individual-parameter-analyses.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(x, <span class="st">`</span><span class="at">Max Temperature (C)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(<span class="fu">str_detect</span>(<span class="fu">as.character</span>(SPSTDS), <span class="st">&#39;ee&#39;</span>) <span class="sc">&amp;</span> <span class="fu">month</span>(FDT_DATE_TIME) <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">~</span> <span class="dv">26</span>,</span>
<span id="cb112-8"><a href="individual-parameter-analyses.html#cb112-8" aria-hidden="true" tabindex="-1"></a>                                              <span class="fu">str_detect</span>(<span class="fu">as.character</span>(SPSTDS), <span class="st">&#39;ff&#39;</span>) <span class="sc">&amp;</span> <span class="fu">month</span>(FDT_DATE_TIME) <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">~</span> <span class="dv">28</span>,</span>
<span id="cb112-9"><a href="individual-parameter-analyses.html#cb112-9" aria-hidden="true" tabindex="-1"></a>                                              <span class="fu">str_detect</span>(<span class="fu">as.character</span>(SPSTDS), <span class="st">&#39;hh&#39;</span>) <span class="sc">&amp;</span> <span class="fu">month</span>(FDT_DATE_TIME) <span class="sc">%in%</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">10</span> <span class="sc">~</span> <span class="dv">31</span>,</span>
<span id="cb112-10"><a href="individual-parameter-analyses.html#cb112-10" aria-hidden="true" tabindex="-1"></a>                                              <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">`</span><span class="at">Max Temperature (C)</span><span class="st">`</span>)) </span>
<span id="cb112-11"><a href="individual-parameter-analyses.html#cb112-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-12"><a href="individual-parameter-analyses.html#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="individual-parameter-analyses.html#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb112-14"><a href="individual-parameter-analyses.html#cb112-14" aria-hidden="true" tabindex="-1"></a><span class="co"># where conventionals and stationTable objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb112-15"><a href="individual-parameter-analyses.html#cb112-15" aria-hidden="true" tabindex="-1"></a><span class="co"># stationData &lt;- filter(conventionals, FDT_STA_ID %in% &#39;2-JKS023.61&#39;) %&gt;%</span></span>
<span id="cb112-16"><a href="individual-parameter-analyses.html#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     left_join(stationTable, by = c(&#39;FDT_STA_ID&#39; = &#39;STATION_ID&#39;)) %&gt;%</span></span>
<span id="cb112-17"><a href="individual-parameter-analyses.html#cb112-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     temperatureSpecialStandardsCorrection()</span></span></code></pre></div>
</div>
<div id="phspecialstandardscorrection" class="section level4" number="3.5.15.7">
<h4><span class="header-section-number">3.5.15.7</span> pHSpecialStandardsCorrection</h4>
<p>This helper function is applied after <code>WQSvalues()</code> is run on a tibble of station data. The function corrects the coarser WQS value joined by Class by identifying if any pH special standards are attributed to a station. If so, the function then adjusts each <code>pH Min</code> and <code>pH Max</code> record based on applicable criteria accordingly.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="individual-parameter-analyses.html#cb113-1" aria-hidden="true" tabindex="-1"></a>pHSpecialStandardsCorrection <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb113-2"><a href="individual-parameter-analyses.html#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(stationData, <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(<span class="fu">str_detect</span>(<span class="fu">as.character</span>(SPSTDS), <span class="st">&#39;6.5-9.5&#39;</span>) <span class="sc">~</span> <span class="fl">6.5</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">`</span><span class="at">pH Min</span><span class="st">`</span>),</span>
<span id="cb113-3"><a href="individual-parameter-analyses.html#cb113-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">case_when</span>(<span class="fu">str_detect</span>(<span class="fu">as.character</span>(SPSTDS), <span class="st">&#39;6.5-9.5&#39;</span>) <span class="sc">~</span> <span class="fl">9.5</span>, <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">`</span><span class="at">pH Max</span><span class="st">`</span>))</span>
<span id="cb113-4"><a href="individual-parameter-analyses.html#cb113-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb113-5"><a href="individual-parameter-analyses.html#cb113-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb113-6"><a href="individual-parameter-analyses.html#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># where conventionals and stationTable objects are already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb113-7"><a href="individual-parameter-analyses.html#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co"># stationData &lt;- filter(conventionals, FDT_STA_ID %in% &#39;2-JKS023.61&#39;) %&gt;%</span></span>
<span id="cb113-8"><a href="individual-parameter-analyses.html#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     left_join(stationTable, by = c(&#39;FDT_STA_ID&#39; = &#39;STATION_ID&#39;)) %&gt;%</span></span>
<span id="cb113-9"><a href="individual-parameter-analyses.html#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     pHSpecialStandardsCorrection()</span></span></code></pre></div>
</div>
<div id="stationtablecomments" class="section level4" number="3.5.15.8">
<h4><span class="header-section-number">3.5.15.8</span> stationTableComments</h4>
<p>This helper function parses station level comments from the two most recent IR Station Table outputs. This information is joined into the current IR Station Table, despite not fitting with the CEDS Bulk Data Upload template, in order to provide regional assessment staff with historical station information adjacent to current station information.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="individual-parameter-analyses.html#cb114-1" aria-hidden="true" tabindex="-1"></a>stationTableComments <span class="ot">&lt;-</span> <span class="cf">function</span>(stations, </span>
<span id="cb114-2"><a href="individual-parameter-analyses.html#cb114-2" aria-hidden="true" tabindex="-1"></a>                                 previousStationTable, </span>
<span id="cb114-3"><a href="individual-parameter-analyses.html#cb114-3" aria-hidden="true" tabindex="-1"></a>                                 previousStationTableCycle,</span>
<span id="cb114-4"><a href="individual-parameter-analyses.html#cb114-4" aria-hidden="true" tabindex="-1"></a>                                 previousStationTable2,</span>
<span id="cb114-5"><a href="individual-parameter-analyses.html#cb114-5" aria-hidden="true" tabindex="-1"></a>                                 previousStationTable2Cycle){</span>
<span id="cb114-6"><a href="individual-parameter-analyses.html#cb114-6" aria-hidden="true" tabindex="-1"></a>  lastComment <span class="ot">&lt;-</span> <span class="fu">filter</span>(previousStationTable, <span class="st">`</span><span class="at">Station Id</span><span class="st">`</span> <span class="sc">%in%</span> stations) <span class="sc">%&gt;%</span></span>
<span id="cb114-7"><a href="individual-parameter-analyses.html#cb114-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">`</span><span class="at">Station Id</span><span class="st">`</span>, Comments)</span>
<span id="cb114-8"><a href="individual-parameter-analyses.html#cb114-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(lastComment) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;STATION_ID&#39;</span>, <span class="fu">paste</span>(previousStationTableCycle, <span class="st">&#39;IR COMMENTS&#39;</span>))</span>
<span id="cb114-9"><a href="individual-parameter-analyses.html#cb114-9" aria-hidden="true" tabindex="-1"></a>  lastComment2 <span class="ot">&lt;-</span> <span class="fu">filter</span>(previousStationTable2, <span class="st">`</span><span class="at">Station Id</span><span class="st">`</span> <span class="sc">%in%</span> stations) <span class="sc">%&gt;%</span></span>
<span id="cb114-10"><a href="individual-parameter-analyses.html#cb114-10" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="st">`</span><span class="at">Station Id</span><span class="st">`</span>, Comments)</span>
<span id="cb114-11"><a href="individual-parameter-analyses.html#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(lastComment2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;STATION_ID&#39;</span>, <span class="fu">paste</span>(previousStationTable2Cycle, <span class="st">&#39;IR COMMENTS&#39;</span>))</span>
<span id="cb114-12"><a href="individual-parameter-analyses.html#cb114-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">left_join</span>(lastComment, lastComment2, <span class="at">by=</span> <span class="st">&#39;STATION_ID&#39;</span>))</span>
<span id="cb114-13"><a href="individual-parameter-analyses.html#cb114-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb114-14"><a href="individual-parameter-analyses.html#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="individual-parameter-analyses.html#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Usage:</span></span>
<span id="cb114-16"><a href="individual-parameter-analyses.html#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationsTable2022 and stationTable2020 are objects containing previous stations table spreadsheets read into your R environment, see Automated Assessment for environment set up help</span></span>
<span id="cb114-17"><a href="individual-parameter-analyses.html#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="co"># stationTableComments(&#39;2-JKS023.61&#39;, stationsTable2022, &#39;2022&#39;, stationsTable2020, &#39;2020&#39;)</span></span></code></pre></div>
</div>
<div id="thermoclinedepth" class="section level4" number="3.5.15.9">
<h4><span class="header-section-number">3.5.15.9</span> thermoclineDepth</h4>
<p>This helper function is essential for any lake station. The function takes in all conventionals data for a particular station and calculates a thermocline depth for each sample date. This depth is then used to attribute every sample as either â€œEpilimnion,â€ â€œHypolimnion,â€ or unstratified (NA).</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="individual-parameter-analyses.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily thermocline depth and designate Epilimnion vs Hypolimnion</span></span>
<span id="cb115-2"><a href="individual-parameter-analyses.html#cb115-2" aria-hidden="true" tabindex="-1"></a>thermoclineDepth <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb115-3"><a href="individual-parameter-analyses.html#cb115-3" aria-hidden="true" tabindex="-1"></a>  stationData <span class="ot">&lt;-</span> stationData <span class="sc">%&gt;%</span></span>
<span id="cb115-4"><a href="individual-parameter-analyses.html#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">SampleDate =</span> <span class="fu">as.Date</span>(FDT_DATE_TIME)) <span class="sc">%&gt;%</span></span>
<span id="cb115-5"><a href="individual-parameter-analyses.html#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(FDT_STA_ID, SampleDate) </span>
<span id="cb115-6"><a href="individual-parameter-analyses.html#cb115-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-7"><a href="individual-parameter-analyses.html#cb115-7" aria-hidden="true" tabindex="-1"></a>  dailyThermDepth <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(stationData, FDT_STA_ID, SampleDate, FDT_DEPTH, FDT_TEMP_CELCIUS) <span class="sc">%&gt;%</span></span>
<span id="cb115-8"><a href="individual-parameter-analyses.html#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">DepthDiff =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(FDT_DEPTH)),</span>
<span id="cb115-9"><a href="individual-parameter-analyses.html#cb115-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">TempDiff =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(FDT_TEMP_CELCIUS))) <span class="sc">%&gt;%</span></span>
<span id="cb115-10"><a href="individual-parameter-analyses.html#cb115-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(DepthDiff <span class="sc">==</span> <span class="dv">1</span>) <span class="co"># get rid of changes less than 1 meter depth</span></span>
<span id="cb115-11"><a href="individual-parameter-analyses.html#cb115-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Alt route in case shallow lake</span></span>
<span id="cb115-12"><a href="individual-parameter-analyses.html#cb115-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(dailyThermDepth) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb115-13"><a href="individual-parameter-analyses.html#cb115-13" aria-hidden="true" tabindex="-1"></a>    dailyThermDepth <span class="ot">&lt;-</span> <span class="fu">filter</span>(dailyThermDepth, TempDiff <span class="sc">&lt;=</span> <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb115-14"><a href="individual-parameter-analyses.html#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># one more catch if no thermocline established</span></span>
<span id="cb115-15"><a href="individual-parameter-analyses.html#cb115-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(dailyThermDepth) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb115-16"><a href="individual-parameter-analyses.html#cb115-16" aria-hidden="true" tabindex="-1"></a>      dailyThermDepth <span class="ot">&lt;-</span> <span class="fu">summarise</span>(dailyThermDepth, <span class="at">ThermoclineDepth =</span> <span class="fu">min</span>(FDT_DEPTH) <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() </span>
<span id="cb115-17"><a href="individual-parameter-analyses.html#cb115-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb115-18"><a href="individual-parameter-analyses.html#cb115-18" aria-hidden="true" tabindex="-1"></a>      dailyThermDepth <span class="ot">&lt;-</span> <span class="fu">summarise</span>(stationData, <span class="at">ThermoclineDepth =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()  }</span>
<span id="cb115-19"><a href="individual-parameter-analyses.html#cb115-19" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb115-20"><a href="individual-parameter-analyses.html#cb115-20" aria-hidden="true" tabindex="-1"></a>    dailyThermDepth <span class="ot">&lt;-</span> <span class="fu">summarise</span>(stationData, <span class="at">ThermoclineDepth =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() }</span>
<span id="cb115-21"><a href="individual-parameter-analyses.html#cb115-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-22"><a href="individual-parameter-analyses.html#cb115-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-23"><a href="individual-parameter-analyses.html#cb115-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(stationData, dailyThermDepth, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&#39;FDT_STA_ID&#39;</span>, <span class="st">&#39;SampleDate&#39;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb115-24"><a href="individual-parameter-analyses.html#cb115-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">LakeStratification=</span> <span class="fu">ifelse</span>(FDT_DEPTH <span class="sc">&lt;</span> ThermoclineDepth,<span class="st">&quot;Epilimnion&quot;</span>,<span class="st">&quot;Hypolimnion&quot;</span>))<span class="sc">%&gt;%</span> <span class="fu">ungroup</span>() </span>
<span id="cb115-25"><a href="individual-parameter-analyses.html#cb115-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb115-26"><a href="individual-parameter-analyses.html#cb115-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-27"><a href="individual-parameter-analyses.html#cb115-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb115-28"><a href="individual-parameter-analyses.html#cb115-28" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb115-29"><a href="individual-parameter-analyses.html#cb115-29" aria-hidden="true" tabindex="-1"></a><span class="co"># stationData %&gt;% thermoclineDepth()</span></span></code></pre></div>
</div>
<div id="lowflowflagcolumn" class="section level4" number="3.5.15.10">
<h4><span class="header-section-number">3.5.15.10</span> lowFlowFlagColumn</h4>
<p>This helper function is new for IR2024. The function provides a flag field to the Station Table output only if a station has temperature, DO, or pH data collected on day with gage in subbasin is below 7Q10.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="individual-parameter-analyses.html#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to add a column to stations table output that summarizes 7Q10 information for relevant parameters</span></span>
<span id="cb116-2"><a href="individual-parameter-analyses.html#cb116-2" aria-hidden="true" tabindex="-1"></a>lowFlowFlagColumn <span class="ot">&lt;-</span> <span class="cf">function</span>(stationData){</span>
<span id="cb116-3"><a href="individual-parameter-analyses.html#cb116-3" aria-hidden="true" tabindex="-1"></a>  lowFlowFlag <span class="ot">&lt;-</span> <span class="fu">filter</span>(stationData, <span class="sc">!</span><span class="fu">is.na</span>(<span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>))</span>
<span id="cb116-4"><a href="individual-parameter-analyses.html#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(lowFlowFlag) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb116-5"><a href="individual-parameter-analyses.html#cb116-5" aria-hidden="true" tabindex="-1"></a>    withParameterData <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(lowFlowFlag, FDT_STA_ID, FDT_DATE_TIME, </span>
<span id="cb116-6"><a href="individual-parameter-analyses.html#cb116-6" aria-hidden="true" tabindex="-1"></a>                                       FDT_TEMP_CELCIUS, DO_mg_L, FDT_FIELD_PH, <span class="st">`</span><span class="at">7Q10 Flag Gage</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-7"><a href="individual-parameter-analyses.html#cb116-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(FDT_STA_ID, FDT_DATE_TIME, <span class="st">`</span><span class="at">7Q10 Flag Gage</span><span class="st">`</span>), <span class="at">names_to =</span> <span class="st">&#39;parameter&#39;</span>, <span class="at">values_to =</span> <span class="st">&#39;value&#39;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-8"><a href="individual-parameter-analyses.html#cb116-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)) <span class="co"># drop rows with no data for specific parameters</span></span>
<span id="cb116-9"><a href="individual-parameter-analyses.html#cb116-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">nrow</span>(withParameterData) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb116-10"><a href="individual-parameter-analyses.html#cb116-10" aria-hidden="true" tabindex="-1"></a>      gageFlags <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(withParameterData, FDT_STA_ID, FDT_DATE_TIME,  <span class="st">`</span><span class="at">7Q10 Flag Gage</span><span class="st">`</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb116-11"><a href="individual-parameter-analyses.html#cb116-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">distinct</span>(FDT_DATE_TIME, <span class="at">.keep_all =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb116-12"><a href="individual-parameter-analyses.html#cb116-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">STATION_ID =</span> FDT_STA_ID, </span>
<span id="cb116-13"><a href="individual-parameter-analyses.html#cb116-13" aria-hidden="true" tabindex="-1"></a>                  <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">as.Date</span>(FDT_DATE_TIME),  <span class="st">`</span><span class="at">7Q10 Flag Gage</span><span class="st">`</span>, <span class="at">collapse =</span> <span class="st">&#39;; &#39;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb116-14"><a href="individual-parameter-analyses.html#cb116-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&#39;USGS Gages in subbasin below 7Q10: &#39;</span>, <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span>)) </span>
<span id="cb116-15"><a href="individual-parameter-analyses.html#cb116-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb116-16"><a href="individual-parameter-analyses.html#cb116-16" aria-hidden="true" tabindex="-1"></a>      gageFlags <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">STATION_ID =</span> <span class="fu">unique</span>(lowFlowFlag<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb116-17"><a href="individual-parameter-analyses.html#cb116-17" aria-hidden="true" tabindex="-1"></a>                          <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA_character_</span>)   }</span>
<span id="cb116-18"><a href="individual-parameter-analyses.html#cb116-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb116-19"><a href="individual-parameter-analyses.html#cb116-19" aria-hidden="true" tabindex="-1"></a>    gageFlags <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">STATION_ID =</span> <span class="fu">unique</span>(lowFlowFlag<span class="sc">$</span>FDT_STA_ID),</span>
<span id="cb116-20"><a href="individual-parameter-analyses.html#cb116-20" aria-hidden="true" tabindex="-1"></a>                        <span class="st">`</span><span class="at">7Q10 Flag</span><span class="st">`</span> <span class="ot">=</span> <span class="cn">NA_character_</span>)</span>
<span id="cb116-21"><a href="individual-parameter-analyses.html#cb116-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb116-22"><a href="individual-parameter-analyses.html#cb116-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(gageFlags)</span>
<span id="cb116-23"><a href="individual-parameter-analyses.html#cb116-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb116-24"><a href="individual-parameter-analyses.html#cb116-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-25"><a href="individual-parameter-analyses.html#cb116-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb116-26"><a href="individual-parameter-analyses.html#cb116-26" aria-hidden="true" tabindex="-1"></a><span class="co"># where stationData is already in your environment, see Automated Assessment for environment set up help</span></span>
<span id="cb116-27"><a href="individual-parameter-analyses.html#cb116-27" aria-hidden="true" tabindex="-1"></a><span class="co">#lowFlowFlagColumn(stationData)</span></span></code></pre></div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="automated-assessment-analysis.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="automated-output.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": null
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["series.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
