# Regional Metadata Validation Tool How To

```{r metadata setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The [Regional Metadata Validation Tool](https://rconnect.deq.virginia.gov/RegionalAssessmentMetadataValidation/) is located on the R server.


The purpose of this tool is to streamline the QA of metadata attached to individual stations that was performed by automated scripts. This metadata include Water Quality Standards (WQS) and Assessment Unit (AU) information that are necessary to properly analyze and organize assessment results. A scripted process automates the data organization of stations from disparate data sources, spatially joins these sites to the appropriate WQS and AUs where information is not available from previous cycles, and runs basic QA on the output to ensure all stations that were expected to receive metadata did in fact get attributed. These scripts are detailed in the [Metadata Attribution](#metadata-attribution) section. 

It is the responsibility of each regional assessor to review the metadata linked through the automated snapping process to ensure the closest snapped information does in fact apply to the given station. This application offers an opportunity to perform QA on the spatial WQS and AU layers and communicate with Central Office Assessment/WQS staff when mistakes are found. 

## Application Orientation

This application expedites the review of the spatially joined output by organizing stations into the appropriate waterbody type, Assessment Region, and subbasin. The application is divided into two tabs (corresponding to AU review and WQS review) that can be navigated between using the navigation bar at the top of the page. The application opens to the Assessment Unit Review tab by default, but there is no specified order in which a reviewer must interact with either tab. Data for each tab are saved back to the R server independently. Each of these tabs have a drop down option that is accessible by clicking the triangle adjacent to the name of the tab. These options are identical for both the Assessment Unit QA and Water Quality Standards QA tabs. The top option called `Watershed Selection` allows users to choose certain types of stations to review and the bottom option called `Manual Review` allows users to visualize the stations selected in the `Watershed Selection` tab option in more detail. The final tab called "About" offers instructions to the user similar to what is detailed below.

The following application workflow is applicable to both the Assessment Unit QA and Water Quality Standards QA sections of the application. For brevity, this user guide will only go over instructions for the WQS side of the application, but the application flow applied to the WQS side of the application mimics the application flow applied on the AU side of the application.

## Application Use: Water Quality Standards QA- Watershed Selection Tab

On load, the tab will provide three related drop down menus on the left hand side of the page. These interact in a top-down hierarchical system where the selection in the top drop down, `Select Waterbody Type`, dictates available options in the middle drop down, `Select DEQ Assessment Region`, which then dictates the available options in the bottom drop down, `Select Subbasin`. Users navigate through these cascading filters to identify the precise waterbody type (e.g. riverine, lacustrine, or estuarine), assessment region, and subbasin to tackle QA in a given session. 

![](images/metadata1.PNG)

Once the user is happy with their selection, they must click the `Begin Review With Subbasin Selection (Retrieves Last Saved Result)` button. This button uses the user provided information to retrieve all the applicable stations that require QA. This information is sourced from the R server in addition to all the applicable spatial layers necessary to produce meaningful maps in the subsequent `Manual Review` tab option. Once this information is retrieved from the R server, a basic interactive map of the selected subbasin populates the tab as well as verbal breakdowns of the type of information that needs to be reviewed for the selected subbasin (Preprocessing Data Recap for Selected Region/Subbasin/Type Combination).

![](images/metadata2.PNG)

Based on the summarized information about the stations in the selected subbasin, the user may choose to begin reviewing that subbasin or they might scroll through other waterbody type/region/subbasin combinations until a more desirable "to do list" is identified. Each time a user changes any of the drop down inputs, they must press the `Begin Review With Subbasin Selection (Retrieves Last Saved Result)` button to retrieve the associated station breakdown from the chosen subbasin. A small progress bar appears in the lower right corner of the browser window to communicate that large spatial data are being transmitted to the app. The popup disappears when the map re-renders and loads the new spatial information.

Once a user is ready to review the stations in the selected subbasin, the user must navigate to the `Manual Review` tab under the Water Quality Standards QA drop down on the navigation bar.


## Application Use: Water Quality Standards QA- Manual Review Tab

On load, the `Manual Review` tab renders three buttons, an interactive map of Virginia, and an area for output information from the map that is blank until user input dictates. 

### Map Orientation

The map allows users to zoom and pan interactively with the mouse. In the top left corner there are a number of tools to aid users. The plus and minus buttons offer fixed zoom in/out. The home button returns the map orientation to the original zoom level in case a user gets lost. The magnifying glass button allows users to search for and zoom to a selected station. To use this feature, click on the magnifying glass, begin typing the StationID of interest in the text box (after each character entered, a dropdown of options based on the characters entered appears), once a station is selected, the map will zoom to that station and highlight it with a red circle. You may notice that if there isn't the `All Stations in Basin` layer on, then no station point appears inside the red circle. Additional layers available in the map (by hovering over the layers button on the left side) include `All Stations in Basin` (all other stations identified in the basin with data for the given IR window) and `Assessment Regions` (regional assessment boundaries). 

![](images/metadata3.PNG)

### What do the buttons do?

The three buttons correspond to the station snapping summaries presented on the `Watershed Selection` tab. In the example above, we can see this subbasin has: 
* There are 8 stations that snapped to 1 WQS segment in preprocessing.
* There are 1 stations that snapped to > 1 WQS segment in preprocessing.
* There are 1 stations that snapped to 0 WQS segments in preprocessing.

By clicking the `Plot stations that snapped to 1 WQS Segment`, users will see all the stations that only retrieved one WQS segment in the spatial snapping process. They are colored from green to light red based on the buffer distance required to snap to a segment  (within the smallest set buffer distance of the sequence dictated to the automated snapping functions). Green stations snapped to segments at closer distances compared to red sites. The legend for the buffer distance stations colors is presented in the right corner of the app.

By clicking the `Plot stations that snapped to >1 WQS Segment`, users will see all the stations that retrieved multiple WQS segments in the spatial snapping process  (within the smallest set buffer distance of the sequence dictated to the automated snapping functions). They are colored to red to indicate these stations need more attention. 

By clicking the `Plot stations that snapped to 0 WQS Segment`, users will see all the stations that retrieved no WQS segments in the spatial snapping process (within the largest buffer distance of the sequence dictated to the automated snapping functions). They are colored to orange to indicate these stations need the most attention. 

If any of the categories listed above had 0 stations, a warning message will appear in the lower right corner of the app indicating there is nothing for the button to plot.

![](images/metadata4.PNG)

### Application Operation

The goal of this section of the application is to review each station and either accept or adjust the provided WQS information snapped to the site. To review a site, users may zoom to a selected map area and click on a site. By clicking a site, users are selecting a site to QA, as indicated by the green halo around the selected site. The associated metadata is now populated in the `Stations Data and Spatially Joined WQS` tab below the map. 

The `Selected Station Information` table details information about the station including:
* the WQS_ID of snapped segment(s)
* the Buffer Distance (distance required to snap to the linked segment(s))
* n (the number of segments linked to the station during spatial processing)
* a hyperlink to the internal GIS Web Application that pulls up the appropriate WQS layer and station information in a new browser tab
* additional station metadata information

The `Spatially Joined WQS Information` table details information about the WQS segment(s) attached to the selected station including:
* WQS_ID (unique code attributed to each WQS segment)
* GNIS_Name (name of the WQS segment)
* SEC (WQS section)
* CLASS (WQS class)
* SPSTDS (WQS special standards)
* SECTION_DESCRIPTION (narrative description of the section location)
* PWS (whether or not the section is designated as a Public Water Supply)
* Tier_III (whether or not the section is designated as a Tier III water)
* additional WQS segment information

**Users may click on more than one station and subsequently reveal information about more than one station in the `Stations Data and Spatially Joined WQS` tab below the map.** If more than one row is presented in a table, a y scroll bar on the right side of the table will automatically appear such that the user may access all the table information.

#### Application Operation: Clear Selection

To deselect a station or stations, click the blue `Clear Selection` button below the map. 
` 
![](images/metadata5.PNG)

### Application Operation: Station that Snapped to 1 WQS Segment

Should a user select a station for review that snapped to 1 WQS segment, the process for QAing that station is simple. With the station highlighted with the green halo, the user reviews all the information presented below the map in the `Stations Data and Spatially Joined WQS` tab. Additionally, when the `Plot stations that snapped to 1 WQS Segment` button was pressed, additional spatial layers became available in the layers drop down of the map. The user may now turn on the layer called `WQS Segments of Stations Snapped to 1 Segment` to reveal all the segments in that category. These segments may be clicked on in the map to reveal the same information from the `Selected Station Information` table in a popup on the map.

![](images/metadata6.PNG)

#### Application Operation: Accept

If the user is satisfied with the snapped WQS segment, they may press the blue `Accept` button to reveal a modal window named `Accept Snapped WQS`. This modal shows the information from the `Selected Station Information` table one last time for review. There is a textbox below the table where users may input any additional comments and documentation to archive with the snapped StationID and WQS segment information. This could be why the selection was made, notes to future assessors about this site/segment, or nothing at all. At this point the user may navigate away from the modal by pressing `Dismiss` or `Cancel` if they choose to not proceed with that station.

![](images/metadata7.PNG)

Once the user presses the `Accept` button in the `Accept Snapped WQS` modal, the station and WQS segment are linked, the modal disappears, the station changes to a purple (completed) color, and the count of stations "to do" in that category at the top of the page goes down by one. 


#### Application Operation: Manual WQS Adjustment (1 segment)

If the user is not satisfied with the snapped WQS segment, they may press the blue `Manual WQS Adjustment` button to reveal a modal window named `Manually Adjust WQS`. This modal shows the information from the `Selected Station Information` table one last time for review. There are two textboxes below the table where users may input the desired WQS_ID to attach to the StationID and any additional comments and documentation to archive with the snapped StationID and WQS segment information. This could be why the selection was made, notes to future assessors about this site/segment, or nothing at all. At this point the user may navigate away from the modal by pressing `Dismiss` or `Cancel` if they choose to not proceed with that station.

**It is highly recommended that users copy and paste the desired WQS_ID from either this application or the GIS Web App to ensure the correct WQS_ID information is entered into the text box.** 


**Pro Tip: By clicking the record in the WQS_ID cell of the table on the modal window three time quickly, the cell contents will be highlighted. Users may use the keyboard shortcuts to copy(ctrl+c)/paste(ctrl+v) this information into the text box below the table.**

![](images/metadata8.PNG)

Once the user presses the `Accept` button in the `Manually Adjust WQS` modal, the station and manually entered WQS segment are linked, the modal disappears, the station changes to a purple (completed) color, and the count of stations "to do" in that category at the top of the page goes down by one. 


#### Application Operation: Export Reviews

All the work the user has completed so far accepting or manually adjusting WQS are only saved in the local application environment. **The only way to preserve the work completed in the application is to press the green `Export reviews` button.** It is highly recommended that users click the `Export reviews` button frequently (every 3-4 stations or after a particularly challenging review) to ensure their work is in fact saved on the server. 

Users may "undo" any accidental work still in their local application environment by either closing the app or returning to the `Watershed Selection` tab without pressing the `Export reviews` button. This work flow would look like: 

1. User selects station, Accept
2. User selects station, Accept
3. User selects station, Accept
4. User presses `Export reviews` to save work to the R server
5. User selects station, Accept- user realizes they made a mistake and doesn't want to save that accept to the server
6. User closes the app or navigates back to the `Watershed Selection` tab without pressing the `Export reviews` button- **all information completed in the app since the last time `Export reviews` was pressed will not be saved**
7. User opens the app or clicks the `Begin Review With Subbasin Selection (Retrieves Last Saved Result)` button on the `Watershed Selection` tab to pull the last information saved on the server
8. User proceeds to the `Manual Review` tab and continues work


### Application Operation: Station that Snapped to >1 WQS Segment

Should a user select a station for review that snapped to >1 WQS segment, the process for QAing that station is relatively simple. With the station highlighted with the green halo, the user reviews all the information presented below the map in the `Stations Data and Spatially Joined WQS` tab. Additionally, when the `Plot stations that snapped to >1 WQS Segment` button was pressed, additional spatial layers became available in the layers drop down of the map. The user may now turn on the layer called `WQS Segments of Stations Snapped to >1 Segment` to reveal all the segments in that category. These segments are plotted on a color ramp to distinguish them from one another and may be clicked on in the map to reveal the same information from the `Selected Station Information` table in a popup on the map. The GIS Web App hyperlinks may also be useful to use at this stage. 

![](images/metadata9.PNG)


#### Application Operation: Manual WQS Adjustment (> 1 segment)

If the user needs to choose between multiple WQS segments, they must press the blue `Manual WQS Adjustment` button to reveal a modal window named `Manually Adjust WQS`. **The user cannot accept a single StationID that is linked to multiple WQS_ID's using the `Accept` button.** The `Manually Adjust WQS` modal shows the information from the `Selected Station Information` table one last time for review. There are two textboxes below the table where users may input the desired WQS_ID to attach to the StationID and any additional comments and documentation to archive with the snapped StationID and WQS segment information. This could be why the selection was made, notes to future assessors about this site/segment, or nothing at all. At this point the user may navigate away from the modal by pressing `Dismiss` or `Cancel` if they choose to not proceed with that station.

**It is highly recommended that users copy and paste the desired WQS_ID from either this application or the GIS Web App to ensure the correct WQS_ID information is entered into the text box.** 

**Pro Tip: By clicking the record in the WQS_ID cell of the table on the modal window three time quickly, the cell contents will be highlighted. Users may use the keyboard shortcuts to copy(ctrl+c)/paste(ctrl+v) this information into the text box below the table.**

Once the user presses the `Accept` button in the `Manually Adjust WQS` modal, the station and manually entered WQS segment are linked, the modal disappears, the station changes to a purple (completed) color, and the count of stations "to do" in that category at the top of the page goes down by one. 



### Application Operation: Station that Snapped to 0 WQS Segments

Should a user select a station for review that snapped to no WQS segments, the process for QAing that station is more involved. With the station highlighted with the green halo, the user reviews all the information presented below the map in the `Stations Data and Spatially Joined WQS` tab. To preserve application rendering time, additional spatial layers are not available in the layers drop down of the map for this scenario. Instead, the user should click the `Open Link In New Tab` button in the `Selected Station Information` table to navigate to the GIS Web App to visualize all WQS segments around the station. 


#### Application Operation: Manual WQS Adjustment (0 segments)

Once the user has chosen an appropriate WQS segment, they must press the blue `Manual WQS Adjustment` button to reveal a modal window named `Manually Adjust WQS`. **The user cannot accept a single StationID that is linked to no WQS_ID's using the `Accept` button.** The `Manually Adjust WQS` modal shows the information from the `Selected Station Information` table one last time for review. This will show information about the station but no WQS_ID. There are two textboxes below the table where users may input the desired WQS_ID to attach to the StationID and any additional comments and documentation to archive with the snapped StationID and WQS segment information. This could be why the selection was made, notes to future assessors about this site/segment, or nothing at all. At this point the user may navigate away from the modal by pressing `Dismiss` or `Cancel` if they choose to not proceed with that station.

**It is highly recommended that users copy and paste the desired WQS_ID from either this application or the GIS Web App to ensure the correct WQS_ID information is entered into the text box.** 


Once the user presses the `Accept` button in the `Manually Adjust WQS` modal, the station and manually entered WQS segment are linked, the modal disappears, the station changes to a purple (completed) color, and the count of stations "to do" in that category at the top of the page goes down by one. 

